<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_54404668/documentation/portfolio/from-signals/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 20 Jun 2024 15:50:56 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation on portfolio simulation based on signals"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/documentation/portfolio/from-signals/ rel=canonical><link href=../from-orders/index.html rel=prev><link href=../../to-be-continued/index.html rel=next><link rel=icon href=../../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.18+insiders-4.53.6"><title>From signals - VectorBT PRO</title><link rel=stylesheet href=../../../assets/stylesheets/main.d5b5f0fd.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/stylesheets/extra.css><link rel=stylesheet href=../../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-0C5VNYCFHL",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script><meta name=robots content=noindex><meta property=og:title content="From signals"><meta property=og:type content=website><meta content=https://vectorbt.pro/documentation/portfolio/from-signals/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_54404668/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Documentation on portfolio simulation based on signals"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=../../../assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=../../../assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=../../../assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../assets/logo/favicon-16x16.png><link rel=manifest href=../../../assets/logo/site.webmanifest><link rel=mask-icon href=../../../assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=../../../assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_54404668/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#from-signals class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> <i>New</i>: Smart Money Concepts, Hurst exponent, tasks, iterated decorator, and <a href=../../../features/index.html><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.2c0 13.1 5.4 25.7 14.9 34.7l84.7 80.8c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9z"/></svg></span> </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=../../../index.html title="VectorBT PRO" class="md-header__button md-logo" aria-label="VectorBT PRO" data-md-component=logo> <img src=../../../assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT PRO <span class=md-version> v2024.6.19 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M224 64c-44.2 0-80 35.8-80 80v48h240c35.3 0 64 28.7 64 64v192c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64h16v-48C80 64.5 144.5 0 224 0c57.5 0 107 33.7 130.1 82.3 7.6 16 .8 35.1-15.2 42.6s-35.1.8-42.6-15.2C283.4 82.6 255.9 64 224 64zm32 320c17.7 0 32-14.3 32-32s-14.3-32-32-32h-64c-17.7 0-32 14.3-32 32s14.3 32 32 32h64z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> From signals </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../index.html class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=../../../features/overview/index.html class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../../../tutorials/overview/index.html class=md-tabs__link> Tutorials </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../overview/index.html class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=../../../api/index.html class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=../../../cookbook/overview/index.html class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=../../../terms/terms-of-use/index.html class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../index.html title="VectorBT PRO" class="md-nav__button md-logo" aria-label="VectorBT PRO" data-md-component=logo> <img src=../../../assets/logo/logo.svg alt=logo class=logo> </a> VectorBT PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../index.html class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../features/overview/index.html class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../tutorials/overview/index.html class=md-nav__link> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../overview/index.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../fundamentals/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 7a2 2 0 0 0-2 2v8h2v-4h2v4h2V9a2 2 0 0 0-2-2H3m0 2h2v2H3m12-.5V9a2 2 0 0 0-2-2H9v10h4a2 2 0 0 0 2-2v-1.5a1.54 1.54 0 0 0-1.5-1.5 1.54 1.54 0 0 0 1.5-1.5M13 15h-2v-2h2v2m0-4h-2V9h2m6-2a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-1h-2v1h-2V9h2v1h2V9a2 2 0 0 0-2-2Z"/></svg> <span class=md-ellipsis> Fundamentals </span> </a> </li> <li class=md-nav__item> <a href=../../building-blocks/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9M12 4.15 6.04 7.5 12 10.85l5.96-3.35L12 4.15M5 15.91l6 3.38v-6.71L5 9.21v6.7m14 0v-6.7l-6 3.37v6.71l6-3.38Z"/></svg> <span class=md-ellipsis> Building blocks </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex> <span class=md-ellipsis> Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../data/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4Z"/></svg> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=../../data/local/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 20H4a2 2 0 0 1-2-2V6c0-1.11.89-2 2-2h6l2 2h7a2 2 0 0 1 2 2H4v10l2.14-8h17.07l-2.28 8.5c-.23.87-1.01 1.5-1.93 1.5Z"/></svg> <span class=md-ellipsis> Local </span> </a> </li> <li class=md-nav__item> <a href=../../data/remote/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2m-5.15 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56M14.34 14H9.66c-.1-.66-.16-1.32-.16-2 0-.68.06-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2M12 19.96c-.83-1.2-1.5-2.53-1.91-3.96h3.82c-.41 1.43-1.08 2.76-1.91 3.96M8 8H5.08A7.923 7.923 0 0 1 9.4 4.44C8.8 5.55 8.35 6.75 8 8m-2.92 8H8c.35 1.25.8 2.45 1.4 3.56A8.008 8.008 0 0 1 5.08 16m-.82-2C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2M12 4.03c.83 1.2 1.5 2.54 1.91 3.97h-3.82c.41-1.43 1.08-2.77 1.91-3.97M18.92 8h-2.95a15.65 15.65 0 0 0-1.38-3.56c1.84.63 3.37 1.9 4.33 3.56M12 2C6.47 2 2 6.5 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2Z"/></svg> <span class=md-ellipsis> Remote </span> </a> </li> <li class=md-nav__item> <a href=../../data/synthetic/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 1-1.26 2.75L15 5l2.74 1.26L19 9l1.25-2.74L23 5l-2.75-1.25M9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5M19 15l-1.26 2.74L15 19l2.74 1.25L19 23l1.25-2.75L23 19l-2.75-1.26"/></svg> <span class=md-ellipsis> Synthetic </span> </a> </li> <li class=md-nav__item> <a href=../../data/scheduling/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a7 7 0 0 1-7-7 7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7m7.03-12.61 1.42-1.42c-.45-.51-.9-.97-1.41-1.41L17.62 6c-1.55-1.26-3.5-2-5.62-2a9 9 0 0 0-9 9 9 9 0 0 0 9 9c5 0 9-4.03 9-9 0-2.12-.74-4.07-1.97-5.61M11 14h2V8h-2m4-7H9v2h6V1Z"/></svg> <span class=md-ellipsis> Scheduling </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex> <span class=md-ellipsis> Indicators </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Indicators </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../indicators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3 14 .5.07L8.07 9.5a1.95 1.95 0 0 1 .52-1.91c.78-.79 2.04-.79 2.82 0 .53.52.7 1.26.52 1.91l2.57 2.57.5-.07c.18 0 .35 0 .5.07l3.57-3.57C19 8.35 19 8.18 19 8a2 2 0 0 1 2-2 2 2 0 0 1 2 2 2 2 0 0 1-2 2c-.18 0-.35 0-.5-.07l-3.57 3.57c.07.15.07.32.07.5a2 2 0 0 1-2 2 2 2 0 0 1-2-2l.07-.5-2.57-2.57c-.32.07-.68.07-1 0L4.93 15.5 5 16a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2Z"/></svg> <span class=md-ellipsis> Indicators </span> </a> </li> <li class=md-nav__item> <a href=../../indicators/development/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 3c-1.11 0-2 .89-2 2v4c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2m.2 1.5 1.06 1.05L5.27 9.5 2.74 6.95 3.81 5.9l1.47 1.49M4 13c-1.11 0-2 .89-2 2v4c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2v-4c0-1.11-.89-2-2-2m-4 2h4v4H4m8-14h10v2H12m0 12v-2h10v2m-10-8h10v2H12Z"/></svg> <span class=md-ellipsis> Development </span> </a> </li> <li class=md-nav__item> <a href=../../indicators/analysis/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 8c-1.5 0-2.3 1.4-1.9 2.5l-3.6 3.6c-.3-.1-.7-.1-1 0l-2.6-2.6c.4-1.1-.4-2.5-1.9-2.5-1.4 0-2.3 1.4-1.9 2.5L3.5 16c-1.1-.3-2.5.5-2.5 2 0 1.1.9 2 2 2 1.4 0 2.3-1.4 1.9-2.5l4.5-4.6c.3.1.7.1 1 0l2.6 2.6c-.3 1 .5 2.5 2 2.5s2.3-1.4 1.9-2.5l3.6-3.6c1.1.3 2.5-.5 2.5-1.9 0-1.1-.9-2-2-2m-6 1 .9-2.1L18 6l-2.1-.9L15 3l-.9 2.1L12 6l2.1.9L15 9M3.5 11 4 9l2-.5L4 8l-.5-2L3 8l-2 .5L3 9l.5 2Z"/></svg> <span class=md-ellipsis> Analysis </span> </a> </li> <li class=md-nav__item> <a href=../../indicators/parsers/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.6 16.6 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4m-5.2 0L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4Z"/></svg> <span class=md-ellipsis> Parsers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_6 checked> <label class=md-nav__link for=__nav_4_6 id=__nav_4_6_label tabindex> <span class=md-ellipsis> Portfolio </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_6_label aria-expanded=true> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> Portfolio </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56 6.49 3.74Z"/></svg> <span class=md-ellipsis> Portfolio </span> </a> </li> <li class=md-nav__item> <a href=../from-orders/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 2v20h20V2H2m18 10h-4v4h4v4h-4v-4h-4v4H8v-4H4v-4h4V8H4V4h4v4h4V4h4v4h4v4m-4-4v4h-4V8h4m-4 4v4H8v-4h4Z"/></svg> <span class=md-ellipsis> From orders </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg> <span class=md-ellipsis> From signals </span> <span class="md-nav__icon md-icon"></span> </label> <a href=index.html class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg> <span class=md-ellipsis> From signals </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#mechanics class=md-nav__link> <span class=md-ellipsis> Mechanics </span> </a> <nav class=md-nav aria-label=Mechanics> <ul class=md-nav__list> <li class=md-nav__item> <a href=#framework class=md-nav__link> <span class=md-ellipsis> Framework </span> </a> <nav class=md-nav aria-label=Framework> <ul class=md-nav__list> <li class=md-nav__item> <a href=#segment-workflow class=md-nav__link> <span class=md-ellipsis> Segment workflow </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signal-generation class=md-nav__link> <span class=md-ellipsis> Signal generation </span> </a> <nav class=md-nav aria-label="Signal generation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#signal-function class=md-nav__link> <span class=md-ellipsis> Signal function </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signal-resolution class=md-nav__link> <span class=md-ellipsis> Signal resolution </span> </a> </li> <li class=md-nav__item> <a href=#signal-conversion class=md-nav__link> <span class=md-ellipsis> Signal conversion </span> </a> </li> <li class=md-nav__item> <a href=#main-order-resolution class=md-nav__link> <span class=md-ellipsis> Main order resolution </span> </a> </li> <li class=md-nav__item> <a href=#limit-management class=md-nav__link> <span class=md-ellipsis> Limit management </span> </a> <nav class=md-nav aria-label="Limit management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creation class=md-nav__link> <span class=md-ellipsis> Creation </span> </a> </li> <li class=md-nav__item> <a href=#expiration class=md-nav__link> <span class=md-ellipsis> Expiration </span> </a> </li> <li class=md-nav__item> <a href=#activation class=md-nav__link> <span class=md-ellipsis> Activation </span> </a> </li> <li class=md-nav__item> <a href=#cancellation class=md-nav__link> <span class=md-ellipsis> Cancellation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stop-management class=md-nav__link> <span class=md-ellipsis> Stop management </span> </a> <nav class=md-nav aria-label="Stop management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#types class=md-nav__link> <span class=md-ellipsis> Types </span> </a> </li> <li class=md-nav__item> <a href=#creation_1 class=md-nav__link> <span class=md-ellipsis> Creation </span> </a> </li> <li class=md-nav__item> <a href=#activation_1 class=md-nav__link> <span class=md-ellipsis> Activation </span> </a> </li> <li class=md-nav__item> <a href=#resolution class=md-nav__link> <span class=md-ellipsis> Resolution </span> </a> </li> <li class=md-nav__item> <a href=#updating class=md-nav__link> <span class=md-ellipsis> Updating </span> </a> </li> <li class=md-nav__item> <a href=#cancellation_1 class=md-nav__link> <span class=md-ellipsis> Cancellation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signals class=md-nav__link> <span class=md-ellipsis> Signals </span> </a> <nav class=md-nav aria-label=Signals> <ul class=md-nav__list> <li class=md-nav__item> <a href=#direction-unaware class=md-nav__link> <span class=md-ellipsis> Direction-unaware </span> </a> </li> <li class=md-nav__item> <a href=#direction-aware class=md-nav__link> <span class=md-ellipsis> Direction-aware </span> </a> </li> <li class=md-nav__item> <a href=#signal-function_1 class=md-nav__link> <span class=md-ellipsis> Signal function </span> </a> </li> <li class=md-nav__item> <a href=#conflicts class=md-nav__link> <span class=md-ellipsis> Conflicts </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#orders class=md-nav__link> <span class=md-ellipsis> Orders </span> </a> <nav class=md-nav aria-label=Orders> <ul class=md-nav__list> <li class=md-nav__item> <a href=#accumulation class=md-nav__link> <span class=md-ellipsis> Accumulation </span> </a> </li> <li class=md-nav__item> <a href=#size-types class=md-nav__link> <span class=md-ellipsis> Size types </span> </a> </li> <li class=md-nav__item> <a href=#size-granularity class=md-nav__link> <span class=md-ellipsis> Size granularity </span> </a> </li> <li class=md-nav__item> <a href=#price class=md-nav__link> <span class=md-ellipsis> Price </span> </a> </li> <li class=md-nav__item> <a href=#shifting class=md-nav__link> <span class=md-ellipsis> Shifting </span> </a> </li> <li class=md-nav__item> <a href=#slippage class=md-nav__link> <span class=md-ellipsis> Slippage </span> </a> </li> <li class=md-nav__item> <a href=#limit-orders class=md-nav__link> <span class=md-ellipsis> Limit orders </span> </a> <nav class=md-nav aria-label="Limit orders"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#time-in-force class=md-nav__link> <span class=md-ellipsis> Time in force </span> </a> </li> <li class=md-nav__item> <a href=#expiration-date class=md-nav__link> <span class=md-ellipsis> Expiration date </span> </a> </li> <li class=md-nav__item> <a href=#conflicts_1 class=md-nav__link> <span class=md-ellipsis> Conflicts </span> </a> </li> <li class=md-nav__item> <a href=#delta class=md-nav__link> <span class=md-ellipsis> Delta </span> </a> </li> <li class=md-nav__item> <a href=#reversing class=md-nav__link> <span class=md-ellipsis> Reversing </span> </a> </li> <li class=md-nav__item> <a href=#adjustment class=md-nav__link> <span class=md-ellipsis> Adjustment </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stop-orders class=md-nav__link> <span class=md-ellipsis> Stop orders </span> </a> <nav class=md-nav aria-label="Stop orders"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#entry-point class=md-nav__link> <span class=md-ellipsis> Entry point </span> </a> </li> <li class=md-nav__item> <a href=#exit-point class=md-nav__link> <span class=md-ellipsis> Exit point </span> </a> </li> <li class=md-nav__item> <a href=#conflicts_2 class=md-nav__link> <span class=md-ellipsis> Conflicts </span> </a> </li> <li class=md-nav__item> <a href=#adjustment_1 class=md-nav__link> <span class=md-ellipsis> Adjustment </span> </a> </li> <li class=md-nav__item> <a href=#laddering class=md-nav__link> <span class=md-ellipsis> Laddering </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dynamic class=md-nav__link> <span class=md-ellipsis> Dynamic </span> </a> <nav class=md-nav aria-label=Dynamic> <ul class=md-nav__list> <li class=md-nav__item> <a href=#entry-laddering class=md-nav__link> <span class=md-ellipsis> Entry laddering </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#grouping class=md-nav__link> <span class=md-ellipsis> Grouping </span> </a> <nav class=md-nav aria-label=Grouping> <ul class=md-nav__list> <li class=md-nav__item> <a href=#after-simulation class=md-nav__link> <span class=md-ellipsis> After simulation </span> </a> </li> <li class=md-nav__item> <a href=#before-simulation class=md-nav__link> <span class=md-ellipsis> Before simulation </span> </a> <nav class=md-nav aria-label="Before simulation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sorting class=md-nav__link> <span class=md-ellipsis> Sorting </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#custom-outputs class=md-nav__link> <span class=md-ellipsis> Custom outputs </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../to-be-continued/index.html class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../api/index.html class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../cookbook/overview/index.html class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../terms/terms-of-use/index.html class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../../overview/index.html class=md-path__link> <span class=md-ellipsis> Documentation </span> </a> </li> <li class=md-path__item> <a href=../index.html class=md-path__link> <span class=md-ellipsis> Portfolio </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=from-signals><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg></span> From signals<a class=headerlink href=#from-signals title="Permanent link">&para;</a></h1> <p>The method <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a> (<abbr title="From-orders simulation method">FO</abbr>), which was discussed previously, is the most primitive simulation method: it takes order information in form of multiple array-like arguments and broadcasts them to a single shape, such that we know exactly what has to be ordered of each asset at each bar. This method requires us to have that information in advance, regardless of any events during the simulation. But what if we wanted to create an order only given that we're not currently in the market, or in general, to make an order dependable on the current simulation state? Such a conditional logic cannot be represented using orders alone - we either need to use a callback, or define more arrays. The former and the latter are both implemented by <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> (<abbr title="From-signals simulation method">FS</abbr>).</p> <p>Before we dive deep into this method, make sure to learn more about signals <a href=../../../tutorials/signal-development/index.html>here</a>. In a nutshell: signals are an abstraction layer over orders. Each signal consists of four boolean values: <img alt=1⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/31-20e3.svg title=:one:> long entry, <img alt=2⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/32-20e3.svg title=:two:> long exit, <img alt=3⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/33-20e3.svg title=:three:> short entry, and <img alt=4⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/34-20e3.svg title=:four:> short exit. A combination of these values enables us to control the direction of an order relative to the current position. For example, a short entry flag will reverse the current long position, or open a new short one if we're not in the market. This way, position management can be abstracted away from order management, such that we can lean back and only express our decision of whether we're currently bullish or bearish - a perfect playground for ML models, by the way.</p> <p>And there's another reason to love signals: statistically, in an entire universe of signal <a href=https://en.wikipedia.org/wiki/Permutation>permutations</a>, there is at least one permutation that beats the market all the time. This means that we can design a perfect trading algorithm using the above signal schema alone - we just need to guess the right timing and direction of each signal, which reduces the number of factors we need to care about to just two (in a perfect world, of course, because in the real world we also need to take into account the risk, execution modalities, etc.). For example, if the price of any security is $21 at day 1, $20 at day 2, and $22 at day 3, we can short entry at day 1 and long entry at day 2 to get positive-only returns. That's why trading systems and their backtesting components as well shouldn't necessarily scream from complexity in order to be profitable - they just need a robust signal generator as their algorithmic backbone and a trading infrastructure that closely matches the backtesting one.</p> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Here are all the signal permutations for a price series with 4 points and their total return:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>vectorbtpro</span> <span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>21</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>22</span><span class=p>,</span> <span class=mi>21</span><span class=p>])</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>returns</span> <span class=o>=</span> <span class=p>(</span><span class=n>price</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span> <span class=o>-</span> <span class=n>price</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>price</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>permutations</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>product</span><span class=p>([</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>],</span> <span class=n>repeat</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)))</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>prod</span><span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>permutations</span><span class=p>,</span> <span class=n>returns</span><span class=p>,</span> <span class=o>-</span><span class=n>returns</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>total_return</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>permutations</span><span class=p>)</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>(False, True, False)     0.204762</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>(False, True, True)      0.100000</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=go>(True, True, False)      0.095238</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=go>(True, True, True)       0.000000</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>(False, False, False)   -0.014286</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=go>(False, False, True)    -0.100000</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=go>(True, False, False)    -0.103896</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=go>(True, False, True)     -0.181818</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=go>dtype: float64</span>
</span></code></pre></div> <p>Don't run this on longer price series since the number of permutations grows exponentially with the number of data points - <code>2^n</code>. That is, a year of daily history would require checking <code>2^365</code> or <code>7.515336e+109</code> permutations.</p> </div> <h2 id=mechanics>Mechanics<a class=headerlink href=#mechanics title="Permanent link">&para;</a></h2> <p>Similarly to <abbr title="From-orders simulation method">FO</abbr>, this method is also a class method of <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> and has two Numba-compiled core functions: <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.from_signals_nb>from_signals_nb</a> and <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.from_signal_func_nb>from_signal_func_nb</a>. In fact, <abbr title="From-signals simulation method">FS</abbr> shares many arguments with <abbr title="From-orders simulation method">FO</abbr>, especially those used to set up the simulation, such as <code>init_cash</code>, and those carrying order information, such as <code>size</code>. For instance, if we look at the API documentation of the argument <code>size</code> under <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>, we'll see <em>"See <code>Portfolio.from_orders</code>"</em>. But also the simulation procedure of <abbr title="From-signals simulation method">FS</abbr> itself is very similar to that of <abbr title="From-orders simulation method">FO</abbr>: while looping over all columns and rows, at each iteration, it resolves the current order and executes it by appending information on the filled order to the order records and updating the current simulation state. But that's where the similarities end.</p> <h3 id=framework>Framework<a class=headerlink href=#framework title="Permanent link">&para;</a></h3> <p>Here's an abstract visualization of the framework of <abbr title="From-signals simulation method">FS</abbr> run on three rows and two groups with two columns and one column respectively:</p> <p><img alt loading=lazy src=../../../assets/images/documentation/pf/from_signals_framework.svg style=width:800px;></p> <p>If you worked with vectorbt long enough, you have likely noticed that the framework of <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> follows that of <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_orders</a> and <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_order_func>Portfolio.from_order_func</a>. Like most things in the vectorbt's universe, the simulation with <abbr title="From-signals simulation method">FS</abbr> is done by iterating over a so-called "target shape". This shape consists of two dimensions: rows representing the time axis and columns representing the asset axis (or, generally, configurations). Columns are further divided into groups: if multiple columns share the same cash, they are put into the same group (blue rectangle on the left above), while columns without cash sharing or grouping are isolated and appear as a group with exactly one column (blue rectangle on the right above). Groups are considered to be separate, atomic backtesting instances that aren't connected by any means, that is, splitting the shape by target groups shouldn't affect the final result. This, by the way, is why chunking is generally performed on groups rather than columns <img alt=💡 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4a1.svg title=:bulb:></p> <p>The actual iteration over the rows and groups happens in the <a href=https://en.wikipedia.org/wiki/Row-_and_column-major_order>column-major order</a>: the simulator starts moving over the rows in the first group, and once finished, continues with the second group. Every time it hits a new row when processing a group, all the assets at this row are called a "segment" because they together compete for the same resources at the same time, or are connected by any user-defined means. For example, an account with <code>BTC-USD</code> and <code>ETH-USD</code> on the date <code>2020-01-01</code> is considered a segment because the value of both assets adds to the total value of the group at this date. Each asset within a segment is called an "element", which is the smallest simulation unit. An element in <abbr title="From-signals simulation method">FS</abbr> can host only one order, such that the number of filled orders is effectively capped by the number of rows times the number of columns. For example, a year of the daily <code>BTC-USD</code> and <code>ETH-USD</code> history can generate at most <code>365 * 2 = 730</code> orders, or one order per bar and asset.</p> <h4 id=segment-workflow>Segment workflow<a class=headerlink href=#segment-workflow title="Permanent link">&para;</a></h4> <p>Segment is where the major part of the simulation takes place:</p> <pre class=mermaid><code>flowchart TD;
    id0["Update state at open"]

    id4["Get signals (0)"]
    id5["Get signals (1)"]
    id6["Get signals (2)"]

    id7["Generate order"]
    id8["Generate order"]
    id9["Generate order"]

    id10["Sort orders"]

    id11["Execute order (2)"]
    id12["Execute order (0)"]
    id13["Execute order (1)"]

    id14["Update state at close"]

    id15["Post-segment processing (optional)"]

    id0 --&gt; id4;
    id0 --&gt; id5;
    id0 --&gt; id6;
    id4 --&gt; id7;
    id5 --&gt; id8;
    id6 --&gt; id9;
    id7 --&gt; id10;
    id8 --&gt; id10;
    id9 --&gt; id10;
    id10 --&gt; id11;
    id10 --&gt; id12;
    id10 --&gt; id13;
    id11 --&gt; id14;
    id12 --&gt; id14;
    id13 --&gt; id14;
    id14 --&gt; id15;</code></pre> <p><abbr title="From-signals simulation method">FS</abbr> first updates the current simulation state using the opening price. This is done to get the group value in case some order has the size defined as a (target) percentage, to be able to convert the size into an absolute amount of units. Then, it iterates through the columns in the current group and determines the four signals under each column. Those signals then get converted into an order specification that is quite similar to the one <abbr title="From-orders simulation method">FO</abbr> takes. </p> <p>After having resolved all the order specifications, and if the automatic call sequence is enabled, the simulator attempts to sort the orders by their potential value such that sell orders are executed first - which is needed for rebalancing. This is only possible if all the (limit, order, and user-defined) orders within the current group happen either at the beginning or at the end of the current bar. If some orders happen in the middle of the bar, or some happen at the beginning and some at the end of a bar, an error will be thrown because we can only sort orders if they are guaranteed to happen at the same time! If the dynamic call sequence is disabled and there are orders in multiple bar zones, the simulator will sort them by the bar zone. </p> <p>Finally, <abbr title="From-signals simulation method">FS</abbr> goes through the columns in a newly established call sequence to execute the orders, and updates the simulation state once again using the closing price. The final update is required to optionally generate the portfolio returns and for the segment post-processing function.</p> <h3 id=signal-generation>Signal generation<a class=headerlink href=#signal-generation title="Permanent link">&para;</a></h3> <p><abbr title="From-signals simulation method">FS</abbr> supports two signal generation modes: fixed (cached), and dynamic (non-cached). The first mode is implemented by the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.from_signals_nb>from_signals_nb</a>, which takes the signals as four pre-defined arrays and doesn't allow defining any callbacks, thus it's perfectly cacheable and doesn't have to be recompiled with each new runtime, unless it discovers a new set of data types. The second mode is implemented by the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.from_signal_func_nb>from_signal_func_nb</a>, which doesn't accept any signal arrays, but defines a signal function - a special callback meant to generate the four signals for each asset and at each bar dynamically. It's most suited for use cases where the signal depends on the current simulation state. Furthermore, it defines a callback that is getting called after processing the current segment, which can be used to pre-compute various metrics, such as the Sharpe ratio. The main downsize is that it cannot be cached (yet), thus it has to be re-compiled in each new runtime (<img alt=⚰ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26b0.svg title=:coffin:> to those running vectorbt as a script).</p> <p>The convenience of the method <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>, which wraps those two modes, is in its ability to choose the mode automatically: whenever we override any default callback, it runs the second mode over the first one.</p> <h4 id=signal-function>Signal function<a class=headerlink href=#signal-function title="Permanent link">&para;</a></h4> <p>Remember how in <abbr title="From-orders simulation method">FO</abbr> we had to provide everything as arrays and could neither dynamically change the provided information nor affect the execution in any way? <abbr title="From-signals simulation method">FS</abbr> is much more flexible than that: it expects most information to be defined beforehand (acting as a facade), while signals can be generated both statically and dynamically. Let's play with the dynamic signal generation a bit.</p> <p>The second mode is implemented by accepting a user-defined callback function, <code>signal_func_nb</code>. Whenever the main simulation loop hits a new row (bar), it asks each asset in the current group to generate signals using this callback function. For this, it packs all the information that might be useful to the user, such as the current cash balance and the group value, into a named tuple of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext>SignalContext</a>. In return, it expects the function to return four signals, which will be used to create an order for that asset.</p> <p>Here's how a dead-simple signal function that orders nothing looks like:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>vectorbtpro</span> <span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=gp>... </span>    <span class=s2>&quot;BTC-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>20594.29</span><span class=p>,</span> <span class=mf>20719.41</span><span class=p>,</span> <span class=mf>19986.60</span><span class=p>,</span> <span class=mf>21084.64</span><span class=p>],</span> 
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=gp>... </span>    <span class=s2>&quot;ETH-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>1127.51</span><span class=p>,</span> <span class=mf>1125.37</span><span class=p>,</span> <span class=mf>1051.32</span><span class=p>,</span> <span class=mf>1143.20</span><span class=p>],</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=gp>... </span>    <span class=s2>&quot;DOT-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>7.88</span><span class=p>,</span> <span class=mf>7.74</span><span class=p>,</span> <span class=mf>7.41</span><span class=p>,</span> <span class=mf>7.78</span><span class=p>],</span> 
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=gp>... </span>    <span class=s2>&quot;BNB-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>216.90</span><span class=p>,</span> <span class=mf>219.67</span><span class=p>,</span> <span class=mf>214.23</span><span class=p>,</span> <span class=mf>228.92</span><span class=p>]</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=gp>... </span><span class=p>})</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span> 
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>order_records</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=go>array([], dtype={...})</span>
</span></code></pre></div> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>To avoid waiting for the function to compile, remove the <code>@njit</code> decorator from <code>signal_func_nb</code> and pass <code>jitted=False</code> to <code>from_signals</code> in order to disable Numba for this method completely. Do this only if the amount of input data is small (&lt; 1000).</p> </div> <p>To better understand when the function is called, let's expand our data to two assets and print out the current column and row:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>[[</span><span class=s2>&quot;BTC-USD&quot;</span><span class=p>,</span> <span class=s2>&quot;ETH-USD&quot;</span><span class=p>]],</span> 
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=go>0 0</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=go>0 1</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=go>0 2</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=go>0 3</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=go>1 0</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=go>1 1</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=go>1 2</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=go>1 3</span>
</span></code></pre></div> <p>We see that the function was called at each row, first in the column <code>BTC-USD</code>, then in the column <code>ETH-USD</code>. Here, both assets are acting as isolated tests, thus the simulator processes one column after another. But once we introduce a grouping with or without cash sharing, which binds columns semantically, the simulator will process the columns group-wise, that is, it will move over the groups, then over the rows, and finally over the columns in the current group and at the current row. Let's demonstrate this by introducing two groups with two assets sharing the same cash:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span> 
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=go>0 0 0</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=go>0 1 0</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=go>0 0 1</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=go>0 1 1</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=go>0 0 2</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=go>0 1 2</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=go>0 0 3</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=go>0 1 3</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=go>1 2 0</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=go>1 3 0</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=go>1 2 1</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=go>1 3 1</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=go>1 2 2</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=go>1 3 2</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=go>1 2 3</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=go>1 3 3</span>
</span></code></pre></div> <p>The context tuple passed to the signal function contains all the necessary information to identify the position of the call in the simulation. For example, we can use <code>c.index[c.i]</code> with <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext.index>SignalContext.index</a> and <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext.i>SignalContext.i</a> to get the timestamp of the current bar. We can also change the current state of any pending limit or stop order before it's processed since the signal function is conceptually executed right before the beginning of the bar.</p> <p>Thanks to the strict processing of groups from left to right and storing the state of each group globally, we can access the order records and, generally, the latest simulation state of all the groups that were processed earlier. For example, <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext.last_cash>SignalContext.last_cash</a> has the same number of elements as there are groups. This is powerful and dangerous at the same time: we can introduce complex intergroup relationships if wanted, or accidentally access the wrong group if not paying enough attention.</p> <h3 id=signal-resolution>Signal resolution<a class=headerlink href=#signal-resolution title="Permanent link">&para;</a></h3> <p>Signals are just one additional level of abstraction over orders, meaning there needs to be some logic in place that translates them into order specifications. Indeed, whenever the simulator receives a new set of four signals at each row and column, it first resolves them into a single signal, which then gets converted into an order. The resolution step checks whether the provided signals have conflicts. Mostly, the signals are expected to have only one <code>True</code> value and three <code>False</code> values, but sometimes multiple signals are <code>True</code>, especially when the signal function is forwarding data from multiple boolean arrays. In such a case, the simulator goes through the following procedure consisting of multiple checks and fixes:</p> <pre class=mermaid><code>flowchart TD;
    id1["Long entry and long exit?"]
    id2["Short entry and short exit?"]
    id3["Long entry and short entry?"]
    id4["Long/short position and short/long entry?"]
    id5["Final signal"]

    id1 --&gt;|"fix"| id2;
    id2 --&gt;|"fix"| id3;
    id3 --&gt;|"fix"| id4;
    id4 --&gt;|"fix"| id5;</code></pre> <p>It first checks whether there are multiple <code>True</code> values within the same direction, for example, when the long entry and long exit are both set. To decide which one in the long direction to keep, it looks at the argument <code>upon_long_conflict</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.ConflictMode>ConflictMode</a> provided by the user. For example, the option "adjacent" will pick the signal adjacent to the position we are currently in such that only the long entry will remain active if we're in a long position. This is done by calling the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.resolve_signal_conflict_nb>resolve_signal_conflict_nb</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_signal_conflict_nb</span><span class=p>(</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=gp>... </span>    <span class=n>is_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=gp>... </span>    <span class=n>is_exit</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span><span class=p>,</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=gp>... </span>    <span class=n>conflict_mode</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ConflictMode</span><span class=o>.</span><span class=n>Adjacent</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>(True, False)</span>
</span></code></pre></div> <p>After deciding for at most one signal in both directions, the simulator checks whether both the long and short entry are active and uses the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.resolve_dir_conflict_nb>resolve_dir_conflict_nb</a> based on the argument <code>upon_dir_conflict</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.DirectionConflictMode>DirectionConflictMode</a> to select the winner. For example, we can choose to always go short when there is any uncertainty:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_dir_conflict_nb</span><span class=p>(</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=gp>... </span>    <span class=n>upon_dir_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>DirectionConflictMode</span><span class=o>.</span><span class=n>Short</span><span class=p>,</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=go>(False, True)</span>
</span></code></pre></div> <p>Finally, it calls the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.resolve_opposite_entry_nb>resolve_opposite_entry_nb</a> if there is an entry signal that is opposite to the direction of the current position. For example, if we're in a long position and the short entry signal is set, the simulator will use the argument <code>upon_opposite_entry</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OppositeEntryMode>OppositeEntryMode</a> to decide whether to reduce, close, or completely reverse the current long position. Let's make the short entry signal behave like the long exit signal:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_opposite_entry_nb</span><span class=p>(</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=gp>... </span>    <span class=n>is_long_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=gp>... </span>    <span class=n>is_short_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=gp>... </span>    <span class=n>upon_opposite_entry</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OppositeEntryMode</span><span class=o>.</span><span class=n>Close</span><span class=p>,</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=go>(False, True, False, False, 0)</span>
</span></code></pre></div> <ol> <li>This argument can be <code>True</code>, <code>False</code>, or any of <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.AccumulationMode>AccumulationMode</a> </li> </ol> <p>In the end, only one active signal out of four will remain <img alt=🛤 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f6e4.svg title=:railway_track:></p> <h3 id=signal-conversion>Signal conversion<a class=headerlink href=#signal-conversion title="Permanent link">&para;</a></h3> <p>We have our one signal, now what? It's time to convert it into an order! And this is the easiest step in the pipeline, done by the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.signal_to_size_nb>signal_to_size_nb</a>, which takes the four signals (three of which are now deactivated) and the size requirement under this row and column (i.e., for this element), and returns the order size, size type, and direction to be requested. For example, being in a position of 20 shares and receiving the long exit signal, the size becomes minus 20 shares, the size type becomes <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SizeType.Amount>SizeType.Amount</a>, and the direction becomes <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.Direction.LongOnly>Direction.LongOnly</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>signal_to_size_nb</span><span class=p>(</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=gp>... </span>    <span class=n>val_price_now</span><span class=o>=</span><span class=mf>20594.29</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=gp>... </span>    <span class=n>value_now</span><span class=o>=</span><span class=mf>411885.80</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=gp>... </span>    <span class=n>is_long_exit</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=gp>... </span>    <span class=n>is_short_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>ValuePercent</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>False</span>  <span class=c1># (5)!</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=go>(-20.0, 0, 0)</span>
</span></code></pre></div> <ol> <li>The latest asset price known</li> <li>The latest group value known</li> <li>Default value for this element</li> <li>Default value for this element</li> <li>Default value for this element</li> </ol> <p>Even though we provided the function with the default order specification for the current element, such as <code>size</code>, the function didn't use it because it isn't required for closing the current position. On the other hand, if we wanted to reverse the current position (that is, close it and then order using the default specification), those inputs would suddenly become effective:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>signal_to_size_nb</span><span class=p>(</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>... </span>    <span class=n>val_price_now</span><span class=o>=</span><span class=mf>20594.29</span><span class=p>,</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=gp>... </span>    <span class=n>value_now</span><span class=o>=</span><span class=mf>411885.80</span><span class=p>,</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=gp>... </span>    <span class=n>is_long_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=gp>... </span>    <span class=n>is_short_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>ValuePercent</span><span class=p>,</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=go>(-22.0, 0, 2)</span>
</span></code></pre></div> <ol> <li>Reverse the long position</li> </ol> <p>The size is calculated as follows: reduce the number of shares by 20 to close out the long position, and, given that we're operating with a percentage of the current group value, open a new short position of <code>size * value_now / val_price_now = 2.0</code> shares. The size type is <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SizeType.Amount>SizeType.Amount</a> while the direction is <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.Direction.Both>Direction.Both</a> because the operation now involves two directions.</p> <h3 id=main-order-resolution>Main order resolution<a class=headerlink href=#main-order-resolution title="Permanent link">&para;</a></h3> <p>The simulator called the signal function, resolved the incoming signals, and converted them into an order specification. But this is not the only order that competes for the current bar: there may be also pending limit and stop orders. Since the <abbr title="From-signals simulation method">FS</abbr> simulation function can process at most one order at each bar, it has to decide for a winner, which should always be an order that executes first. But how do we know which one comes first if we don't have any intra-bar data? We can still divide each bar into three "zones": opening (first rectangle below), somewhere in-between (second rectangle below), and closing (third rectangle below). For example, if a stop order was hit at or before the opening of the current bar and the user order should execute at the close price, then clearly the stop order should be first on the line. Here's the full decision chain:</p> <pre class=mermaid><code>flowchart TD;
    subgraph " "
    id1["Pending limit price hit at/before open?"]
    id2["Pending stop price hit at/before open?"]
    id3["User price is open?"]

    id1 --&gt;|"no"| id2;
    id2 --&gt;|"no"| id3;
    end

    subgraph " "
    id4["Pending limit price hit?"]
    id5["Pending stop price hit before close?"]
    id6["User price isn't close?"]

    id3 --&gt;|"no"| id4;
    id4 --&gt;|"no"| id5;
    id5 --&gt;|"no"| id6;
    end

    subgraph " "
    id7["Pending stop price hit at close?"]
    id8["User price is close?"]

    id6 --&gt;|"no"| id7;
    id7 --&gt;|"no"| id8;
    end</code></pre> <p>As we see, limit orders have priority over stop orders, while stop orders have priority over user orders, but only if they are triggered within the same zone of a bar.</p> <h3 id=limit-management>Limit management<a class=headerlink href=#limit-management title="Permanent link">&para;</a></h3> <p>While a market order is a transaction meant to execute as quickly as possible at the current market price, a limit order is an order to buy or sell an asset with a restriction on the maximum price to be paid or the minimum price to be received (the "limit price"). The price of a limit order is getting compared against a pre-defined price level. Until this level is reached, the order is marked as pending, and it will not be filled if the price does not reach this level.</p> <h4 id=creation>Creation<a class=headerlink href=#creation title="Permanent link">&para;</a></h4> <p>Whenever a stop or user-defined order goes through and its order type provided via <code>order_type</code> is <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OrderType.Limit>OrderType.Limit</a>, the simulator first determines what kind of limit price the order should be executed at: open, close, or something else? And this is a very important concept to grasp: the argument <code>price</code> gives vectorbt hints on where in the bar the operation should take place. If the limit price is the open price (provided as either <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PriceType.Open>PriceType.Open</a> or <code>-np.inf</code>), the simulator is allowed to use the entire candle for its checks and execute the order right upon detecting the price being hit, at the same bar. If the limit price is not the close price but something in-between, the simulator is allowed to use the close price only. If the limit price is the close price (provided as either <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PriceType.Close>PriceType.Close</a> or <code>np.inf</code>), the simulator is not allowed to execute the limit order right away - it's forced to postpone its very first check to the next bar.</p> <p>If the limit order couldn't be executed at the same bar as it was created, the order is marked as pending and all the relevant information becomes stored in a record array of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.limit_info_dt>limit_info_dt</a>, which is structured by asset. This array can keep only one instance per asset, thus <abbr title="From-signals simulation method">FS</abbr> allows only one limit order to be active at a time. In a signal function, this array can be accessed via <code>c.limit_info_dt</code>, allowing us to change any information before the new bar. For example, to change the price: <code>c.limit_info_dt["init_price"][c.col] = new_price</code>.</p> <h4 id=expiration>Expiration<a class=headerlink href=#expiration title="Permanent link">&para;</a></h4> <p>Once the simulator hits the next bar, it first uses <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.check_limit_expired_nb>check_limit_expired_nb</a> to check whether the pending limit order expired at the beginning or somewhere in the middle of the bar. If the former, the order is thrown away. If the latter, the simulator also checks whether the order was hit at the beginning of the bar (and execute it), and if not, throw it away because there is no guarantee that the order was hit before the deadline. For example, let's assume that the order can be at most 36 hours in force, it was issued at the day <code>2020-01-01</code>, and now is the day <code>2020-01-02</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_expired_nb</span><span class=p>(</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=gp>... </span>    <span class=n>creation_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=gp>... </span>    <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>... </span>    <span class=n>tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;36h&quot;</span><span class=p>)),</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=gp>... </span>    <span class=n>index</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>3</span><span class=p>)),</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=gp>... </span>    <span class=n>freq</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1d&quot;</span><span class=p>))</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=go>(False, True)</span>
</span></code></pre></div> <ol> <li>Index and time deltas must be converted into nanoseconds</li> </ol> <p>We see that the function marked the order as expired, but not at the beginning of the bar such that it can still be executed using the open price. But if the lifespan of the order was 24 hours, the function would also raise the first flag and disallow any execution:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_expired_nb</span><span class=p>(</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=gp>... </span>    <span class=n>creation_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=gp>... </span>    <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=gp>... </span>    <span class=n>tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;24h&quot;</span><span class=p>)),</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=gp>... </span>    <span class=n>index</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>3</span><span class=p>)),</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=gp>... </span>    <span class=n>freq</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1d&quot;</span><span class=p>))</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=go>(True, True)</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The lifespan is calculated by subtracting any time from the opening time of the creation bar, even if the order was placed at the very end of the creation bar.</p> </div> <h4 id=activation>Activation<a class=headerlink href=#activation title="Permanent link">&para;</a></h4> <p>Once we're sure that the order <strong>can</strong> be executed at this bar (i.e., it won't expire), the simulator uses the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.check_limit_hit_nb>check_limit_hit_nb</a> to check whether the order <strong>should</strong> be executed by determining whether its target price has been hit. This is implemented through comparison of the price against the current candle. For example, if we have a pending buy limit order with a target price of <code>9.5</code>, the function will check whether the low price went below the target price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_hit_nb</span><span class=p>(</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>9.5</span><span class=p>,</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>2.0</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=go>(9.5, False, True)</span>
</span></code></pre></div> <p>If the target price was <code>11</code>, the function would notify us about the price being hit already at the beginning of the bar; in such a case, the order will be executed right away using the open price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_hit_nb</span><span class=p>(</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>2.0</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=go>(10.0, True, True)</span>
</span></code></pre></div> <h4 id=cancellation>Cancellation<a class=headerlink href=#cancellation title="Permanent link">&para;</a></h4> <p>If the target price hasn't been hit, the limit order remains pending. It can still be cancelled manually in the signal function called before all the checks above, or in the post-segment function called after processing the entire segment. The pending order will also be cancelled automatically once any stop order gets executed since the latter may change the simulation state and potentially pull the resources required to execute the former in the future. </p> <p>Finally, the four signals returned by the signal function and resolved into a single signal also can affect the pending order, regardless of whether the final signal gets executed or not. Consider the example where we have a pending buy limit order and the user decides to issue the long exit or short entry signal; in this case, the most intuitive reaction would be cancelling the pending order since the user have changed their mind. Exactly this is happening by default. Such "pending conflicts" are resolved using the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.resolve_pending_conflict_nb>resolve_pending_conflict_nb</a>, which uses the arguments <code>upon_adj_limit_conflict</code> and <code>upon_opp_limit_conflict</code>, both of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PendingConflictMode>PendingConflictMode</a>, to decide what to do if the direction of the pending order is adjacent and opposite respectively to the direction of the resolved user-defined signal.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_pending_conflict_nb</span><span class=p>(</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=gp>... </span>    <span class=n>is_pending_long</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=gp>... </span>    <span class=n>is_user_long</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=gp>... </span>    <span class=n>upon_adj_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PendingConflictMode</span><span class=o>.</span><span class=n>KeepIgnore</span><span class=p>,</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=gp>... </span>    <span class=n>upon_opp_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PendingConflictMode</span><span class=o>.</span><span class=n>CancelIgnore</span><span class=p>,</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=go>(False, False)</span>
</span></code></pre></div> <p>Here, the function decided to cancel the limit order and to ignore the user-defined signal.</p> <h3 id=stop-management>Stop management<a class=headerlink href=#stop-management title="Permanent link">&para;</a></h3> <p>Stop orders help to ensure a higher probability of achieving a predetermined entry or exit price, limiting the investor's loss, or locking in a profit. They remain dormant until a certain price is passed, at which time they are activated as a market or limit order. Execution of a stop order usually closes out the position. </p> <h4 id=types>Types<a class=headerlink href=#types title="Permanent link">&para;</a></h4> <p>There are four types of stop orders:</p> <ol> <li>Stop loss (<abbr title="Stop loss">SL</abbr>)</li> <li>Trailing stop loss (<abbr title="Trailing stop loss">TSL</abbr>)</li> <li>Trailing take profit (<abbr title="Trailing take profit">TTP</abbr>)</li> <li>Take profit (<abbr title="Take profit">TP</abbr>)</li> </ol> <p>By using a stop-loss order, we're limiting our risk in the trade to a set amount in the event that the market moves against us. For instance, if a stop-loss sell order were placed at $45 per unit, the order would be inactive until the price reached or dropped below $45. The order would then be transformed into a market or limit order, and the units would be sold at the best available price. A take profit is pretty much the exact opposite. It expresses how much we're willing to make as a profit with one trade and close it once we're happy with the amount. A combination of an <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> order creates a certain risk-to-reward ratio, which can be further tuned to respect the odds of reaching each certain breakout scenario. </p> <p>A different bread are trailing orders: when the price increases, it drags the trailing stop along with it. Then, when the price finally stops rising, the new stop-loss price remains at the level it was dragged to, thus automatically protecting our downside, while locking in profits as the price reaches new highs. Also, <abbr title="Trailing take profit">TTP</abbr> is a version of <abbr title="Trailing stop loss">TSL</abbr> that gets activated after a certain threshold. These two orders are usually viewed and represented as a single order.</p> <h4 id=creation_1>Creation<a class=headerlink href=#creation_1 title="Permanent link">&para;</a></h4> <p>In contrast to limit orders, stop orders are created after an entry order has been filled, and behave identically to user-defined exit signals that are triggered once a stop condition has been met. An entry order is any successfully-filled order that has opened a new position or increased an existing one. Once the simulator detects such an order, it first resolves the stop entry price provided via the argument <code>stop_entry_price</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.StopEntryPrice>StopEntryPrice</a>. This is the initial price to which all the stop values and thresholds are applied.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>By default, the stop entry price is the closing price, not the order price, to avoid a scenario where the stop is getting hit at the very first bar but cannot be executed since we don't have intra-bar data and cannot execute two orders at the same bar. By using the order price, the earliest time the stop can execute at is the opening of the next bar.</p> </div> <p>Based on this price, the simulator can also determine where exactly in the bar the stop order should be triggered. Why is this important? Because the simulator needs to know whether it can already use the current candle to update the price of any <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr> order. Internally, the information on stop orders is stored inside three arrays of the data types <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.sl_info_dt>sl_info_dt</a>, <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.tsl_info_dt>tsl_info_dt</a>, and <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.tp_info_dt>tp_info_dt</a>, laid out per asset. Each data type has a similar schema: the initial row and price, the current stop value (either in absolute or percentage terms), and the limit delta and its format if the stop order should ultimately trigger a limit order. The trailing stops also include the newly updated price and the row of the update.</p> <h4 id=activation_1>Activation<a class=headerlink href=#activation_1 title="Permanent link">&para;</a></h4> <p>Stop orders cannot be activated at the same bar as they were issued, even if the entry price is the opening price. This is because <abbr title="From-signals simulation method">FS</abbr> cannot handle two orders at the same bar (if there is a need for this, use a flexible order function with <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_order_func>Portfolio.from_order_func</a>). After hitting a new bar, the price of any pending <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> order then gets checked against the low and high price of the current candle respectively (the other way round for short positions), using the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.check_stop_hit_nb>check_stop_hit_nb</a>, which returns the stop price, whether it happened on open, and whether it happened at all. For example, let's imagine that the initial price is $10 per unit and the stop loss sits at 10%. For the stop to be marked as hit, the lowest price of this candle must be under <code>10 * (1 - 0.1) = 9</code> per unit:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_stop_hit_nb</span><span class=p>(</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=gp>... </span>    <span class=n>is_position_long</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=gp>... </span>    <span class=n>init_price</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=</span><span class=mf>0.1</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=go>(9.0, False, True)</span>
</span></code></pre></div> <p>But if the initial price was at $12 per unit, the stop would match already at open:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_stop_hit_nb</span><span class=p>(</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=gp>... </span>    <span class=n>is_position_long</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=gp>... </span>    <span class=n>init_price</span><span class=o>=</span><span class=mf>12.0</span><span class=p>,</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=</span><span class=mf>0.1</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=go>(10.0, True, True)</span>
</span></code></pre></div> <p>To check a <abbr title="Take profit">TP</abbr> order, we would need to set the argument <code>hit_below</code> to <code>False</code>.</p> <p>As opposed to fixed stop orders, <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr> orders additionally need to track the peak price the stop price is based upon. Since we have no information on whether the highest price of a candle comes before the lowest price or vice versa, we need to split the candle into distinct zones and update the peak price in a zone that precedes that of the stop check. First, the simulator uses the opening price to update the peak price. Then, it checks whether the stop has been hit during the entire bar. If not, it proceeds to update the peak price using the highest (for long positions) or lowest (for short positions) price of the candle, and performs the stop check again, but now using the closing price alone to avoid the ambiguity that's been mentioned before. This way, the simulator always pessimistically assumes that the worst event (where the stop is being hit) happens before the best event (where the peak price is being updated).</p> <p>To make the matter even more complex, a <abbr title="Trailing take profit">TTP</abbr> order additionally needs to check whether its threshold has been crossed to be properly activated. The check is performed using the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.check_tsl_th_hit_nb>check_tsl_th_hit_nb</a>: it takes the initial and the peak price, and checks whether the difference between them is greater than or equal to the threshold. If so, the order gets converted into a regular <abbr title="Trailing stop loss">TSL</abbr> order. But if the difference is smaller, the simulator proceeds to update the peak price using the current candle, and makes a second attempt to check for the threshold crossover. If the difference is finally greater, it uses <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.check_stop_hit_nb>check_stop_hit_nb</a>, but it cannot use the current candle anymore since it's unknown whether the stop has been hit after or before the threshold has been crossed, thus only the closing price is used by disabling the argument <code>can_use_ohlc</code>. Here's a depiction of what's happening:</p> <pre class=mermaid><code>flowchart TD;
    subgraph " "
    id0["Update peak price using open"]
    id1["Has a threshold?"]
    id2["Threshold crossed at/before open?"]
    id3["Stop hit at/after open?"]

    id0 --&gt; id1;
    id1 --&gt;|"yes - TTP"| id2;
    id1 --&gt;|"no - TSL"| id3;
    id2 --&gt;|"yes"| id3;
    end

    subgraph " "
    id4["Update peak price using high/low"]
    id5["Has a threshold?"]
    id6["Threshold crossed before close?"]
    id7["Stop hit before close?"]

    id2 --&gt;|"no"| id4;
    id3 --&gt;|"no"| id4;
    id4 --&gt; id5;
    id5 --&gt;|"yes - TTP"| id6;
    id5 --&gt;|"no - TSL"| id7;
    id6 --&gt;|"yes"| id7;
    end

    id3 --&gt;|"yes"| id9;
    id6 --&gt;|"no"| id8;
    id7 --&gt;|"yes"| id9;
    id7 --&gt;|"no"| id8;

    id8["Keep pending"]
    id9["Execute"]</code></pre> <p>What happens if multiple stops have been hit? The simulator pessimistically assumes that <abbr title="Stop loss">SL</abbr> comes first, <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr> come second, and <abbr title="Take profit">TP</abbr> comes last. The pending stop that comes before others gets executed while the remaining pending stops get canceled. </p> <h4 id=resolution>Resolution<a class=headerlink href=#resolution title="Permanent link">&para;</a></h4> <p>After that, the winner gets converted into the four signals using the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.generate_stop_signal_nb>generate_stop_signal_nb</a>, which is based on the current position and the default stop exit behavior defined using the argument <code>stop_exit_type</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.StopExitType>StopExitType</a>. For example, instead of closing out the position, we can make the function reverse the position by using <code>StopExitType.Reverse</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>generate_stop_signal_nb</span><span class=p>(</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=gp>... </span>    <span class=n>stop_exit_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopExitType</span><span class=o>.</span><span class=n>Reverse</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=go>(False, False, True, False, 0)</span>
</span></code></pre></div> <p>As we can see, the short entry signal is <code>True</code> while other signals are <code>False</code>. The number after the signals is the selected accumulation mode of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.AccumulationMode>AccumulationMode</a> for a case where we want to reduce the position instead of closing out or reversing it. What's left is the resolution of the stop exit price, done by the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.resolve_stop_exit_price_nb>resolve_stop_exit_price_nb</a>. The logic is quite simple: if the argument <code>stop_exit_price</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.StopExitPrice>StopExitPrice</a> is <code>StopExitPrice.Close</code>, use the closing price, otherwise use the stop price that has been hit. The argument can also be provided as an actual price.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_stop_exit_price_nb</span><span class=p>(</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=gp>... </span>    <span class=n>stop_price</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=gp>... </span>    <span class=n>stop_exit_price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopExitPrice</span><span class=o>.</span><span class=n>Stop</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=go>9.0</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_stop_exit_price_nb</span><span class=p>(</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=gp>... </span>    <span class=n>stop_price</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=gp>... </span>    <span class=n>stop_exit_price</span><span class=o>=</span><span class=mf>9.5</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=go>9.5</span>
</span></code></pre></div> <p>Finally, the order signal gets converted into a market or limit order specification the same way as a user-defined signal. See <a href=#signal-conversion>Signal conversion</a>.</p> <h4 id=updating>Updating<a class=headerlink href=#updating title="Permanent link">&para;</a></h4> <p>Apart from the possibility to update any stop in a callback, there is a possibility to update the stop automatically once the current position has increased. In such a case, the argument <code>upon_stop_update</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.StopUpdateMode>StopUpdateMode</a> controls whether any current stop should remain or be reset. This decision is done by the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.should_update_stop_nb>should_update_stop_nb</a>. For example, our position has increased, and we want to know whether the current stop should be updated given the option <code>StopUpdateMode.Override</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>should_update_stop_nb</span><span class=p>(</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>... </span>    <span class=n>new_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=gp>... </span>    <span class=n>upon_stop_update</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopUpdateMode</span><span class=o>.</span><span class=n>Override</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=go>True</span>
</span></code></pre></div> <p>But if the new stop value is NaN (i.e., no stop), we shouldn't update:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>should_update_stop_nb</span><span class=p>(</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=gp>... </span>    <span class=n>new_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=gp>... </span>    <span class=n>upon_stop_update</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopUpdateMode</span><span class=o>.</span><span class=n>Override</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=go>False</span>
</span></code></pre></div> <p>Unless the option is <code>StopUpdateMode.OverrideNaN</code>, which will effectively disable all stops:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>should_update_stop_nb</span><span class=p>(</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>... </span>    <span class=n>new_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=gp>... </span>    <span class=n>upon_stop_update</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopUpdateMode</span><span class=o>.</span><span class=n>OverrideNaN</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=go>True</span>
</span></code></pre></div> <p>This won't apply to the case where the current position has decreased. But why should we care about updates if signals usually either open or close positions, and don't increase or decrease them? When using accumulation, signals can add to the position or remove from the position. In this case, we should ask ourselves: should this position change invalidate the stops we defined previously, or define new ones? The argument <code>upon_stop_update</code> controls this behavior.</p> <h4 id=cancellation_1>Cancellation<a class=headerlink href=#cancellation_1 title="Permanent link">&para;</a></h4> <p>Similarly to updating, cancellation of the currently pending stop orders happens when the position has been closed out. This will clear all the stops automatically. But also similarly to limit orders, there is a possibility of a conflict with an active user-defined signal, which is resolved using the function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.resolve_pending_conflict_nb>resolve_pending_conflict_nb</a>. The arguments that are used to resolve any pending conflicts for stop orders are <code>upon_adj_stop_conflict</code> and <code>upon_opp_stop_conflict</code>, both of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PendingConflictMode>PendingConflictMode</a>. For example, if the user has decided to reduce the position and clear all the pending stops along with it, they can set the argument <code>upon_adj_stop_conflict</code> (reducing the position and attempting to close it are considered adjacent signals) to the option <code>PendingConflictMode.CancelExecute</code>.</p> <h2 id=signals>Signals<a class=headerlink href=#signals title="Permanent link">&para;</a></h2> <p>We've covered some theory on how this simulation method works. Let's take a break from reading and concern ourselves with signal arrays, which together with a signal function are the main input to this method. As we already know, signals come in two flavors:</p> <ol> <li>Direction-unaware signals: entries and exits enhanced by direction</li> <li>Direction-aware signals: Long entries, long exits, short entries, short exits</li> </ol> <p>The first flavor is a compressed form of the second flavor, so to say: we can always convert direction-unaware signals into direction-aware, but not the other way round since the first format defines a total of <code>2 * 2 * 3 = 12</code> combinations and the second format defines a total of <code>2 * 2 * 2 * 2 = 16</code> combinations. On the other hand, the first format is easier to use since we can set the direction globally and just operate with two arrays instead of four.</p> <p>But first, let's fetch the entire history of <code>BTCUSDT</code> and <code>ETHUSDT</code> for our examples below:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>([</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>])</span>
</span></code></pre></div> <p>As we won't need the entire history to illustrate most concepts, let's select the week of data between the 18th and 24th February 2021, where there is a substantial change in price in both directions:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>:</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>]</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=../../../assets/images/documentation/pf/from_signals_sub_data.light.svg#only-light> <img alt class=iimg loading=lazy src=../../../assets/images/documentation/pf/from_signals_sub_data.dark.svg#only-dark></p> <p>Let's try passing the data without signals:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>sub_data</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=go>symbol</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=go>BTCUSDT    0</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=go>ETHUSDT    0</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <ol> <li>Even though the first argument expects the closing price (<code>close</code>), we can pass the entire data instance, from which the OHLC features will be extracted automatically</li> </ol> <p>By default, all signals are set to <code>False</code>, thus no orders were generated. </p> <p>Now, let's assume that our ML model has correctly predicted the peak on the 21st February and ordered us to enter a position on the 18th February and close it on the 21st February. For this, we need to build our entry and exit arrays of the same shape as our data. But instead of specifying the same signals for each asset redundantly, we can provide a Series instead of a DataFrame, which will be applied to each asset thanks to <a href=../from-orders/index.html#broadcasting>broadcasting</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span>   <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>readable</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=go>   Order Id   Column              Signal Index            Creation Index  \</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=go>0         0  BTCUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=go>1         1  BTCUSDT 2021-02-21 00:00:00+00:00 2021-02-21 00:00:00+00:00   </span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=go>2         0  ETHUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=go>3         1  ETHUSDT 2021-02-21 00:00:00+00:00 2021-02-21 00:00:00+00:00   </span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=go>                 Fill Index      Size     Price  Fees  Side    Type Stop Type  </span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=go>0 2021-02-18 00:00:00+00:00  0.001940  51552.60   0.0   Buy  Market      None  </span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=go>1 2021-02-21 00:00:00+00:00  0.001940  57408.57   0.0  Sell  Market      None  </span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=go>2 2021-02-18 00:00:00+00:00  0.051557   1939.61   0.0   Buy  Market      None  </span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=go>3 2021-02-21 00:00:00+00:00  0.051557   1933.53   0.0  Sell  Market      None  </span>
</span></code></pre></div> <ol> <li>We could have also specified it as a two-dimensional NumPy array with one column</li> </ol> <p>We can see that the first order in the column <code>BTCUSDT</code> is a buy market order that opened a new long position. The second order is of the same size but the opposite side, thus it was used to close out the long position. Reading orders isn't always straight-forward, especially when it comes to determining when positions are opened and closed. To get a better overview, let's calculate and print the position for each symbol at each bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=go>Open time                                   </span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>The returned array represents the position at the end of each bar, hence we're still in the market on the 20th February but went out of the market on the 21st February.</p> <p>We provided the same array for each symbol, but what if our ML model told us that the peak for <code>ETHUSDT</code> is one day ahead of that for <code>BTCUSDT</code>? As soon as our signal specification starts varying with columns, we need to build the respective signal array as a DataFrame with values defined per element. Let's keep the entry array the same for both symbols (entry signals do not vary with columns in our case) and only expand the exit array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=mi>0</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>],</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=mi>1</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>],</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span><span class=p>})</span>  <span class=c1># (1)!</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=go>Open time                                   </span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <ol> <li>We could have also used symbols as column names. Defining rows and columns as a simple range of values (from <code>0</code> to <code>n</code>) will ignore the labels and broadcast only using shapes.</li> </ol> <p>We can now observe that the long position in the column <code>ETHUSDT</code> was cleared one day before that of <code>BTCUSDT</code>, as our imaginary model wished. To make array creation a bit easier and to avoid setting each element manually, we can use the symbol wrapper of the data instance to create empty boolean arrays of the same shape as the data, and fill them on specific dates:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-20&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=go>Open time                                  </span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=go>2021-02-19 00:00:00+00:00    False    False</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=go>2021-02-20 00:00:00+00:00    False     True</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>2021-02-21 00:00:00+00:00     True    False</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=go>2021-02-22 00:00:00+00:00    False    False</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <ol> <li>Create an array with the same number of columns as we have symbols, and fill it with <code>False</code></li> </ol> <p>For readers who appreciate hot features, here's how to let the vectorbt's broadcaster create both arrays and fill them dynamically using <a href=../../../api/base/wrapping/index.html#vectorbtpro.base.wrapping.ArrayWrapper.fill_and_set>index dictionaries</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>idx</span><span class=p>(</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>idx</span><span class=p>(</span><span class=s2>&quot;2021-02-20&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>):</span> <span class=kc>True</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=gp>... </span>    <span class=p>})</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=go>Open time                                   </span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>The best in the approach above is that the broadcaster won't create arrays bigger than necessary: it will notice that the entry specification is the same for both symbols and create an array with one column instead of two, saving us some memory.</p> <h3 id=direction-unaware>Direction-unaware<a class=headerlink href=#direction-unaware title="Permanent link">&para;</a></h3> <p>In all the examples above, we provided only two arrays: <code>entries</code> and <code>exits</code>. Whenever this happens, the method treats the provided signals as direction-unaware, meaning that an additional argument <code>direction</code> is used to control their direction. By default, the direction is <code>Direction.LongOnly</code> (see <code>signal_direction</code> in <a href=../../../api/_settings/index.html#vectorbtpro._settings.portfolio>portfolio settings</a>). To change the direction, override <code>direction</code> with any option available in <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.Direction>Direction</a>. An option can be provided either as an integer or a field name. For example, let's allow <em>both</em> directions to reverse the position on exit instead of just closing it out:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;both&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=go>Open time                                   </span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=go>2021-02-20 00:00:00+00:00  0.00194 -0.051557</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=go>2021-02-21 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=go>2021-02-22 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=go>2021-02-23 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=go>2021-02-24 00:00:00+00:00 -0.00194 -0.051557</span>
</span></code></pre></div> <ol> <li>Can also be provided in the numeric format as <code>Direction.Both</code></li> </ol> <p>Zero values have changed to negative values, which means that positions are now being reversed. Similarly to the arguments for signals, the argument for direction can also be provided as an array. This makes possible defining different directions for different dates and symbols. For example, let's long <code>BTCUSDT</code> and short <code>ETHUSDT</code>. Thanks to broadcasting, to provide any information per column, we can represent it as a two-dimensional array with just one row:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>direction</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([[</span><span class=s2>&quot;longonly&quot;</span><span class=p>,</span> <span class=s2>&quot;shortonly&quot;</span><span class=p>]])</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>direction</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=go>Open time                                   </span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=go>2021-02-18 00:00:00+00:00  0.00194 -0.051557</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=go>2021-02-19 00:00:00+00:00  0.00194 -0.051557</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>The position values under the column <code>ETHUSDT</code> have turned negative indicating that we're in a short position. The following example illustrates the usage of direction defined per element by entering a long position at the first bar, exiting it at the peak, then entering a short one at the next bar, and finally exiting it at the last bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>L</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span>  <span class=c1># (1)!</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>S</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>ShortOnly</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>    <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>])</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=go>Open time</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <ol> <li>Shortcuts for better readability, numeric format</li> <li>Select one symbol of data</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The numeric format should be preferred over the string format for bigger arrays since strings must be converted to integers prior to the simulation, which is a relatively slow operation.</p> </div> <h3 id=direction-aware>Direction-aware<a class=headerlink href=#direction-aware title="Permanent link">&para;</a></h3> <p>Direction-aware signals are a more flexible form of signals as they allow for more signal combinations. To switch to this mode, we need to provide the arguments <code>short_entries</code> and <code>short_exits</code> acting as short signals along with the arguments <code>entries</code> and <code>exits</code> acting as long signals. This will disable the <code>direction</code> argument completely as the direction is now expressed by the signals themselves. Let's adapt the example above:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=go>Open time</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>So, when do we use which signal mode? Use direction-unaware signals when working with a single direction throughout the entire column, and direction-aware signals for more granular decisions, especially when positions need to be closed when both directions are allowed, for example, to close out any position at the end of a day.</p> <h3 id=signal-function_1>Signal function<a class=headerlink href=#signal-function_1 title="Permanent link">&para;</a></h3> <p>Passing signals as pre-defined arrays has one major advantage: caching. Even after we restart the runtime, there won't any recompilation when we pass signal arrays of the same format again. But sometimes there is a need to trade in a bit of performance for more flexibility. Such use cases include path-dependency scenarios where signals depend on the previous or current simulation state such that they cannot be generated in advance. Another use case is to reduce RAM usage: the entire indicator and signal generation logic can be encapsulated into a single signal function such that there is no need for intermediate arrays anymore. This is useful when a huge number of parameters needs to be tested, or when the user wants to choose a number of assets to trade out of a big universe of assets, which usually involves keeping very wide arrays in RAM but using a signal function would make them redundant.</p> <p>Let's implement the latest example above but without any arrays!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=gp>... </span>    <span class=n>ts</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>18</span><span class=p>):</span>  <span class=c1># (2)!</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (3)!</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>21</span><span class=p>):</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>22</span><span class=p>):</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>24</span><span class=p>):</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=go>Open time</span>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-33-21><a id=__codelineno-33-21 name=__codelineno-33-21 href=#__codelineno-33-21></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-33-22><a id=__codelineno-33-22 name=__codelineno-33-22 href=#__codelineno-33-22></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-33-23><a id=__codelineno-33-23 name=__codelineno-33-23 href=#__codelineno-33-23></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-33-24><a id=__codelineno-33-24 name=__codelineno-33-24 href=#__codelineno-33-24></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-33-25><a id=__codelineno-33-25 name=__codelineno-33-25 href=#__codelineno-33-25></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-33-26><a id=__codelineno-33-26 name=__codelineno-33-26 href=#__codelineno-33-26></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-33-27><a id=__codelineno-33-27 name=__codelineno-33-27 href=#__codelineno-33-27></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <ol> <li><code>c.index</code> returns an array with timestamps in the nanosecond format while <code>c.i</code> returns the current row. By applying the latter on the former, we can get the current timestamp.</li> <li>Use <a href=../../../api/utils/datetime_nb/index.html#vectorbtpro.utils.datetime_nb.matches_date_nb>matches_date_nb</a> to check whether the current day matches a date</li> <li>Signal functions must return a set of direction-aware signals</li> </ol> <p>We've switched a vectorized logic in favor of an iterative logic, which is usually more verbose but also much more flexible and similar to the format used in most open-source backtesting frameworks. But that doesn't mean that we have to define everything iteratively, we can still pass one or more arrays and make decisions based on them. All we have to do is to make the signal function accept arrays as positional arguments and select one element out of them at each time step to generate the four signals, and then pass the actual arrays to <abbr title="From-signals simulation method">FS</abbr> as a tuple using <code>signal_args</code>. Just note that any array-like object must be a NumPy array since Numba doesn't understand Pandas.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>short_entries</span><span class=p>,</span> <span class=n>short_exits</span><span class=p>):</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=gp>... </span>    <span class=n>long_entry</span> <span class=o>=</span> <span class=n>entries</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=gp>... </span>    <span class=n>long_exit</span> <span class=o>=</span> <span class=n>exits</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=gp>... </span>    <span class=n>short_entry</span> <span class=o>=</span> <span class=n>short_entries</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=gp>... </span>    <span class=n>short_exit</span> <span class=o>=</span> <span class=n>short_exits</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_entry</span><span class=p>,</span> <span class=n>long_exit</span><span class=p>,</span> <span class=n>short_entry</span><span class=p>,</span> <span class=n>short_exit</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>])</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=go>Open time</span>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-34-27><a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-34-28><a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>But what if we wanted to expand our data to multiple assets? The example above would only work if each of the arrays is kept as one-dimensional since we only select rows in the signal function. To make our logic shape-agnostic though, we need to make each of the arrays two-dimensional and additionally select the current column in the signal function. But that's not enough: we also need to take care of broadcasting, which can be flexibly done in the signal function either manually with <a href=../../../api/base/flex_indexing/index.html#vectorbtpro.base.flex_indexing.flex_select_nb>flex_select_nb</a> or automatically with <a href=../../../api/portfolio/nb/iter_/index.html#vectorbtpro.portfolio.nb.iter_.select_nb>select_nb</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>short_entries</span><span class=p>,</span> <span class=n>short_exits</span><span class=p>):</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=gp>... </span>    <span class=n>long_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>)</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=gp>... </span>    <span class=n>long_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=gp>... </span>    <span class=n>short_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_entries</span><span class=p>)</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=gp>... </span>    <span class=n>short_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_exits</span><span class=p>)</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_entry</span><span class=p>,</span> <span class=n>long_exit</span><span class=p>,</span> <span class=n>short_entry</span><span class=p>,</span> <span class=n>short_exit</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])),</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])),</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])),</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]))</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a><span class=go>Open time                                    </span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a><span class=go>2021-02-19 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-35-24><a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a><span class=go>2021-02-20 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-35-25><a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-35-26><a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a><span class=go>2021-02-22 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-35-27><a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a><span class=go>2021-02-23 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-35-28><a id=__codelineno-35-28 name=__codelineno-35-28 href=#__codelineno-35-28></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>Our strategy can now be applied on an arbitrary number of columns, great! But even this isn't the most flexible design <img alt=😮‍💨 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f62e-200d-1f4a8.svg title=:face_exhaling:> What if the user provides a signal array that doesn't have the same number of rows as the data? If bound checking is enabled, we would get the "index is out of bounds" error since the signal function would attempt to select an element that simply doesn't exist. To make any array broadcast against the data prior to the simulation, we can define it in the dictionary <code>broadcast_named_args</code>, and then use a template to substitute its name by the broadcasted array in <code>signal_args</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-22&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_exits</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>),</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_entries&quot;</span><span class=p>),</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_exits&quot;</span><span class=p>)</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=gp>... </span>        <span class=n>short_entries</span><span class=o>=</span><span class=n>short_entries</span><span class=p>,</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=gp>... </span>        <span class=n>short_exits</span><span class=o>=</span><span class=n>short_exits</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=go>2021-02-19 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a><span class=go>2021-02-20 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a><span class=go>2021-02-22 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-36-29><a id=__codelineno-36-29 name=__codelineno-36-29 href=#__codelineno-36-29></a><span class=go>2021-02-23 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-36-30><a id=__codelineno-36-30 name=__codelineno-36-30 href=#__codelineno-36-30></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <ol> <li><code>entries</code> is recognized as a key in <code>broadcast_named_args</code></li> </ol> <p>Our setup now behaves the same way as the built-in arguments <code>entries</code>, <code>exits</code>, <code>short_entries</code>, and <code>short_exits</code> <img alt=🪄 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1fa84.svg title=:magic_wand:> We don't even have to convert them to NumPy arrays anymore since this is being taken care of automatically by the broadcaster. It allows us also to use index dictionaries and other hot broadcasting features:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>),</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_entries&quot;</span><span class=p>),</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_exits&quot;</span><span class=p>)</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span>      <span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}),</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span>        <span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}),</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=gp>... </span>        <span class=n>short_entries</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-22&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}),</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=gp>... </span>        <span class=n>short_exits</span><span class=o>=</span>  <span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>})</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>But we're rarely interested in backtesting signals on some fixed dates. Let's create a signal function that yields a long entry signal when there is an above-crossover and a short entry signal when there is a below-crossover of two moving average arrays. In addition, we'll parametrize this strategy by introducing a flexible parameter <code>wait</code> that controls the number of bars after which a signal should be placed after a crossover has been detected; if an opposite crossover happens during that time, the signal gets canceled, thus <code>wait</code> also acts as a confirmation period. The parameter will broadcast together with data to be able to define it per row, column, and element.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>wait</span><span class=p>):</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=gp>... </span>    <span class=n>curr_wait</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>wait</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=gp>... </span>    <span class=n>i_wait</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>curr_wait</span>  <span class=c1># (2)!</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>i_wait</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=gp>...</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_above_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>i_wait</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=gp>... </span>        <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i_wait</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>  <span class=c1># (5)!</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_above_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=gp>... </span>                <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=gp>... </span>                <span class=k>break</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>cross_confirmed</span><span class=p>:</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=gp>... </span>            <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=gp>...</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_below_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>i_wait</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>  <span class=c1># (6)!</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=gp>... </span>        <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i_wait</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_below_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=gp>... </span>                <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=gp>... </span>                <span class=k>break</span>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>cross_confirmed</span><span class=p>:</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=gp>... </span>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a><span class=gp>...</span>
</span><span id=__span-38-26><a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-38-27><a id=__codelineno-38-27 name=__codelineno-38-27 href=#__codelineno-38-27></a>
</span><span id=__span-38-28><a id=__codelineno-38-28 name=__codelineno-38-28 href=#__codelineno-38-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fast_sma</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;sma&quot;</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=n>short_name</span><span class=o>=</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>real</span>
</span><span id=__span-38-29><a id=__codelineno-38-29 name=__codelineno-38-29 href=#__codelineno-38-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>slow_sma</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;sma&quot;</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=n>short_name</span><span class=o>=</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>real</span>
</span><span id=__span-38-30><a id=__codelineno-38-30 name=__codelineno-38-30 href=#__codelineno-38-30></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-38-31><a id=__codelineno-38-31 name=__codelineno-38-31 href=#__codelineno-38-31></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-38-32><a id=__codelineno-38-32 name=__codelineno-38-32 href=#__codelineno-38-32></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-38-33><a id=__codelineno-38-33 name=__codelineno-38-33 href=#__codelineno-38-33></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-38-34><a id=__codelineno-38-34 name=__codelineno-38-34 href=#__codelineno-38-34></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>),</span>
</span><span id=__span-38-35><a id=__codelineno-38-35 name=__codelineno-38-35 href=#__codelineno-38-35></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>),</span>
</span><span id=__span-38-36><a id=__codelineno-38-36 name=__codelineno-38-36 href=#__codelineno-38-36></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wait&quot;</span><span class=p>)</span>
</span><span id=__span-38-37><a id=__codelineno-38-37 name=__codelineno-38-37 href=#__codelineno-38-37></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-38-38><a id=__codelineno-38-38 name=__codelineno-38-38 href=#__codelineno-38-38></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-38-39><a id=__codelineno-38-39 name=__codelineno-38-39 href=#__codelineno-38-39></a><span class=gp>... </span>        <span class=n>fast_sma</span><span class=o>=</span><span class=n>fast_sma</span><span class=p>,</span>
</span><span id=__span-38-40><a id=__codelineno-38-40 name=__codelineno-38-40 href=#__codelineno-38-40></a><span class=gp>... </span>        <span class=n>slow_sma</span><span class=o>=</span><span class=n>slow_sma</span><span class=p>,</span>
</span><span id=__span-38-41><a id=__codelineno-38-41 name=__codelineno-38-41 href=#__codelineno-38-41></a><span class=gp>... </span>        <span class=n>wait</span><span class=o>=</span><span class=mi>0</span>  <span class=c1># (7)!</span>
</span><span id=__span-38-42><a id=__codelineno-38-42 name=__codelineno-38-42 href=#__codelineno-38-42></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-38-43><a id=__codelineno-38-43 name=__codelineno-38-43 href=#__codelineno-38-43></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-38-44><a id=__codelineno-38-44 name=__codelineno-38-44 href=#__codelineno-38-44></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-38-45><a id=__codelineno-38-45 name=__codelineno-38-45 href=#__codelineno-38-45></a><span class=go>fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-38-46><a id=__codelineno-38-46 name=__codelineno-38-46 href=#__codelineno-38-46></a><span class=go>20                   50                   BTCUSDT    40</span>
</span><span id=__span-38-47><a id=__codelineno-38-47 name=__codelineno-38-47 href=#__codelineno-38-47></a><span class=go>                                          ETHUSDT    32</span>
</span><span id=__span-38-48><a id=__codelineno-38-48 name=__codelineno-38-48 href=#__codelineno-38-48></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <ol> <li>Since the confirmation period is an array-like parameter, get the value defined for the current row and column</li> <li>Get the row where the crossover should have taken place</li> <li>If the current period is smaller than the confirmation period, return no signal</li> <li>Check whether the faster SMA has crossed the slower SMA at the current bar</li> <li>If true, loop over the confirmation period (including the current bar) and check whether the faster SMA has always stayed above the slower SMA for confirmation</li> <li>The same for the below-crossover</li> <li>Waiting period is a flexible parameter, that is, it must broadcast together with other arrays</li> </ol> <p>To confirm that our strategy has generated a correct number of orders, let's get the total number of crossover signals manually:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_crossed_above</span> <span class=o>=</span> <span class=n>fast_sma</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_above</span><span class=p>(</span><span class=n>slow_sma</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_crossed_below</span> <span class=o>=</span> <span class=n>fast_sma</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>slow_sma</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_crossed_above</span> <span class=o>+</span> <span class=n>n_crossed_below</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=go>fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=go>20                   50                   BTCUSDT    40</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=go>                                          ETHUSDT    32</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <p>To demonstrate the full power of the vectorbt's broadcaster, let's test the confirmation period of 0, 1, 7, and 30 bars by wrapping the parameter with <a href=../../../api/utils/params/index.html#vectorbtpro.utils.params.Param>Param</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>),</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>),</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wait&quot;</span><span class=p>)</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=gp>... </span>        <span class=n>fast_sma</span><span class=o>=</span><span class=n>fast_sma</span><span class=p>,</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=gp>... </span>        <span class=n>slow_sma</span><span class=o>=</span><span class=n>slow_sma</span><span class=p>,</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=gp>... </span>        <span class=n>wait</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>30</span><span class=p>])</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=go>wait  fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=go>0     20                   50                   BTCUSDT    40</span>
</span><span id=__span-40-18><a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-40-19><a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a><span class=go>1     20                   50                   BTCUSDT    38</span>
</span><span id=__span-40-20><a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-40-21><a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a><span class=go>7     20                   50                   BTCUSDT    36</span>
</span><span id=__span-40-22><a id=__codelineno-40-22 name=__codelineno-40-22 href=#__codelineno-40-22></a><span class=go>                                                ETHUSDT    30</span>
</span><span id=__span-40-23><a id=__codelineno-40-23 name=__codelineno-40-23 href=#__codelineno-40-23></a><span class=go>30    20                   50                   BTCUSDT    14</span>
</span><span id=__span-40-24><a id=__codelineno-40-24 name=__codelineno-40-24 href=#__codelineno-40-24></a><span class=go>                                                ETHUSDT    16</span>
</span><span id=__span-40-25><a id=__codelineno-40-25 name=__codelineno-40-25 href=#__codelineno-40-25></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <p>We can observe how the number of orders gradually decreases with a longer confirmation period. If you love vectorbt for its performance, you might argue that even though the number of crossovers is low, having the second loop is not exactly optimal performance-wise: we can rewrite the logic to iterate over the data just once. For this, we need to introduce a temporary array that stores the index of the latest crossover that has been confirmed so far, and once the confirmation period is fully over, we can issue a signal. This use case is a perfect example on how to temporarily store and then share data between multiple signal function calls!</p> <p>The temporary array that we will create will be a one-dimensional NumPy array where the latest crossover index is stored per column. We could have also used a regular typed list but remember that NumPy arrays enjoy superiority in Numba. Why per column and not just an array with one value? This would work for ungrouped portfolios where columns are processed strictly one after another, but in a case where the portfolio is grouped, columns are processed in a zigzag manner inside their groups, thus we should always structure our temporary data per column to be on a safe side. Another challenge is the creation of such an array: how do we know the number of columns in advance? Thankfully, we can use a template!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>wait</span><span class=p>,</span> <span class=n>temp_coi</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=gp>... </span>        <span class=n>crossed_above</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_above_nb</span><span class=p>(</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=gp>... </span>            <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=gp>... </span>        <span class=n>crossed_below</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_below_nb</span><span class=p>(</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=gp>... </span>            <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-41-10><a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>crossed_above</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-41-11><a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_above_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-41-12><a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-41-13><a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>crossed_below</span><span class=p>:</span>
</span><span id=__span-41-14><a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_below_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>
</span><span id=__span-41-15><a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-41-16><a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a><span class=gp>...</span>
</span><span id=__span-41-17><a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a><span class=gp>... </span>    <span class=n>curr_wait</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>wait</span><span class=p>)</span>
</span><span id=__span-41-18><a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>  <span class=c1># (5)!</span>
</span><span id=__span-41-19><a id=__codelineno-41-19 name=__codelineno-41-19 href=#__codelineno-41-19></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=n>curr_wait</span><span class=p>:</span>
</span><span id=__span-41-20><a id=__codelineno-41-20 name=__codelineno-41-20 href=#__codelineno-41-20></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>crossed_above</span><span class=p>:</span>
</span><span id=__span-41-21><a id=__codelineno-41-21 name=__codelineno-41-21 href=#__codelineno-41-21></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-41-22><a id=__codelineno-41-22 name=__codelineno-41-22 href=#__codelineno-41-22></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-41-23><a id=__codelineno-41-23 name=__codelineno-41-23 href=#__codelineno-41-23></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>crossed_below</span><span class=p>:</span>
</span><span id=__span-41-24><a id=__codelineno-41-24 name=__codelineno-41-24 href=#__codelineno-41-24></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-41-25><a id=__codelineno-41-25 name=__codelineno-41-25 href=#__codelineno-41-25></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-41-26><a id=__codelineno-41-26 name=__codelineno-41-26 href=#__codelineno-41-26></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>  <span class=c1># (6)!</span>
</span><span id=__span-41-27><a id=__codelineno-41-27 name=__codelineno-41-27 href=#__codelineno-41-27></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_crossed_above_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>
</span><span id=__span-41-28><a id=__codelineno-41-28 name=__codelineno-41-28 href=#__codelineno-41-28></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>curr_wait</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-41-29><a id=__codelineno-41-29 name=__codelineno-41-29 href=#__codelineno-41-29></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-41-30><a id=__codelineno-41-30 name=__codelineno-41-30 href=#__codelineno-41-30></a><span class=gp>... </span>            <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-41-31><a id=__codelineno-41-31 name=__codelineno-41-31 href=#__codelineno-41-31></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_crossed_below_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>
</span><span id=__span-41-32><a id=__codelineno-41-32 name=__codelineno-41-32 href=#__codelineno-41-32></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>curr_wait</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-41-33><a id=__codelineno-41-33 name=__codelineno-41-33 href=#__codelineno-41-33></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-41-34><a id=__codelineno-41-34 name=__codelineno-41-34 href=#__codelineno-41-34></a><span class=gp>... </span>            <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-41-35><a id=__codelineno-41-35 name=__codelineno-41-35 href=#__codelineno-41-35></a><span class=gp>...</span>
</span><span id=__span-41-36><a id=__codelineno-41-36 name=__codelineno-41-36 href=#__codelineno-41-36></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-41-37><a id=__codelineno-41-37 name=__codelineno-41-37 href=#__codelineno-41-37></a>
</span><span id=__span-41-38><a id=__codelineno-41-38 name=__codelineno-41-38 href=#__codelineno-41-38></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-41-39><a id=__codelineno-41-39 name=__codelineno-41-39 href=#__codelineno-41-39></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-41-40><a id=__codelineno-41-40 name=__codelineno-41-40 href=#__codelineno-41-40></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-41-41><a id=__codelineno-41-41 name=__codelineno-41-41 href=#__codelineno-41-41></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-41-42><a id=__codelineno-41-42 name=__codelineno-41-42 href=#__codelineno-41-42></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>),</span>
</span><span id=__span-41-43><a id=__codelineno-41-43 name=__codelineno-41-43 href=#__codelineno-41-43></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>),</span>
</span><span id=__span-41-44><a id=__codelineno-41-44 name=__codelineno-41-44 href=#__codelineno-41-44></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wait&quot;</span><span class=p>),</span>
</span><span id=__span-41-45><a id=__codelineno-41-45 name=__codelineno-41-45 href=#__codelineno-41-45></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d[1], -1)&quot;</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-41-46><a id=__codelineno-41-46 name=__codelineno-41-46 href=#__codelineno-41-46></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-41-47><a id=__codelineno-41-47 name=__codelineno-41-47 href=#__codelineno-41-47></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-41-48><a id=__codelineno-41-48 name=__codelineno-41-48 href=#__codelineno-41-48></a><span class=gp>... </span>        <span class=n>fast_sma</span><span class=o>=</span><span class=n>fast_sma</span><span class=p>,</span>
</span><span id=__span-41-49><a id=__codelineno-41-49 name=__codelineno-41-49 href=#__codelineno-41-49></a><span class=gp>... </span>        <span class=n>slow_sma</span><span class=o>=</span><span class=n>slow_sma</span><span class=p>,</span>
</span><span id=__span-41-50><a id=__codelineno-41-50 name=__codelineno-41-50 href=#__codelineno-41-50></a><span class=gp>... </span>        <span class=n>wait</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>30</span><span class=p>])</span>
</span><span id=__span-41-51><a id=__codelineno-41-51 name=__codelineno-41-51 href=#__codelineno-41-51></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-41-52><a id=__codelineno-41-52 name=__codelineno-41-52 href=#__codelineno-41-52></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-41-53><a id=__codelineno-41-53 name=__codelineno-41-53 href=#__codelineno-41-53></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-41-54><a id=__codelineno-41-54 name=__codelineno-41-54 href=#__codelineno-41-54></a><span class=go>wait  fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-41-55><a id=__codelineno-41-55 name=__codelineno-41-55 href=#__codelineno-41-55></a><span class=go>0     20                   50                   BTCUSDT    40</span>
</span><span id=__span-41-56><a id=__codelineno-41-56 name=__codelineno-41-56 href=#__codelineno-41-56></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-41-57><a id=__codelineno-41-57 name=__codelineno-41-57 href=#__codelineno-41-57></a><span class=go>1     20                   50                   BTCUSDT    38</span>
</span><span id=__span-41-58><a id=__codelineno-41-58 name=__codelineno-41-58 href=#__codelineno-41-58></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-41-59><a id=__codelineno-41-59 name=__codelineno-41-59 href=#__codelineno-41-59></a><span class=go>7     20                   50                   BTCUSDT    36</span>
</span><span id=__span-41-60><a id=__codelineno-41-60 name=__codelineno-41-60 href=#__codelineno-41-60></a><span class=go>                                                ETHUSDT    30</span>
</span><span id=__span-41-61><a id=__codelineno-41-61 name=__codelineno-41-61 href=#__codelineno-41-61></a><span class=go>30    20                   50                   BTCUSDT    14</span>
</span><span id=__span-41-62><a id=__codelineno-41-62 name=__codelineno-41-62 href=#__codelineno-41-62></a><span class=go>                                                ETHUSDT    16</span>
</span><span id=__span-41-63><a id=__codelineno-41-63 name=__codelineno-41-63 href=#__codelineno-41-63></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <ol> <li>The temporary array is taken as a regular argument</li> <li>Check whether there is a crossover index stored under this column</li> <li>If true, check the type of the crossover and whether it can still be confirmed. If it cannot be confirmed at this bar, remove the index.</li> <li>Use generic iterative functions (starting with <code>vbt.nb.iter_</code>, see <a href=../../../api/generic/nb/iter_/index.html >generic.iter_</a>) when an operation must be performed on a custom row/column, and portfolio iterative functions (starting with <code>vbt.pf_nb.iter_</code>, see <a href=../../../api/portfolio/nb/iter_/index.html >portfolio.iter_</a>) to perform an operation on the current row/column taken from the context</li> <li>If there is still an index in the temporary array, the crossover has been confirmed so far, thus check if the confirmation period is over, and if true, return the signal</li> <li>If there is no crossover index, check whether there is a crossover at this bar, and if true, store it inside the temporary array and move on. If the confirmation period is zero, return the signal right away.</li> <li>Create the temporary array <code>temp_coi</code>. Use an evaluation template to run a code as an expression after all the arrays have been broadcasted and the final shape has been established. Use <code>wrapper</code> to access the shape information.</li> </ol> <p>The code above isn't even complex: it would take the same amount of code to define this logic in a conventional backtesting software. The only difference is that vectorbt relies on functional programming whereas other frameworks rely on object-oriented programming where functions such as <code>crossed_above_nb</code> are methods of the current backtesting instance (<code>self.crossed_above()</code>) and variables such as <code>temp_coi</code> are attributes of that instance (<code>self.temp_coi</code>).</p> <h3 id=conflicts>Conflicts<a class=headerlink href=#conflicts title="Permanent link">&para;</a></h3> <p>When signals are generated in an automated way, it often happens that multiple signals of the same type come one after another, or multiple signals of different types appear at the same bar. The first case is effectively solved by the <abbr title="From-signals simulation method">FS</abbr> method by taking into consideration only the first signal while ignoring others (unless <a href=#accumulation>accumulation</a> is turned on), as demonstrated in the following example where we're repeatedly issuing a long entry signal:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>sub_data</span><span class=p>,</span> <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=go>Open time                                   </span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=go>2021-02-20 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <ol> <li>When signals are provided as a single value, the value gets broadcast against the entire data shape such that it appears under each single row and column</li> </ol> <p>But what if we start issuing a long exit signal at the same time?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>sub_data</span><span class=p>,</span> <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exits</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=go>Open time                                  </span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=go>2021-02-18 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=go>2021-02-19 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=go>2021-02-20 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=go>2021-02-21 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=go>2021-02-22 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=go>2021-02-23 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=go>2021-02-24 00:00:00+00:00      0.0      0.0</span>
</span></code></pre></div> <p>We can see that the simulator simply ignored conflicting signals. But sometimes, we may want to prefer one signal type over another. In the example above, we have a so-called "long signal conflict", the resolution of which is controlled by the argument <code>upon_long_conflict</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.ConflictMode>ConflictMode</a>. For example, if long entries are more important than long exits:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span> 
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=gp>... </span>    <span class=n>upon_long_conflict</span><span class=o>=</span><span class=s2>&quot;entry&quot;</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=go>Open time                                   </span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=go>2021-02-20 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-14><a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-15><a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-16><a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>What about use cases where we allow both directions for an exit signal to become a short entry signal? If so, we would have a so-called "signal direction conflict", the resolution of which is controlled by the argument <code>upon_dir_conflict</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.DirectionConflictMode>DirectionConflictMode</a>. Let's prefer short signals over long signals, in any direction:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span> 
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;both&quot;</span><span class=p>,</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=gp>... </span>    <span class=n>upon_dir_conflict</span><span class=o>=</span><span class=s2>&quot;short&quot;</span>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a><span class=go>Open time                                   </span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a><span class=go>2021-02-18 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a><span class=go>2021-02-20 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-45-14><a id=__codelineno-45-14 name=__codelineno-45-14 href=#__codelineno-45-14></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-45-15><a id=__codelineno-45-15 name=__codelineno-45-15 href=#__codelineno-45-15></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-45-16><a id=__codelineno-45-16 name=__codelineno-45-16 href=#__codelineno-45-16></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-45-17><a id=__codelineno-45-17 name=__codelineno-45-17 href=#__codelineno-45-17></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>We can see that both orders have become sell orders. Let's combine both use cases and apply our knowledge to the scenario where all four signals are set! We will open a long position at the first bar, while at other bars only the one signal that's opposite to the current position will win and reverse the position:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span> 
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=gp>... </span>    <span class=n>upon_long_conflict</span><span class=o>=</span><span class=s2>&quot;entry&quot;</span><span class=p>,</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=gp>... </span>    <span class=n>upon_short_conflict</span><span class=o>=</span><span class=s2>&quot;entry&quot;</span><span class=p>,</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=gp>... </span>    <span class=n>upon_dir_conflict</span><span class=o>=</span><span class=s2>&quot;opposite&quot;</span><span class=p>,</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=gp>... </span>    <span class=n>upon_opposite_entry</span><span class=o>=</span><span class=s2>&quot;reverse&quot;</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-46-13><a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-46-14><a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a><span class=go>Open time                                    </span>
</span><span id=__span-46-15><a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-46-16><a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a><span class=go>2021-02-19 00:00:00+00:00 -0.003880 -0.103114</span>
</span><span id=__span-46-17><a id=__codelineno-46-17 name=__codelineno-46-17 href=#__codelineno-46-17></a><span class=go>2021-02-20 00:00:00+00:00  0.003884  0.105377</span>
</span><span id=__span-46-18><a id=__codelineno-46-18 name=__codelineno-46-18 href=#__codelineno-46-18></a><span class=go>2021-02-21 00:00:00+00:00 -0.003889 -0.107641</span>
</span><span id=__span-46-19><a id=__codelineno-46-19 name=__codelineno-46-19 href=#__codelineno-46-19></a><span class=go>2021-02-22 00:00:00+00:00  0.004127  0.117085</span>
</span><span id=__span-46-20><a id=__codelineno-46-20 name=__codelineno-46-20 href=#__codelineno-46-20></a><span class=go>2021-02-23 00:00:00+00:00 -0.004366 -0.126528</span>
</span><span id=__span-46-21><a id=__codelineno-46-21 name=__codelineno-46-21 href=#__codelineno-46-21></a><span class=go>2021-02-24 00:00:00+00:00  0.004297  0.122982</span>
</span></code></pre></div> <p>Great, we forced vectorbt to reverse the position at each bar <img alt=🥶 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f976.svg title=:cold_face:></p> <h2 id=orders>Orders<a class=headerlink href=#orders title="Permanent link">&para;</a></h2> <p>As we've learned, signals are just another level of abstraction over orders; they control the timing and direction of orders. But how do we specify the parameters of a typical order a signal should be converted into? Identically to <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a>, the class method <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> takes a variety of order-related arguments; in fact, it takes all the arguments that can be found as a field in the class <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.Order>Order</a>. If any argument remains <code>None</code>, the method takes the default value defined in the <a href=../../../api/_settings/index.html#vectorbtpro._settings.portfolio>portfolio settings</a>. For example, the default size is <code>np.inf</code>, meaning that each signal instructs the simulator to use up the entire capital. Also, each order-related argument is array-like and broadcasts together with signals. This way, by setting an argument to a single value, we can enable that value for each signal. Let's make each entry signal order $1 worth of each asset by tweaking the size and size type arguments:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=go>Open time                                    </span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=go>2021-02-18 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=go>2021-02-19 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=go>2021-02-20 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>As we can see, the simulator ordered <code>1 / 51552.60 = 0.000019</code> units of <code>BTCUSDT</code> and then closed out the position. To have a more granular control over any order information, we can specify the information as an array. For example, let's enter a position with 50% of the available cash, close the position, then open a new position of the opposite direction with 25% of the available cash, and close the position again:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span>         <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]),</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;valuepercent&quot;</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_value</span> <span class=o>/</span> <span class=n>pf</span><span class=o>.</span><span class=n>value</span>  <span class=c1># (2)!</span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a><span class=go>Open time                                    </span>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=go>2021-02-18 00:00:00+00:00  0.500000  0.500000  &lt;&lt; long entry of 50%</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=go>2021-02-19 00:00:00+00:00  0.520256  0.501976</span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a><span class=go>2021-02-20 00:00:00+00:00  0.519967  0.496546</span>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000  &lt;&lt; long exit</span>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=go>2021-02-22 00:00:00+00:00 -0.250000 -0.250000  &lt;&lt; short entry of 25%</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a><span class=go>2021-02-23 00:00:00+00:00 -0.220680 -0.215853</span>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000  &lt;&lt; short exit</span>
</span></code></pre></div> <ol> <li>Treat the size as a percentage of the total portfolio value</li> <li>Get the allocation at each bar, that is, the ratio of the asset value in respect to the total portfolio value</li> </ol> <p>Thanks to the vectorbt's powerful broadcasting mechanism, we can backtest arbitrary configurations with a couple lines of code. Below, we're testing three different mutual configurations of the size and size type arguments:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span>     <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>   <span class=mi>1</span><span class=p>,</span>       <span class=mf>0.5</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;amount&quot;</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span> <span class=s2>&quot;valuepercent&quot;</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=go>size  size_type     symbol </span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=go>inf   amount        BTCUSDT    0.113592</span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=go>                    ETHUSDT   -0.003135</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=go>1.0   value         BTCUSDT    0.001136</span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=go>                    ETHUSDT   -0.000031</span>
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a><span class=go>0.5   valuepercent  BTCUSDT    0.056796</span>
</span><span id=__span-49-15><a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a><span class=go>                    ETHUSDT   -0.001567</span>
</span><span id=__span-49-16><a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a><span class=go>Name: total_return, dtype: float64</span>
</span></code></pre></div> <ol> <li>Without the same <code>level</code>, both parameters would build a Cartesian product</li> </ol> <p>Each configuration is getting applied on the entire set of signal arrays.</p> <h3 id=accumulation>Accumulation<a class=headerlink href=#accumulation title="Permanent link">&para;</a></h3> <p>If we wanted to sell 1$ worth of each asset instead of closing out the entire position whenever an exit signal is encountered, we need to turn on accumulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (1)!</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=go>Open time                                    </span>
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a><span class=go>2021-02-18 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a><span class=go>2021-02-19 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a><span class=go>2021-02-20 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a><span class=go>2021-02-21 00:00:00+00:00  0.000002  0.000000</span>
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a><span class=go>2021-02-22 00:00:00+00:00  0.000002  0.000000</span>
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a><span class=go>2021-02-23 00:00:00+00:00  0.000002  0.000000</span>
</span><span id=__span-50-18><a id=__codelineno-50-18 name=__codelineno-50-18 href=#__codelineno-50-18></a><span class=go>2021-02-24 00:00:00+00:00  0.000002  0.000000</span>
</span></code></pre></div> <ol> <li>See <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.AccumulationMode>AccumulationMode</a></li> </ol> <p>There is a leftover in the column <code>BTCUSDT</code> since we made a profit, while the position has been closed entirely in the column <code>ETHUSDT</code> since we made a loss ($1 is worth less than at the beginning of the simulation). But there is another implication: whenever the accumulation is turned on, the method starts behaving effectively like <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a>. For instance, it treats each signal as an order, irrespective of whether we're in the market or not. This is best illustrated by the following example, where we're issuing a long entry signal at each single bar, without and with the accumulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>])</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>  <span class=c1># (1)!</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=go>accumulate                    False                True          </span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=go>symbol                      BTCUSDT   ETHUSDT   BTCUSDT   ETHUSDT</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=go>Open time                                                        </span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=go>2021-02-18 00:00:00+00:00  0.000019  0.000516  0.000019  0.000516</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000  0.000018  0.000512</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=go>2021-02-20 00:00:00+00:00  0.000000  0.000000  0.000018  0.000523</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000  0.000017  0.000517</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000  0.000018  0.000563</span>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000  0.000020  0.000634</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000  0.000020  0.000616</span>
</span></code></pre></div> <ol> <li>Calculate and print the asset flow at each bar, that is, the absolute amount of units bought (positive) or sold (negative)</li> </ol> <p>We can see that without the accumulation, only the first signal is getting executed while all the signals that follow are getting ignored since we're already in a position. With the accumulation though, each signal gets executed irrespective of the current position. This allows for pyramiding and other trading schemes that require binary position requirements to be lifted.</p> <h3 id=size-types>Size types<a class=headerlink href=#size-types title="Permanent link">&para;</a></h3> <p>There is a variety of size types supported. To get the full list, refer to the enumerated type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SizeType>SizeType</a>. Each size type can be provided either as a (case-insensitive) string representing a field name, or an integer representing a value, such that the arguments <code>size_type="value"</code> and <code>size_type=SizeType.Value</code> will behave identically. Most size types will be internally converted into the size type <code>Amount</code>, which is the absolute amount of units to order. The conversion is mostly done using the valuation price <code>val_price</code>, which defaults to the order price and is meant to be the latest price at the point of decision-making.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>When working with Numba-compiled functions directly, only the integer format is supported.</p> </div> <p>But not all size types are supported in <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>: any target size that defines a target, such as <code>TargetAmount</code>, <code>TargetValue</code>, and <code>TargetPercent(100)</code>, cannot be safely used since the final order size may contradict the signal. For example: if we're in a position of 10 units, and we've issued an entry signal with the size of 3 units and the size type of <code>TargetAmount</code>, the actual order will be a sell order of the size 7, which is opposite to the direction of the signal that we've issued. Additionally, the size type <code>Percent</code> cannot be used in certain circumstances when both directions are allowed, such as when reversing a position, because such a percentage cannot be simply "flipped".</p> <h3 id=size-granularity>Size granularity<a class=headerlink href=#size-granularity title="Permanent link">&para;</a></h3> <p>Size is always represented as a (usually 64-bit) floating-point number and the entire simulation logic of vectorbt is also based on this number format. But, as you might have heard, floating numbers aren't exactly ideal for monetary calculations because the floating-point arithmetic often causes a loss of precision. Since Numba doesn't allow us to use fixed-point numbers, vectorbt is forced to use floating-point numbers and apply a range of tricks to compare them with a certain confidence, such as by using <a href=https://numpy.org/doc/stable/reference/generated/numpy.isclose.html>numpy.isclose</a> and <a href=https://numpy.org/doc/stable/reference/generated/numpy.round_.html>numpy.round_</a>.</p> <p>But what about use cases where the size needs to be an integer, such as when trading stocks? For this, we can use the argument <code>size_granularity</code>, which will round off the final absolute size to some number of decimal places. As a rule of thumb: use <code>1</code> for whole shares, <code>0.001</code> for fractional shares, and some custom value for crypto. For example, Binance provides the step size of each trading pair, which can be directly used as <code>size_granularity</code>.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=gp>... </span>    <span class=n>size_granularity</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>]),</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mi>1000_000</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=go>size_granularity            1.000           0.001         </span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=go>symbol                    BTCUSDT ETHUSDT BTCUSDT  ETHUSDT</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=go>Open time                                                 </span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=go>2021-02-18 00:00:00+00:00    19.0   515.0  19.397  515.567</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=go>2021-02-19 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=go>2021-02-20 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=go>2021-02-21 00:00:00+00:00   -19.0  -515.0 -19.397 -515.566</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=go>2021-02-22 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=go>2021-02-23 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=go>2021-02-24 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Even though the traded size appears as an integer, it's still represented by a float.</p> </div> <h3 id=price>Price<a class=headerlink href=#price title="Permanent link">&para;</a></h3> <p>By default, vectorbt executes an order right away using the current closing price. This behavior can be changed by tweaking the argument <code>price</code>, which can either take a price array, or a price option of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PriceType>PriceType</a>. If we take a look into the portfolio settings, we'll find that <code>price</code> is set to the string <code>"close"</code>, which upon running is getting translated into the option <code>PriceType.Close</code>. This option is just an alias for the value <code>np.inf</code> (positive infinity). What does an infinity do here? Since an order price must be defined within the price bounds of a bar, the negative and positive infinity represent the opening and closing price respectively (see <a href=../index.html#price-resolution>Price resolution</a>); both can be used inside arrays. The other two options <code>NextOpen</code> and <code>NextClose</code> are standalone options and cannot be used inside arrays because they involve other arguments.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Which option to choose depends on which price you used to generate your signals. Mostly, signals are generated and executed using the same closing price. To account for potential time gaps between signal generation and execution, use the next open or close, or shift the signals manually. If you generated the signals using the opening price or any other price preceding it, you can also use the option <code>"open"</code> and a bit of slippage.</p> </div> <p>Let's execute entries using open and exits using close. Remember that each order-related argument is defined for all signals types: long entries and exits, and short entries and exits. That means that there isn't any argument that defines price specifically for exits, otherwise, the number of arguments would skyrocket. To make any argument value valid only for a subset of signal types, we should set it by using the signal types a mask:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_to</span><span class=p>(</span><span class=n>price</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span>   <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_to</span><span class=p>(</span><span class=n>price</span><span class=p>)</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span><span class=p>[</span><span class=n>entries</span><span class=p>]</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>  <span class=c1># (3)!</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span><span class=p>[</span><span class=n>exits</span><span class=p>]</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>price</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>  <span class=c1># (4)!</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-53-16><a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a><span class=go>Open time                                  </span>
</span><span id=__span-53-17><a id=__codelineno-53-17 name=__codelineno-53-17 href=#__codelineno-53-17></a><span class=go>2021-02-18 00:00:00+00:00     True     True</span>
</span><span id=__span-53-18><a id=__codelineno-53-18 name=__codelineno-53-18 href=#__codelineno-53-18></a><span class=go>2021-02-19 00:00:00+00:00    False    False</span>
</span><span id=__span-53-19><a id=__codelineno-53-19 name=__codelineno-53-19 href=#__codelineno-53-19></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-53-20><a id=__codelineno-53-20 name=__codelineno-53-20 href=#__codelineno-53-20></a><span class=go>2021-02-21 00:00:00+00:00    False    False</span>
</span><span id=__span-53-21><a id=__codelineno-53-21 name=__codelineno-53-21 href=#__codelineno-53-21></a><span class=go>2021-02-22 00:00:00+00:00    False    False</span>
</span><span id=__span-53-22><a id=__codelineno-53-22 name=__codelineno-53-22 href=#__codelineno-53-22></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-53-23><a id=__codelineno-53-23 name=__codelineno-53-23 href=#__codelineno-53-23></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span><span id=__span-53-24><a id=__codelineno-53-24 name=__codelineno-53-24 href=#__codelineno-53-24></a>
</span><span id=__span-53-25><a id=__codelineno-53-25 name=__codelineno-53-25 href=#__codelineno-53-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>  <span class=c1># (5)!</span>
</span><span id=__span-53-26><a id=__codelineno-53-26 name=__codelineno-53-26 href=#__codelineno-53-26></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-53-27><a id=__codelineno-53-27 name=__codelineno-53-27 href=#__codelineno-53-27></a><span class=go>Open time                                  </span>
</span><span id=__span-53-28><a id=__codelineno-53-28 name=__codelineno-53-28 href=#__codelineno-53-28></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-53-29><a id=__codelineno-53-29 name=__codelineno-53-29 href=#__codelineno-53-29></a><span class=go>2021-02-19 00:00:00+00:00    False    False</span>
</span><span id=__span-53-30><a id=__codelineno-53-30 name=__codelineno-53-30 href=#__codelineno-53-30></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-53-31><a id=__codelineno-53-31 name=__codelineno-53-31 href=#__codelineno-53-31></a><span class=go>2021-02-21 00:00:00+00:00     True     True</span>
</span><span id=__span-53-32><a id=__codelineno-53-32 name=__codelineno-53-32 href=#__codelineno-53-32></a><span class=go>2021-02-22 00:00:00+00:00    False    False</span>
</span><span id=__span-53-33><a id=__codelineno-53-33 name=__codelineno-53-33 href=#__codelineno-53-33></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-53-34><a id=__codelineno-53-34 name=__codelineno-53-34 href=#__codelineno-53-34></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <ol> <li>Create a new price array of the same shape as the data</li> <li>Define signals and broadcast them to the price array to be able to use them as a mask</li> <li>Set any element in price that falls under an entry signal to the opening price</li> <li>Generate a mask of filled orders which price is open (such a comparison works only if slippage is zero!)</li> <li>Generate a mask of filled orders which price is close</li> </ol> <p>Let's order using the opening price of the next bar instead:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;nextopen&quot;</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=go>Open time                                  </span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=go>2021-02-19 00:00:00+00:00     True     True</span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=go>2021-02-21 00:00:00+00:00    False    False</span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a><span class=go>2021-02-22 00:00:00+00:00     True     True</span>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <p>As we can see, the simulator waited one bar and then executed each signal using the opening price. This is one of the safest approaches when it comes to backtesting because now we have the freedom of running indicators on any price, and we don't have to worry about the look-ahead bias during the execution anymore. The most bulletproof approach would be using the next close because the difference between the previous close and the next open is usually negligible.</p> <h3 id=shifting>Shifting<a class=headerlink href=#shifting title="Permanent link">&para;</a></h3> <p>We could have done the same as above by shifting the signal arrays by one bar manually:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=go>Open time                                  </span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a><span class=go>2021-02-19 00:00:00+00:00     True     True</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a><span class=go>2021-02-21 00:00:00+00:00    False    False</span>
</span><span id=__span-55-14><a id=__codelineno-55-14 name=__codelineno-55-14 href=#__codelineno-55-14></a><span class=go>2021-02-22 00:00:00+00:00     True     True</span>
</span><span id=__span-55-15><a id=__codelineno-55-15 name=__codelineno-55-15 href=#__codelineno-55-15></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-55-16><a id=__codelineno-55-16 name=__codelineno-55-16 href=#__codelineno-55-16></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <ol> <li>When shifting manually, use open/close of the current bar</li> </ol> <p>And this is one of the most underrated features of vectorbt: since we're working with array data, we can shift the data to make any current bar use information from the past. In the example above, after we've forward-shifted the signal arrays, the long entry signal on the 18th February has moved to the 19th February while the index has stayed the same. Thus, the surrounding price information in form of OHLC (the arguments <code>open</code>, <code>high</code>, <code>low</code>, and <code>close</code>) must be fixed and should never be shifted! That also means that we not only have to shift the signals, but any information those signals link to, for example, the order direction and price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=kc>False</span><span class=p>),</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>    <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=kc>False</span><span class=p>),</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=go>Open time                                    </span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=go>2021-02-19 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=go>2021-02-20 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=go>2021-02-21 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=go>2021-02-23 00:00:00+00:00 -0.001979 -0.057624</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=go>2021-02-24 00:00:00+00:00 -0.001979 -0.057624</span>
</span></code></pre></div> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>As a rule of thumb: if an argument is signal-anchored, it should be shifted as well. If an argument is date-anchored though, it should stay the same.</p> </div> <p>To reduce the burden of shifting manually, vectorbt can do it for us automatically! For this, it requires from us providing the argument <code>from_ago</code>, which represents how far ago was the bar from which all the signal and order information should be taken. For example, when <code>from_ago=1</code>, the related information is taken from the previous bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>    <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>]),</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=gp>... </span>    <span class=n>from_ago</span><span class=o>=</span><span class=mi>1</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a><span class=go>Open time                                    </span>
</span><span id=__span-57-11><a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-57-12><a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a><span class=go>2021-02-19 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-57-13><a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a><span class=go>2021-02-20 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-57-14><a id=__codelineno-57-14 name=__codelineno-57-14 href=#__codelineno-57-14></a><span class=go>2021-02-21 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-57-15><a id=__codelineno-57-15 name=__codelineno-57-15 href=#__codelineno-57-15></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-57-16><a id=__codelineno-57-16 name=__codelineno-57-16 href=#__codelineno-57-16></a><span class=go>2021-02-23 00:00:00+00:00 -0.001979 -0.057624</span>
</span><span id=__span-57-17><a id=__codelineno-57-17 name=__codelineno-57-17 href=#__codelineno-57-17></a><span class=go>2021-02-24 00:00:00+00:00 -0.001979 -0.057624</span>
</span></code></pre></div> <p>This argument can also be provided as an array.</p> <h3 id=slippage>Slippage<a class=headerlink href=#slippage title="Permanent link">&para;</a></h3> <p>By default, an order is executed as a market order. This can be seen in the portfolio settings, under the key <code>order_type</code>. Market orders are transactions meant to execute as quickly as possible at the current market price, which is always <code>price</code> (the closing price by default). In reality though, the price at which an order is executed often does not match the price at which it was requested. To take into account this discrepancy, we need to introduce a slippage. Assuming the trading volume is high, we should see less slippage. And when the trading volume is slow, we should expect to see more slippage. An optimal slippage can be calculated from order book data (see <a href=https://www.hodlbot.io/blog/an-analysis-of-slippage-on-the-binance-exchange>this blog</a>).</p> <p>But let for a second assume that the average slippage is 0.5%. Using it together with the default price is generally a bad idea since the closing price is meant to be the latest price seen at each bar. To make our simulation more realistic, we need to apply it on the next open instead:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;nextopen&quot;</span><span class=p>,</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a><span class=gp>... </span>    <span class=n>slippage</span><span class=o>=</span><span class=mf>0.005</span>  <span class=c1># (1)!</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a><span class=go>symbol                         BTCUSDT     ETHUSDT</span>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a><span class=go>Open time                                         </span>
</span><span id=__span-58-11><a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a><span class=go>2021-02-18 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-58-12><a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a><span class=go>2021-02-19 00:00:00+00:00  51810.37305  1948.60455</span>
</span><span id=__span-58-13><a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a><span class=go>2021-02-20 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-58-14><a id=__codelineno-58-14 name=__codelineno-58-14 href=#__codelineno-58-14></a><span class=go>2021-02-21 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-58-15><a id=__codelineno-58-15 name=__codelineno-58-15 href=#__codelineno-58-15></a><span class=go>2021-02-22 00:00:00+00:00  57125.28825  1923.87230</span>
</span><span id=__span-58-16><a id=__codelineno-58-16 name=__codelineno-58-16 href=#__codelineno-58-16></a><span class=go>2021-02-23 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-58-17><a id=__codelineno-58-17 name=__codelineno-58-17 href=#__codelineno-58-17></a><span class=go>2021-02-24 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-58-18><a id=__codelineno-58-18 name=__codelineno-58-18 href=#__codelineno-58-18></a>
</span><span id=__span-58-19><a id=__codelineno-58-19 name=__codelineno-58-19 href=#__codelineno-58-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>  <span class=c1># (3)!</span>
</span><span id=__span-58-20><a id=__codelineno-58-20 name=__codelineno-58-20 href=#__codelineno-58-20></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-58-21><a id=__codelineno-58-21 name=__codelineno-58-21 href=#__codelineno-58-21></a><span class=go>Open time                                  </span>
</span><span id=__span-58-22><a id=__codelineno-58-22 name=__codelineno-58-22 href=#__codelineno-58-22></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-58-23><a id=__codelineno-58-23 name=__codelineno-58-23 href=#__codelineno-58-23></a><span class=go>2021-02-19 00:00:00+00:00    1.005    1.005</span>
</span><span id=__span-58-24><a id=__codelineno-58-24 name=__codelineno-58-24 href=#__codelineno-58-24></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-58-25><a id=__codelineno-58-25 name=__codelineno-58-25 href=#__codelineno-58-25></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-58-26><a id=__codelineno-58-26 name=__codelineno-58-26 href=#__codelineno-58-26></a><span class=go>2021-02-22 00:00:00+00:00    0.995    0.995</span>
</span><span id=__span-58-27><a id=__codelineno-58-27 name=__codelineno-58-27 href=#__codelineno-58-27></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-58-28><a id=__codelineno-58-28 name=__codelineno-58-28 href=#__codelineno-58-28></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>0.01 is 1%</li> <li>Get the filled order price</li> <li>Get the filled order price in relation to the opening price</li> </ol> <p>We can see that the slippage increased the price by 0.5% when buying and decreased the price by 0.5% when selling. Introducing a slippage will always result in a fixed price penalty, thus the slippage should always reflect the average penalty that is being recorded in the market for transactions of this magnitude. Since slippage isn't static but depending on various factors, we can provide it as an array.</p> <h3 id=limit-orders>Limit orders<a class=headerlink href=#limit-orders title="Permanent link">&para;</a></h3> <p>To help eliminate or reduce slippage, traders use limit orders instead of market orders. A limit order only fills at the price we want, or better. Unlike a market order, it won't fill at a worse price. But there is a catch: while the price is guaranteed, the filling of the order is not, and limit orders will not be executed unless the asset price meets the order qualifications. If the asset does not reach the specified price, the order is not filled, and we may miss out on the trading opportunity. So, what happens when we execute our signals using limit orders? Let's switch the default order type by setting the argument <code>order_type</code> to <code>"limit"</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=go>symbol                      BTCUSDT  ETHUSDT</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a><span class=go>Open time                                   </span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a><span class=go>2021-02-18 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a><span class=go>2021-02-19 00:00:00+00:00  51552.60  1938.91</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a><span class=go>2021-02-20 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a><span class=go>2021-02-21 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a><span class=go>2021-02-22 00:00:00+00:00  57412.35  1933.54</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a><span class=go>2021-02-23 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-59-16><a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a><span class=go>2021-02-24 00:00:00+00:00       NaN      NaN</span>
</span></code></pre></div> <p>Since the default order price is the closing price, the simulator registered it as the target limit price and skipped the entry bar. At the next bar, the simulator checked whether the limit price has been hit by comparing it against the full candle. As we can see above, each of the target prices could be satisfied already at the next bar, which is quite similar to using the next opening price as the order execution price. But such a rapid match isn't always the case: what if we wanted to enter a short trade on the 22nd February using the previous high as the limit price?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;shortonly&quot;</span><span class=p>,</span>
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>  <span class=c1># (1)!</span>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a><span class=go>Open time                                  </span>
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Shift the high price by one bar to use the previous high price</li> </ol> <p>Suddenly, no limit order could be filled as the same price or higher (we're selling) couldn't be found at any time during or after the 22nd February. We have now an order that can potentially remain pending forever. How do we limit its lifetime? There are various possibilities.</p> <h4 id=time-in-force>Time in force<a class=headerlink href=#time-in-force title="Permanent link">&para;</a></h4> <p>Time-in-force orders can be created using the argument <code>limit_tif</code>, which expects a time delta, in any format that can be translated into <code>np.timedelta64</code> and then to a 64-bit integer representing nanoseconds, that is, a string, <code>pd.Timedelta</code>, <code>datetime.timedelta</code>, <code>np.timedelta64</code>, or an integer. The time-in-force specification starts counting at the <strong>beginning</strong> of the entry bar (even if the limit order has been issued at the end of the bar) and will be checked at the beginning of each bar starting from the second one. Let's create a buy limit order on the 20th February using the previous low price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=go>Open time                                  </span>
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-61-12><a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-61-13><a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-61-14><a id=__codelineno-61-14 name=__codelineno-61-14 href=#__codelineno-61-14></a><span class=go>2021-02-22 00:00:00+00:00  50710.2      NaN</span>
</span><span id=__span-61-15><a id=__codelineno-61-15 name=__codelineno-61-15 href=#__codelineno-61-15></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-61-16><a id=__codelineno-61-16 name=__codelineno-61-16 href=#__codelineno-61-16></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <p>We can see that the limit order in the column <code>BTCUSDT</code> was executed in two bars while the limit order in the column <code>ETHUSDT</code> was executed in just one bar. Below, we're testing a TIF option passed as a frequency string, which works only outside of arrays:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=gp>... </span>    <span class=n>limit_tif</span><span class=o>=</span><span class=s2>&quot;2d&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=go>Open time                                  </span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-62-15><a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-16><a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-17><a id=__codelineno-62-17 name=__codelineno-62-17 href=#__codelineno-62-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Gets translated into a time delta using <a href=../../../api/utils/datetime_/index.html#vectorbtpro.utils.datetime_.to_timedelta64>to_timedelta64</a></li> </ol> <p>Why is there is no order in <code>BTCUSDT</code>? Because 2 days from <code>2021-02-20 00:00:00</code> is <code>2021-02-22 00:00:00</code>, which is the timestamp at which the order gets cancelled, and since each timestamp represents the opening time of a bar, the pending order doesn't exist during the fifth bar anymore. To provide a TIF specification inside an array or to test multiple configurations, instead of a string, we must use either a Pandas or NumPy format, or a total duration in nanoseconds. Let's test all formats at once!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=gp>... </span>    <span class=n>limit_tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-63-7><a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a><span class=gp>... </span>        <span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-63-8><a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-63-9><a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a><span class=gp>... </span>        <span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>timedelta64</span><span class=p>(</span><span class=mi>86400000000000</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-63-10><a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a><span class=gp>... </span>        <span class=mi>3</span> <span class=o>*</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>d_ns</span>  <span class=c1># (4)!</span>
</span><span id=__span-63-11><a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=gp>... </span>    <span class=p>],</span> <span class=n>keys</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;none&quot;</span><span class=p>,</span> <span class=s2>&quot;1 days&quot;</span><span class=p>,</span> <span class=s2>&quot;2 days&quot;</span><span class=p>,</span> <span class=s2>&quot;3 days&quot;</span><span class=p>])</span>
</span><span id=__span-63-12><a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-63-13><a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-63-14><a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a><span class=go>limit_tif                     none          1 days          2 days          \</span>
</span><span id=__span-63-15><a id=__codelineno-63-15 name=__codelineno-63-15 href=#__codelineno-63-15></a><span class=go>symbol                     BTCUSDT ETHUSDT BTCUSDT ETHUSDT BTCUSDT ETHUSDT   </span>
</span><span id=__span-63-16><a id=__codelineno-63-16 name=__codelineno-63-16 href=#__codelineno-63-16></a><span class=go>Open time                                                                    </span>
</span><span id=__span-63-17><a id=__codelineno-63-17 name=__codelineno-63-17 href=#__codelineno-63-17></a><span class=go>2021-02-18 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-63-18><a id=__codelineno-63-18 name=__codelineno-63-18 href=#__codelineno-63-18></a><span class=go>2021-02-19 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-63-19><a id=__codelineno-63-19 name=__codelineno-63-19 href=#__codelineno-63-19></a><span class=go>2021-02-20 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-63-20><a id=__codelineno-63-20 name=__codelineno-63-20 href=#__codelineno-63-20></a><span class=go>2021-02-21 00:00:00+00:00      NaN  1891.0     NaN     NaN     NaN  1891.0   </span>
</span><span id=__span-63-21><a id=__codelineno-63-21 name=__codelineno-63-21 href=#__codelineno-63-21></a><span class=go>2021-02-22 00:00:00+00:00  50710.2     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-63-22><a id=__codelineno-63-22 name=__codelineno-63-22 href=#__codelineno-63-22></a><span class=go>2021-02-23 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-63-23><a id=__codelineno-63-23 name=__codelineno-63-23 href=#__codelineno-63-23></a><span class=go>2021-02-24 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-63-24><a id=__codelineno-63-24 name=__codelineno-63-24 href=#__codelineno-63-24></a>
</span><span id=__span-63-25><a id=__codelineno-63-25 name=__codelineno-63-25 href=#__codelineno-63-25></a><span class=go>limit_tif                   3 days          </span>
</span><span id=__span-63-26><a id=__codelineno-63-26 name=__codelineno-63-26 href=#__codelineno-63-26></a><span class=go>symbol                     BTCUSDT ETHUSDT  </span>
</span><span id=__span-63-27><a id=__codelineno-63-27 name=__codelineno-63-27 href=#__codelineno-63-27></a><span class=go>Open time                                   </span>
</span><span id=__span-63-28><a id=__codelineno-63-28 name=__codelineno-63-28 href=#__codelineno-63-28></a><span class=go>2021-02-18 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-63-29><a id=__codelineno-63-29 name=__codelineno-63-29 href=#__codelineno-63-29></a><span class=go>2021-02-19 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-63-30><a id=__codelineno-63-30 name=__codelineno-63-30 href=#__codelineno-63-30></a><span class=go>2021-02-20 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-63-31><a id=__codelineno-63-31 name=__codelineno-63-31 href=#__codelineno-63-31></a><span class=go>2021-02-21 00:00:00+00:00      NaN  1891.0  </span>
</span><span id=__span-63-32><a id=__codelineno-63-32 name=__codelineno-63-32 href=#__codelineno-63-32></a><span class=go>2021-02-22 00:00:00+00:00  50710.2     NaN  </span>
</span><span id=__span-63-33><a id=__codelineno-63-33 name=__codelineno-63-33 href=#__codelineno-63-33></a><span class=go>2021-02-23 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-63-34><a id=__codelineno-63-34 name=__codelineno-63-34 href=#__codelineno-63-34></a><span class=go>2021-02-24 00:00:00+00:00      NaN     NaN  </span>
</span></code></pre></div> <ol> <li>Don't use TIF</li> <li>TIF of 1 day in Pandas format</li> <li>TIF of 2 days in NumPy format</li> <li>TIF of 3 days in integer format (nanoseconds)</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>NumPy and integer formats are preferred when building large arrays.</p> </div> <p>There is also a way to specify a number of rows as opposed to a time delta by tweaking the time delta format (<code>time_delta_format</code>), which is represented by the enumerated type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.TimeDeltaFormat>TimeDeltaFormat</a>. This is required in cases where the index is not datetime-like, such as after splitting the data for cross-validation. Let's change the time delta format to <code>Rows</code> and do the same as above but now waiting for a specific number of rows to pass:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a><span class=gp>... </span>    <span class=n>limit_tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span>
</span><span id=__span-64-7><a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a><span class=gp>... </span>        <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> 
</span><span id=__span-64-8><a id=__codelineno-64-8 name=__codelineno-64-8 href=#__codelineno-64-8></a><span class=gp>... </span>        <span class=n>keys</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;none&quot;</span><span class=p>,</span> <span class=s2>&quot;1 rows&quot;</span><span class=p>,</span> <span class=s2>&quot;2 rows&quot;</span><span class=p>,</span> <span class=s2>&quot;3 rows&quot;</span><span class=p>]</span>
</span><span id=__span-64-9><a id=__codelineno-64-9 name=__codelineno-64-9 href=#__codelineno-64-9></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-64-10><a id=__codelineno-64-10 name=__codelineno-64-10 href=#__codelineno-64-10></a><span class=gp>... </span>    <span class=n>time_delta_format</span><span class=o>=</span><span class=s2>&quot;rows&quot;</span>
</span><span id=__span-64-11><a id=__codelineno-64-11 name=__codelineno-64-11 href=#__codelineno-64-11></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>If we're confident that our index has a fixed frequency (for example, days instead of business days) and doesn't have gaps, we can also determine the number of rows by dividing time deltas:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index_td</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1 minute&quot;</span><span class=p>)</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tif_td</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1 day&quot;</span><span class=p>)</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>int</span><span class=p>(</span><span class=n>tif_td</span> <span class=o>/</span> <span class=n>index_td</span><span class=p>)</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=go>1440</span>
</span></code></pre></div> <h4 id=expiration-date>Expiration date<a class=headerlink href=#expiration-date title="Permanent link">&para;</a></h4> <p>Another way to let limit orders expire based on dates and times is by setting an expiration date with <code>limit_expiry</code>. We've got two meaningful options here: setting a frequency at which limit orders should expire, or providing a datetime-like array that can incorporate <code>pd.Timestamp</code>, <code>datetime.datetime</code>, and <code>np.datetime64</code> objects. In the end, the argument will be converted into the 64-bit integer format representing a Unix time (total nanoseconds since 1970). Let's play with the first option first by making limit orders behave like day orders! By receiving a frequency, the simulation method will determine the right bound of each timestamp based by using the method <a href=../../../api/base/wrapping/index.html#vectorbtpro.base.wrapping.ArrayWrapper.get_period_ns_index>ArrayWrapper.get_period_ns_index</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>get_period_ns_index</span><span class=p>(</span><span class=s2>&quot;1d&quot;</span><span class=p>)</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=go>array([1613692800000000000, 1613779200000000000, 1613865600000000000,</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a><span class=go>       1613952000000000000, 1614038400000000000, 1614124800000000000,</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=go>       1614211200000000000])</span>
</span></code></pre></div> <p>But since our data is already daily, let's make a pending limit order expire at the end of the week in which it was created:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-67-5><a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-67-6><a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a><span class=gp>... </span>    <span class=n>limit_expiry</span><span class=o>=</span><span class=s2>&quot;monday&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-67-7><a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-67-8><a id=__codelineno-67-8 name=__codelineno-67-8 href=#__codelineno-67-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-67-9><a id=__codelineno-67-9 name=__codelineno-67-9 href=#__codelineno-67-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-67-10><a id=__codelineno-67-10 name=__codelineno-67-10 href=#__codelineno-67-10></a><span class=go>Open time                                  </span>
</span><span id=__span-67-11><a id=__codelineno-67-11 name=__codelineno-67-11 href=#__codelineno-67-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-67-12><a id=__codelineno-67-12 name=__codelineno-67-12 href=#__codelineno-67-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-67-13><a id=__codelineno-67-13 name=__codelineno-67-13 href=#__codelineno-67-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-67-14><a id=__codelineno-67-14 name=__codelineno-67-14 href=#__codelineno-67-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-67-15><a id=__codelineno-67-15 name=__codelineno-67-15 href=#__codelineno-67-15></a><span class=go>2021-02-22 00:00:00+00:00  50710.2      NaN</span>
</span><span id=__span-67-16><a id=__codelineno-67-16 name=__codelineno-67-16 href=#__codelineno-67-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-67-17><a id=__codelineno-67-17 name=__codelineno-67-17 href=#__codelineno-67-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-67-18><a id=__codelineno-67-18 name=__codelineno-67-18 href=#__codelineno-67-18></a>
</span><span id=__span-67-19><a id=__codelineno-67-19 name=__codelineno-67-19 href=#__codelineno-67-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>to_period</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=s2>&quot;monday&quot;</span><span class=p>))</span>  <span class=c1># (2)!</span>
</span><span id=__span-67-20><a id=__codelineno-67-20 name=__codelineno-67-20 href=#__codelineno-67-20></a><span class=go>PeriodIndex([&#39;2021-02-16/2021-02-22&#39;, &#39;2021-02-16/2021-02-22&#39;,</span>
</span><span id=__span-67-21><a id=__codelineno-67-21 name=__codelineno-67-21 href=#__codelineno-67-21></a><span class=go>             &#39;2021-02-16/2021-02-22&#39;, &#39;2021-02-16/2021-02-22&#39;,</span>
</span><span id=__span-67-22><a id=__codelineno-67-22 name=__codelineno-67-22 href=#__codelineno-67-22></a><span class=go>             &#39;2021-02-16/2021-02-22&#39;, &#39;2021-02-23/2021-03-01&#39;,</span>
</span><span id=__span-67-23><a id=__codelineno-67-23 name=__codelineno-67-23 href=#__codelineno-67-23></a><span class=go>             &#39;2021-02-23/2021-03-01&#39;],</span>
</span><span id=__span-67-24><a id=__codelineno-67-24 name=__codelineno-67-24 href=#__codelineno-67-24></a><span class=go>            dtype=&#39;period[W-MON]&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <ol> <li>See <a href=https://pandas.pydata.org/docs/user_guide/timeseries.html#anchored-offsets>Anchored offsets</a></li> <li>User warning "Converting to PeriodArray/Index representation will drop timezone information" can be ignored</li> </ol> <p>Both orders could be executed because the dates <code>2021-02-20</code>, <code>2021-02-21</code>, and <code>2021-02-22</code> belong to the same week <code>2021-02-16/2021-02-22</code>. As soon as we had changed the week layout to start on a Sunday though, only the first two dates would belong to the same week, thus resulting in the expiration of the pending order in the column <code>BTCUSDT</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=gp>... </span>    <span class=n>limit_expiry</span><span class=o>=</span><span class=s2>&quot;sunday&quot;</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a><span class=go>Open time                                  </span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-68-14><a id=__codelineno-68-14 name=__codelineno-68-14 href=#__codelineno-68-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-68-15><a id=__codelineno-68-15 name=__codelineno-68-15 href=#__codelineno-68-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-68-16><a id=__codelineno-68-16 name=__codelineno-68-16 href=#__codelineno-68-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-68-17><a id=__codelineno-68-17 name=__codelineno-68-17 href=#__codelineno-68-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-68-18><a id=__codelineno-68-18 name=__codelineno-68-18 href=#__codelineno-68-18></a>
</span><span id=__span-68-19><a id=__codelineno-68-19 name=__codelineno-68-19 href=#__codelineno-68-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>to_period</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=s2>&quot;sunday&quot;</span><span class=p>))</span>
</span><span id=__span-68-20><a id=__codelineno-68-20 name=__codelineno-68-20 href=#__codelineno-68-20></a><span class=go>PeriodIndex([&#39;2021-02-15/2021-02-21&#39;, &#39;2021-02-15/2021-02-21&#39;,</span>
</span><span id=__span-68-21><a id=__codelineno-68-21 name=__codelineno-68-21 href=#__codelineno-68-21></a><span class=go>             &#39;2021-02-15/2021-02-21&#39;, &#39;2021-02-15/2021-02-21&#39;,</span>
</span><span id=__span-68-22><a id=__codelineno-68-22 name=__codelineno-68-22 href=#__codelineno-68-22></a><span class=go>             &#39;2021-02-22/2021-02-28&#39;, &#39;2021-02-22/2021-02-28&#39;,</span>
</span><span id=__span-68-23><a id=__codelineno-68-23 name=__codelineno-68-23 href=#__codelineno-68-23></a><span class=go>             &#39;2021-02-22/2021-02-28&#39;],</span>
</span><span id=__span-68-24><a id=__codelineno-68-24 name=__codelineno-68-24 href=#__codelineno-68-24></a><span class=go>            dtype=&#39;period[W-SUN]&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <p>We can also build our own <code>limit_expiry</code> array. For instance, let's simulate a TIF of 2 days by relying on the expiration dates alone - the same as passing <code>limit_tif="2d"</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a><span class=gp>... </span>    <span class=n>limit_expiry</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=gp>... </span><span class=s2>    expiry_index = wrapper.index + pd.Timedelta(days=2)</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=gp>... </span><span class=s2>    expiry_arr = vbt.to_2d_array(vbt.dt.to_ns(expiry_index))</span>
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a><span class=gp>... </span><span class=s2>    expiry_arr</span>
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a><span class=gp>... </span><span class=s2>    &quot;&quot;&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-69-13><a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-69-14><a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a><span class=go>Open time                                  </span>
</span><span id=__span-69-15><a id=__codelineno-69-15 name=__codelineno-69-15 href=#__codelineno-69-15></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-16><a id=__codelineno-69-16 name=__codelineno-69-16 href=#__codelineno-69-16></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-17><a id=__codelineno-69-17 name=__codelineno-69-17 href=#__codelineno-69-17></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-18><a id=__codelineno-69-18 name=__codelineno-69-18 href=#__codelineno-69-18></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-69-19><a id=__codelineno-69-19 name=__codelineno-69-19 href=#__codelineno-69-19></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-20><a id=__codelineno-69-20 name=__codelineno-69-20 href=#__codelineno-69-20></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-21><a id=__codelineno-69-21 name=__codelineno-69-21 href=#__codelineno-69-21></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Since, after broadcasting, the final index might be different from the original one, we need to create a template that adds 2 days to the final index and converts it into a two-dimensional array. Leaving it as one-dimensional will broadcast values per column (!)</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Don't attempt to pass a <code>pd.Index</code> directly, it will be converted into parameters. Use <code>pd.Series</code> instead.</p> </div> <h4 id=conflicts_1>Conflicts<a class=headerlink href=#conflicts_1 title="Permanent link">&para;</a></h4> <p>What happens if the user issues a signal when there is a limit order pending? Since <abbr title="From-signals simulation method">FS</abbr> can track only one limit order per column at a time, we need to choose a winner. There are two arguments that are relevant: <code>upon_adj_limit_conflict</code> and <code>upon_opp_limit_conflict</code>, both of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PendingConflictMode>PendingConflictMode</a>. The first controls the decision process if both orders attempt to go in the same direction, the second if their directions are opposite. Let's introduce a sell market order on the 21st February and test various conflict resolution options:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>all_conflict_modes</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PendingConflictMode</span><span class=o>.</span><span class=n>_fields</span>  <span class=c1># (1)!</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>2</span><span class=p>:</span> <span class=s2>&quot;limit&quot;</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=s2>&quot;market&quot;</span><span class=p>}),</span>  <span class=c1># (2)!</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a><span class=gp>... </span>    <span class=n>upon_opp_limit_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>all_conflict_modes</span><span class=p>)</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a><span class=go>upon_opp_limit_conflict    KeepIgnore  KeepExecute  CancelIgnore  \</span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=go>Open time                                                          </span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a><span class=go>2021-02-18 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a><span class=go>2021-02-19 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a><span class=go>2021-02-20 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a><span class=go>2021-02-21 00:00:00+00:00         NaN     53863.93           NaN   </span>
</span><span id=__span-70-17><a id=__codelineno-70-17 name=__codelineno-70-17 href=#__codelineno-70-17></a><span class=go>2021-02-22 00:00:00+00:00     50710.2     50710.20           NaN   </span>
</span><span id=__span-70-18><a id=__codelineno-70-18 name=__codelineno-70-18 href=#__codelineno-70-18></a><span class=go>2021-02-23 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-70-19><a id=__codelineno-70-19 name=__codelineno-70-19 href=#__codelineno-70-19></a><span class=go>2021-02-24 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-70-20><a id=__codelineno-70-20 name=__codelineno-70-20 href=#__codelineno-70-20></a>
</span><span id=__span-70-21><a id=__codelineno-70-21 name=__codelineno-70-21 href=#__codelineno-70-21></a><span class=go>upon_opp_limit_conflict    CancelExecute  </span>
</span><span id=__span-70-22><a id=__codelineno-70-22 name=__codelineno-70-22 href=#__codelineno-70-22></a><span class=go>Open time                                 </span>
</span><span id=__span-70-23><a id=__codelineno-70-23 name=__codelineno-70-23 href=#__codelineno-70-23></a><span class=go>2021-02-18 00:00:00+00:00            NaN  </span>
</span><span id=__span-70-24><a id=__codelineno-70-24 name=__codelineno-70-24 href=#__codelineno-70-24></a><span class=go>2021-02-19 00:00:00+00:00            NaN  </span>
</span><span id=__span-70-25><a id=__codelineno-70-25 name=__codelineno-70-25 href=#__codelineno-70-25></a><span class=go>2021-02-20 00:00:00+00:00            NaN  </span>
</span><span id=__span-70-26><a id=__codelineno-70-26 name=__codelineno-70-26 href=#__codelineno-70-26></a><span class=go>2021-02-21 00:00:00+00:00       53863.93  </span>
</span><span id=__span-70-27><a id=__codelineno-70-27 name=__codelineno-70-27 href=#__codelineno-70-27></a><span class=go>2021-02-22 00:00:00+00:00            NaN  </span>
</span><span id=__span-70-28><a id=__codelineno-70-28 name=__codelineno-70-28 href=#__codelineno-70-28></a><span class=go>2021-02-23 00:00:00+00:00            NaN  </span>
</span><span id=__span-70-29><a id=__codelineno-70-29 name=__codelineno-70-29 href=#__codelineno-70-29></a><span class=go>2021-02-24 00:00:00+00:00            NaN  </span>
</span></code></pre></div> <ol> <li>Get the list with all options</li> <li>Only the first order should be a limit order</li> </ol> <p>As you might have noticed, the first word in the option's name means what to do with the pending limit order, and the second word means what to do with the user-defined order. By default, the limit order wins when the user-defined signal is of the same direction (buy and buy, sell and sell, option <code>KeepIgnore</code>) to avoid repeatedly executing similar signals, and the user-defined signal wins when both orders are of the opposite direction (buy and sell, sell and buy, option <code>CancelExecute</code>) to account for a change in the market regime.</p> <h4 id=delta>Delta<a class=headerlink href=#delta title="Permanent link">&para;</a></h4> <p>The target price of a limit order is taken from the argument <code>price</code>. But what if we wanted to place a limit order at a price some distance (a.k.a. "delta") above or below some another price, such as 10% from the current closing price? For this, we would need to know whether a signal is a buy or sell order beforehand: if it's a buy order, the price should be lower than the closing price, and if it's a sell order, the price should be higher than the closing price. To avoid determining such information in advance and building a price array manually, there is a handy argument <code>limit_delta</code> that specifies how far away from <code>price</code> the target limit price should be. The format of this argument is controlled by another argument <code>delta_format</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.DeltaFormat>DeltaFormat</a>. The default format is a percentage (<code>Percent</code>), such as passing <code>limit_delta=0.1</code> will be understood as 10%. Let's try out different deltas for a buy limit order at the very first bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>])</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a><span class=go>limit_delta                    0.0                0.1               0.5  \</span>
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT   BTCUSDT   ETHUSDT BTCUSDT   </span>
</span><span id=__span-71-10><a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a><span class=go>Open time                                                                 </span>
</span><span id=__span-71-11><a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-71-12><a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a><span class=go>2021-02-19 00:00:00+00:00  51552.6  1938.91       NaN       NaN     NaN   </span>
</span><span id=__span-71-13><a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-71-14><a id=__codelineno-71-14 name=__codelineno-71-14 href=#__codelineno-71-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-71-15><a id=__codelineno-71-15 name=__codelineno-71-15 href=#__codelineno-71-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN       NaN  1745.649     NaN   </span>
</span><span id=__span-71-16><a id=__codelineno-71-16 name=__codelineno-71-16 href=#__codelineno-71-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN  46397.34       NaN     NaN   </span>
</span><span id=__span-71-17><a id=__codelineno-71-17 name=__codelineno-71-17 href=#__codelineno-71-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-71-18><a id=__codelineno-71-18 name=__codelineno-71-18 href=#__codelineno-71-18></a>
</span><span id=__span-71-19><a id=__codelineno-71-19 name=__codelineno-71-19 href=#__codelineno-71-19></a><span class=go>limit_delta                        </span>
</span><span id=__span-71-20><a id=__codelineno-71-20 name=__codelineno-71-20 href=#__codelineno-71-20></a><span class=go>symbol                    ETHUSDT  </span>
</span><span id=__span-71-21><a id=__codelineno-71-21 name=__codelineno-71-21 href=#__codelineno-71-21></a><span class=go>Open time                          </span>
</span><span id=__span-71-22><a id=__codelineno-71-22 name=__codelineno-71-22 href=#__codelineno-71-22></a><span class=go>2021-02-18 00:00:00+00:00     NaN  </span>
</span><span id=__span-71-23><a id=__codelineno-71-23 name=__codelineno-71-23 href=#__codelineno-71-23></a><span class=go>2021-02-19 00:00:00+00:00     NaN  </span>
</span><span id=__span-71-24><a id=__codelineno-71-24 name=__codelineno-71-24 href=#__codelineno-71-24></a><span class=go>2021-02-20 00:00:00+00:00     NaN  </span>
</span><span id=__span-71-25><a id=__codelineno-71-25 name=__codelineno-71-25 href=#__codelineno-71-25></a><span class=go>2021-02-21 00:00:00+00:00     NaN  </span>
</span><span id=__span-71-26><a id=__codelineno-71-26 name=__codelineno-71-26 href=#__codelineno-71-26></a><span class=go>2021-02-22 00:00:00+00:00     NaN  </span>
</span><span id=__span-71-27><a id=__codelineno-71-27 name=__codelineno-71-27 href=#__codelineno-71-27></a><span class=go>2021-02-23 00:00:00+00:00     NaN  </span>
</span><span id=__span-71-28><a id=__codelineno-71-28 name=__codelineno-71-28 href=#__codelineno-71-28></a><span class=go>2021-02-24 00:00:00+00:00     NaN  </span>
</span></code></pre></div> <p>As we can see, without a delta, the target limit price is essentially the current closing price. With a limit delta of 10%, the target limit price becomes <code>close * (1 - limit_delta)</code>, which in our example have only been matched after a few bars. The final limit delta of 50% haven't been matched at all since the price window that we chose doesn't have dips of such a magnitude. If our limit order was a sell order, the calculation would be <code>close * (1 + limit_delta)</code>.</p> <h4 id=reversing>Reversing<a class=headerlink href=#reversing title="Permanent link">&para;</a></h4> <p>We've covered regular buy/sell limit orders that get matched whenever the price is found to be the same or lower/higher than the requested price. Now, we can reverse the matching logic with the argument <code>limit_reverse</code> to simulate buy/sell <strong>stop</strong> orders. For instance, for a buy stop order with an absolute delta of $100, it would search for a price that is $100 higher (as opposed to lower) than the current closing price and execute the limit order using that price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=mi>10000</span><span class=p>]),</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=gp>... </span>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;absolute&quot;</span><span class=p>,</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a><span class=gp>... </span>    <span class=n>limit_reverse</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a><span class=go>limit_delta                   0        100      5000   10000</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a><span class=go>Open time                                                   </span>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a><span class=go>2021-02-18 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-72-13><a id=__codelineno-72-13 name=__codelineno-72-13 href=#__codelineno-72-13></a><span class=go>2021-02-19 00:00:00+00:00  51552.61  51652.6      NaN    NaN</span>
</span><span id=__span-72-14><a id=__codelineno-72-14 name=__codelineno-72-14 href=#__codelineno-72-14></a><span class=go>2021-02-20 00:00:00+00:00       NaN      NaN  56552.6    NaN</span>
</span><span id=__span-72-15><a id=__codelineno-72-15 name=__codelineno-72-15 href=#__codelineno-72-15></a><span class=go>2021-02-21 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-72-16><a id=__codelineno-72-16 name=__codelineno-72-16 href=#__codelineno-72-16></a><span class=go>2021-02-22 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-72-17><a id=__codelineno-72-17 name=__codelineno-72-17 href=#__codelineno-72-17></a><span class=go>2021-02-23 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-72-18><a id=__codelineno-72-18 name=__codelineno-72-18 href=#__codelineno-72-18></a><span class=go>2021-02-24 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Why does the same delta of zero result in a different fill price without and with reversing? Because upon hitting the second bar, the limit price is getting compared against the opening price. In the first example, the opening price is higher than the limit price, thus the limit order is executed using the limit price. In the second example, because the opening price is higher, the limit order is executed using the opening price.</p> </div> <h4 id=adjustment>Adjustment<a class=headerlink href=#adjustment title="Permanent link">&para;</a></h4> <p>In the theoretical section we discussed how it's possible to change any limit order from a callback. There are four callbacks that we can use: a signal function (<code>signal_func_nb</code>), an adjustment function (<code>adjust_func_nb</code>), a post-signal function (<code>post_signal_func_nb</code>), or a post-segment function (<code>post_segment_func_nb</code>). The signal function is called at the beginning of a bar and should only be used if we need to define the four user-defined signals dynamically. The adjustment function is called at the beginning of the default signal function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.dir_signal_func_nb>dir_signal_func_nb</a> for direction-unaware and <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.ls_signal_func_nb>ls_signal_func_nb</a> for direction-aware signals, which are provided via boolean arrays (statically). The post-segment function is called at the end of a bar for pre-calculating metrics such as portfolio returns. </p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The adjustment function gets called only if the signals are provided statically, that is, <code>signal_func_nb</code> hasn't been overridden. Also note that overriding any of the functions above will disable caching of <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>!</p> </div> <p>Each of those functions accepts a named tuple with the current simulation context, which includes a one-dimensional record array <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext.last_limit_info>SignalContext.last_limit_info</a> with the latest limit order information defined per column. By changing this array, we can change the limit order that is yet to be processed at this bar (or the next one for the post-segment function). We will focus on the adjustment function since it's meant to work together with signal arrays. This function should be Numba-compiled, take the current context variable (usually denoted with <code>c</code>) and other custom arguments (<code>adjust_args</code>), and return nothing (<code>None</code>). Why nothing? Because we can change all the relevant information in the context. Let's create a function that cancels any pending limit order (that is, it hasn't been executed at the entry bar). Limit orders will be created using the opening price and a parametrized custom delta:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a><span class=gp>... </span>    <span class=n>limit_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_limit_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (2)!</span>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>  <span class=c1># (4)!</span>
</span><span id=__span-73-6><a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>clear_limit_info_nb</span><span class=p>(</span><span class=n>limit_info</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-73-7><a id=__codelineno-73-7 name=__codelineno-73-7 href=#__codelineno-73-7></a>
</span><span id=__span-73-8><a id=__codelineno-73-8 name=__codelineno-73-8 href=#__codelineno-73-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-73-9><a id=__codelineno-73-9 name=__codelineno-73-9 href=#__codelineno-73-9></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-73-10><a id=__codelineno-73-10 name=__codelineno-73-10 href=#__codelineno-73-10></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-73-11><a id=__codelineno-73-11 name=__codelineno-73-11 href=#__codelineno-73-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span><span class=p>,</span>
</span><span id=__span-73-12><a id=__codelineno-73-12 name=__codelineno-73-12 href=#__codelineno-73-12></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-73-13><a id=__codelineno-73-13 name=__codelineno-73-13 href=#__codelineno-73-13></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-73-14><a id=__codelineno-73-14 name=__codelineno-73-14 href=#__codelineno-73-14></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span>
</span><span id=__span-73-15><a id=__codelineno-73-15 name=__codelineno-73-15 href=#__codelineno-73-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-73-16><a id=__codelineno-73-16 name=__codelineno-73-16 href=#__codelineno-73-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-73-17><a id=__codelineno-73-17 name=__codelineno-73-17 href=#__codelineno-73-17></a><span class=go>limit_delta                     0.0             0.1        </span>
</span><span id=__span-73-18><a id=__codelineno-73-18 name=__codelineno-73-18 href=#__codelineno-73-18></a><span class=go>symbol                      BTCUSDT ETHUSDT BTCUSDT ETHUSDT</span>
</span><span id=__span-73-19><a id=__codelineno-73-19 name=__codelineno-73-19 href=#__codelineno-73-19></a><span class=go>Open time                                                  </span>
</span><span id=__span-73-20><a id=__codelineno-73-20 name=__codelineno-73-20 href=#__codelineno-73-20></a><span class=go>2021-02-18 00:00:00+00:00  52117.67  1849.7     NaN     NaN</span>
</span><span id=__span-73-21><a id=__codelineno-73-21 name=__codelineno-73-21 href=#__codelineno-73-21></a><span class=go>2021-02-19 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-73-22><a id=__codelineno-73-22 name=__codelineno-73-22 href=#__codelineno-73-22></a><span class=go>2021-02-20 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-73-23><a id=__codelineno-73-23 name=__codelineno-73-23 href=#__codelineno-73-23></a><span class=go>2021-02-21 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-73-24><a id=__codelineno-73-24 name=__codelineno-73-24 href=#__codelineno-73-24></a><span class=go>2021-02-22 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-73-25><a id=__codelineno-73-25 name=__codelineno-73-25 href=#__codelineno-73-25></a><span class=go>2021-02-23 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-73-26><a id=__codelineno-73-26 name=__codelineno-73-26 href=#__codelineno-73-26></a><span class=go>2021-02-24 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span></code></pre></div> <ol> <li>Must take <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext>SignalContext</a> </li> <li>Get the pending limit order information for the current column (asset)</li> <li>Check whether there is any limit order pending</li> <li>Check whether the order has been pending for one bar or longer</li> <li>Use <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.clear_limit_info_nb>clear_limit_info_nb</a> to cancel the order</li> </ol> <p>We can see that without a delta, each order could be filled already at the entry bar. With a delta of 10% though, the orders couldn't be filled at the entry bar, and thus they were cancelled at the beginning of the second bar (19th February). Let's do the opposite: if a limit order is still pending, override its price with the valuation price and delta with 1% to execute at this bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=gp>... </span>    <span class=n>limit_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_limit_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=gp>... </span>            <span class=n>limit_info</span><span class=o>.</span><span class=n>init_price</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>  <span class=c1># (1)!</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=gp>... </span>            <span class=n>limit_info</span><span class=o>.</span><span class=n>delta</span> <span class=o>=</span> <span class=mf>0.01</span>
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a>
</span><span id=__span-74-9><a id=__codelineno-74-9 name=__codelineno-74-9 href=#__codelineno-74-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-74-10><a id=__codelineno-74-10 name=__codelineno-74-10 href=#__codelineno-74-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-74-11><a id=__codelineno-74-11 name=__codelineno-74-11 href=#__codelineno-74-11></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-74-12><a id=__codelineno-74-12 name=__codelineno-74-12 href=#__codelineno-74-12></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span><span class=p>,</span>
</span><span id=__span-74-13><a id=__codelineno-74-13 name=__codelineno-74-13 href=#__codelineno-74-13></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-74-14><a id=__codelineno-74-14 name=__codelineno-74-14 href=#__codelineno-74-14></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>
</span><span id=__span-74-15><a id=__codelineno-74-15 name=__codelineno-74-15 href=#__codelineno-74-15></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span>
</span><span id=__span-74-16><a id=__codelineno-74-16 name=__codelineno-74-16 href=#__codelineno-74-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-74-17><a id=__codelineno-74-17 name=__codelineno-74-17 href=#__codelineno-74-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-74-18><a id=__codelineno-74-18 name=__codelineno-74-18 href=#__codelineno-74-18></a><span class=go>limit_delta                       0.1                    0.2           </span>
</span><span id=__span-74-19><a id=__codelineno-74-19 name=__codelineno-74-19 href=#__codelineno-74-19></a><span class=go>symbol                        BTCUSDT    ETHUSDT     BTCUSDT    ETHUSDT</span>
</span><span id=__span-74-20><a id=__codelineno-74-20 name=__codelineno-74-20 href=#__codelineno-74-20></a><span class=go>Open time                                                              </span>
</span><span id=__span-74-21><a id=__codelineno-74-21 name=__codelineno-74-21 href=#__codelineno-74-21></a><span class=go>2021-02-18 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-74-22><a id=__codelineno-74-22 name=__codelineno-74-22 href=#__codelineno-74-22></a><span class=go>2021-02-19 00:00:00+00:00  51037.0839  1919.5209  51037.0839  1919.5209</span>
</span><span id=__span-74-23><a id=__codelineno-74-23 name=__codelineno-74-23 href=#__codelineno-74-23></a><span class=go>2021-02-20 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-74-24><a id=__codelineno-74-24 name=__codelineno-74-24 href=#__codelineno-74-24></a><span class=go>2021-02-21 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-74-25><a id=__codelineno-74-25 name=__codelineno-74-25 href=#__codelineno-74-25></a><span class=go>2021-02-22 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-74-26><a id=__codelineno-74-26 name=__codelineno-74-26 href=#__codelineno-74-26></a><span class=go>2021-02-23 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-74-27><a id=__codelineno-74-27 name=__codelineno-74-27 href=#__codelineno-74-27></a><span class=go>2021-02-24 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span></code></pre></div> <ol> <li>Negative infinity will be translated into the valuation price, that is, the latest known price at the time of calling a callback, which is the opening price for adjustment and signal callbacks, and the closing price for post-segment callbacks. Note that you cannot use positive infinity for the closing price because it's unknown!</li> </ol> <p>The same way as we cancelled an order, we can also create a new order without the need of user-defined signals - basically out of nothing!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>custom_delta</span><span class=p>):</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a><span class=gp>... </span>    <span class=n>limit_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_limit_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (1)!</span>
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a><span class=gp>... </span>        <span class=n>curr_delta</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>custom_delta</span><span class=p>)</span>
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>set_limit_info_nb</span><span class=p>(</span><span class=n>limit_info</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>delta</span><span class=o>=</span><span class=n>curr_delta</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a>
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>custom_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>])),</span>  <span class=c1># (3)!</span>
</span><span id=__span-75-11><a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-75-12><a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a><span class=gp>... </span>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;custom_delta&quot;</span><span class=p>),)</span>  <span class=c1># (4)!</span>
</span><span id=__span-75-13><a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-75-14><a id=__codelineno-75-14 name=__codelineno-75-14 href=#__codelineno-75-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-75-15><a id=__codelineno-75-15 name=__codelineno-75-15 href=#__codelineno-75-15></a><span class=go>custom_delta                    0.0                0.1         </span>
</span><span id=__span-75-16><a id=__codelineno-75-16 name=__codelineno-75-16 href=#__codelineno-75-16></a><span class=go>symbol                      BTCUSDT ETHUSDT    BTCUSDT  ETHUSDT</span>
</span><span id=__span-75-17><a id=__codelineno-75-17 name=__codelineno-75-17 href=#__codelineno-75-17></a><span class=go>Open time                                                      </span>
</span><span id=__span-75-18><a id=__codelineno-75-18 name=__codelineno-75-18 href=#__codelineno-75-18></a><span class=go>2021-02-18 00:00:00+00:00  52117.67  1849.7        NaN      NaN</span>
</span><span id=__span-75-19><a id=__codelineno-75-19 name=__codelineno-75-19 href=#__codelineno-75-19></a><span class=go>2021-02-19 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span><span id=__span-75-20><a id=__codelineno-75-20 name=__codelineno-75-20 href=#__codelineno-75-20></a><span class=go>2021-02-20 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span><span id=__span-75-21><a id=__codelineno-75-21 name=__codelineno-75-21 href=#__codelineno-75-21></a><span class=go>2021-02-21 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span><span id=__span-75-22><a id=__codelineno-75-22 name=__codelineno-75-22 href=#__codelineno-75-22></a><span class=go>2021-02-22 00:00:00+00:00       NaN     NaN        NaN  1664.73</span>
</span><span id=__span-75-23><a id=__codelineno-75-23 name=__codelineno-75-23 href=#__codelineno-75-23></a><span class=go>2021-02-23 00:00:00+00:00       NaN     NaN  46905.903      NaN</span>
</span><span id=__span-75-24><a id=__codelineno-75-24 name=__codelineno-75-24 href=#__codelineno-75-24></a><span class=go>2021-02-24 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span></code></pre></div> <ol> <li>Create a signal order at the very first bar only</li> <li>Use <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.set_limit_info_nb>set_limit_info_nb</a>. Take a look at its signature to learn more about defaults. For example, it uses the current valuation price, the infinity size, and both directions by default.</li> <li>To make a custom argument parameterizable, we need to define it as a flexible argument in <code>broadcast_named_args</code>, that is, it must be able to be defined per element</li> <li>Don't forget to put a comma after a single element in a tuple</li> </ol> <p>We just created limit orders dynamically, without any signals <img alt=✨ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2728.svg title=:sparkles:></p> <h3 id=stop-orders>Stop orders<a class=headerlink href=#stop-orders title="Permanent link">&para;</a></h3> <p>Just like limit orders, stop orders are executed only once a price condition is met. Their information is also stored per column inside a one-dimensional record array. But in contrast to limit orders, they are just deterred user-defined signals that result in a market or limit order to mainly close out an existing position. They are created upon a successful entry order that either opens, increases, or reverses a position (i.e., closes out and then enters a new position in the opposite direction). There are three stop order types: <abbr title="Stop loss">SL</abbr> (<code>sl_stop</code>), <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr> (<code>tsl_stop</code> and <code>tsl_th</code>, acting as one order), and <abbr title="Take profit">TP</abbr> (<code>tp_stop</code>). Each one of them is stored and tracked separately, but they all act as a one-cancels-all (OCA) order where one order is triggered in full while the others are automatically canceled. Any pending stop orders get also canceled if the entered position has been closed out by other means.</p> <p>Let's place a stop loss order of 10%:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-76-6><a id=__codelineno-76-6 name=__codelineno-76-6 href=#__codelineno-76-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-76-7><a id=__codelineno-76-7 name=__codelineno-76-7 href=#__codelineno-76-7></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-76-8><a id=__codelineno-76-8 name=__codelineno-76-8 href=#__codelineno-76-8></a><span class=go>Open time                                    </span>
</span><span id=__span-76-9><a id=__codelineno-76-9 name=__codelineno-76-9 href=#__codelineno-76-9></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.610</span>
</span><span id=__span-76-10><a id=__codelineno-76-10 name=__codelineno-76-10 href=#__codelineno-76-10></a><span class=go>2021-02-19 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-76-11><a id=__codelineno-76-11 name=__codelineno-76-11 href=#__codelineno-76-11></a><span class=go>2021-02-20 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-76-12><a id=__codelineno-76-12 name=__codelineno-76-12 href=#__codelineno-76-12></a><span class=go>2021-02-21 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-76-13><a id=__codelineno-76-13 name=__codelineno-76-13 href=#__codelineno-76-13></a><span class=go>2021-02-22 00:00:00+00:00       NaN  1745.649</span>
</span><span id=__span-76-14><a id=__codelineno-76-14 name=__codelineno-76-14 href=#__codelineno-76-14></a><span class=go>2021-02-23 00:00:00+00:00  46397.34       NaN</span>
</span><span id=__span-76-15><a id=__codelineno-76-15 name=__codelineno-76-15 href=#__codelineno-76-15></a><span class=go>2021-02-24 00:00:00+00:00       NaN       NaN</span>
</span></code></pre></div> <div class="admonition important"> <p class=admonition-title>Important</p> <p>When passing an instance of <a href=../../../api/data/base/index.html#vectorbtpro.data.base.Data>Data</a> as the first argument (as we did with <code>sub_data</code>), the method will extract OHLC from it automatically. If you're passing the closing price as the first argument instead, make sure to pass other price features (OHL) as well, using the arguments <code>open</code>, <code>high</code>, and <code>low</code>. Without them, candles will be incomplete and vectorbt will make decisions solely based on <code>close</code>!</p> </div> <p>We can see that the entered long position has been exited at the price <code>51552.60 * 0.9 = 46397.34</code>. To test multiple stop values, we can wrap it with the class <a href=../../../api/utils/params/index.html#vectorbtpro.utils.params.Param>Param</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>  <span class=c1># (1)!</span>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-77-7><a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a><span class=go>sl_stop                        NaN                0.1                0.2  \</span>
</span><span id=__span-77-8><a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT   BTCUSDT   ETHUSDT  BTCUSDT   </span>
</span><span id=__span-77-9><a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a><span class=go>Open time                                                                  </span>
</span><span id=__span-77-10><a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a><span class=go>2021-02-18 00:00:00+00:00  51552.6  1939.61  51552.60  1939.610  51552.6   </span>
</span><span id=__span-77-11><a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-77-12><a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-77-13><a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-77-14><a id=__codelineno-77-14 name=__codelineno-77-14 href=#__codelineno-77-14></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN       NaN  1745.649      NaN   </span>
</span><span id=__span-77-15><a id=__codelineno-77-15 name=__codelineno-77-15 href=#__codelineno-77-15></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN  46397.34       NaN      NaN   </span>
</span><span id=__span-77-16><a id=__codelineno-77-16 name=__codelineno-77-16 href=#__codelineno-77-16></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-77-17><a id=__codelineno-77-17 name=__codelineno-77-17 href=#__codelineno-77-17></a>
</span><span id=__span-77-18><a id=__codelineno-77-18 name=__codelineno-77-18 href=#__codelineno-77-18></a><span class=go>sl_stop                              </span>
</span><span id=__span-77-19><a id=__codelineno-77-19 name=__codelineno-77-19 href=#__codelineno-77-19></a><span class=go>symbol                      ETHUSDT  </span>
</span><span id=__span-77-20><a id=__codelineno-77-20 name=__codelineno-77-20 href=#__codelineno-77-20></a><span class=go>Open time                            </span>
</span><span id=__span-77-21><a id=__codelineno-77-21 name=__codelineno-77-21 href=#__codelineno-77-21></a><span class=go>2021-02-18 00:00:00+00:00  1939.610  </span>
</span><span id=__span-77-22><a id=__codelineno-77-22 name=__codelineno-77-22 href=#__codelineno-77-22></a><span class=go>2021-02-19 00:00:00+00:00       NaN  </span>
</span><span id=__span-77-23><a id=__codelineno-77-23 name=__codelineno-77-23 href=#__codelineno-77-23></a><span class=go>2021-02-20 00:00:00+00:00       NaN  </span>
</span><span id=__span-77-24><a id=__codelineno-77-24 name=__codelineno-77-24 href=#__codelineno-77-24></a><span class=go>2021-02-21 00:00:00+00:00       NaN  </span>
</span><span id=__span-77-25><a id=__codelineno-77-25 name=__codelineno-77-25 href=#__codelineno-77-25></a><span class=go>2021-02-22 00:00:00+00:00  1551.688  </span>
</span><span id=__span-77-26><a id=__codelineno-77-26 name=__codelineno-77-26 href=#__codelineno-77-26></a><span class=go>2021-02-23 00:00:00+00:00       NaN  </span>
</span><span id=__span-77-27><a id=__codelineno-77-27 name=__codelineno-77-27 href=#__codelineno-77-27></a><span class=go>2021-02-24 00:00:00+00:00       NaN  </span>
</span></code></pre></div> <ol> <li>NaN means no stop order</li> </ol> <p>Since each stop argument and its accompanying information broadcast together with the data, we can provide them as fully-fledged arrays. Below, we're defining a stop loss based on the ATR:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>atr</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;atr&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>atr</span>
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_atr</span> <span class=o>=</span> <span class=n>atr</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>:</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>]</span>
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a>
</span><span id=__span-78-4><a id=__codelineno-78-4 name=__codelineno-78-4 href=#__codelineno-78-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-78-5><a id=__codelineno-78-5 name=__codelineno-78-5 href=#__codelineno-78-5></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-78-6><a id=__codelineno-78-6 name=__codelineno-78-6 href=#__codelineno-78-6></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-78-7><a id=__codelineno-78-7 name=__codelineno-78-7 href=#__codelineno-78-7></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>sub_atr</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>
</span><span id=__span-78-8><a id=__codelineno-78-8 name=__codelineno-78-8 href=#__codelineno-78-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-78-9><a id=__codelineno-78-9 name=__codelineno-78-9 href=#__codelineno-78-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-78-10><a id=__codelineno-78-10 name=__codelineno-78-10 href=#__codelineno-78-10></a><span class=go>symbol                          BTCUSDT      ETHUSDT</span>
</span><span id=__span-78-11><a id=__codelineno-78-11 name=__codelineno-78-11 href=#__codelineno-78-11></a><span class=go>Open time                                           </span>
</span><span id=__span-78-12><a id=__codelineno-78-12 name=__codelineno-78-12 href=#__codelineno-78-12></a><span class=go>2021-02-18 00:00:00+00:00  51552.600000  1939.610000</span>
</span><span id=__span-78-13><a id=__codelineno-78-13 name=__codelineno-78-13 href=#__codelineno-78-13></a><span class=go>2021-02-19 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-78-14><a id=__codelineno-78-14 name=__codelineno-78-14 href=#__codelineno-78-14></a><span class=go>2021-02-20 00:00:00+00:00           NaN  1805.283249</span>
</span><span id=__span-78-15><a id=__codelineno-78-15 name=__codelineno-78-15 href=#__codelineno-78-15></a><span class=go>2021-02-21 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-78-16><a id=__codelineno-78-16 name=__codelineno-78-16 href=#__codelineno-78-16></a><span class=go>2021-02-22 00:00:00+00:00  48335.716826          NaN</span>
</span><span id=__span-78-17><a id=__codelineno-78-17 name=__codelineno-78-17 href=#__codelineno-78-17></a><span class=go>2021-02-23 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-78-18><a id=__codelineno-78-18 name=__codelineno-78-18 href=#__codelineno-78-18></a><span class=go>2021-02-24 00:00:00+00:00           NaN          NaN</span>
</span></code></pre></div> <p>What about absolute stop values? They can be specified the same way as for limit orders:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-79-3><a id=__codelineno-79-3 name=__codelineno-79-3 href=#__codelineno-79-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-79-4><a id=__codelineno-79-4 name=__codelineno-79-4 href=#__codelineno-79-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-79-5><a id=__codelineno-79-5 name=__codelineno-79-5 href=#__codelineno-79-5></a><span class=gp>... </span>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;absolute&quot;</span>
</span><span id=__span-79-6><a id=__codelineno-79-6 name=__codelineno-79-6 href=#__codelineno-79-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-79-7><a id=__codelineno-79-7 name=__codelineno-79-7 href=#__codelineno-79-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-79-8><a id=__codelineno-79-8 name=__codelineno-79-8 href=#__codelineno-79-8></a><span class=go>Open time</span>
</span><span id=__span-79-9><a id=__codelineno-79-9 name=__codelineno-79-9 href=#__codelineno-79-9></a><span class=go>2021-02-18 00:00:00+00:00    51552.6</span>
</span><span id=__span-79-10><a id=__codelineno-79-10 name=__codelineno-79-10 href=#__codelineno-79-10></a><span class=go>2021-02-19 00:00:00+00:00    51452.6</span>
</span><span id=__span-79-11><a id=__codelineno-79-11 name=__codelineno-79-11 href=#__codelineno-79-11></a><span class=go>2021-02-20 00:00:00+00:00        NaN</span>
</span><span id=__span-79-12><a id=__codelineno-79-12 name=__codelineno-79-12 href=#__codelineno-79-12></a><span class=go>2021-02-21 00:00:00+00:00        NaN</span>
</span><span id=__span-79-13><a id=__codelineno-79-13 name=__codelineno-79-13 href=#__codelineno-79-13></a><span class=go>2021-02-22 00:00:00+00:00        NaN</span>
</span><span id=__span-79-14><a id=__codelineno-79-14 name=__codelineno-79-14 href=#__codelineno-79-14></a><span class=go>2021-02-23 00:00:00+00:00        NaN</span>
</span><span id=__span-79-15><a id=__codelineno-79-15 name=__codelineno-79-15 href=#__codelineno-79-15></a><span class=go>2021-02-24 00:00:00+00:00        NaN</span>
</span><span id=__span-79-16><a id=__codelineno-79-16 name=__codelineno-79-16 href=#__codelineno-79-16></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>We can also provide a target stop price directly:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>51452.6</span><span class=p>,</span>
</span><span id=__span-80-5><a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a><span class=gp>... </span>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;target&quot;</span>
</span><span id=__span-80-6><a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-80-7><a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-80-8><a id=__codelineno-80-8 name=__codelineno-80-8 href=#__codelineno-80-8></a><span class=go>Open time</span>
</span><span id=__span-80-9><a id=__codelineno-80-9 name=__codelineno-80-9 href=#__codelineno-80-9></a><span class=go>2021-02-18 00:00:00+00:00    51552.6</span>
</span><span id=__span-80-10><a id=__codelineno-80-10 name=__codelineno-80-10 href=#__codelineno-80-10></a><span class=go>2021-02-19 00:00:00+00:00    51452.6</span>
</span><span id=__span-80-11><a id=__codelineno-80-11 name=__codelineno-80-11 href=#__codelineno-80-11></a><span class=go>2021-02-20 00:00:00+00:00        NaN</span>
</span><span id=__span-80-12><a id=__codelineno-80-12 name=__codelineno-80-12 href=#__codelineno-80-12></a><span class=go>2021-02-21 00:00:00+00:00        NaN</span>
</span><span id=__span-80-13><a id=__codelineno-80-13 name=__codelineno-80-13 href=#__codelineno-80-13></a><span class=go>2021-02-22 00:00:00+00:00        NaN</span>
</span><span id=__span-80-14><a id=__codelineno-80-14 name=__codelineno-80-14 href=#__codelineno-80-14></a><span class=go>2021-02-23 00:00:00+00:00        NaN</span>
</span><span id=__span-80-15><a id=__codelineno-80-15 name=__codelineno-80-15 href=#__codelineno-80-15></a><span class=go>2021-02-24 00:00:00+00:00        NaN</span>
</span><span id=__span-80-16><a id=__codelineno-80-16 name=__codelineno-80-16 href=#__codelineno-80-16></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>Since the simulator can keep track of multiple stop types at the same time, we can simulate a specific risk-to-reward (R/R) ratio by setting a stop loss and a take profit. For instance, let's simulate the risk-to-reward ratio of 1/2 based on the ATR:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mi>1</span> <span class=o>*</span> <span class=n>sub_atr</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mi>2</span> <span class=o>*</span> <span class=n>sub_atr</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-81-8><a id=__codelineno-81-8 name=__codelineno-81-8 href=#__codelineno-81-8></a><span class=go>symbol                          BTCUSDT      ETHUSDT</span>
</span><span id=__span-81-9><a id=__codelineno-81-9 name=__codelineno-81-9 href=#__codelineno-81-9></a><span class=go>Open time                                           </span>
</span><span id=__span-81-10><a id=__codelineno-81-10 name=__codelineno-81-10 href=#__codelineno-81-10></a><span class=go>2021-02-18 00:00:00+00:00  51552.600000  1939.610000</span>
</span><span id=__span-81-11><a id=__codelineno-81-11 name=__codelineno-81-11 href=#__codelineno-81-11></a><span class=go>2021-02-19 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-81-12><a id=__codelineno-81-12 name=__codelineno-81-12 href=#__codelineno-81-12></a><span class=go>2021-02-20 00:00:00+00:00           NaN  1805.283249</span>
</span><span id=__span-81-13><a id=__codelineno-81-13 name=__codelineno-81-13 href=#__codelineno-81-13></a><span class=go>2021-02-21 00:00:00+00:00  57986.366348          NaN</span>
</span><span id=__span-81-14><a id=__codelineno-81-14 name=__codelineno-81-14 href=#__codelineno-81-14></a><span class=go>2021-02-22 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-81-15><a id=__codelineno-81-15 name=__codelineno-81-15 href=#__codelineno-81-15></a><span class=go>2021-02-23 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-81-16><a id=__codelineno-81-16 name=__codelineno-81-16 href=#__codelineno-81-16></a><span class=go>2021-02-24 00:00:00+00:00           NaN          NaN</span>
</span></code></pre></div> <p>The <abbr title="Take profit">TP</abbr> order won in the first column, the <abbr title="Stop loss">SL</abbr> order won in the second column. But is there a way to see the order type and preferably the date of the signal that initiated it? Sure, vectorbt can fulfill all of your wishes! <img alt=🧞 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f9de.svg title=:genie:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>readable</span>  <span class=c1># (1)!</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a><span class=go>   Order Id   Column              Signal Index            Creation Index  \</span>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a><span class=go>0         0  BTCUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=go>1         1  BTCUSDT 2021-02-18 00:00:00+00:00 2021-02-21 00:00:00+00:00   </span>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a><span class=go>2         0  ETHUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a><span class=go>3         1  ETHUSDT 2021-02-18 00:00:00+00:00 2021-02-20 00:00:00+00:00   </span>
</span><span id=__span-82-7><a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a>
</span><span id=__span-82-8><a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a><span class=go>                 Fill Index      Size         Price  Fees  Side    Type  \</span>
</span><span id=__span-82-9><a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a><span class=go>0 2021-02-18 00:00:00+00:00  0.001940  51552.600000   0.0   Buy  Market   </span>
</span><span id=__span-82-10><a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a><span class=go>1 2021-02-21 00:00:00+00:00  0.001940  57986.366348   0.0  Sell  Market   </span>
</span><span id=__span-82-11><a id=__codelineno-82-11 name=__codelineno-82-11 href=#__codelineno-82-11></a><span class=go>2 2021-02-18 00:00:00+00:00  0.051557   1939.610000   0.0   Buy  Market   </span>
</span><span id=__span-82-12><a id=__codelineno-82-12 name=__codelineno-82-12 href=#__codelineno-82-12></a><span class=go>3 2021-02-20 00:00:00+00:00  0.051557   1805.283249   0.0  Sell  Market   </span>
</span><span id=__span-82-13><a id=__codelineno-82-13 name=__codelineno-82-13 href=#__codelineno-82-13></a>
</span><span id=__span-82-14><a id=__codelineno-82-14 name=__codelineno-82-14 href=#__codelineno-82-14></a><span class=go>  Stop Type  </span>
</span><span id=__span-82-15><a id=__codelineno-82-15 name=__codelineno-82-15 href=#__codelineno-82-15></a><span class=go>0      None  </span>
</span><span id=__span-82-16><a id=__codelineno-82-16 name=__codelineno-82-16 href=#__codelineno-82-16></a><span class=go>1        TP  </span>
</span><span id=__span-82-17><a id=__codelineno-82-17 name=__codelineno-82-17 href=#__codelineno-82-17></a><span class=go>2      None  </span>
</span><span id=__span-82-18><a id=__codelineno-82-18 name=__codelineno-82-18 href=#__codelineno-82-18></a><span class=go>3        SL  </span>
</span><span id=__span-82-19><a id=__codelineno-82-19 name=__codelineno-82-19 href=#__codelineno-82-19></a>
</span><span id=__span-82-20><a id=__codelineno-82-20 name=__codelineno-82-20 href=#__codelineno-82-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>stop_type</span><span class=o>.</span><span class=n>to_pd</span><span class=p>(</span><span class=n>mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-82-21><a id=__codelineno-82-21 name=__codelineno-82-21 href=#__codelineno-82-21></a><span class=go>symbol                    BTCUSDT ETHUSDT</span>
</span><span id=__span-82-22><a id=__codelineno-82-22 name=__codelineno-82-22 href=#__codelineno-82-22></a><span class=go>Open time                                </span>
</span><span id=__span-82-23><a id=__codelineno-82-23 name=__codelineno-82-23 href=#__codelineno-82-23></a><span class=go>2021-02-18 00:00:00+00:00    None    None</span>
</span><span id=__span-82-24><a id=__codelineno-82-24 name=__codelineno-82-24 href=#__codelineno-82-24></a><span class=go>2021-02-19 00:00:00+00:00    None    None</span>
</span><span id=__span-82-25><a id=__codelineno-82-25 name=__codelineno-82-25 href=#__codelineno-82-25></a><span class=go>2021-02-20 00:00:00+00:00    None      SL</span>
</span><span id=__span-82-26><a id=__codelineno-82-26 name=__codelineno-82-26 href=#__codelineno-82-26></a><span class=go>2021-02-21 00:00:00+00:00      TP    None</span>
</span><span id=__span-82-27><a id=__codelineno-82-27 name=__codelineno-82-27 href=#__codelineno-82-27></a><span class=go>2021-02-22 00:00:00+00:00    None    None</span>
</span><span id=__span-82-28><a id=__codelineno-82-28 name=__codelineno-82-28 href=#__codelineno-82-28></a><span class=go>2021-02-23 00:00:00+00:00    None    None</span>
</span><span id=__span-82-29><a id=__codelineno-82-29 name=__codelineno-82-29 href=#__codelineno-82-29></a><span class=go>2021-02-24 00:00:00+00:00    None    None</span>
</span></code></pre></div> <ol> <li>Orders are represented as rows in a compressed record array. Specific information as a column.</li> <li>Specific information as a time series</li> </ol> <p>As we can read form the first DataFrame, the first order is a buy market order (<code>Side</code> and <code>Type</code>) that was filled on the 18th February (<code>Fill Index</code>). The second order in the same column is a sell market order resulting from a <abbr title="Take profit">TP</abbr> order (<code>Stop Type</code>) that was issued on the 18th February (<code>Signal Index</code>) but actually filled on the 21st February (<code>Fill Index</code>). The column <code>Creation Index</code> is the same as the column <code>Fill Index</code> since all orders are market orders. The second DataFrame is a common representation of a single piece of information in relation to the time and asset; it's best used when the information should be analyzed as a time series with Pandas.</p> <p>Finally, let's talk about multiple stop configurations. Here's how to test each stop type independently, that is, <abbr title="Stop loss">SL</abbr> of 10%, <abbr title="Trailing stop loss">TSL</abbr> of 10%, <abbr title="Trailing take profit">TTP</abbr> of 10% with a 10%-threshold, and <abbr title="Take profit">TP</abbr> of 10%:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-83-3><a id=__codelineno-83-3 name=__codelineno-83-3 href=#__codelineno-83-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-83-4><a id=__codelineno-83-4 name=__codelineno-83-4 href=#__codelineno-83-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-83-5><a id=__codelineno-83-5 name=__codelineno-83-5 href=#__codelineno-83-5></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span>    <span class=mf>0.1</span><span class=p>,</span>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-83-6><a id=__codelineno-83-6 name=__codelineno-83-6 href=#__codelineno-83-6></a><span class=gp>... </span>    <span class=n>tsl_th</span><span class=o>=</span>  <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-83-7><a id=__codelineno-83-7 name=__codelineno-83-7 href=#__codelineno-83-7></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span>   <span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-83-8><a id=__codelineno-83-8 name=__codelineno-83-8 href=#__codelineno-83-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-83-9><a id=__codelineno-83-9 name=__codelineno-83-9 href=#__codelineno-83-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-83-10><a id=__codelineno-83-10 name=__codelineno-83-10 href=#__codelineno-83-10></a><span class=go>sl_stop  tsl_stop  tsl_th  tp_stop  symbol </span>
</span><span id=__span-83-11><a id=__codelineno-83-11 name=__codelineno-83-11 href=#__codelineno-83-11></a><span class=go>0.1      NaN       NaN     NaN      BTCUSDT   -0.100000</span>
</span><span id=__span-83-12><a id=__codelineno-83-12 name=__codelineno-83-12 href=#__codelineno-83-12></a><span class=go>                                    ETHUSDT   -0.100000</span>
</span><span id=__span-83-13><a id=__codelineno-83-13 name=__codelineno-83-13 href=#__codelineno-83-13></a><span class=go>NaN      0.1       NaN     NaN      BTCUSDT    0.018717</span>
</span><span id=__span-83-14><a id=__codelineno-83-14 name=__codelineno-83-14 href=#__codelineno-83-14></a><span class=go>                                    ETHUSDT   -0.052332</span>
</span><span id=__span-83-15><a id=__codelineno-83-15 name=__codelineno-83-15 href=#__codelineno-83-15></a><span class=go>NaN      0.1       0.1     NaN      BTCUSDT    0.018717</span>
</span><span id=__span-83-16><a id=__codelineno-83-16 name=__codelineno-83-16 href=#__codelineno-83-16></a><span class=go>                                    ETHUSDT   -0.163033</span>
</span><span id=__span-83-17><a id=__codelineno-83-17 name=__codelineno-83-17 href=#__codelineno-83-17></a><span class=go>NaN      NaN       NaN     0.1      BTCUSDT    0.100000</span>
</span><span id=__span-83-18><a id=__codelineno-83-18 name=__codelineno-83-18 href=#__codelineno-83-18></a><span class=go>                                    ETHUSDT   -0.163033</span>
</span><span id=__span-83-19><a id=__codelineno-83-19 name=__codelineno-83-19 href=#__codelineno-83-19></a><span class=go>Name: total_return, dtype: float64</span>
</span></code></pre></div> <p>To build a product of various stop types, we can specify unique (non-repeating) values and omit the <code>level</code> argument:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2 href=#__codelineno-84-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3 href=#__codelineno-84-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-84-4><a id=__codelineno-84-4 name=__codelineno-84-4 href=#__codelineno-84-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-84-5><a id=__codelineno-84-5 name=__codelineno-84-5 href=#__codelineno-84-5></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-84-6><a id=__codelineno-84-6 name=__codelineno-84-6 href=#__codelineno-84-6></a><span class=gp>... </span>    <span class=n>tsl_th</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-84-7><a id=__codelineno-84-7 name=__codelineno-84-7 href=#__codelineno-84-7></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-84-8><a id=__codelineno-84-8 name=__codelineno-84-8 href=#__codelineno-84-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>The number of columns generated from a Cartesian product of multiple parameter combinations grows exponentially with the number of parameter combinations - show mercy to your RAM!</p> </div> <p>But this would include a combination where <code>tsl_th</code> is not NaN but <code>tsl_stop</code> is NaN, which doesn't make any sense. What we need though are three combinations: no <abbr title="Trailing stop loss">TSL</abbr>/<abbr title="Trailing take profit">TTP</abbr> stop, <abbr title="Trailing stop loss">TSL</abbr> stop, and <abbr title="Trailing take profit">TTP</abbr> stop. Thus, we need to combine those two arguments manually and link them by the same <code>level</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-85-5><a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-85-6><a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a><span class=gp>... </span>    <span class=n>tsl_th</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-85-7><a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-85-8><a id=__codelineno-85-8 name=__codelineno-85-8 href=#__codelineno-85-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>If some arguments require a level, it must be defined for all arguments.</p> </div> <p>We can then call some metric and analyze it using Pandas. For example, let's calculate the average return of using 1) either <abbr title="Stop loss">SL</abbr> or <abbr title="Take profit">TP</abbr>, or 2) <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> together:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sl_stops</span> <span class=o>=</span> <span class=n>total_return</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>get_level_values</span><span class=p>(</span><span class=s2>&quot;sl_stop&quot;</span><span class=p>)</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tp_stops</span> <span class=o>=</span> <span class=n>total_return</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>get_level_values</span><span class=p>(</span><span class=s2>&quot;tp_stop&quot;</span><span class=p>)</span>
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a>
</span><span id=__span-86-5><a id=__codelineno-86-5 name=__codelineno-86-5 href=#__codelineno-86-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>sl_stops</span><span class=p>)</span> <span class=o>|</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>tp_stops</span><span class=p>)]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span><span id=__span-86-6><a id=__codelineno-86-6 name=__codelineno-86-6 href=#__codelineno-86-6></a><span class=go>-0.045462468872515135</span>
</span><span id=__span-86-7><a id=__codelineno-86-7 name=__codelineno-86-7 href=#__codelineno-86-7></a>
</span><span id=__span-86-8><a id=__codelineno-86-8 name=__codelineno-86-8 href=#__codelineno-86-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span><span class=p>[</span><span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>sl_stops</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>tp_stops</span><span class=p>)]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span><span id=__span-86-9><a id=__codelineno-86-9 name=__codelineno-86-9 href=#__codelineno-86-9></a><span class=go>0.0</span>
</span></code></pre></div> <p>Seems like combining <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> works better on our "huge" time series with 7 points <img alt=🙃 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f643.svg title=:upside_down_face:></p> <p>The examples above work only if we're testing arguments provided as scalars (single values). How can we backtest various combinations of stop values provided as arrays though, such as those computed from the ATR? Performing that manually would be highly difficult because we would need to tile each stop type array by the number of stop values and then combine all stop type arrays using the Cartesian product. An easier approach is to build a basic indicator that does the preparation of arrays for us:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>StopOrderPrep</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>IF</span><span class=o>.</span><span class=n>from_expr</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a><span class=gp>... </span><span class=s2>    sl_stop = @p_sl_mult * @in_atr / @in_close</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a><span class=gp>... </span><span class=s2>    tp_stop = @p_tp_mult * @in_atr / @in_close</span>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a><span class=gp>... </span><span class=s2>    sl_stop, tp_stop</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a><span class=gp>... </span><span class=s2>&quot;&quot;&quot;</span><span class=p>)</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6 href=#__codelineno-87-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stop_order_prep</span> <span class=o>=</span> <span class=n>StopOrderPrep</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7 href=#__codelineno-87-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> 
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8 href=#__codelineno-87-8></a><span class=gp>... </span>    <span class=n>atr</span><span class=o>=</span><span class=n>sub_atr</span><span class=p>,</span>
</span><span id=__span-87-9><a id=__codelineno-87-9 name=__codelineno-87-9 href=#__codelineno-87-9></a><span class=gp>... </span>    <span class=n>sl_mult</span><span class=o>=</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span>  <span class=c1># (1)!</span>
</span><span id=__span-87-10><a id=__codelineno-87-10 name=__codelineno-87-10 href=#__codelineno-87-10></a><span class=gp>... </span>    <span class=n>tp_mult</span><span class=o>=</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span>
</span><span id=__span-87-11><a id=__codelineno-87-11 name=__codelineno-87-11 href=#__codelineno-87-11></a><span class=gp>... </span>    <span class=n>param_product</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-87-12><a id=__codelineno-87-12 name=__codelineno-87-12 href=#__codelineno-87-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-87-13><a id=__codelineno-87-13 name=__codelineno-87-13 href=#__codelineno-87-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-87-14><a id=__codelineno-87-14 name=__codelineno-87-14 href=#__codelineno-87-14></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-87-15><a id=__codelineno-87-15 name=__codelineno-87-15 href=#__codelineno-87-15></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-87-16><a id=__codelineno-87-16 name=__codelineno-87-16 href=#__codelineno-87-16></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>stop_order_prep</span><span class=o>.</span><span class=n>sl_stop</span><span class=p>,</span>
</span><span id=__span-87-17><a id=__codelineno-87-17 name=__codelineno-87-17 href=#__codelineno-87-17></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>stop_order_prep</span><span class=o>.</span><span class=n>tp_stop</span><span class=p>,</span>
</span><span id=__span-87-18><a id=__codelineno-87-18 name=__codelineno-87-18 href=#__codelineno-87-18></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-87-19><a id=__codelineno-87-19 name=__codelineno-87-19 href=#__codelineno-87-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-87-20><a id=__codelineno-87-20 name=__codelineno-87-20 href=#__codelineno-87-20></a><span class=go>custom_sl_mult  custom_tp_mult  symbol </span>
</span><span id=__span-87-21><a id=__codelineno-87-21 name=__codelineno-87-21 href=#__codelineno-87-21></a><span class=go>NaN             NaN             BTCUSDT   -0.036398</span>
</span><span id=__span-87-22><a id=__codelineno-87-22 name=__codelineno-87-22 href=#__codelineno-87-22></a><span class=go>                                ETHUSDT   -0.163033</span>
</span><span id=__span-87-23><a id=__codelineno-87-23 name=__codelineno-87-23 href=#__codelineno-87-23></a><span class=go>NaN             1.0             BTCUSDT    0.062400</span>
</span><span id=__span-87-24><a id=__codelineno-87-24 name=__codelineno-87-24 href=#__codelineno-87-24></a><span class=go>                                ETHUSDT   -0.163033</span>
</span><span id=__span-87-25><a id=__codelineno-87-25 name=__codelineno-87-25 href=#__codelineno-87-25></a><span class=go>1.0             NaN             BTCUSDT   -0.062400</span>
</span><span id=__span-87-26><a id=__codelineno-87-26 name=__codelineno-87-26 href=#__codelineno-87-26></a><span class=go>                                ETHUSDT   -0.069255</span>
</span><span id=__span-87-27><a id=__codelineno-87-27 name=__codelineno-87-27 href=#__codelineno-87-27></a><span class=go>1.0             1.0             BTCUSDT    0.062400</span>
</span><span id=__span-87-28><a id=__codelineno-87-28 name=__codelineno-87-28 href=#__codelineno-87-28></a><span class=go>                                ETHUSDT   -0.069255</span>
</span><span id=__span-87-29><a id=__codelineno-87-29 name=__codelineno-87-29 href=#__codelineno-87-29></a><span class=go>Name: total_return, dtype: float64</span>
</span></code></pre></div> <ol> <li>NaN means no order, 1 means one ATR divided by the close</li> </ol> <h4 id=entry-point>Entry point<a class=headerlink href=#entry-point title="Permanent link">&para;</a></h4> <p>The entry price of stop orders can be configured using the argument <code>stop_entry_price</code>: it can take either the price itself, or any option from the enumerated type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.StopEntryPrice>StopEntryPrice</a>. To be able to distinguish between real prices and options, the options have a negative sign. By default, the entry price is the closing price, even if the entry order itself was filled before the closing price, such as at the opening price; this is because we cannot fill a stop order at the same bar as the entry order, that's why we're postponing the first check to the next bar. Let's see what happens if we define a stop order that can be executed already at the first bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span><span class=p>,</span>
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.005</span><span class=p>,</span>
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a><span class=gp>... </span>    <span class=n>stop_entry_price</span><span class=o>=</span><span class=s2>&quot;fillprice&quot;</span>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-88-9><a id=__codelineno-88-9 name=__codelineno-88-9 href=#__codelineno-88-9></a><span class=go>symbol                         BTCUSDT  ETHUSDT</span>
</span><span id=__span-88-10><a id=__codelineno-88-10 name=__codelineno-88-10 href=#__codelineno-88-10></a><span class=go>Open time                                      </span>
</span><span id=__span-88-11><a id=__codelineno-88-11 name=__codelineno-88-11 href=#__codelineno-88-11></a><span class=go>2021-02-18 00:00:00+00:00  52117.67000  1849.70</span>
</span><span id=__span-88-12><a id=__codelineno-88-12 name=__codelineno-88-12 href=#__codelineno-88-12></a><span class=go>2021-02-19 00:00:00+00:00  52378.25835  1938.91</span>
</span><span id=__span-88-13><a id=__codelineno-88-13 name=__codelineno-88-13 href=#__codelineno-88-13></a><span class=go>2021-02-20 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-88-14><a id=__codelineno-88-14 name=__codelineno-88-14 href=#__codelineno-88-14></a><span class=go>2021-02-21 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-88-15><a id=__codelineno-88-15 name=__codelineno-88-15 href=#__codelineno-88-15></a><span class=go>2021-02-22 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-88-16><a id=__codelineno-88-16 name=__codelineno-88-16 href=#__codelineno-88-16></a><span class=go>2021-02-23 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-88-17><a id=__codelineno-88-17 name=__codelineno-88-17 href=#__codelineno-88-17></a><span class=go>2021-02-24 00:00:00+00:00          NaN      NaN</span>
</span></code></pre></div> <p>As we can see, even though the target price <code>52378.26</code> could theoretically be filled at the first bar as it's lower than the highest price of <code>52530.00</code> of that bar, the check was still postponed to the next bar because of the <abbr title="From-signals simulation method">FS</abbr>'s limitation of one order per bar and asset.</p> <h4 id=exit-point>Exit point<a class=headerlink href=#exit-point title="Permanent link">&para;</a></h4> <p>The number of options to define a stop <strong>exit</strong> price is relatively small: the stop price and the closing price. If the stop has been matched at the beginning of a bar, the stop price will become the opening price. The same for the closing price. By default, a stop order is executed using the stop price, but if the entire simulation should be done on the closing prices only, the second option might be more appropriate.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
</span><span id=__span-89-5><a id=__codelineno-89-5 name=__codelineno-89-5 href=#__codelineno-89-5></a><span class=gp>... </span>    <span class=n>stop_exit_price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;stop&quot;</span><span class=p>,</span> <span class=s2>&quot;close&quot;</span><span class=p>])</span>
</span><span id=__span-89-6><a id=__codelineno-89-6 name=__codelineno-89-6 href=#__codelineno-89-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-89-7><a id=__codelineno-89-7 name=__codelineno-89-7 href=#__codelineno-89-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-89-8><a id=__codelineno-89-8 name=__codelineno-89-8 href=#__codelineno-89-8></a><span class=go>stop_exit_price                stop               close         </span>
</span><span id=__span-89-9><a id=__codelineno-89-9 name=__codelineno-89-9 href=#__codelineno-89-9></a><span class=go>symbol                      BTCUSDT    ETHUSDT  BTCUSDT  ETHUSDT</span>
</span><span id=__span-89-10><a id=__codelineno-89-10 name=__codelineno-89-10 href=#__codelineno-89-10></a><span class=go>Open time                                                       </span>
</span><span id=__span-89-11><a id=__codelineno-89-11 name=__codelineno-89-11 href=#__codelineno-89-11></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.6100  51552.6  1939.61</span>
</span><span id=__span-89-12><a id=__codelineno-89-12 name=__codelineno-89-12 href=#__codelineno-89-12></a><span class=go>2021-02-19 00:00:00+00:00  54130.23        NaN  55906.0      NaN</span>
</span><span id=__span-89-13><a id=__codelineno-89-13 name=__codelineno-89-13 href=#__codelineno-89-13></a><span class=go>2021-02-20 00:00:00+00:00       NaN  2036.5905      NaN  1913.00</span>
</span><span id=__span-89-14><a id=__codelineno-89-14 name=__codelineno-89-14 href=#__codelineno-89-14></a><span class=go>2021-02-21 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span><span id=__span-89-15><a id=__codelineno-89-15 name=__codelineno-89-15 href=#__codelineno-89-15></a><span class=go>2021-02-22 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span><span id=__span-89-16><a id=__codelineno-89-16 name=__codelineno-89-16 href=#__codelineno-89-16></a><span class=go>2021-02-23 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span><span id=__span-89-17><a id=__codelineno-89-17 name=__codelineno-89-17 href=#__codelineno-89-17></a><span class=go>2021-02-24 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span></code></pre></div> <p>This way, we're effectively delaying the execution of a stop order until the end of a bar. Not only we can change the default stop exit price, but also the default stop exit behavior: using the argument <code>stop_exit_type</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.StopExitType>StopExitType</a> we can reduce/reverse/reverse+reduce the position instead of closing it. By default, the position is being closed out by issuing an exit signal and disabling accumulation, but we can also reverse it by issuing an opposite entry signal and/or reduce it by keeping the default accumulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a><span class=gp>... </span>    <span class=n>stop_exit_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;close&quot;</span><span class=p>,</span> <span class=s2>&quot;reverse&quot;</span><span class=p>])</span>
</span><span id=__span-90-6><a id=__codelineno-90-6 name=__codelineno-90-6 href=#__codelineno-90-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-90-7><a id=__codelineno-90-7 name=__codelineno-90-7 href=#__codelineno-90-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-90-8><a id=__codelineno-90-8 name=__codelineno-90-8 href=#__codelineno-90-8></a><span class=go>stop_exit_type                 close                reverse           </span>
</span><span id=__span-90-9><a id=__codelineno-90-9 name=__codelineno-90-9 href=#__codelineno-90-9></a><span class=go>symbol                       BTCUSDT    ETHUSDT     BTCUSDT    ETHUSDT</span>
</span><span id=__span-90-10><a id=__codelineno-90-10 name=__codelineno-90-10 href=#__codelineno-90-10></a><span class=go>Open time                                                             </span>
</span><span id=__span-90-11><a id=__codelineno-90-11 name=__codelineno-90-11 href=#__codelineno-90-11></a><span class=go>2021-02-18 00:00:00+00:00  51552.600  1939.6100  51552.6000  1939.6100</span>
</span><span id=__span-90-12><a id=__codelineno-90-12 name=__codelineno-90-12 href=#__codelineno-90-12></a><span class=go>2021-02-19 00:00:00+00:00  52068.126  1959.0061  52068.1260  1959.0061</span>
</span><span id=__span-90-13><a id=__codelineno-90-13 name=__codelineno-90-13 href=#__codelineno-90-13></a><span class=go>2021-02-20 00:00:00+00:00        NaN        NaN  55346.9400  1935.4500</span>
</span><span id=__span-90-14><a id=__codelineno-90-14 name=__codelineno-90-14 href=#__codelineno-90-14></a><span class=go>2021-02-21 00:00:00+00:00        NaN        NaN  56399.6019  1932.1300</span>
</span><span id=__span-90-15><a id=__codelineno-90-15 name=__codelineno-90-15 href=#__codelineno-90-15></a><span class=go>2021-02-22 00:00:00+00:00        NaN        NaN  56834.4843  1914.1947</span>
</span><span id=__span-90-16><a id=__codelineno-90-16 name=__codelineno-90-16 href=#__codelineno-90-16></a><span class=go>2021-02-23 00:00:00+00:00        NaN        NaN         NaN        NaN</span>
</span><span id=__span-90-17><a id=__codelineno-90-17 name=__codelineno-90-17 href=#__codelineno-90-17></a><span class=go>2021-02-24 00:00:00+00:00        NaN        NaN         NaN        NaN</span>
</span></code></pre></div> <ol> <li><abbr title="Take profit">TP</abbr> of 1%</li> </ol> <p>Take a look at both columns under the parameter value <code>reverse</code>: they now have five orders instead of two, how so? By reversing, we're closing the existing position and opening a new one but in the opposite direction, using a single order. Opening a new position will create a new stop order, thus we've created a never-ending cycle of conditional reversals <img alt=😬 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f62c.svg title=:grimacing:> If such a cycle is unwanted, we can define <code>stop_exit_type</code> as an array where only a particular stop is closed or reversed. Each value in this array should be located at the entry point rather than exit point because this information (along with <code>stop_exit_price</code>) is order-anchored and not date-anchored! For example, let's reverse the first order only:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a><span class=gp>... </span>    <span class=n>stop_exit_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=s2>&quot;reverse&quot;</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=s2>&quot;close&quot;</span><span class=p>})</span>
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6 href=#__codelineno-91-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7 href=#__codelineno-91-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8 href=#__codelineno-91-8></a><span class=go>symbol                       BTCUSDT    ETHUSDT</span>
</span><span id=__span-91-9><a id=__codelineno-91-9 name=__codelineno-91-9 href=#__codelineno-91-9></a><span class=go>Open time                                      </span>
</span><span id=__span-91-10><a id=__codelineno-91-10 name=__codelineno-91-10 href=#__codelineno-91-10></a><span class=go>2021-02-18 00:00:00+00:00  51552.600  1939.6100</span>
</span><span id=__span-91-11><a id=__codelineno-91-11 name=__codelineno-91-11 href=#__codelineno-91-11></a><span class=go>2021-02-19 00:00:00+00:00  52068.126  1959.0061</span>
</span><span id=__span-91-12><a id=__codelineno-91-12 name=__codelineno-91-12 href=#__codelineno-91-12></a><span class=go>2021-02-20 00:00:00+00:00  55346.940  1935.4500</span>
</span><span id=__span-91-13><a id=__codelineno-91-13 name=__codelineno-91-13 href=#__codelineno-91-13></a><span class=go>2021-02-21 00:00:00+00:00        NaN        NaN</span>
</span><span id=__span-91-14><a id=__codelineno-91-14 name=__codelineno-91-14 href=#__codelineno-91-14></a><span class=go>2021-02-22 00:00:00+00:00        NaN        NaN</span>
</span><span id=__span-91-15><a id=__codelineno-91-15 name=__codelineno-91-15 href=#__codelineno-91-15></a><span class=go>2021-02-23 00:00:00+00:00        NaN        NaN</span>
</span><span id=__span-91-16><a id=__codelineno-91-16 name=__codelineno-91-16 href=#__codelineno-91-16></a><span class=go>2021-02-24 00:00:00+00:00        NaN        NaN</span>
</span></code></pre></div> <p>The first position was reversed while the second position only exited.</p> <p>What about order type? Upon exit, the order type becomes either a market or limit order. This behavior is controlled by the argument <code>stop_order_type</code> of the type <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OrderType>OrderType</a>. There is also an argument <code>stop_limit_delta</code> to specify a delta for the resulting limit order! Let's test a 5% <abbr title="Take profit">TP</abbr> order as a stop market order vs. stop limit order with a delta of 1%:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2 href=#__codelineno-92-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3 href=#__codelineno-92-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4 href=#__codelineno-92-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5 href=#__codelineno-92-5></a><span class=gp>... </span>    <span class=n>stop_order_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;market&quot;</span><span class=p>,</span> <span class=s2>&quot;limit&quot;</span><span class=p>]),</span>
</span><span id=__span-92-6><a id=__codelineno-92-6 name=__codelineno-92-6 href=#__codelineno-92-6></a><span class=gp>... </span>    <span class=n>stop_limit_delta</span><span class=o>=</span><span class=mf>0.01</span>
</span><span id=__span-92-7><a id=__codelineno-92-7 name=__codelineno-92-7 href=#__codelineno-92-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-92-8><a id=__codelineno-92-8 name=__codelineno-92-8 href=#__codelineno-92-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-92-9><a id=__codelineno-92-9 name=__codelineno-92-9 href=#__codelineno-92-9></a><span class=go>stop_order_type              market                  limit         </span>
</span><span id=__span-92-10><a id=__codelineno-92-10 name=__codelineno-92-10 href=#__codelineno-92-10></a><span class=go>symbol                      BTCUSDT    ETHUSDT     BTCUSDT  ETHUSDT</span>
</span><span id=__span-92-11><a id=__codelineno-92-11 name=__codelineno-92-11 href=#__codelineno-92-11></a><span class=go>Open time                                                          </span>
</span><span id=__span-92-12><a id=__codelineno-92-12 name=__codelineno-92-12 href=#__codelineno-92-12></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.6100  51552.6000  1939.61</span>
</span><span id=__span-92-13><a id=__codelineno-92-13 name=__codelineno-92-13 href=#__codelineno-92-13></a><span class=go>2021-02-19 00:00:00+00:00  54130.23        NaN  54671.5323      NaN</span>
</span><span id=__span-92-14><a id=__codelineno-92-14 name=__codelineno-92-14 href=#__codelineno-92-14></a><span class=go>2021-02-20 00:00:00+00:00       NaN  2036.5905         NaN      NaN</span>
</span><span id=__span-92-15><a id=__codelineno-92-15 name=__codelineno-92-15 href=#__codelineno-92-15></a><span class=go>2021-02-21 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span><span id=__span-92-16><a id=__codelineno-92-16 name=__codelineno-92-16 href=#__codelineno-92-16></a><span class=go>2021-02-22 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span><span id=__span-92-17><a id=__codelineno-92-17 name=__codelineno-92-17 href=#__codelineno-92-17></a><span class=go>2021-02-23 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span><span id=__span-92-18><a id=__codelineno-92-18 name=__codelineno-92-18 href=#__codelineno-92-18></a><span class=go>2021-02-24 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span></code></pre></div> <p>The latest stop limit order couldn't be filled because the highest price in the entire column <code>ETHUSDT</code> is <code>2042.34</code> while the requested limit price is <code>1939.61 * 1.05 * 1.01 = 2056.96</code>. But even if there was a price higher on the 20th February: unless the stop price was triggered at open, the simulator wouldn't be able to use the entire candle to match the limit price because there is no intra-bar data to prove that the limit price can be hit strictly after the stop price. The only information the simulator could have used in this case is the closing price: only if it was higher than the limit price, there would be a guarantee that the limit price has actually been hit.</p> <h4 id=conflicts_2>Conflicts<a class=headerlink href=#conflicts_2 title="Permanent link">&para;</a></h4> <p>Conflicts between stops orders and user-defined signals enjoy the same resolution logic as limit orders, the only difference is in the argument naming: <code>upon_adj_stop_conflict</code> and <code>upon_opp_stop_conflict</code>. By default, whenever a user-defined signal in any direction is encountered, nothing happens: any stop order remains pending and the signal gets executed as usual; that's because pending stop orders are automatically cancelled whenever the position gets closed out. Let's cancel any signal when there is a stop order pending:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3 href=#__codelineno-93-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4 href=#__codelineno-93-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5 href=#__codelineno-93-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;both&quot;</span><span class=p>,</span>
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6 href=#__codelineno-93-6></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7 href=#__codelineno-93-7></a><span class=gp>... </span>    <span class=n>upon_adj_stop_conflict</span><span class=o>=</span><span class=s2>&quot;keepignore&quot;</span><span class=p>,</span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8 href=#__codelineno-93-8></a><span class=gp>... </span>    <span class=n>upon_opp_stop_conflict</span><span class=o>=</span><span class=s2>&quot;keepignore&quot;</span><span class=p>,</span>
</span><span id=__span-93-9><a id=__codelineno-93-9 name=__codelineno-93-9 href=#__codelineno-93-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-93-10><a id=__codelineno-93-10 name=__codelineno-93-10 href=#__codelineno-93-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-93-11><a id=__codelineno-93-11 name=__codelineno-93-11 href=#__codelineno-93-11></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-93-12><a id=__codelineno-93-12 name=__codelineno-93-12 href=#__codelineno-93-12></a><span class=go>Open time                                    </span>
</span><span id=__span-93-13><a id=__codelineno-93-13 name=__codelineno-93-13 href=#__codelineno-93-13></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.610</span>
</span><span id=__span-93-14><a id=__codelineno-93-14 name=__codelineno-93-14 href=#__codelineno-93-14></a><span class=go>2021-02-19 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-93-15><a id=__codelineno-93-15 name=__codelineno-93-15 href=#__codelineno-93-15></a><span class=go>2021-02-20 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-93-16><a id=__codelineno-93-16 name=__codelineno-93-16 href=#__codelineno-93-16></a><span class=go>2021-02-21 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-93-17><a id=__codelineno-93-17 name=__codelineno-93-17 href=#__codelineno-93-17></a><span class=go>2021-02-22 00:00:00+00:00       NaN  1745.649</span>
</span><span id=__span-93-18><a id=__codelineno-93-18 name=__codelineno-93-18 href=#__codelineno-93-18></a><span class=go>2021-02-23 00:00:00+00:00  46397.34  1577.890</span>
</span><span id=__span-93-19><a id=__codelineno-93-19 name=__codelineno-93-19 href=#__codelineno-93-19></a><span class=go>2021-02-24 00:00:00+00:00  49676.20       NaN</span>
</span></code></pre></div> <h4 id=adjustment_1>Adjustment<a class=headerlink href=#adjustment_1 title="Permanent link">&para;</a></h4> <p>Similarly to limit orders, stop orders are also stored in one-dimensional record arrays where information is laid out per column: <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext.last_sl_info>SignalContext.last_sl_info</a> for <abbr title="Stop loss">SL</abbr>, <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext.last_tsl_info>SignalContext.last_tsl_info</a> for <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr>, and <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext.last_tp_info>SignalContext.last_tp_info</a> for <abbr title="Take profit">TP</abbr>. For instance, create an adjustment function that creates one <abbr title="Take profit">TP</abbr> and one <abbr title="Stop loss">SL</abbr> order based on a maximum allowed, absolute, parameterizable profit and loss (PnL):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>max_loss</span><span class=p>,</span> <span class=n>max_profit</span><span class=p>):</span>
</span><span id=__span-94-3><a id=__codelineno-94-3 name=__codelineno-94-3 href=#__codelineno-94-3></a><span class=gp>... </span>    <span class=n>position_now</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-94-4><a id=__codelineno-94-4 name=__codelineno-94-4 href=#__codelineno-94-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>position_now</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-94-5><a id=__codelineno-94-5 name=__codelineno-94-5 href=#__codelineno-94-5></a><span class=gp>... </span>        <span class=n>sl_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-94-6><a id=__codelineno-94-6 name=__codelineno-94-6 href=#__codelineno-94-6></a><span class=gp>... </span>        <span class=n>tp_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_tp_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-94-7><a id=__codelineno-94-7 name=__codelineno-94-7 href=#__codelineno-94-7></a><span class=gp>... </span>        <span class=n>ml</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>max_loss</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-94-8><a id=__codelineno-94-8 name=__codelineno-94-8 href=#__codelineno-94-8></a><span class=gp>... </span>        <span class=n>mp</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>max_profit</span><span class=p>)</span>
</span><span id=__span-94-9><a id=__codelineno-94-9 name=__codelineno-94-9 href=#__codelineno-94-9></a><span class=gp>...</span>
</span><span id=__span-94-10><a id=__codelineno-94-10 name=__codelineno-94-10 href=#__codelineno-94-10></a><span class=gp>... </span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_active_nb</span><span class=p>(</span><span class=n>sl_info</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-94-11><a id=__codelineno-94-11 name=__codelineno-94-11 href=#__codelineno-94-11></a><span class=gp>... </span>            <span class=n>sl_info</span><span class=o>.</span><span class=n>stop</span> <span class=o>=</span> <span class=n>ml</span> <span class=o>/</span> <span class=p>(</span><span class=n>sl_info</span><span class=o>.</span><span class=n>init_price</span> <span class=o>*</span> <span class=n>position_now</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-94-12><a id=__codelineno-94-12 name=__codelineno-94-12 href=#__codelineno-94-12></a><span class=gp>... </span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_active_nb</span><span class=p>(</span><span class=n>tp_info</span><span class=p>):</span>
</span><span id=__span-94-13><a id=__codelineno-94-13 name=__codelineno-94-13 href=#__codelineno-94-13></a><span class=gp>... </span>            <span class=n>tp_info</span><span class=o>.</span><span class=n>stop</span> <span class=o>=</span> <span class=n>mp</span> <span class=o>/</span> <span class=p>(</span><span class=n>sl_info</span><span class=o>.</span><span class=n>init_price</span> <span class=o>*</span> <span class=n>position_now</span><span class=p>)</span>
</span><span id=__span-94-14><a id=__codelineno-94-14 name=__codelineno-94-14 href=#__codelineno-94-14></a>
</span><span id=__span-94-15><a id=__codelineno-94-15 name=__codelineno-94-15 href=#__codelineno-94-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-94-16><a id=__codelineno-94-16 name=__codelineno-94-16 href=#__codelineno-94-16></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-94-17><a id=__codelineno-94-17 name=__codelineno-94-17 href=#__codelineno-94-17></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-94-18><a id=__codelineno-94-18 name=__codelineno-94-18 href=#__codelineno-94-18></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-94-19><a id=__codelineno-94-19 name=__codelineno-94-19 href=#__codelineno-94-19></a><span class=gp>... </span>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;max_loss&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;max_profit&quot;</span><span class=p>)),</span>
</span><span id=__span-94-20><a id=__codelineno-94-20 name=__codelineno-94-20 href=#__codelineno-94-20></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-94-21><a id=__codelineno-94-21 name=__codelineno-94-21 href=#__codelineno-94-21></a><span class=gp>... </span>        <span class=n>max_loss</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-94-22><a id=__codelineno-94-22 name=__codelineno-94-22 href=#__codelineno-94-22></a><span class=gp>... </span>        <span class=n>max_profit</span><span class=o>=</span><span class=mi>10</span>
</span><span id=__span-94-23><a id=__codelineno-94-23 name=__codelineno-94-23 href=#__codelineno-94-23></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-94-24><a id=__codelineno-94-24 name=__codelineno-94-24 href=#__codelineno-94-24></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-94-25><a id=__codelineno-94-25 name=__codelineno-94-25 href=#__codelineno-94-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>exit_trades</span><span class=o>.</span><span class=n>pnl</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>  <span class=c1># (6)!</span>
</span><span id=__span-94-26><a id=__codelineno-94-26 name=__codelineno-94-26 href=#__codelineno-94-26></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-94-27><a id=__codelineno-94-27 name=__codelineno-94-27 href=#__codelineno-94-27></a><span class=go>Open time                                  </span>
</span><span id=__span-94-28><a id=__codelineno-94-28 name=__codelineno-94-28 href=#__codelineno-94-28></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-94-29><a id=__codelineno-94-29 name=__codelineno-94-29 href=#__codelineno-94-29></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-94-30><a id=__codelineno-94-30 name=__codelineno-94-30 href=#__codelineno-94-30></a><span class=go>2021-02-20 00:00:00+00:00     10.0      NaN</span>
</span><span id=__span-94-31><a id=__codelineno-94-31 name=__codelineno-94-31 href=#__codelineno-94-31></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-94-32><a id=__codelineno-94-32 name=__codelineno-94-32 href=#__codelineno-94-32></a><span class=go>2021-02-22 00:00:00+00:00      NaN    -10.0</span>
</span><span id=__span-94-33><a id=__codelineno-94-33 name=__codelineno-94-33 href=#__codelineno-94-33></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-94-34><a id=__codelineno-94-34 name=__codelineno-94-34 href=#__codelineno-94-34></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Get the size of the current position. Remember that fields that are not associated with cash are accessible via column!</li> <li>We're in the market when the position is not zero</li> <li>Our parameters broadcast against the data, thus we need to select the current element flexibly</li> <li>There is a handy function <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.is_stop_info_active_nb>is_stop_info_active_nb</a> to check whether the current stop information record is active (i.e., the stop value is not NaN)</li> <li>Divide the maximum loss/profit by the notional value to get the optimal stop loss/take profit</li> <li>Get PnL of each trade as a time series</li> </ol> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>To avoid re-compiling the entire simulation function with each new run, define the adjustment function in a different cell or even file. Caching won't help though since Numba doesn't allow for caching callbacks.</p> </div> <p>Our losses and profits are now capped by $10! Here's what happened. Whenever we provide a custom adjustment function or any other callback, the simulator switches to the flexible mode and enables stop orders. Then, whenever a new position is opened or an existing one is increased, the simulator initializes each stop type with the provided arguments. But since we haven't passed anything related to <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr>, their default stop value is NaN, thus they are inactive by default. But regardless of that, they still contain valuable information, such as the initial price. Hence, what's left for us is just to check whether the respective stop is inactive and override the stop value to activate it. We could have also used the functions <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.set_sl_info_nb>set_sl_info_nb</a> and <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.set_tp_info_nb>set_tp_info_nb</a> to set the entire information, but there was no need for that.</p> <h4 id=laddering>Laddering <img alt=🪜 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1fa9c.svg title=:ladder:><a class=headerlink href=#laddering title="Permanent link">&para;</a></h4> <p>We know how to define a single stop to close out an entire position, but what about moving out of a position gradually? For this, we need a way to provide multiple stop values. But there is a problem: the stop arguments should broadcast together with other broadcastable arguments, that is, when providing (for example) <code>tp_stop</code> as an array, the first axis should represent time and the second axis should represent columns. But thanks to a new single-axis broadcasting feature, we can notify the broadcaster that the array's rows don't represent time but something completely different.</p> <p>On practice, <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> has an argument <code>stop_ladder</code>, which when enabled can switch to single-axis broadcasting such that providing a list (or one-dimensional array) of values will be considered as a single ladder. We can also provide a two-dimensional array to specify the ladder for each single column.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Enabling this argument makes <strong>all</strong> stop arguments behave like ladders - there's no way we can make one argument to be a ladder series and another argument to be a time series! Also, the argument <code>stop_ladder</code> is affective on all columns and cannot be provided per column.</p> </div> <p>In a ladder, each value represents a step with a stop value. Just like in real-world ladders, steps must be ordered from low to high such that a step is executed only after the previous one has been executed first. There's no limit on the number of steps. Let's enable laddering through the argument <code>stop_ladder</code> and build our first <abbr title="Take profit">TP</abbr> ladder with two values: 1% and 5%.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-95-4><a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-95-5><a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>]</span>
</span><span id=__span-95-6><a id=__codelineno-95-6 name=__codelineno-95-6 href=#__codelineno-95-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-95-7><a id=__codelineno-95-7 name=__codelineno-95-7 href=#__codelineno-95-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-95-8><a id=__codelineno-95-8 name=__codelineno-95-8 href=#__codelineno-95-8></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-95-9><a id=__codelineno-95-9 name=__codelineno-95-9 href=#__codelineno-95-9></a><span class=go>Open time                                   </span>
</span><span id=__span-95-10><a id=__codelineno-95-10 name=__codelineno-95-10 href=#__codelineno-95-10></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-95-11><a id=__codelineno-95-11 name=__codelineno-95-11 href=#__codelineno-95-11></a><span class=go>2021-02-19 00:00:00+00:00 -0.00097 -0.025778</span>
</span><span id=__span-95-12><a id=__codelineno-95-12 name=__codelineno-95-12 href=#__codelineno-95-12></a><span class=go>2021-02-20 00:00:00+00:00 -0.00097 -0.025778</span>
</span><span id=__span-95-13><a id=__codelineno-95-13 name=__codelineno-95-13 href=#__codelineno-95-13></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-95-14><a id=__codelineno-95-14 name=__codelineno-95-14 href=#__codelineno-95-14></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-95-15><a id=__codelineno-95-15 name=__codelineno-95-15 href=#__codelineno-95-15></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-95-16><a id=__codelineno-95-16 name=__codelineno-95-16 href=#__codelineno-95-16></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>Both ladder steps were successfully executed and removed an equal chunk of the position. By default, the exit size distribution of the steps is uniform - the exit size depends only on the number of steps. But what if we wanted remove an amount from the position that is proportional to the step size? Step size in this scenario is the difference of the current stop price and the previous stop price (step range), relative to the difference of the last stop price and the entry price (full range). For this, we can provide the argument <code>stop_ladder</code> with the value "weighted", which corresponds to the mode <code>StopLadderMode.Weighted</code> (for possible ladder modes see <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.StopLadderMode>StopLadderMode</a>):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=s2>&quot;weighted&quot;</span><span class=p>,</span>
</span><span id=__span-96-5><a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>]</span>
</span><span id=__span-96-6><a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-96-7><a id=__codelineno-96-7 name=__codelineno-96-7 href=#__codelineno-96-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-96-8><a id=__codelineno-96-8 name=__codelineno-96-8 href=#__codelineno-96-8></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-96-9><a id=__codelineno-96-9 name=__codelineno-96-9 href=#__codelineno-96-9></a><span class=go>Open time                                    </span>
</span><span id=__span-96-10><a id=__codelineno-96-10 name=__codelineno-96-10 href=#__codelineno-96-10></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-96-11><a id=__codelineno-96-11 name=__codelineno-96-11 href=#__codelineno-96-11></a><span class=go>2021-02-19 00:00:00+00:00 -0.000388 -0.010311</span>
</span><span id=__span-96-12><a id=__codelineno-96-12 name=__codelineno-96-12 href=#__codelineno-96-12></a><span class=go>2021-02-20 00:00:00+00:00 -0.001552 -0.041245</span>
</span><span id=__span-96-13><a id=__codelineno-96-13 name=__codelineno-96-13 href=#__codelineno-96-13></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-96-14><a id=__codelineno-96-14 name=__codelineno-96-14 href=#__codelineno-96-14></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-96-15><a id=__codelineno-96-15 name=__codelineno-96-15 href=#__codelineno-96-15></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-96-16><a id=__codelineno-96-16 name=__codelineno-96-16 href=#__codelineno-96-16></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>The first step removed <code>(0.01 - 0) / (0.05 - 0) = 20%</code> of the initial position while the second stop removed the remaining <code>(0.05 - 0.01) / (0.05 - 0) = 80%</code>.</p> <p>Let's say we want to have two parallel ladders: <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr>. What happens to the exit size distribution if both ladders are executed partially?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-97-3><a id=__codelineno-97-3 name=__codelineno-97-3 href=#__codelineno-97-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-97-4><a id=__codelineno-97-4 name=__codelineno-97-4 href=#__codelineno-97-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=s2>&quot;uniform&quot;</span><span class=p>,</span>
</span><span id=__span-97-5><a id=__codelineno-97-5 name=__codelineno-97-5 href=#__codelineno-97-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span>
</span><span id=__span-97-6><a id=__codelineno-97-6 name=__codelineno-97-6 href=#__codelineno-97-6></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>]</span>
</span><span id=__span-97-7><a id=__codelineno-97-7 name=__codelineno-97-7 href=#__codelineno-97-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-97-8><a id=__codelineno-97-8 name=__codelineno-97-8 href=#__codelineno-97-8></a>
</span><span id=__span-97-9><a id=__codelineno-97-9 name=__codelineno-97-9 href=#__codelineno-97-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>stop_type</span><span class=o>.</span><span class=n>to_pd</span><span class=p>(</span><span class=n>mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-97-10><a id=__codelineno-97-10 name=__codelineno-97-10 href=#__codelineno-97-10></a><span class=go>symbol                    BTCUSDT ETHUSDT</span>
</span><span id=__span-97-11><a id=__codelineno-97-11 name=__codelineno-97-11 href=#__codelineno-97-11></a><span class=go>Open time                                </span>
</span><span id=__span-97-12><a id=__codelineno-97-12 name=__codelineno-97-12 href=#__codelineno-97-12></a><span class=go>2021-02-18 00:00:00+00:00    None    None</span>
</span><span id=__span-97-13><a id=__codelineno-97-13 name=__codelineno-97-13 href=#__codelineno-97-13></a><span class=go>2021-02-19 00:00:00+00:00    None    None</span>
</span><span id=__span-97-14><a id=__codelineno-97-14 name=__codelineno-97-14 href=#__codelineno-97-14></a><span class=go>2021-02-20 00:00:00+00:00      TP      SL</span>
</span><span id=__span-97-15><a id=__codelineno-97-15 name=__codelineno-97-15 href=#__codelineno-97-15></a><span class=go>2021-02-21 00:00:00+00:00    None    None</span>
</span><span id=__span-97-16><a id=__codelineno-97-16 name=__codelineno-97-16 href=#__codelineno-97-16></a><span class=go>2021-02-22 00:00:00+00:00      SL      SL</span>
</span><span id=__span-97-17><a id=__codelineno-97-17 name=__codelineno-97-17 href=#__codelineno-97-17></a><span class=go>2021-02-23 00:00:00+00:00      SL      SL</span>
</span><span id=__span-97-18><a id=__codelineno-97-18 name=__codelineno-97-18 href=#__codelineno-97-18></a><span class=go>2021-02-24 00:00:00+00:00    None    None</span>
</span><span id=__span-97-19><a id=__codelineno-97-19 name=__codelineno-97-19 href=#__codelineno-97-19></a>
</span><span id=__span-97-20><a id=__codelineno-97-20 name=__codelineno-97-20 href=#__codelineno-97-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-97-21><a id=__codelineno-97-21 name=__codelineno-97-21 href=#__codelineno-97-21></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-97-22><a id=__codelineno-97-22 name=__codelineno-97-22 href=#__codelineno-97-22></a><span class=go>Open time                                    </span>
</span><span id=__span-97-23><a id=__codelineno-97-23 name=__codelineno-97-23 href=#__codelineno-97-23></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-97-24><a id=__codelineno-97-24 name=__codelineno-97-24 href=#__codelineno-97-24></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-97-25><a id=__codelineno-97-25 name=__codelineno-97-25 href=#__codelineno-97-25></a><span class=go>2021-02-20 00:00:00+00:00 -0.000970 -0.017186</span>
</span><span id=__span-97-26><a id=__codelineno-97-26 name=__codelineno-97-26 href=#__codelineno-97-26></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-97-27><a id=__codelineno-97-27 name=__codelineno-97-27 href=#__codelineno-97-27></a><span class=go>2021-02-22 00:00:00+00:00 -0.000647 -0.017186</span>
</span><span id=__span-97-28><a id=__codelineno-97-28 name=__codelineno-97-28 href=#__codelineno-97-28></a><span class=go>2021-02-23 00:00:00+00:00 -0.000323 -0.017186</span>
</span><span id=__span-97-29><a id=__codelineno-97-29 name=__codelineno-97-29 href=#__codelineno-97-29></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>We see that the first <abbr title="Take profit">TP</abbr> step in the column <code>BTCUSDT</code> removed the half of the position because there are only two steps in the <abbr title="Take profit">TP</abbr> ladder. But then an <abbr title="Stop loss">SL</abbr> step was hit and removed 33.3% of the initial position because there are three steps in the <abbr title="Stop loss">SL</abbr> ladder. The final step then removed the remainder of the position. But what if our intention is to move out of the position respective to the current position and not the initial one? If the position suddenly changed, the exit sizes would be redistributed based on this change. This can be done by providing <code>StopLadderMode.AdaptUniform</code> or <code>StopLadderMode.AdaptWeighted</code> mode:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-98-3><a id=__codelineno-98-3 name=__codelineno-98-3 href=#__codelineno-98-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-98-4><a id=__codelineno-98-4 name=__codelineno-98-4 href=#__codelineno-98-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=s2>&quot;adaptuniform&quot;</span><span class=p>,</span>
</span><span id=__span-98-5><a id=__codelineno-98-5 name=__codelineno-98-5 href=#__codelineno-98-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span>
</span><span id=__span-98-6><a id=__codelineno-98-6 name=__codelineno-98-6 href=#__codelineno-98-6></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>]</span>
</span><span id=__span-98-7><a id=__codelineno-98-7 name=__codelineno-98-7 href=#__codelineno-98-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-98-8><a id=__codelineno-98-8 name=__codelineno-98-8 href=#__codelineno-98-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>stop_type</span><span class=o>.</span><span class=n>to_pd</span><span class=p>(</span><span class=n>mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-98-9><a id=__codelineno-98-9 name=__codelineno-98-9 href=#__codelineno-98-9></a><span class=go>symbol                    BTCUSDT ETHUSDT</span>
</span><span id=__span-98-10><a id=__codelineno-98-10 name=__codelineno-98-10 href=#__codelineno-98-10></a><span class=go>Open time                                </span>
</span><span id=__span-98-11><a id=__codelineno-98-11 name=__codelineno-98-11 href=#__codelineno-98-11></a><span class=go>2021-02-18 00:00:00+00:00    None    None</span>
</span><span id=__span-98-12><a id=__codelineno-98-12 name=__codelineno-98-12 href=#__codelineno-98-12></a><span class=go>2021-02-19 00:00:00+00:00    None    None</span>
</span><span id=__span-98-13><a id=__codelineno-98-13 name=__codelineno-98-13 href=#__codelineno-98-13></a><span class=go>2021-02-20 00:00:00+00:00      TP      SL</span>
</span><span id=__span-98-14><a id=__codelineno-98-14 name=__codelineno-98-14 href=#__codelineno-98-14></a><span class=go>2021-02-21 00:00:00+00:00    None    None</span>
</span><span id=__span-98-15><a id=__codelineno-98-15 name=__codelineno-98-15 href=#__codelineno-98-15></a><span class=go>2021-02-22 00:00:00+00:00      SL      SL</span>
</span><span id=__span-98-16><a id=__codelineno-98-16 name=__codelineno-98-16 href=#__codelineno-98-16></a><span class=go>2021-02-23 00:00:00+00:00      SL      SL</span>
</span><span id=__span-98-17><a id=__codelineno-98-17 name=__codelineno-98-17 href=#__codelineno-98-17></a><span class=go>2021-02-24 00:00:00+00:00    None    None</span>
</span><span id=__span-98-18><a id=__codelineno-98-18 name=__codelineno-98-18 href=#__codelineno-98-18></a>
</span><span id=__span-98-19><a id=__codelineno-98-19 name=__codelineno-98-19 href=#__codelineno-98-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-98-20><a id=__codelineno-98-20 name=__codelineno-98-20 href=#__codelineno-98-20></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-98-21><a id=__codelineno-98-21 name=__codelineno-98-21 href=#__codelineno-98-21></a><span class=go>Open time                                    </span>
</span><span id=__span-98-22><a id=__codelineno-98-22 name=__codelineno-98-22 href=#__codelineno-98-22></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-98-23><a id=__codelineno-98-23 name=__codelineno-98-23 href=#__codelineno-98-23></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-98-24><a id=__codelineno-98-24 name=__codelineno-98-24 href=#__codelineno-98-24></a><span class=go>2021-02-20 00:00:00+00:00 -0.000970 -0.017186</span>
</span><span id=__span-98-25><a id=__codelineno-98-25 name=__codelineno-98-25 href=#__codelineno-98-25></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-98-26><a id=__codelineno-98-26 name=__codelineno-98-26 href=#__codelineno-98-26></a><span class=go>2021-02-22 00:00:00+00:00 -0.000323 -0.017186</span>
</span><span id=__span-98-27><a id=__codelineno-98-27 name=__codelineno-98-27 href=#__codelineno-98-27></a><span class=go>2021-02-23 00:00:00+00:00 -0.000323 -0.017186</span>
</span><span id=__span-98-28><a id=__codelineno-98-28 name=__codelineno-98-28 href=#__codelineno-98-28></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>The both <abbr title="Stop loss">SL</abbr> steps in the first column now remove exactly <code>1 / 3</code> of the new position and act as if they were created right after the position change by the first <abbr title="Take profit">TP</abbr> step.</p> <p>Now, let's illustrate how to specify a different ladder for a different column. For this, we need to construct a two-dimensional array. Since some ladders may have a smaller number of steps than the others, we need to pad them with NaN:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-99-2><a id=__codelineno-99-2 name=__codelineno-99-2 href=#__codelineno-99-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-99-3><a id=__codelineno-99-3 name=__codelineno-99-3 href=#__codelineno-99-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-99-4><a id=__codelineno-99-4 name=__codelineno-99-4 href=#__codelineno-99-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-99-5><a id=__codelineno-99-5 name=__codelineno-99-5 href=#__codelineno-99-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>column_stack</span><span class=p>((</span>
</span><span id=__span-99-6><a id=__codelineno-99-6 name=__codelineno-99-6 href=#__codelineno-99-6></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>]),</span>  <span class=c1># (1)!</span>
</span><span id=__span-99-7><a id=__codelineno-99-7 name=__codelineno-99-7 href=#__codelineno-99-7></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>])</span>  <span class=c1># (2)!</span>
</span><span id=__span-99-8><a id=__codelineno-99-8 name=__codelineno-99-8 href=#__codelineno-99-8></a><span class=gp>... </span>    <span class=p>))</span>
</span><span id=__span-99-9><a id=__codelineno-99-9 name=__codelineno-99-9 href=#__codelineno-99-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-99-10><a id=__codelineno-99-10 name=__codelineno-99-10 href=#__codelineno-99-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-99-11><a id=__codelineno-99-11 name=__codelineno-99-11 href=#__codelineno-99-11></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-99-12><a id=__codelineno-99-12 name=__codelineno-99-12 href=#__codelineno-99-12></a><span class=go>Open time                                   </span>
</span><span id=__span-99-13><a id=__codelineno-99-13 name=__codelineno-99-13 href=#__codelineno-99-13></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-99-14><a id=__codelineno-99-14 name=__codelineno-99-14 href=#__codelineno-99-14></a><span class=go>2021-02-19 00:00:00+00:00  0.00000 -0.017186</span>
</span><span id=__span-99-15><a id=__codelineno-99-15 name=__codelineno-99-15 href=#__codelineno-99-15></a><span class=go>2021-02-20 00:00:00+00:00 -0.00097 -0.017186</span>
</span><span id=__span-99-16><a id=__codelineno-99-16 name=__codelineno-99-16 href=#__codelineno-99-16></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-99-17><a id=__codelineno-99-17 name=__codelineno-99-17 href=#__codelineno-99-17></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-99-18><a id=__codelineno-99-18 name=__codelineno-99-18 href=#__codelineno-99-18></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-99-19><a id=__codelineno-99-19 name=__codelineno-99-19 href=#__codelineno-99-19></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <ol> <li>Gets applied on <code>BTCUSDT</code></li> <li>Gets applied on <code>ETHUSDT</code></li> </ol> <p>The padding step wouldn't be necessary if we provided the ladders as parameters:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-100-5><a id=__codelineno-100-5 name=__codelineno-100-5 href=#__codelineno-100-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-100-6><a id=__codelineno-100-6 name=__codelineno-100-6 href=#__codelineno-100-6></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>  <span class=c1># (1)!</span>
</span><span id=__span-100-7><a id=__codelineno-100-7 name=__codelineno-100-7 href=#__codelineno-100-7></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>])</span>  <span class=c1># (2)!</span>
</span><span id=__span-100-8><a id=__codelineno-100-8 name=__codelineno-100-8 href=#__codelineno-100-8></a><span class=gp>... </span>    <span class=p>])</span>
</span><span id=__span-100-9><a id=__codelineno-100-9 name=__codelineno-100-9 href=#__codelineno-100-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-100-10><a id=__codelineno-100-10 name=__codelineno-100-10 href=#__codelineno-100-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-100-11><a id=__codelineno-100-11 name=__codelineno-100-11 href=#__codelineno-100-11></a><span class=go>tp_stop                    array_0             array_1          </span>
</span><span id=__span-100-12><a id=__codelineno-100-12 name=__codelineno-100-12 href=#__codelineno-100-12></a><span class=go>symbol                     BTCUSDT   ETHUSDT   BTCUSDT   ETHUSDT</span>
</span><span id=__span-100-13><a id=__codelineno-100-13 name=__codelineno-100-13 href=#__codelineno-100-13></a><span class=go>Open time                                                       </span>
</span><span id=__span-100-14><a id=__codelineno-100-14 name=__codelineno-100-14 href=#__codelineno-100-14></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557  0.001940  0.051557</span>
</span><span id=__span-100-15><a id=__codelineno-100-15 name=__codelineno-100-15 href=#__codelineno-100-15></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000 -0.000647 -0.017186</span>
</span><span id=__span-100-16><a id=__codelineno-100-16 name=__codelineno-100-16 href=#__codelineno-100-16></a><span class=go>2021-02-20 00:00:00+00:00 -0.00097  0.000000 -0.000647 -0.017186</span>
</span><span id=__span-100-17><a id=__codelineno-100-17 name=__codelineno-100-17 href=#__codelineno-100-17></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000 -0.000647  0.000000</span>
</span><span id=__span-100-18><a id=__codelineno-100-18 name=__codelineno-100-18 href=#__codelineno-100-18></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000  0.000000  0.000000</span>
</span><span id=__span-100-19><a id=__codelineno-100-19 name=__codelineno-100-19 href=#__codelineno-100-19></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000  0.000000  0.000000</span>
</span><span id=__span-100-20><a id=__codelineno-100-20 name=__codelineno-100-20 href=#__codelineno-100-20></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000  0.000000  0.000000</span>
</span></code></pre></div> <ol> <li>Gets applied on both columns</li> <li>Gets applied on both columns</li> </ol> <p>Finally, let's discuss how to specify our own exit size for each ladder step. Since there are no arguments for specifying the exit size, we need change it inside an adjustment or signal function. Remember to use an adjustment function if you already have signal arrays, and a signal function if you generate your signals dynamically. Inside the callback, we need to 1) retrieve the current information record of the stop type we've defined the ladder for, 2) select the exit size corresponding to the current step (available via the record field <code>step</code>), and 3) write the exit size to the record. Once the step is hit, the user-defined exit size will used instead of the default one.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The default size and size type in any record are NaN and -1 respectively. Only once the step is hit, they will be internally replaced by the calculated values. Thus, you can check whether the ladder uses the default exit size by testing these fields against these values.</p> </div> <p>In the following example we go into a trade with 6 units, and then test two <abbr title="Take profit">TP</abbr> ladders: 1) remove 3 units at the level of 10% and the remaining 3 units at the level of 20%, and 2) remove 1 unit at the level of 1%, another 2 units at the level of 2%, and the remaining 3 units at the level of 3%.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-101-1><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-101-2><a id=__codelineno-101-2 name=__codelineno-101-2 href=#__codelineno-101-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exit_size</span><span class=p>,</span> <span class=n>exit_size_type</span><span class=p>):</span>
</span><span id=__span-101-3><a id=__codelineno-101-3 name=__codelineno-101-3 href=#__codelineno-101-3></a><span class=gp>... </span>    <span class=n>tp_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_tp_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-101-4><a id=__codelineno-101-4 name=__codelineno-101-4 href=#__codelineno-101-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_ladder_active_nb</span><span class=p>(</span><span class=n>tp_info</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-101-5><a id=__codelineno-101-5 name=__codelineno-101-5 href=#__codelineno-101-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>tp_info</span><span class=o>.</span><span class=n>exit_size</span><span class=p>):</span>  <span class=c1># (2)!</span>
</span><span id=__span-101-6><a id=__codelineno-101-6 name=__codelineno-101-6 href=#__codelineno-101-6></a><span class=gp>... </span>            <span class=n>tp_info</span><span class=o>.</span><span class=n>exit_size</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exit_size</span><span class=p>,</span> <span class=n>i</span><span class=o>=</span><span class=n>tp_info</span><span class=o>.</span><span class=n>step</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-101-7><a id=__codelineno-101-7 name=__codelineno-101-7 href=#__codelineno-101-7></a><span class=gp>... </span>            <span class=n>tp_info</span><span class=o>.</span><span class=n>exit_size_type</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exit_size_type</span><span class=p>,</span> <span class=n>i</span><span class=o>=</span><span class=n>tp_info</span><span class=o>.</span><span class=n>step</span><span class=p>)</span>
</span><span id=__span-101-8><a id=__codelineno-101-8 name=__codelineno-101-8 href=#__codelineno-101-8></a>
</span><span id=__span-101-9><a id=__codelineno-101-9 name=__codelineno-101-9 href=#__codelineno-101-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-101-10><a id=__codelineno-101-10 name=__codelineno-101-10 href=#__codelineno-101-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-101-11><a id=__codelineno-101-11 name=__codelineno-101-11 href=#__codelineno-101-11></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-101-12><a id=__codelineno-101-12 name=__codelineno-101-12 href=#__codelineno-101-12></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-101-13><a id=__codelineno-101-13 name=__codelineno-101-13 href=#__codelineno-101-13></a><span class=gp>... </span>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exit_size&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exit_size_type&quot;</span><span class=p>)),</span>  <span class=c1># (4)!</span>
</span><span id=__span-101-14><a id=__codelineno-101-14 name=__codelineno-101-14 href=#__codelineno-101-14></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-101-15><a id=__codelineno-101-15 name=__codelineno-101-15 href=#__codelineno-101-15></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-101-16><a id=__codelineno-101-16 name=__codelineno-101-16 href=#__codelineno-101-16></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>
</span><span id=__span-101-17><a id=__codelineno-101-17 name=__codelineno-101-17 href=#__codelineno-101-17></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>])</span>
</span><span id=__span-101-18><a id=__codelineno-101-18 name=__codelineno-101-18 href=#__codelineno-101-18></a><span class=gp>... </span>    <span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>  <span class=c1># (5)!</span>
</span><span id=__span-101-19><a id=__codelineno-101-19 name=__codelineno-101-19 href=#__codelineno-101-19></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-101-20><a id=__codelineno-101-20 name=__codelineno-101-20 href=#__codelineno-101-20></a><span class=gp>... </span>        <span class=n>exit_size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>BCO</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-101-21><a id=__codelineno-101-21 name=__codelineno-101-21 href=#__codelineno-101-21></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-101-22><a id=__codelineno-101-22 name=__codelineno-101-22 href=#__codelineno-101-22></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>]),</span>
</span><span id=__span-101-23><a id=__codelineno-101-23 name=__codelineno-101-23 href=#__codelineno-101-23></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
</span><span id=__span-101-24><a id=__codelineno-101-24 name=__codelineno-101-24 href=#__codelineno-101-24></a><span class=gp>... </span>            <span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>hide</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>  <span class=c1># (7)!</span>
</span><span id=__span-101-25><a id=__codelineno-101-25 name=__codelineno-101-25 href=#__codelineno-101-25></a><span class=gp>... </span>            <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-101-26><a id=__codelineno-101-26 name=__codelineno-101-26 href=#__codelineno-101-26></a><span class=gp>... </span>            <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-101-27><a id=__codelineno-101-27 name=__codelineno-101-27 href=#__codelineno-101-27></a><span class=gp>... </span>                <span class=n>reset_index</span><span class=o>=</span><span class=s2>&quot;from_start&quot;</span><span class=p>,</span> 
</span><span id=__span-101-28><a id=__codelineno-101-28 name=__codelineno-101-28 href=#__codelineno-101-28></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-101-29><a id=__codelineno-101-29 name=__codelineno-101-29 href=#__codelineno-101-29></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-101-30><a id=__codelineno-101-30 name=__codelineno-101-30 href=#__codelineno-101-30></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-101-31><a id=__codelineno-101-31 name=__codelineno-101-31 href=#__codelineno-101-31></a><span class=gp>... </span>        <span class=n>exit_size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>BCO</span><span class=p>(</span>
</span><span id=__span-101-32><a id=__codelineno-101-32 name=__codelineno-101-32 href=#__codelineno-101-32></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>Amount</span><span class=p>,</span>  <span class=c1># (9)!</span>
</span><span id=__span-101-33><a id=__codelineno-101-33 name=__codelineno-101-33 href=#__codelineno-101-33></a><span class=gp>... </span>            <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-101-34><a id=__codelineno-101-34 name=__codelineno-101-34 href=#__codelineno-101-34></a><span class=gp>... </span>            <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-101-35><a id=__codelineno-101-35 name=__codelineno-101-35 href=#__codelineno-101-35></a><span class=gp>... </span>                <span class=n>reset_index</span><span class=o>=</span><span class=s2>&quot;from_start&quot;</span><span class=p>,</span> 
</span><span id=__span-101-36><a id=__codelineno-101-36 name=__codelineno-101-36 href=#__codelineno-101-36></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-101-37><a id=__codelineno-101-37 name=__codelineno-101-37 href=#__codelineno-101-37></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-101-38><a id=__codelineno-101-38 name=__codelineno-101-38 href=#__codelineno-101-38></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-101-39><a id=__codelineno-101-39 name=__codelineno-101-39 href=#__codelineno-101-39></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-101-40><a id=__codelineno-101-40 name=__codelineno-101-40 href=#__codelineno-101-40></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span>
</span><span id=__span-101-41><a id=__codelineno-101-41 name=__codelineno-101-41 href=#__codelineno-101-41></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-101-42><a id=__codelineno-101-42 name=__codelineno-101-42 href=#__codelineno-101-42></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-101-43><a id=__codelineno-101-43 name=__codelineno-101-43 href=#__codelineno-101-43></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-101-44><a id=__codelineno-101-44 name=__codelineno-101-44 href=#__codelineno-101-44></a><span class=go>tp_stop                   array_0         array_1        </span>
</span><span id=__span-101-45><a id=__codelineno-101-45 name=__codelineno-101-45 href=#__codelineno-101-45></a><span class=go>symbol                    BTCUSDT ETHUSDT BTCUSDT ETHUSDT</span>
</span><span id=__span-101-46><a id=__codelineno-101-46 name=__codelineno-101-46 href=#__codelineno-101-46></a><span class=go>Open time                                                </span>
</span><span id=__span-101-47><a id=__codelineno-101-47 name=__codelineno-101-47 href=#__codelineno-101-47></a><span class=go>2021-02-18 00:00:00+00:00     6.0     6.0     6.0     6.0</span>
</span><span id=__span-101-48><a id=__codelineno-101-48 name=__codelineno-101-48 href=#__codelineno-101-48></a><span class=go>2021-02-19 00:00:00+00:00     0.0     0.0    -1.0    -1.0</span>
</span><span id=__span-101-49><a id=__codelineno-101-49 name=__codelineno-101-49 href=#__codelineno-101-49></a><span class=go>2021-02-20 00:00:00+00:00    -3.0     0.0    -2.0    -2.0</span>
</span><span id=__span-101-50><a id=__codelineno-101-50 name=__codelineno-101-50 href=#__codelineno-101-50></a><span class=go>2021-02-21 00:00:00+00:00     0.0     0.0    -3.0     0.0</span>
</span><span id=__span-101-51><a id=__codelineno-101-51 name=__codelineno-101-51 href=#__codelineno-101-51></a><span class=go>2021-02-22 00:00:00+00:00     0.0     0.0     0.0     0.0</span>
</span><span id=__span-101-52><a id=__codelineno-101-52 name=__codelineno-101-52 href=#__codelineno-101-52></a><span class=go>2021-02-23 00:00:00+00:00     0.0     0.0     0.0     0.0</span>
</span><span id=__span-101-53><a id=__codelineno-101-53 name=__codelineno-101-53 href=#__codelineno-101-53></a><span class=go>2021-02-24 00:00:00+00:00     0.0     0.0     0.0     0.0</span>
</span></code></pre></div> <ol> <li>Check whether the <abbr title="Take profit">TP</abbr> ladder is active using <a href=../../../api/portfolio/nb/from_signals/index.html#vectorbtpro.portfolio.nb.from_signals.is_stop_info_ladder_active_nb>is_stop_info_ladder_active_nb</a></li> <li>We want to override the exit size and type only once per step; if the exit size is not NaN, then it has already been overridden.</li> <li>Since the exit size and type arrays at least partially broadcast against the target shape, we can use <a href=../../../api/portfolio/nb/iter_/index.html#vectorbtpro.portfolio.nb.iter_.select_nb>select_nb</a> by providing the current step as <code>i</code></li> <li>Exit size and type are passed to <code>broadcast_named_args</code>. These templates are then substituted by the actual arrays once the broadcasting is over.</li> <li>Specify the same level to avoid building the product between <code>tp_stop</code>, <code>exit_size</code>, and <code>exit_size_type</code>. This way, the three parameters will be considered as a single parameter.</li> <li>Exit size and type must broadcast in the same way as our ladders, thus use <a href=../../../api/base/reshaping/index.html#vectorbtpro.base.reshaping.BCO>BCO</a> to change the default behavior</li> <li>We should provide the exit size in an adentical fashion to <code>tp_stop</code>. Additionally, we'll hide the parameter from the final columns as it's redundant.</li> <li>These keyword arguments are required if parameter arrays have different shapes. In this case, smaller arrays will be padded with NaN to match the length of the longest array.</li> <li>In our example, the size type is the same for all sizes, thus we can just use a single value here</li> </ol> <h3 id=dynamic>Dynamic<a class=headerlink href=#dynamic title="Permanent link">&para;</a></h3> <p>We've learned that order-related arguments such as <code>size</code> act as a facade of the backtesting process with <abbr title="From-signals simulation method">FS</abbr>: they are meant to be anchored by time rather than signals, so we cannot change them dynamically. This is proved by the fact that any signal function (<code>signal_func_nb</code>) returns only signals and nothing else. But what if a signal needs to have a size or other order information different from the default one? </p> <p>Remember that vectorbt takes order information as arrays and processes them iteratively: it goes through each row and column, reads the current element, and uses this element along with the returned signals. Theoretically, if we override the current element in the signal function, vectorbt should pick it and use it as new order information! The only question is how to get access to the respective array if context (<code>c</code>) doesn't list it? Use templates! For example, by passing <code>vbt.Rep("size")</code> in <code>signal_args</code>, the method will search for a variable called <code>size</code> in its template context and pass it to the signal function. Conveniently for us, the template context contains all the information passed to the method, including the order-related arguments.</p> <p>But there is a catch: to avoid consuming too much memory, vectorbt keeps most array-like arguments as two-dimensional arrays with only one element and uses flexible indexing (see <a href=../../fundamentals/index.html#flexible-indexing>this</a> and <a href=../index.html#flexible-indexing>this</a>) to select that one element at each single row and column. That is, we either have to tell the broadcaster to build the full array and then override each element (<code>arr[c.i, c.col] = ...</code>), which is wasteful but still may be wanted if there is also a requirement to keep track of all the values used previously. Or, we can make an array with only one element per column and override that one element (<code>arr[0, c.col] = ...</code>) to make vectorbt use flexible indexing.</p> <p>Let's demonstrate both approaches by buying for $10 when a long signal is encountered and selling for $5 when a short signal is encountered. Here's the first approach using a full-sized array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-102-1><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-102-2><a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span><span id=__span-102-3><a id=__codelineno-102-3 name=__codelineno-102-3 href=#__codelineno-102-3></a><span class=gp>... </span>    <span class=n>long_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>)</span>
</span><span id=__span-102-4><a id=__codelineno-102-4 name=__codelineno-102-4 href=#__codelineno-102-4></a><span class=gp>... </span>    <span class=n>short_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>)</span>
</span><span id=__span-102-5><a id=__codelineno-102-5 name=__codelineno-102-5 href=#__codelineno-102-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>long_signal</span><span class=p>:</span>
</span><span id=__span-102-6><a id=__codelineno-102-6 name=__codelineno-102-6 href=#__codelineno-102-6></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># (1)!</span>
</span><span id=__span-102-7><a id=__codelineno-102-7 name=__codelineno-102-7 href=#__codelineno-102-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>short_signal</span><span class=p>:</span>
</span><span id=__span-102-8><a id=__codelineno-102-8 name=__codelineno-102-8 href=#__codelineno-102-8></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>5</span>
</span><span id=__span-102-9><a id=__codelineno-102-9 name=__codelineno-102-9 href=#__codelineno-102-9></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_signal</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=n>short_signal</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-102-10><a id=__codelineno-102-10 name=__codelineno-102-10 href=#__codelineno-102-10></a>
</span><span id=__span-102-11><a id=__codelineno-102-11 name=__codelineno-102-11 href=#__codelineno-102-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-102-12><a id=__codelineno-102-12 name=__codelineno-102-12 href=#__codelineno-102-12></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-102-13><a id=__codelineno-102-13 name=__codelineno-102-13 href=#__codelineno-102-13></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-102-14><a id=__codelineno-102-14 name=__codelineno-102-14 href=#__codelineno-102-14></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-102-15><a id=__codelineno-102-15 name=__codelineno-102-15 href=#__codelineno-102-15></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;long_signals&quot;</span><span class=p>),</span> 
</span><span id=__span-102-16><a id=__codelineno-102-16 name=__codelineno-102-16 href=#__codelineno-102-16></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_signals&quot;</span><span class=p>),</span> 
</span><span id=__span-102-17><a id=__codelineno-102-17 name=__codelineno-102-17 href=#__codelineno-102-17></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;size&quot;</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-102-18><a id=__codelineno-102-18 name=__codelineno-102-18 href=#__codelineno-102-18></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-102-19><a id=__codelineno-102-19 name=__codelineno-102-19 href=#__codelineno-102-19></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape, np.nan)&quot;</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-102-20><a id=__codelineno-102-20 name=__codelineno-102-20 href=#__codelineno-102-20></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-102-21><a id=__codelineno-102-21 name=__codelineno-102-21 href=#__codelineno-102-21></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-102-22><a id=__codelineno-102-22 name=__codelineno-102-22 href=#__codelineno-102-22></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-102-23><a id=__codelineno-102-23 name=__codelineno-102-23 href=#__codelineno-102-23></a><span class=gp>... </span>        <span class=n>long_signals</span><span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-102-24><a id=__codelineno-102-24 name=__codelineno-102-24 href=#__codelineno-102-24></a><span class=gp>... </span>        <span class=n>short_signals</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-102-25><a id=__codelineno-102-25 name=__codelineno-102-25 href=#__codelineno-102-25></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-102-26><a id=__codelineno-102-26 name=__codelineno-102-26 href=#__codelineno-102-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-102-27><a id=__codelineno-102-27 name=__codelineno-102-27 href=#__codelineno-102-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-102-28><a id=__codelineno-102-28 name=__codelineno-102-28 href=#__codelineno-102-28></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-102-29><a id=__codelineno-102-29 name=__codelineno-102-29 href=#__codelineno-102-29></a><span class=go>Open time                                  </span>
</span><span id=__span-102-30><a id=__codelineno-102-30 name=__codelineno-102-30 href=#__codelineno-102-30></a><span class=go>2021-02-18 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-102-31><a id=__codelineno-102-31 name=__codelineno-102-31 href=#__codelineno-102-31></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-102-32><a id=__codelineno-102-32 name=__codelineno-102-32 href=#__codelineno-102-32></a><span class=go>2021-02-20 00:00:00+00:00     -5.0     -5.0</span>
</span><span id=__span-102-33><a id=__codelineno-102-33 name=__codelineno-102-33 href=#__codelineno-102-33></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-102-34><a id=__codelineno-102-34 name=__codelineno-102-34 href=#__codelineno-102-34></a><span class=go>2021-02-22 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-102-35><a id=__codelineno-102-35 name=__codelineno-102-35 href=#__codelineno-102-35></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-102-36><a id=__codelineno-102-36 name=__codelineno-102-36 href=#__codelineno-102-36></a><span class=go>2021-02-24 00:00:00+00:00     -5.0     -5.0</span>
</span></code></pre></div> <ol> <li>Set the value under the current row and column to be picked by vectorbt</li> <li>Forward <code>size</code> we built below to the signal function using templates</li> <li>Using this template we can delay the creation of the array to the point where the target shape is known (i.e., after broadcasting all arrays), which gets available via <code>wrapper.shape</code></li> </ol> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Can we somehow get access to the filled array after the simulation? Yes! The trick is to create an empty dictionary, pass it to the template, and save the created array to the dictionary inside the template expression:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-103-1><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>memory</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-103-2><a id=__codelineno-103-2 name=__codelineno-103-2 href=#__codelineno-103-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-103-3><a id=__codelineno-103-3 name=__codelineno-103-3 href=#__codelineno-103-3></a><span class=gp>... </span>    <span class=c1># ...</span>
</span><span id=__span-103-4><a id=__codelineno-103-4 name=__codelineno-103-4 href=#__codelineno-103-4></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-103-5><a id=__codelineno-103-5 name=__codelineno-103-5 href=#__codelineno-103-5></a><span class=gp>... </span><span class=s2>        size = np.full(wrapper.shape, np.nan)</span>
</span><span id=__span-103-6><a id=__codelineno-103-6 name=__codelineno-103-6 href=#__codelineno-103-6></a><span class=gp>... </span><span class=s2>        memory[&quot;size&quot;] = size</span>
</span><span id=__span-103-7><a id=__codelineno-103-7 name=__codelineno-103-7 href=#__codelineno-103-7></a><span class=gp>... </span><span class=s2>        return size</span>
</span><span id=__span-103-8><a id=__codelineno-103-8 name=__codelineno-103-8 href=#__codelineno-103-8></a><span class=gp>... </span><span class=s2>        &quot;&quot;&quot;</span><span class=p>,</span> 
</span><span id=__span-103-9><a id=__codelineno-103-9 name=__codelineno-103-9 href=#__codelineno-103-9></a><span class=gp>... </span>        <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>memory</span><span class=o>=</span><span class=n>memory</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-103-10><a id=__codelineno-103-10 name=__codelineno-103-10 href=#__codelineno-103-10></a><span class=gp>... </span>        <span class=n>context_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>nested</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-103-11><a id=__codelineno-103-11 name=__codelineno-103-11 href=#__codelineno-103-11></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-103-12><a id=__codelineno-103-12 name=__codelineno-103-12 href=#__codelineno-103-12></a><span class=gp>... </span>    <span class=c1># ...</span>
</span><span id=__span-103-13><a id=__codelineno-103-13 name=__codelineno-103-13 href=#__codelineno-103-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-103-14><a id=__codelineno-103-14 name=__codelineno-103-14 href=#__codelineno-103-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>memory</span><span class=p>[</span><span class=s2>&quot;size&quot;</span><span class=p>]</span>
</span><span id=__span-103-15><a id=__codelineno-103-15 name=__codelineno-103-15 href=#__codelineno-103-15></a><span class=go>[[10. 10.]</span>
</span><span id=__span-103-16><a id=__codelineno-103-16 name=__codelineno-103-16 href=#__codelineno-103-16></a><span class=go> [nan nan]</span>
</span><span id=__span-103-17><a id=__codelineno-103-17 name=__codelineno-103-17 href=#__codelineno-103-17></a><span class=go> [ 5.  5.]</span>
</span><span id=__span-103-18><a id=__codelineno-103-18 name=__codelineno-103-18 href=#__codelineno-103-18></a><span class=go> [nan nan]</span>
</span><span id=__span-103-19><a id=__codelineno-103-19 name=__codelineno-103-19 href=#__codelineno-103-19></a><span class=go> [10. 10.]</span>
</span><span id=__span-103-20><a id=__codelineno-103-20 name=__codelineno-103-20 href=#__codelineno-103-20></a><span class=go> [nan nan]</span>
</span><span id=__span-103-21><a id=__codelineno-103-21 name=__codelineno-103-21 href=#__codelineno-103-21></a><span class=go> [ 5.  5.]]</span>
</span></code></pre></div> <ol> <li>Everything that we pass as <code>context</code> will be available as a variable in the template</li> <li>We don't want to lose the reference to the dictionary <code>memory</code>, that's why we disable nested dictionary merging when the local context is being merged with the global context</li> </ol> </div> <p>Here's the second approach using a one-element array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-104-1><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-104-2><a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span><span id=__span-104-3><a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a><span class=gp>... </span>    <span class=n>long_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>)</span>
</span><span id=__span-104-4><a id=__codelineno-104-4 name=__codelineno-104-4 href=#__codelineno-104-4></a><span class=gp>... </span>    <span class=n>short_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>)</span>
</span><span id=__span-104-5><a id=__codelineno-104-5 name=__codelineno-104-5 href=#__codelineno-104-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>long_signal</span><span class=p>:</span>
</span><span id=__span-104-6><a id=__codelineno-104-6 name=__codelineno-104-6 href=#__codelineno-104-6></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># (1)!</span>
</span><span id=__span-104-7><a id=__codelineno-104-7 name=__codelineno-104-7 href=#__codelineno-104-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>short_signal</span><span class=p>:</span>
</span><span id=__span-104-8><a id=__codelineno-104-8 name=__codelineno-104-8 href=#__codelineno-104-8></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>5</span>
</span><span id=__span-104-9><a id=__codelineno-104-9 name=__codelineno-104-9 href=#__codelineno-104-9></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_signal</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=n>short_signal</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-104-10><a id=__codelineno-104-10 name=__codelineno-104-10 href=#__codelineno-104-10></a>
</span><span id=__span-104-11><a id=__codelineno-104-11 name=__codelineno-104-11 href=#__codelineno-104-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-104-12><a id=__codelineno-104-12 name=__codelineno-104-12 href=#__codelineno-104-12></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-104-13><a id=__codelineno-104-13 name=__codelineno-104-13 href=#__codelineno-104-13></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-104-14><a id=__codelineno-104-14 name=__codelineno-104-14 href=#__codelineno-104-14></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-104-15><a id=__codelineno-104-15 name=__codelineno-104-15 href=#__codelineno-104-15></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;long_signals&quot;</span><span class=p>),</span> 
</span><span id=__span-104-16><a id=__codelineno-104-16 name=__codelineno-104-16 href=#__codelineno-104-16></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_signals&quot;</span><span class=p>),</span> 
</span><span id=__span-104-17><a id=__codelineno-104-17 name=__codelineno-104-17 href=#__codelineno-104-17></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;size&quot;</span><span class=p>)</span>
</span><span id=__span-104-18><a id=__codelineno-104-18 name=__codelineno-104-18 href=#__codelineno-104-18></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-104-19><a id=__codelineno-104-19 name=__codelineno-104-19 href=#__codelineno-104-19></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full((1, wrapper.shape_2d[1]), np.nan)&quot;</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-104-20><a id=__codelineno-104-20 name=__codelineno-104-20 href=#__codelineno-104-20></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-104-21><a id=__codelineno-104-21 name=__codelineno-104-21 href=#__codelineno-104-21></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-104-22><a id=__codelineno-104-22 name=__codelineno-104-22 href=#__codelineno-104-22></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-104-23><a id=__codelineno-104-23 name=__codelineno-104-23 href=#__codelineno-104-23></a><span class=gp>... </span>        <span class=n>long_signals</span><span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-104-24><a id=__codelineno-104-24 name=__codelineno-104-24 href=#__codelineno-104-24></a><span class=gp>... </span>        <span class=n>short_signals</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-104-25><a id=__codelineno-104-25 name=__codelineno-104-25 href=#__codelineno-104-25></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-104-26><a id=__codelineno-104-26 name=__codelineno-104-26 href=#__codelineno-104-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-104-27><a id=__codelineno-104-27 name=__codelineno-104-27 href=#__codelineno-104-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-104-28><a id=__codelineno-104-28 name=__codelineno-104-28 href=#__codelineno-104-28></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-104-29><a id=__codelineno-104-29 name=__codelineno-104-29 href=#__codelineno-104-29></a><span class=go>Open time                                  </span>
</span><span id=__span-104-30><a id=__codelineno-104-30 name=__codelineno-104-30 href=#__codelineno-104-30></a><span class=go>2021-02-18 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-104-31><a id=__codelineno-104-31 name=__codelineno-104-31 href=#__codelineno-104-31></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-104-32><a id=__codelineno-104-32 name=__codelineno-104-32 href=#__codelineno-104-32></a><span class=go>2021-02-20 00:00:00+00:00     -5.0     -5.0</span>
</span><span id=__span-104-33><a id=__codelineno-104-33 name=__codelineno-104-33 href=#__codelineno-104-33></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-104-34><a id=__codelineno-104-34 name=__codelineno-104-34 href=#__codelineno-104-34></a><span class=go>2021-02-22 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-104-35><a id=__codelineno-104-35 name=__codelineno-104-35 href=#__codelineno-104-35></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-104-36><a id=__codelineno-104-36 name=__codelineno-104-36 href=#__codelineno-104-36></a><span class=go>2021-02-24 00:00:00+00:00     -5.0     -5.0</span>
</span></code></pre></div> <ol> <li>Since our array has only one element, vectorbt will pick its value for any row and column, thus we need to override this exact element</li> <li>In contrast to the previous example, here we only need one row</li> </ol> <h4 id=entry-laddering>Entry laddering<a class=headerlink href=#entry-laddering title="Permanent link">&para;</a></h4> <p>To demonstrate the full power of this trick, we'll create a custom entry ladder! Whenever a user-defined entry signal is discovered, it will be split into multiple smaller entry signals, each executed after a predefined number of bars and adding a predefined percentage of resources to the current position. Also, we'll show how to group arguments using named tuples and define custom record arrays that hold complex temporary information. Finally, we'll show how to parameterize the ladder and test two completely different ladders with a single simulation.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-105-1><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>Signals</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;Signals&quot;</span><span class=p>,</span> <span class=p>[</span>  <span class=c1># (1)!</span>
</span><span id=__span-105-2><a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a><span class=gp>... </span>    <span class=s2>&quot;entries&quot;</span><span class=p>,</span>
</span><span id=__span-105-3><a id=__codelineno-105-3 name=__codelineno-105-3 href=#__codelineno-105-3></a><span class=gp>... </span>    <span class=s2>&quot;exits&quot;</span>
</span><span id=__span-105-4><a id=__codelineno-105-4 name=__codelineno-105-4 href=#__codelineno-105-4></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-105-5><a id=__codelineno-105-5 name=__codelineno-105-5 href=#__codelineno-105-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>Order</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;Order&quot;</span><span class=p>,</span> <span class=p>[</span>  <span class=c1># (2)!</span>
</span><span id=__span-105-6><a id=__codelineno-105-6 name=__codelineno-105-6 href=#__codelineno-105-6></a><span class=gp>... </span>    <span class=s2>&quot;size&quot;</span><span class=p>,</span>
</span><span id=__span-105-7><a id=__codelineno-105-7 name=__codelineno-105-7 href=#__codelineno-105-7></a><span class=gp>... </span>    <span class=s2>&quot;size_type&quot;</span>
</span><span id=__span-105-8><a id=__codelineno-105-8 name=__codelineno-105-8 href=#__codelineno-105-8></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-105-9><a id=__codelineno-105-9 name=__codelineno-105-9 href=#__codelineno-105-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ladder_dt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dtype</span><span class=p>([</span>  <span class=c1># (3)!</span>
</span><span id=__span-105-10><a id=__codelineno-105-10 name=__codelineno-105-10 href=#__codelineno-105-10></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;after_n_bars&quot;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>),</span>
</span><span id=__span-105-11><a id=__codelineno-105-11 name=__codelineno-105-11 href=#__codelineno-105-11></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;exit_pct&quot;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-105-12><a id=__codelineno-105-12 name=__codelineno-105-12 href=#__codelineno-105-12></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-105-13><a id=__codelineno-105-13 name=__codelineno-105-13 href=#__codelineno-105-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ladder_info_dt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dtype</span><span class=p>([</span>  <span class=c1># (4)!</span>
</span><span id=__span-105-14><a id=__codelineno-105-14 name=__codelineno-105-14 href=#__codelineno-105-14></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;init_idx&quot;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>),</span>
</span><span id=__span-105-15><a id=__codelineno-105-15 name=__codelineno-105-15 href=#__codelineno-105-15></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;step&quot;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-105-16><a id=__codelineno-105-16 name=__codelineno-105-16 href=#__codelineno-105-16></a><span class=gp>... </span><span class=p>],</span> <span class=n>align</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-105-17><a id=__codelineno-105-17 name=__codelineno-105-17 href=#__codelineno-105-17></a>
</span><span id=__span-105-18><a id=__codelineno-105-18 name=__codelineno-105-18 href=#__codelineno-105-18></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>  <span class=c1># (5)!</span>
</span><span id=__span-105-19><a id=__codelineno-105-19 name=__codelineno-105-19 href=#__codelineno-105-19></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>order</span><span class=p>,</span> <span class=n>ladders</span><span class=p>,</span> <span class=n>last_ladder_info</span><span class=p>):</span>  <span class=c1># (6)!</span>
</span><span id=__span-105-20><a id=__codelineno-105-20 name=__codelineno-105-20 href=#__codelineno-105-20></a><span class=gp>... </span>    <span class=n>is_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=o>.</span><span class=n>entries</span><span class=p>)</span>
</span><span id=__span-105-21><a id=__codelineno-105-21 name=__codelineno-105-21 href=#__codelineno-105-21></a><span class=gp>... </span>    <span class=n>is_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=o>.</span><span class=n>exits</span><span class=p>)</span>
</span><span id=__span-105-22><a id=__codelineno-105-22 name=__codelineno-105-22 href=#__codelineno-105-22></a><span class=gp>... </span>    <span class=n>position_now</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-105-23><a id=__codelineno-105-23 name=__codelineno-105-23 href=#__codelineno-105-23></a><span class=gp>... </span>    <span class=n>ladder_info</span> <span class=o>=</span> <span class=n>last_ladder_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (7)!</span>
</span><span id=__span-105-24><a id=__codelineno-105-24 name=__codelineno-105-24 href=#__codelineno-105-24></a><span class=gp>... </span>    
</span><span id=__span-105-25><a id=__codelineno-105-25 name=__codelineno-105-25 href=#__codelineno-105-25></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>position_now</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>is_exit</span><span class=p>:</span>  <span class=c1># (8)!</span>
</span><span id=__span-105-26><a id=__codelineno-105-26 name=__codelineno-105-26 href=#__codelineno-105-26></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;init_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># (9)!</span>
</span><span id=__span-105-27><a id=__codelineno-105-27 name=__codelineno-105-27 href=#__codelineno-105-27></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-105-28><a id=__codelineno-105-28 name=__codelineno-105-28 href=#__codelineno-105-28></a><span class=gp>... </span>        <span class=n>order</span><span class=o>.</span><span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>  <span class=c1># (10)!</span>
</span><span id=__span-105-29><a id=__codelineno-105-29 name=__codelineno-105-29 href=#__codelineno-105-29></a><span class=gp>... </span>        <span class=n>order</span><span class=o>.</span><span class=n>size_type</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>Amount</span>
</span><span id=__span-105-30><a id=__codelineno-105-30 name=__codelineno-105-30 href=#__codelineno-105-30></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (11)!</span>
</span><span id=__span-105-31><a id=__codelineno-105-31 name=__codelineno-105-31 href=#__codelineno-105-31></a><span class=gp>... </span>    
</span><span id=__span-105-32><a id=__codelineno-105-32 name=__codelineno-105-32 href=#__codelineno-105-32></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>is_entry</span><span class=p>:</span>  <span class=c1># (12)!</span>
</span><span id=__span-105-33><a id=__codelineno-105-33 name=__codelineno-105-33 href=#__codelineno-105-33></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;init_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-105-34><a id=__codelineno-105-34 name=__codelineno-105-34 href=#__codelineno-105-34></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-105-35><a id=__codelineno-105-35 name=__codelineno-105-35 href=#__codelineno-105-35></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-105-36><a id=__codelineno-105-36 name=__codelineno-105-36 href=#__codelineno-105-36></a><span class=gp>... </span>        
</span><span id=__span-105-37><a id=__codelineno-105-37 name=__codelineno-105-37 href=#__codelineno-105-37></a><span class=gp>... </span>    <span class=n>step</span> <span class=o>=</span> <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span>
</span><span id=__span-105-38><a id=__codelineno-105-38 name=__codelineno-105-38 href=#__codelineno-105-38></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>step</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=ow>and</span> <span class=n>step</span> <span class=o>&lt;</span> <span class=n>ladders</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>  <span class=c1># (13)!</span>
</span><span id=__span-105-39><a id=__codelineno-105-39 name=__codelineno-105-39 href=#__codelineno-105-39></a><span class=gp>... </span>        <span class=n>after_n_bars</span> <span class=o>=</span> <span class=n>ladders</span><span class=o>.</span><span class=n>after_n_bars</span><span class=p>[</span><span class=n>step</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (14)!</span>
</span><span id=__span-105-40><a id=__codelineno-105-40 name=__codelineno-105-40 href=#__codelineno-105-40></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>after_n_bars</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;=</span> <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;init_idx&quot;</span><span class=p>]</span> <span class=o>+</span> <span class=n>after_n_bars</span><span class=p>:</span>  <span class=c1># (15)!</span>
</span><span id=__span-105-41><a id=__codelineno-105-41 name=__codelineno-105-41 href=#__codelineno-105-41></a><span class=gp>... </span>            <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>step</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># (16)!</span>
</span><span id=__span-105-42><a id=__codelineno-105-42 name=__codelineno-105-42 href=#__codelineno-105-42></a><span class=gp>... </span>            <span class=n>order</span><span class=o>.</span><span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>ladders</span><span class=o>.</span><span class=n>exit_pct</span><span class=p>[</span><span class=n>step</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (17)!</span>
</span><span id=__span-105-43><a id=__codelineno-105-43 name=__codelineno-105-43 href=#__codelineno-105-43></a><span class=gp>... </span>            <span class=n>order</span><span class=o>.</span><span class=n>size_type</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>Percent</span>
</span><span id=__span-105-44><a id=__codelineno-105-44 name=__codelineno-105-44 href=#__codelineno-105-44></a><span class=gp>... </span>            <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (18)!</span>
</span><span id=__span-105-45><a id=__codelineno-105-45 name=__codelineno-105-45 href=#__codelineno-105-45></a><span class=gp>... </span>    
</span><span id=__span-105-46><a id=__codelineno-105-46 name=__codelineno-105-46 href=#__codelineno-105-46></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (19)!</span>
</span><span id=__span-105-47><a id=__codelineno-105-47 name=__codelineno-105-47 href=#__codelineno-105-47></a>
</span><span id=__span-105-48><a id=__codelineno-105-48 name=__codelineno-105-48 href=#__codelineno-105-48></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-105-49><a id=__codelineno-105-49 name=__codelineno-105-49 href=#__codelineno-105-49></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-105-50><a id=__codelineno-105-50 name=__codelineno-105-50 href=#__codelineno-105-50></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-105-51><a id=__codelineno-105-51 name=__codelineno-105-51 href=#__codelineno-105-51></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>  <span class=c1># (20)!</span>
</span><span id=__span-105-52><a id=__codelineno-105-52 name=__codelineno-105-52 href=#__codelineno-105-52></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>
</span><span id=__span-105-53><a id=__codelineno-105-53 name=__codelineno-105-53 href=#__codelineno-105-53></a><span class=gp>... </span>            <span class=s2>&quot;Signals(entries, exits)&quot;</span><span class=p>,</span>
</span><span id=__span-105-54><a id=__codelineno-105-54 name=__codelineno-105-54 href=#__codelineno-105-54></a><span class=gp>... </span>            <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>Signals</span><span class=o>=</span><span class=n>Signals</span><span class=p>)</span>  <span class=c1># (21)!</span>
</span><span id=__span-105-55><a id=__codelineno-105-55 name=__codelineno-105-55 href=#__codelineno-105-55></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-105-56><a id=__codelineno-105-56 name=__codelineno-105-56 href=#__codelineno-105-56></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>
</span><span id=__span-105-57><a id=__codelineno-105-57 name=__codelineno-105-57 href=#__codelineno-105-57></a><span class=gp>... </span>            <span class=s2>&quot;Order(size, size_type)&quot;</span><span class=p>,</span>
</span><span id=__span-105-58><a id=__codelineno-105-58 name=__codelineno-105-58 href=#__codelineno-105-58></a><span class=gp>... </span>            <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>Order</span><span class=o>=</span><span class=n>Order</span><span class=p>)</span>
</span><span id=__span-105-59><a id=__codelineno-105-59 name=__codelineno-105-59 href=#__codelineno-105-59></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-105-60><a id=__codelineno-105-60 name=__codelineno-105-60 href=#__codelineno-105-60></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;ladders&quot;</span><span class=p>),</span>  <span class=c1># (22)!</span>
</span><span id=__span-105-61><a id=__codelineno-105-61 name=__codelineno-105-61 href=#__codelineno-105-61></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>  <span class=c1># (23)!</span>
</span><span id=__span-105-62><a id=__codelineno-105-62 name=__codelineno-105-62 href=#__codelineno-105-62></a><span class=gp>... </span>            <span class=s2>&quot;np.full(wrapper.shape_2d[1], np.array((-1, -1), ladder_info_dt))&quot;</span><span class=p>,</span>
</span><span id=__span-105-63><a id=__codelineno-105-63 name=__codelineno-105-63 href=#__codelineno-105-63></a><span class=gp>... </span>            <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>ladder_info_dt</span><span class=o>=</span><span class=n>ladder_info_dt</span><span class=p>)</span>
</span><span id=__span-105-64><a id=__codelineno-105-64 name=__codelineno-105-64 href=#__codelineno-105-64></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-105-65><a id=__codelineno-105-65 name=__codelineno-105-65 href=#__codelineno-105-65></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-105-66><a id=__codelineno-105-66 name=__codelineno-105-66 href=#__codelineno-105-66></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d, np.nan)&quot;</span><span class=p>),</span>  <span class=c1># (24)!</span>
</span><span id=__span-105-67><a id=__codelineno-105-67 name=__codelineno-105-67 href=#__codelineno-105-67></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d, -1)&quot;</span><span class=p>),</span>
</span><span id=__span-105-68><a id=__codelineno-105-68 name=__codelineno-105-68 href=#__codelineno-105-68></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (25)!</span>
</span><span id=__span-105-69><a id=__codelineno-105-69 name=__codelineno-105-69 href=#__codelineno-105-69></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-105-70><a id=__codelineno-105-70 name=__codelineno-105-70 href=#__codelineno-105-70></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-105-71><a id=__codelineno-105-71 name=__codelineno-105-71 href=#__codelineno-105-71></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-105-72><a id=__codelineno-105-72 name=__codelineno-105-72 href=#__codelineno-105-72></a><span class=gp>... </span>        <span class=n>ladders</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>BCO</span><span class=p>(</span>  <span class=c1># (26)!</span>
</span><span id=__span-105-73><a id=__codelineno-105-73 name=__codelineno-105-73 href=#__codelineno-105-73></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>  <span class=c1># (27)!</span>
</span><span id=__span-105-74><a id=__codelineno-105-74 name=__codelineno-105-74 href=#__codelineno-105-74></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>  <span class=c1># (28)!</span>
</span><span id=__span-105-75><a id=__codelineno-105-75 name=__codelineno-105-75 href=#__codelineno-105-75></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>4</span><span class=p>),</span>  <span class=c1># (29)!</span>
</span><span id=__span-105-76><a id=__codelineno-105-76 name=__codelineno-105-76 href=#__codelineno-105-76></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>3</span><span class=p>),</span>
</span><span id=__span-105-77><a id=__codelineno-105-77 name=__codelineno-105-77 href=#__codelineno-105-77></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-105-78><a id=__codelineno-105-78 name=__codelineno-105-78 href=#__codelineno-105-78></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-105-79><a id=__codelineno-105-79 name=__codelineno-105-79 href=#__codelineno-105-79></a><span class=gp>... </span>                <span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>ladder_dt</span><span class=p>),</span>
</span><span id=__span-105-80><a id=__codelineno-105-80 name=__codelineno-105-80 href=#__codelineno-105-80></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span><span id=__span-105-81><a id=__codelineno-105-81 name=__codelineno-105-81 href=#__codelineno-105-81></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-105-82><a id=__codelineno-105-82 name=__codelineno-105-82 href=#__codelineno-105-82></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-105-83><a id=__codelineno-105-83 name=__codelineno-105-83 href=#__codelineno-105-83></a><span class=gp>... </span>                <span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>ladder_dt</span><span class=p>),</span>
</span><span id=__span-105-84><a id=__codelineno-105-84 name=__codelineno-105-84 href=#__codelineno-105-84></a><span class=gp>... </span>            <span class=p>]),</span>
</span><span id=__span-105-85><a id=__codelineno-105-85 name=__codelineno-105-85 href=#__codelineno-105-85></a><span class=gp>... </span>            <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>  <span class=c1># (30)!</span>
</span><span id=__span-105-86><a id=__codelineno-105-86 name=__codelineno-105-86 href=#__codelineno-105-86></a><span class=gp>... </span>            <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (31)!</span>
</span><span id=__span-105-87><a id=__codelineno-105-87 name=__codelineno-105-87 href=#__codelineno-105-87></a><span class=gp>... </span>                <span class=n>reset_index</span><span class=o>=</span><span class=s2>&quot;from_start&quot;</span><span class=p>,</span> 
</span><span id=__span-105-88><a id=__codelineno-105-88 name=__codelineno-105-88 href=#__codelineno-105-88></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>((</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>ladder_dt</span><span class=p>),</span>
</span><span id=__span-105-89><a id=__codelineno-105-89 name=__codelineno-105-89 href=#__codelineno-105-89></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-105-90><a id=__codelineno-105-90 name=__codelineno-105-90 href=#__codelineno-105-90></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-105-91><a id=__codelineno-105-91 name=__codelineno-105-91 href=#__codelineno-105-91></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-105-92><a id=__codelineno-105-92 name=__codelineno-105-92 href=#__codelineno-105-92></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-105-93><a id=__codelineno-105-93 name=__codelineno-105-93 href=#__codelineno-105-93></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-105-94><a id=__codelineno-105-94 name=__codelineno-105-94 href=#__codelineno-105-94></a><span class=go>ladder                      array_0   array_1</span>
</span><span id=__span-105-95><a id=__codelineno-105-95 name=__codelineno-105-95 href=#__codelineno-105-95></a><span class=go>Open time                                    </span>
</span><span id=__span-105-96><a id=__codelineno-105-96 name=__codelineno-105-96 href=#__codelineno-105-96></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-105-97><a id=__codelineno-105-97 name=__codelineno-105-97 href=#__codelineno-105-97></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-105-98><a id=__codelineno-105-98 name=__codelineno-105-98 href=#__codelineno-105-98></a><span class=go>2021-02-20 00:00:00+00:00  0.000448  0.000895</span>
</span><span id=__span-105-99><a id=__codelineno-105-99 name=__codelineno-105-99 href=#__codelineno-105-99></a><span class=go>2021-02-21 00:00:00+00:00  0.000435  0.000000</span>
</span><span id=__span-105-100><a id=__codelineno-105-100 name=__codelineno-105-100 href=#__codelineno-105-100></a><span class=go>2021-02-22 00:00:00+00:00  0.000462  0.000924</span>
</span><span id=__span-105-101><a id=__codelineno-105-101 name=__codelineno-105-101 href=#__codelineno-105-101></a><span class=go>2021-02-23 00:00:00+00:00  0.000511  0.000000</span>
</span><span id=__span-105-102><a id=__codelineno-105-102 name=__codelineno-105-102 href=#__codelineno-105-102></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <ol> <li>Create a <a href=https://realpython.com/python-namedtuple/ >namedtuple</a> to define a container for multiple arrays. Otherwise, the amount of arrays passed to the signal function would take a lot of space and be poorly readable. This named tuple contains two signal arrays: entries and exits.</li> <li>The second named tuple contains order-related arrays that are meant to be overridden in the signal function: size and size type. You can add more fields to it if needed.</li> <li>Ladders are stored in a two-dimensional array where each column represents a ladder and each row a step within this ladder. Each step should define how many bars need to pass and how much we need to order (basically a tuple). Regular NumPy arrays cannot store such information, but structured arrays can! Here, we define the data type for such an array.</li> <li>We also need to keep track of the index of the user-defined entry and the current step being processed. We need this per ladder (column), thus we will create a one-dimensional structured array.</li> <li>If you're finished with the function, don't forget to put it into another cell to avoid re-compilation! Also, don't cache it because it might break if you change some named tuples.</li> <li>Our function takes the context, and the initialized named tuples and structured arrays that we defined above</li> <li>Similarly to built-in information arrays such as <code>last_position</code> and <code>last_sl_info</code>, our latest ladder information is also laid out per column</li> <li>If we encounter a user-defined exit signal, close out the position</li> <li>Reset the temporary information to deactivate our laddering logic at the next bars</li> <li>Override the order-related information for this signal, here we go all out</li> <li>Long exit</li> <li>If we encounter a user-defined entry signal, write the current bar index to the temporary information, set the current step to zero to activate our laddering logic, and return no signal to skip to the next bar</li> <li>Check whether the ladder is active and the current step is lower than the total number of steps</li> <li>Remember that ladders are stored in a two-dimensional array with a ladder per column, that is, the first axis represents steps and the second axis represents columns</li> <li>Next, we need to check whether the condition of the current step has been satisfied, that is, whether the current bar index comes after the target bar index. But first, we must check whether the value is defined; this is because ladders may have a different number of steps.</li> <li>Increment the current step</li> <li>Execute the signal by ordering the requested percentage of the available resources</li> <li>Long entry</li> <li>If there was no action during this bar, return no signal</li> <li>Use templates to construct named tuples and record arrays. The arrays defined in <code>broadcast_named_args</code> will be automatically recognized in template expressions.</li> <li>We need to provide the classes via a context since they are not automatically available in the expressions</li> <li>We will define ladders in <code>broadcast_named_args</code> to broadcast it together with data</li> <li>Create a structured NumPy array that holds temporary information per ladder (column). Here, <code>np.array((-1, -1), ladder_info_dt)</code> is a single value that instructs NumPy to use the data type <code>ladder_info_dt</code> and fill both fields with -1.</li> <li>Size and size type are built-in arguments that we want to override, thus make them of the full shape</li> <li>Don't forget to enable accumulation to be able to gradually increase the position</li> <li>Use <a href=../../../api/base/reshaping/index.html#vectorbtpro.base.reshaping.BCO>BCO</a> to control broadcasting of a single argument</li> <li>Use <a href=../../../api/utils/params/index.html#vectorbtpro.utils.params.Param>Param</a> to test multiple values (here ladder arrays)</li> <li>Luckily, any structured array can be initialized using regular tuples</li> <li>For example, in the first step, once we're two bars away from the user-defined entry signal, execute an order for 25% of the available cash balance</li> <li>Remember that the first axis are steps, not bars, thus our array isn't broadcastable along the time axis (<code>axis=0</code>), only along the column axis (<code>axis=1</code>)</li> <li>What happens if one array has fewer steps than another? Under the hood, both arrays will be stacked along columns, but stacking cannot work if they have different shapes. Here, we specify that whenever an array has insufficient number of rows, it should be padded using <code>fill_value</code>.</li> </ol> <p>The strategy has correctly split the entry signal into a set of smaller entry orders distributed over time. The code above is a great template for defining dynamic signal strategies of any complexity.</p> <h2 id=grouping>Grouping<a class=headerlink href=#grouping title="Permanent link">&para;</a></h2> <p>Until now, we processed the columns <code>BTCUSDT</code> and <code>ETHUSDT</code> separately, that is, the second column is processed strictly after the first column. But what if there is a need to put both columns into the same portfolio for analysis? By introducing a grouping, we can make a group of columns to be treated as a single column (read more <a href=../from-orders/index.html#grouping_1>here</a>). Here, we need to distinguish between grouping after and before the simulation.</p> <h3 id=after-simulation>After simulation<a class=headerlink href=#after-simulation title="Permanent link">&para;</a></h3> <p>When the main scenario is to simulate columns <strong>separately</strong> and then subsequently analyze them as a whole, we can group-by the columns after the simulation, either when querying a specific metric of interest:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-106-1><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-106-2><a id=__codelineno-106-2 name=__codelineno-106-2 href=#__codelineno-106-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-106-3><a id=__codelineno-106-3 name=__codelineno-106-3 href=#__codelineno-106-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-106-4><a id=__codelineno-106-4 name=__codelineno-106-4 href=#__codelineno-106-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-106-5><a id=__codelineno-106-5 name=__codelineno-106-5 href=#__codelineno-106-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-106-6><a id=__codelineno-106-6 name=__codelineno-106-6 href=#__codelineno-106-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-106-7><a id=__codelineno-106-7 name=__codelineno-106-7 href=#__codelineno-106-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-106-8><a id=__codelineno-106-8 name=__codelineno-106-8 href=#__codelineno-106-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-106-9><a id=__codelineno-106-9 name=__codelineno-106-9 href=#__codelineno-106-9></a><span class=go>Open time</span>
</span><span id=__span-106-10><a id=__codelineno-106-10 name=__codelineno-106-10 href=#__codelineno-106-10></a><span class=go>2021-02-18 00:00:00+00:00    200.000000</span>
</span><span id=__span-106-11><a id=__codelineno-106-11 name=__codelineno-106-11 href=#__codelineno-106-11></a><span class=go>2021-02-19 00:00:00+00:00    209.238037</span>
</span><span id=__span-106-12><a id=__codelineno-106-12 name=__codelineno-106-12 href=#__codelineno-106-12></a><span class=go>2021-02-20 00:00:00+00:00    206.946937</span>
</span><span id=__span-106-13><a id=__codelineno-106-13 name=__codelineno-106-13 href=#__codelineno-106-13></a><span class=go>2021-02-21 00:00:00+00:00    211.045749</span>
</span><span id=__span-106-14><a id=__codelineno-106-14 name=__codelineno-106-14 href=#__codelineno-106-14></a><span class=go>2021-02-22 00:00:00+00:00    211.045749</span>
</span><span id=__span-106-15><a id=__codelineno-106-15 name=__codelineno-106-15 href=#__codelineno-106-15></a><span class=go>2021-02-23 00:00:00+00:00    232.943589</span>
</span><span id=__span-106-16><a id=__codelineno-106-16 name=__codelineno-106-16 href=#__codelineno-106-16></a><span class=go>2021-02-24 00:00:00+00:00    228.775332</span>
</span><span id=__span-106-17><a id=__codelineno-106-17 name=__codelineno-106-17 href=#__codelineno-106-17></a><span class=go>Freq: D, Name: group, dtype: float64</span>
</span></code></pre></div> <p>Or, by quick-fixing the entire portfolio:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-107-1><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_pf</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>wrapper</span><span class=o>=</span><span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-107-2><a id=__codelineno-107-2 name=__codelineno-107-2 href=#__codelineno-107-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_pf</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-107-3><a id=__codelineno-107-3 name=__codelineno-107-3 href=#__codelineno-107-3></a><span class=go>Open time</span>
</span><span id=__span-107-4><a id=__codelineno-107-4 name=__codelineno-107-4 href=#__codelineno-107-4></a><span class=go>2021-02-18 00:00:00+00:00    200.000000</span>
</span><span id=__span-107-5><a id=__codelineno-107-5 name=__codelineno-107-5 href=#__codelineno-107-5></a><span class=go>2021-02-19 00:00:00+00:00    209.238037</span>
</span><span id=__span-107-6><a id=__codelineno-107-6 name=__codelineno-107-6 href=#__codelineno-107-6></a><span class=go>2021-02-20 00:00:00+00:00    206.946937</span>
</span><span id=__span-107-7><a id=__codelineno-107-7 name=__codelineno-107-7 href=#__codelineno-107-7></a><span class=go>2021-02-21 00:00:00+00:00    211.045749</span>
</span><span id=__span-107-8><a id=__codelineno-107-8 name=__codelineno-107-8 href=#__codelineno-107-8></a><span class=go>2021-02-22 00:00:00+00:00    211.045749</span>
</span><span id=__span-107-9><a id=__codelineno-107-9 name=__codelineno-107-9 href=#__codelineno-107-9></a><span class=go>2021-02-23 00:00:00+00:00    232.943589</span>
</span><span id=__span-107-10><a id=__codelineno-107-10 name=__codelineno-107-10 href=#__codelineno-107-10></a><span class=go>2021-02-24 00:00:00+00:00    228.775332</span>
</span><span id=__span-107-11><a id=__codelineno-107-11 name=__codelineno-107-11 href=#__codelineno-107-11></a><span class=go>Freq: D, Name: group, dtype: float64</span>
</span></code></pre></div> <ol> <li>Group-by instruction is part of the portfolio's wrapper</li> </ol> <p>What the portfolio above did was aggregate various metrics such as the initial capital and time series such as the cash flows along the column axis. There are some time series that cannot be aggregated though, such as the asset flows:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-108-1><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-108-2><a id=__codelineno-108-2 name=__codelineno-108-2 href=#__codelineno-108-2></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-108-3><a id=__codelineno-108-3 name=__codelineno-108-3 href=#__codelineno-108-3></a><span class=go>Open time                                    </span>
</span><span id=__span-108-4><a id=__codelineno-108-4 name=__codelineno-108-4 href=#__codelineno-108-4></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-108-5><a id=__codelineno-108-5 name=__codelineno-108-5 href=#__codelineno-108-5></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-108-6><a id=__codelineno-108-6 name=__codelineno-108-6 href=#__codelineno-108-6></a><span class=go>2021-02-20 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-108-7><a id=__codelineno-108-7 name=__codelineno-108-7 href=#__codelineno-108-7></a><span class=go>2021-02-21 00:00:00+00:00 -0.001940 -0.051557</span>
</span><span id=__span-108-8><a id=__codelineno-108-8 name=__codelineno-108-8 href=#__codelineno-108-8></a><span class=go>2021-02-22 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-108-9><a id=__codelineno-108-9 name=__codelineno-108-9 href=#__codelineno-108-9></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-108-10><a id=__codelineno-108-10 name=__codelineno-108-10 href=#__codelineno-108-10></a><span class=go>2021-02-24 00:00:00+00:00  0.002059  0.056080</span>
</span></code></pre></div> <p>We can still disable the grouping for individual metrics by passing <code>group_by=False</code>. What we cannot do after the simulation though is to introduce cash sharing because it can be only applied during the simulation where it has real consequences on the trading logic.</p> <h3 id=before-simulation>Before simulation<a class=headerlink href=#before-simulation title="Permanent link">&para;</a></h3> <p>Adding a group-by instruction before the simulation may or may not have consequences on the simulation. For instance, grouping with cash sharing will always have consequences, while grouping without cash sharing will only have consequences when <abbr title="From-signals simulation method">FS</abbr> is run in the flexible mode (that is, when any of the default callbacks are overridden); in this case, columns are grouped for the user to take advantage of the grouping in the callbacks, while all the calculations are still done on the per-column basis as if there was no grouping at all. Let's make use of this fact and limit the number of active positions to just one in each group:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-109-1><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-109-2><a id=__codelineno-109-2 name=__codelineno-109-2 href=#__codelineno-109-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>):</span>
</span><span id=__span-109-3><a id=__codelineno-109-3 name=__codelineno-109-3 href=#__codelineno-109-3></a><span class=gp>... </span>    <span class=n>is_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>)</span>
</span><span id=__span-109-4><a id=__codelineno-109-4 name=__codelineno-109-4 href=#__codelineno-109-4></a><span class=gp>... </span>    <span class=n>is_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-109-5><a id=__codelineno-109-5 name=__codelineno-109-5 href=#__codelineno-109-5></a><span class=gp>... </span>    <span class=n>other_in_position</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-109-6><a id=__codelineno-109-6 name=__codelineno-109-6 href=#__codelineno-109-6></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>to_col</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-109-7><a id=__codelineno-109-7 name=__codelineno-109-7 href=#__codelineno-109-7></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>col</span> <span class=o>!=</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-109-8><a id=__codelineno-109-8 name=__codelineno-109-8 href=#__codelineno-109-8></a><span class=gp>... </span>            <span class=n>other_in_position</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-109-9><a id=__codelineno-109-9 name=__codelineno-109-9 href=#__codelineno-109-9></a><span class=gp>... </span>            <span class=k>break</span>
</span><span id=__span-109-10><a id=__codelineno-109-10 name=__codelineno-109-10 href=#__codelineno-109-10></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>other_in_position</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-109-11><a id=__codelineno-109-11 name=__codelineno-109-11 href=#__codelineno-109-11></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-109-12><a id=__codelineno-109-12 name=__codelineno-109-12 href=#__codelineno-109-12></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>is_entry</span><span class=p>,</span> <span class=n>is_exit</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (3)!</span>
</span><span id=__span-109-13><a id=__codelineno-109-13 name=__codelineno-109-13 href=#__codelineno-109-13></a>
</span><span id=__span-109-14><a id=__codelineno-109-14 name=__codelineno-109-14 href=#__codelineno-109-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-109-15><a id=__codelineno-109-15 name=__codelineno-109-15 href=#__codelineno-109-15></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-109-16><a id=__codelineno-109-16 name=__codelineno-109-16 href=#__codelineno-109-16></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-109-17><a id=__codelineno-109-17 name=__codelineno-109-17 href=#__codelineno-109-17></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>)),</span>
</span><span id=__span-109-18><a id=__codelineno-109-18 name=__codelineno-109-18 href=#__codelineno-109-18></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-109-19><a id=__codelineno-109-19 name=__codelineno-109-19 href=#__codelineno-109-19></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-109-20><a id=__codelineno-109-20 name=__codelineno-109-20 href=#__codelineno-109-20></a><span class=gp>... </span>            <span class=mi>0</span><span class=p>:</span> <span class=p>[</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>],</span> 
</span><span id=__span-109-21><a id=__codelineno-109-21 name=__codelineno-109-21 href=#__codelineno-109-21></a><span class=gp>... </span>            <span class=mi>1</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]</span>
</span><span id=__span-109-22><a id=__codelineno-109-22 name=__codelineno-109-22 href=#__codelineno-109-22></a><span class=gp>... </span>        <span class=p>}),</span> 
</span><span id=__span-109-23><a id=__codelineno-109-23 name=__codelineno-109-23 href=#__codelineno-109-23></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-109-24><a id=__codelineno-109-24 name=__codelineno-109-24 href=#__codelineno-109-24></a><span class=gp>... </span>            <span class=mi>0</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>],</span> 
</span><span id=__span-109-25><a id=__codelineno-109-25 name=__codelineno-109-25 href=#__codelineno-109-25></a><span class=gp>... </span>            <span class=mi>1</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>]</span>
</span><span id=__span-109-26><a id=__codelineno-109-26 name=__codelineno-109-26 href=#__codelineno-109-26></a><span class=gp>... </span>        <span class=p>})</span>
</span><span id=__span-109-27><a id=__codelineno-109-27 name=__codelineno-109-27 href=#__codelineno-109-27></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-109-28><a id=__codelineno-109-28 name=__codelineno-109-28 href=#__codelineno-109-28></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (4)!</span>
</span><span id=__span-109-29><a id=__codelineno-109-29 name=__codelineno-109-29 href=#__codelineno-109-29></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-109-30><a id=__codelineno-109-30 name=__codelineno-109-30 href=#__codelineno-109-30></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-109-31><a id=__codelineno-109-31 name=__codelineno-109-31 href=#__codelineno-109-31></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-109-32><a id=__codelineno-109-32 name=__codelineno-109-32 href=#__codelineno-109-32></a><span class=go>Open time                                   </span>
</span><span id=__span-109-33><a id=__codelineno-109-33 name=__codelineno-109-33 href=#__codelineno-109-33></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-109-34><a id=__codelineno-109-34 name=__codelineno-109-34 href=#__codelineno-109-34></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-109-35><a id=__codelineno-109-35 name=__codelineno-109-35 href=#__codelineno-109-35></a><span class=go>2021-02-20 00:00:00+00:00 -0.00194  0.000000</span>
</span><span id=__span-109-36><a id=__codelineno-109-36 name=__codelineno-109-36 href=#__codelineno-109-36></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.051719</span>
</span><span id=__span-109-37><a id=__codelineno-109-37 name=__codelineno-109-37 href=#__codelineno-109-37></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-109-38><a id=__codelineno-109-38 name=__codelineno-109-38 href=#__codelineno-109-38></a><span class=go>2021-02-23 00:00:00+00:00  0.00000 -0.051719</span>
</span><span id=__span-109-39><a id=__codelineno-109-39 name=__codelineno-109-39 href=#__codelineno-109-39></a><span class=go>2021-02-24 00:00:00+00:00  0.00218  0.000000</span>
</span></code></pre></div> <ol> <li>Go through the columns in this group and check whether there are open positions apart from this one</li> <li>If true, return no signal</li> <li>If false, return the signal</li> <li>Put all columns into the same group. For multiple groups, use <code>vbt.ExceptLevel("symbol")</code></li> </ol> <p>The first signal in the column <code>ETHUSDT</code> couldn't execute because there was already a position in the column <code>BTCUSDT</code>, but once it was closed, the second signal could finally go through.</p> <h4 id=sorting>Sorting<a class=headerlink href=#sorting title="Permanent link">&para;</a></h4> <p>Orders are sorted only in groups with cash sharing, and only in two cases: when orders in different columns should be executed in different bar zones (i.e., at different times) such that they need to be sorted by time, and when orders are instructed to be sorted by order value as part of the automatic call sequence enabled by <code>call_seq="auto"</code>. Both cases cannot be combined! Let's take a look at the first case where the first column is executed using the closing price and the second column using the opening price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-110-1><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-110-2><a id=__codelineno-110-2 name=__codelineno-110-2 href=#__codelineno-110-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-110-3><a id=__codelineno-110-3 name=__codelineno-110-3 href=#__codelineno-110-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-110-4><a id=__codelineno-110-4 name=__codelineno-110-4 href=#__codelineno-110-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=p>[[</span><span class=s2>&quot;close&quot;</span><span class=p>,</span> <span class=s2>&quot;open&quot;</span><span class=p>]],</span>  <span class=c1># (1)!</span>
</span><span id=__span-110-5><a id=__codelineno-110-5 name=__codelineno-110-5 href=#__codelineno-110-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-110-6><a id=__codelineno-110-6 name=__codelineno-110-6 href=#__codelineno-110-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-110-7><a id=__codelineno-110-7 name=__codelineno-110-7 href=#__codelineno-110-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-110-8><a id=__codelineno-110-8 name=__codelineno-110-8 href=#__codelineno-110-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (2)!</span>
</span><span id=__span-110-9><a id=__codelineno-110-9 name=__codelineno-110-9 href=#__codelineno-110-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-110-10><a id=__codelineno-110-10 name=__codelineno-110-10 href=#__codelineno-110-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-110-11><a id=__codelineno-110-11 name=__codelineno-110-11 href=#__codelineno-110-11></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-110-12><a id=__codelineno-110-12 name=__codelineno-110-12 href=#__codelineno-110-12></a><span class=go>Open time                                  </span>
</span><span id=__span-110-13><a id=__codelineno-110-13 name=__codelineno-110-13 href=#__codelineno-110-13></a><span class=go>2021-02-18 00:00:00+00:00     50.0     50.0</span>
</span><span id=__span-110-14><a id=__codelineno-110-14 name=__codelineno-110-14 href=#__codelineno-110-14></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-110-15><a id=__codelineno-110-15 name=__codelineno-110-15 href=#__codelineno-110-15></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-110-16><a id=__codelineno-110-16 name=__codelineno-110-16 href=#__codelineno-110-16></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-110-17><a id=__codelineno-110-17 name=__codelineno-110-17 href=#__codelineno-110-17></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-110-18><a id=__codelineno-110-18 name=__codelineno-110-18 href=#__codelineno-110-18></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-110-19><a id=__codelineno-110-19 name=__codelineno-110-19 href=#__codelineno-110-19></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>If we want to provide any information per column, we need to build a two-dimensional array with exactly one row (any array-like object will be transformed into a NumPy array, thus passing a list works too)</li> <li>Turn on cash sharing</li> </ol> <p>As we can see, the second column was executed first and has ended up using the half of the capital. If both assets were executed in the same bar zone though, they wouldn't be sorted and would be just normally executed from the left column to the right:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-111-1><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-111-2><a id=__codelineno-111-2 name=__codelineno-111-2 href=#__codelineno-111-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-111-3><a id=__codelineno-111-3 name=__codelineno-111-3 href=#__codelineno-111-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-111-4><a id=__codelineno-111-4 name=__codelineno-111-4 href=#__codelineno-111-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;close&quot;</span><span class=p>,</span>
</span><span id=__span-111-5><a id=__codelineno-111-5 name=__codelineno-111-5 href=#__codelineno-111-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-111-6><a id=__codelineno-111-6 name=__codelineno-111-6 href=#__codelineno-111-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-111-7><a id=__codelineno-111-7 name=__codelineno-111-7 href=#__codelineno-111-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-111-8><a id=__codelineno-111-8 name=__codelineno-111-8 href=#__codelineno-111-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-111-9><a id=__codelineno-111-9 name=__codelineno-111-9 href=#__codelineno-111-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-111-10><a id=__codelineno-111-10 name=__codelineno-111-10 href=#__codelineno-111-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-111-11><a id=__codelineno-111-11 name=__codelineno-111-11 href=#__codelineno-111-11></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-111-12><a id=__codelineno-111-12 name=__codelineno-111-12 href=#__codelineno-111-12></a><span class=go>Open time                                  </span>
</span><span id=__span-111-13><a id=__codelineno-111-13 name=__codelineno-111-13 href=#__codelineno-111-13></a><span class=go>2021-02-18 00:00:00+00:00    100.0      NaN</span>
</span><span id=__span-111-14><a id=__codelineno-111-14 name=__codelineno-111-14 href=#__codelineno-111-14></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-111-15><a id=__codelineno-111-15 name=__codelineno-111-15 href=#__codelineno-111-15></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-111-16><a id=__codelineno-111-16 name=__codelineno-111-16 href=#__codelineno-111-16></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-111-17><a id=__codelineno-111-17 name=__codelineno-111-17 href=#__codelineno-111-17></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-111-18><a id=__codelineno-111-18 name=__codelineno-111-18 href=#__codelineno-111-18></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-111-19><a id=__codelineno-111-19 name=__codelineno-111-19 href=#__codelineno-111-19></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <p>Even though the second column requested $50 of assets, the simulator couldn't fulfill that request because the default initial capital is $100, which has been all used up by the first column. To sort by order value, use the automatic call sequence:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-112-1><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-112-2><a id=__codelineno-112-2 name=__codelineno-112-2 href=#__codelineno-112-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-112-3><a id=__codelineno-112-3 name=__codelineno-112-3 href=#__codelineno-112-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-112-4><a id=__codelineno-112-4 name=__codelineno-112-4 href=#__codelineno-112-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;close&quot;</span><span class=p>,</span>
</span><span id=__span-112-5><a id=__codelineno-112-5 name=__codelineno-112-5 href=#__codelineno-112-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-112-6><a id=__codelineno-112-6 name=__codelineno-112-6 href=#__codelineno-112-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-112-7><a id=__codelineno-112-7 name=__codelineno-112-7 href=#__codelineno-112-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-112-8><a id=__codelineno-112-8 name=__codelineno-112-8 href=#__codelineno-112-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-112-9><a id=__codelineno-112-9 name=__codelineno-112-9 href=#__codelineno-112-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-112-10><a id=__codelineno-112-10 name=__codelineno-112-10 href=#__codelineno-112-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-112-11><a id=__codelineno-112-11 name=__codelineno-112-11 href=#__codelineno-112-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-112-12><a id=__codelineno-112-12 name=__codelineno-112-12 href=#__codelineno-112-12></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-112-13><a id=__codelineno-112-13 name=__codelineno-112-13 href=#__codelineno-112-13></a><span class=go>Open time                                  </span>
</span><span id=__span-112-14><a id=__codelineno-112-14 name=__codelineno-112-14 href=#__codelineno-112-14></a><span class=go>2021-02-18 00:00:00+00:00     50.0     50.0</span>
</span><span id=__span-112-15><a id=__codelineno-112-15 name=__codelineno-112-15 href=#__codelineno-112-15></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-16><a id=__codelineno-112-16 name=__codelineno-112-16 href=#__codelineno-112-16></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-17><a id=__codelineno-112-17 name=__codelineno-112-17 href=#__codelineno-112-17></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-18><a id=__codelineno-112-18 name=__codelineno-112-18 href=#__codelineno-112-18></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-19><a id=__codelineno-112-19 name=__codelineno-112-19 href=#__codelineno-112-19></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-20><a id=__codelineno-112-20 name=__codelineno-112-20 href=#__codelineno-112-20></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Here</li> </ol> <p>This has made the second column execute first. But if we attempted to sort by order value when the columns had to execute their orders at different times, the simulation would fail:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-113-1><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-113-2><a id=__codelineno-113-2 name=__codelineno-113-2 href=#__codelineno-113-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-113-3><a id=__codelineno-113-3 name=__codelineno-113-3 href=#__codelineno-113-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-113-4><a id=__codelineno-113-4 name=__codelineno-113-4 href=#__codelineno-113-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=p>[[</span><span class=s2>&quot;close&quot;</span><span class=p>,</span> <span class=s2>&quot;open&quot;</span><span class=p>]],</span>
</span><span id=__span-113-5><a id=__codelineno-113-5 name=__codelineno-113-5 href=#__codelineno-113-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-113-6><a id=__codelineno-113-6 name=__codelineno-113-6 href=#__codelineno-113-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-113-7><a id=__codelineno-113-7 name=__codelineno-113-7 href=#__codelineno-113-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-113-8><a id=__codelineno-113-8 name=__codelineno-113-8 href=#__codelineno-113-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-113-9><a id=__codelineno-113-9 name=__codelineno-113-9 href=#__codelineno-113-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-113-10><a id=__codelineno-113-10 name=__codelineno-113-10 href=#__codelineno-113-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-113-11><a id=__codelineno-113-11 name=__codelineno-113-11 href=#__codelineno-113-11></a><span class=go>ValueError: Cannot sort orders by value if they are executed at different times</span>
</span></code></pre></div> <p>And it makes sense if we think more about it: if the simulator sorted both columns by value, the second column would come first, but how it's possible if it should execute at the beginning of the bar? Remember that each bar is divided into three zones: open, middle, and close. The only possibility to sort orders by value is to use either the opening or the closing point of the bar. We cannot use the middle of the bar because we don't really know what happens there. Since we give vectorbt clues on where in the bar an order should execute by using <code>-np.inf</code> (bar open) and <code>np.inf</code> (bar close) as order price, passing any custom prices would be considered happening in the middle of a bar and thus fail as well:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-114-1><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-114-2><a id=__codelineno-114-2 name=__codelineno-114-2 href=#__codelineno-114-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-114-3><a id=__codelineno-114-3 name=__codelineno-114-3 href=#__codelineno-114-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-114-4><a id=__codelineno-114-4 name=__codelineno-114-4 href=#__codelineno-114-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-114-5><a id=__codelineno-114-5 name=__codelineno-114-5 href=#__codelineno-114-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-114-6><a id=__codelineno-114-6 name=__codelineno-114-6 href=#__codelineno-114-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-114-7><a id=__codelineno-114-7 name=__codelineno-114-7 href=#__codelineno-114-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-114-8><a id=__codelineno-114-8 name=__codelineno-114-8 href=#__codelineno-114-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-114-9><a id=__codelineno-114-9 name=__codelineno-114-9 href=#__codelineno-114-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-114-10><a id=__codelineno-114-10 name=__codelineno-114-10 href=#__codelineno-114-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-114-11><a id=__codelineno-114-11 name=__codelineno-114-11 href=#__codelineno-114-11></a><span class=go>ValueError: Cannot sort orders by value if they are executed at different times</span>
</span></code></pre></div> <p>Even if we know that the provided array represents the closing price, vectorbt doesn't know about it. Thus, make sure to use exclusively any option from <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PriceType>PriceType</a> when the automatic call sequence should be enabled. If you're using stop orders, make sure to use <code>PriceType.Close</code> and <code>StopExitPrice.Close</code> to execute all orders at the closing price, for instance, for rebalancing. Limit orders, on the other hand, are never executed at the closing price, thus using them together with the automatic call sequence is hardly possible.</p> <h2 id=custom-outputs>Custom outputs<a class=headerlink href=#custom-outputs title="Permanent link">&para;</a></h2> <p>When the portfolio has been simulated, and we've got our new shiny portfolio instance, the first thing we usually do is run various statistics. Since most statistics are based on returns, the portfolio instance may sometimes need to repeatedly re-calculate the returns, which is a slow process because it has to translate order records into asset flows, cash flows, assets, cash, asset value, portfolio value, and finally, returns. Such operations are known as "reconstructions" because they aim to derive a certain property of the simulation post factum. Hence, performance analysis is usually the main performance bottleneck in a typical backtesting pipeline. Gladly, there is an argument <code>save_returns</code> that, when enabled, pre-calculates the returns during the simulation and makes them available for all the metrics that need them (read more <a href=../from-orders/index.html#filling-returns>here</a>):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-115-1><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-115-2><a id=__codelineno-115-2 name=__codelineno-115-2 href=#__codelineno-115-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-115-3><a id=__codelineno-115-3 name=__codelineno-115-3 href=#__codelineno-115-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-115-4><a id=__codelineno-115-4 name=__codelineno-115-4 href=#__codelineno-115-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-115-5><a id=__codelineno-115-5 name=__codelineno-115-5 href=#__codelineno-115-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-115-6><a id=__codelineno-115-6 name=__codelineno-115-6 href=#__codelineno-115-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-115-7><a id=__codelineno-115-7 name=__codelineno-115-7 href=#__codelineno-115-7></a><span class=gp>... </span>    <span class=n>save_returns</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-115-8><a id=__codelineno-115-8 name=__codelineno-115-8 href=#__codelineno-115-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-115-9><a id=__codelineno-115-9 name=__codelineno-115-9 href=#__codelineno-115-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>returns</span>
</span><span id=__span-115-10><a id=__codelineno-115-10 name=__codelineno-115-10 href=#__codelineno-115-10></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-115-11><a id=__codelineno-115-11 name=__codelineno-115-11 href=#__codelineno-115-11></a><span class=go>Open time                                    </span>
</span><span id=__span-115-12><a id=__codelineno-115-12 name=__codelineno-115-12 href=#__codelineno-115-12></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-115-13><a id=__codelineno-115-13 name=__codelineno-115-13 href=#__codelineno-115-13></a><span class=go>2021-02-19 00:00:00+00:00  0.084446  0.007935</span>
</span><span id=__span-115-14><a id=__codelineno-115-14 name=__codelineno-115-14 href=#__codelineno-115-14></a><span class=go>2021-02-20 00:00:00+00:00 -0.001159 -0.021483</span>
</span><span id=__span-115-15><a id=__codelineno-115-15 name=__codelineno-115-15 href=#__codelineno-115-15></a><span class=go>2021-02-21 00:00:00+00:00  0.028069  0.010732</span>
</span><span id=__span-115-16><a id=__codelineno-115-16 name=__codelineno-115-16 href=#__codelineno-115-16></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-115-17><a id=__codelineno-115-17 name=__codelineno-115-17 href=#__codelineno-115-17></a><span class=go>2021-02-23 00:00:00+00:00  0.096079  0.112338</span>
</span><span id=__span-115-18><a id=__codelineno-115-18 name=__codelineno-115-18 href=#__codelineno-115-18></a><span class=go>2021-02-24 00:00:00+00:00 -0.013245 -0.023012</span>
</span></code></pre></div> <p>To check whether they make sense, compare them to the reconstructed returns:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-116-1><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>get_returns</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-116-2><a id=__codelineno-116-2 name=__codelineno-116-2 href=#__codelineno-116-2></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-116-3><a id=__codelineno-116-3 name=__codelineno-116-3 href=#__codelineno-116-3></a><span class=go>Open time                                    </span>
</span><span id=__span-116-4><a id=__codelineno-116-4 name=__codelineno-116-4 href=#__codelineno-116-4></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-116-5><a id=__codelineno-116-5 name=__codelineno-116-5 href=#__codelineno-116-5></a><span class=go>2021-02-19 00:00:00+00:00  0.084446  0.007935</span>
</span><span id=__span-116-6><a id=__codelineno-116-6 name=__codelineno-116-6 href=#__codelineno-116-6></a><span class=go>2021-02-20 00:00:00+00:00 -0.001159 -0.021483</span>
</span><span id=__span-116-7><a id=__codelineno-116-7 name=__codelineno-116-7 href=#__codelineno-116-7></a><span class=go>2021-02-21 00:00:00+00:00  0.028069  0.010732</span>
</span><span id=__span-116-8><a id=__codelineno-116-8 name=__codelineno-116-8 href=#__codelineno-116-8></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-116-9><a id=__codelineno-116-9 name=__codelineno-116-9 href=#__codelineno-116-9></a><span class=go>2021-02-23 00:00:00+00:00  0.096079  0.112338</span>
</span><span id=__span-116-10><a id=__codelineno-116-10 name=__codelineno-116-10 href=#__codelineno-116-10></a><span class=go>2021-02-24 00:00:00+00:00 -0.013245 -0.023012</span>
</span></code></pre></div> <ol> <li>Every attribute with <code>get_</code> triggers a reconstruction</li> </ol> <p>Under the hood, <abbr title="From-signals simulation method">FS</abbr> creates a named tuple with an uninitialized returns array and gradually fills it at the end of each bar. Once the simulation is over, this tuple gets attached to the created portfolio instance under the attribute <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.in_outputs>Portfolio.in_outputs</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-117-1><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>in_outputs</span>
</span><span id=__span-117-2><a id=__codelineno-117-2 name=__codelineno-117-2 href=#__codelineno-117-2></a><span class=go>FSInOutputs(returns=array([[ 0.        ,  0.        ],</span>
</span><span id=__span-117-3><a id=__codelineno-117-3 name=__codelineno-117-3 href=#__codelineno-117-3></a><span class=go>                           [ 0.08444579,  0.00793458],</span>
</span><span id=__span-117-4><a id=__codelineno-117-4 name=__codelineno-117-4 href=#__codelineno-117-4></a><span class=go>                           [-0.00115927, -0.02148338],</span>
</span><span id=__span-117-5><a id=__codelineno-117-5 name=__codelineno-117-5 href=#__codelineno-117-5></a><span class=go>                           [ 0.02806853,  0.01073183],</span>
</span><span id=__span-117-6><a id=__codelineno-117-6 name=__codelineno-117-6 href=#__codelineno-117-6></a><span class=go>                           [ 0.        ,  0.        ],</span>
</span><span id=__span-117-7><a id=__codelineno-117-7 name=__codelineno-117-7 href=#__codelineno-117-7></a><span class=go>                           [ 0.09607864,  0.11233812],</span>
</span><span id=__span-117-8><a id=__codelineno-117-8 name=__codelineno-117-8 href=#__codelineno-117-8></a><span class=go>                           [-0.01324464, -0.02301153]]))</span>
</span></code></pre></div> <p>Since most things returned by the simulator are in NumPy format, we can use the method <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.get_in_output>Portfolio.get_in_output</a> to wrap any array with Pandas:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-118-1><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;returns&quot;</span><span class=p>)</span>
</span><span id=__span-118-2><a id=__codelineno-118-2 name=__codelineno-118-2 href=#__codelineno-118-2></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-118-3><a id=__codelineno-118-3 name=__codelineno-118-3 href=#__codelineno-118-3></a><span class=go>Open time                                    </span>
</span><span id=__span-118-4><a id=__codelineno-118-4 name=__codelineno-118-4 href=#__codelineno-118-4></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-118-5><a id=__codelineno-118-5 name=__codelineno-118-5 href=#__codelineno-118-5></a><span class=go>2021-02-19 00:00:00+00:00  0.084446  0.007935</span>
</span><span id=__span-118-6><a id=__codelineno-118-6 name=__codelineno-118-6 href=#__codelineno-118-6></a><span class=go>2021-02-20 00:00:00+00:00 -0.001159 -0.021483</span>
</span><span id=__span-118-7><a id=__codelineno-118-7 name=__codelineno-118-7 href=#__codelineno-118-7></a><span class=go>2021-02-21 00:00:00+00:00  0.028069  0.010732</span>
</span><span id=__span-118-8><a id=__codelineno-118-8 name=__codelineno-118-8 href=#__codelineno-118-8></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-118-9><a id=__codelineno-118-9 name=__codelineno-118-9 href=#__codelineno-118-9></a><span class=go>2021-02-23 00:00:00+00:00  0.096079  0.112338</span>
</span><span id=__span-118-10><a id=__codelineno-118-10 name=__codelineno-118-10 href=#__codelineno-118-10></a><span class=go>2021-02-24 00:00:00+00:00 -0.013245 -0.023012</span>
</span></code></pre></div> <p>But there is one catch: the argument <code>save_returns</code> is only available in the fixed simulation mode, that is, when none of the default callbacks have been overridden. As soon as we enter the flexible mode, we need to define our own in-output tuple under the argument <code>in_outputs</code> and fill it with any information we want, usually in the segment post-processing function <code>post_segment_func</code>. This callback takes the context <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalSegmentContext>SignalSegmentContext</a>, which is the same as <a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalContext>SignalContext</a> but without the information on the current column since a segment encompasses multiple columns in a particular group at a particular row, hence, we need to go over the columns in the current segment manually. </p> <p>For demonstration, let's develop a post-segment callback that fills the portfolio returns the same way as done by the fixed <abbr title="From-signals simulation method">FS</abbr> mode! In addition, we will store the total portfolio return per column to avoid reconstructing it during the post-analysis phase:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-119-1><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-119-2><a id=__codelineno-119-2 name=__codelineno-119-2 href=#__codelineno-119-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>post_segment_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-119-3><a id=__codelineno-119-3 name=__codelineno-119-3 href=#__codelineno-119-3></a><span class=gp>... </span>    <span class=n>returns</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>returns</span>  <span class=c1># (1)!</span>
</span><span id=__span-119-4><a id=__codelineno-119-4 name=__codelineno-119-4 href=#__codelineno-119-4></a><span class=gp>... </span>    <span class=n>total_return</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-119-5><a id=__codelineno-119-5 name=__codelineno-119-5 href=#__codelineno-119-5></a><span class=gp>... </span>    <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-119-6><a id=__codelineno-119-6 name=__codelineno-119-6 href=#__codelineno-119-6></a><span class=gp>... </span>    <span class=n>g</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span>
</span><span id=__span-119-7><a id=__codelineno-119-7 name=__codelineno-119-7 href=#__codelineno-119-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>cash_sharing</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-119-8><a id=__codelineno-119-8 name=__codelineno-119-8 href=#__codelineno-119-8></a><span class=gp>... </span>        <span class=n>returns</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>g</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_return</span><span class=p>[</span><span class=n>g</span><span class=p>]</span>
</span><span id=__span-119-9><a id=__codelineno-119-9 name=__codelineno-119-9 href=#__codelineno-119-9></a><span class=gp>... </span>        <span class=n>total_return</span><span class=p>[</span><span class=n>g</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_value</span><span class=p>[</span><span class=n>g</span><span class=p>]</span> <span class=o>/</span> <span class=n>c</span><span class=o>.</span><span class=n>init_cash</span><span class=p>[</span><span class=n>g</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-119-10><a id=__codelineno-119-10 name=__codelineno-119-10 href=#__codelineno-119-10></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-119-11><a id=__codelineno-119-11 name=__codelineno-119-11 href=#__codelineno-119-11></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>to_col</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-119-12><a id=__codelineno-119-12 name=__codelineno-119-12 href=#__codelineno-119-12></a><span class=gp>... </span>            <span class=n>returns</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_return</span><span class=p>[</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-119-13><a id=__codelineno-119-13 name=__codelineno-119-13 href=#__codelineno-119-13></a><span class=gp>... </span>            <span class=n>total_return</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_value</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>/</span> <span class=n>c</span><span class=o>.</span><span class=n>init_cash</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-119-14><a id=__codelineno-119-14 name=__codelineno-119-14 href=#__codelineno-119-14></a>
</span><span id=__span-119-15><a id=__codelineno-119-15 name=__codelineno-119-15 href=#__codelineno-119-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-119-16><a id=__codelineno-119-16 name=__codelineno-119-16 href=#__codelineno-119-16></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-119-17><a id=__codelineno-119-17 name=__codelineno-119-17 href=#__codelineno-119-17></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-119-18><a id=__codelineno-119-18 name=__codelineno-119-18 href=#__codelineno-119-18></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-119-19><a id=__codelineno-119-19 name=__codelineno-119-19 href=#__codelineno-119-19></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-119-20><a id=__codelineno-119-20 name=__codelineno-119-20 href=#__codelineno-119-20></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-119-21><a id=__codelineno-119-21 name=__codelineno-119-21 href=#__codelineno-119-21></a><span class=gp>... </span>    <span class=n>post_segment_func_nb</span><span class=o>=</span><span class=n>post_segment_func_nb</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-119-22><a id=__codelineno-119-22 name=__codelineno-119-22 href=#__codelineno-119-22></a><span class=gp>... </span>    <span class=n>in_outputs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-119-23><a id=__codelineno-119-23 name=__codelineno-119-23 href=#__codelineno-119-23></a><span class=gp>... </span>        <span class=n>returns</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>  <span class=c1># (7)!</span>
</span><span id=__span-119-24><a id=__codelineno-119-24 name=__codelineno-119-24 href=#__codelineno-119-24></a><span class=gp>... </span>            <span class=s2>&quot;np.full((target_shape[0], len(cs_group_lens)), np.nan)&quot;</span>
</span><span id=__span-119-25><a id=__codelineno-119-25 name=__codelineno-119-25 href=#__codelineno-119-25></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-119-26><a id=__codelineno-119-26 name=__codelineno-119-26 href=#__codelineno-119-26></a><span class=gp>... </span>        <span class=n>total_return</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>
</span><span id=__span-119-27><a id=__codelineno-119-27 name=__codelineno-119-27 href=#__codelineno-119-27></a><span class=gp>... </span>            <span class=s2>&quot;np.full(len(cs_group_lens), np.nan)&quot;</span>
</span><span id=__span-119-28><a id=__codelineno-119-28 name=__codelineno-119-28 href=#__codelineno-119-28></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-119-29><a id=__codelineno-119-29 name=__codelineno-119-29 href=#__codelineno-119-29></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-119-30><a id=__codelineno-119-30 name=__codelineno-119-30 href=#__codelineno-119-30></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-119-31><a id=__codelineno-119-31 name=__codelineno-119-31 href=#__codelineno-119-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>testing</span><span class=o>.</span><span class=n>assert_frame_equal</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-119-32><a id=__codelineno-119-32 name=__codelineno-119-32 href=#__codelineno-119-32></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;returns&quot;</span><span class=p>),</span>
</span><span id=__span-119-33><a id=__codelineno-119-33 name=__codelineno-119-33 href=#__codelineno-119-33></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_returns</span><span class=p>()</span>
</span><span id=__span-119-34><a id=__codelineno-119-34 name=__codelineno-119-34 href=#__codelineno-119-34></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-119-35><a id=__codelineno-119-35 name=__codelineno-119-35 href=#__codelineno-119-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>testing</span><span class=o>.</span><span class=n>assert_series_equal</span><span class=p>(</span>
</span><span id=__span-119-36><a id=__codelineno-119-36 name=__codelineno-119-36 href=#__codelineno-119-36></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;total_return&quot;</span><span class=p>),</span>
</span><span id=__span-119-37><a id=__codelineno-119-37 name=__codelineno-119-37 href=#__codelineno-119-37></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_total_return</span><span class=p>()</span>
</span><span id=__span-119-38><a id=__codelineno-119-38 name=__codelineno-119-38 href=#__codelineno-119-38></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li><a href=../../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SignalSegmentContext.in_outputs>SignalSegmentContext.in_outputs</a> contains exactly the in-output tuple that we passed</li> <li>If cash sharing is enabled, returns must be computed per group</li> <li>If cash sharing is disabled, returns must be computed per column</li> <li>Iterate over each column in the current group</li> <li>Overriding this callback is enough to switch to the flexible mode</li> <li>In-output tuple can be provided either as a named tuple or a dict. If the latter, if will be automatically transformed into a named tuple by the method.</li> <li>Use expression evaluation templates to build arrays only after the target shape is established. Use <code>len(cs_group_lens)</code> to get the number of groups when cash sharing is enabled, and the number of columns when cash sharing is disabled.</li> <li>Check the pre-computed and reconstructed arrays for equality</li> </ol> <p>The most impressive in the approach above is that any pre-computed metric that can be found among the attributes of the <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> class is automatically picked by any built-in property and method that requires it, such as <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.stats>Portfolio.stats</a>. The only limitation is the inability to change the grouping after the array has been created; when this happens, the reconstructed version of the metric will be returned instead.</p> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>Backtesting shouldn't be complex! One of the most crucial factors in successful trading is a proper entry and exit timing. By parametrizing the timing and direction of our trades, we can theoretically achieve the worst and best-possible returns in any market, thus the representation of a trading strategy as a permutation of buy, sell, short-sell, and short-cover signals is almost "<a href=https://en.wikipedia.org/wiki/Turing_completeness>Turing-complete</a>" in this regard. Reducing complex strategies into such a limited signal set has another advantage: we can enable and standardize backtesting of many trading strategies using the same piece of code. The method <a href=../../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> not only makes all of that possible, but it also encourages us to hack into the simulation to define our custom trading logic iteratively, or to change the default simulation behavior, making it the best of both vectorized and event-driven worlds. But not everything is appropriate to be represented using signals: strategies that heavily rely upon variations in order information, such as rebalancing strategies, are best implemented using other means. Gladly, vectorbt offers solutions to such problems as well <img alt=🥷 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f977.svg title=:ninja:></p> <p><a class=md-button href=../../../assets/jupytext/documentation/portfolio/from-signals.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5h1.18m-4.28 11.79c-.4 0-.72.3-.72.89 0 .59.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68H4.86M9.14 5.71c.4 0 .72-.3.72-.89 0-.59-.32-.71-.72-.71-.39 0-.71.12-.71.71s.32.89.71.89Z"/></svg></span> Python code</a></p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../from-orders/index.html class="md-footer__link md-footer__link--prev" aria-label="Previous: From orders"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> From orders </div> </div> </a> <a href=../../to-be-continued/index.html class="md-footer__link md-footer__link--next" aria-label="Next: To be continued..."> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> To be continued... </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2024 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.sections", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.ede584c9.min.js></script> <script src=../../../assets/scripts/extra.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_54404668/documentation/portfolio/from-signals/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 20 Jun 2024 15:51:01 GMT -->
</html>