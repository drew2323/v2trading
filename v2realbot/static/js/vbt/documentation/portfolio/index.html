<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_321460c7/documentation/portfolio/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 05 Mar 2024 10:56:15 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation on portfolio simulation"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/documentation/portfolio/ rel=canonical><link href=../indicators/parsers/index.html rel=prev><link href=from-orders/index.html rel=next><link rel=icon href=../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.2+insiders-4.47.1"><title>Portfolio - VectorBT PRO</title><link rel=stylesheet href=../../assets/stylesheets/main.78d85e4f.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><link rel=stylesheet href=../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-0C5VNYCFHL",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script><meta name=robots content=noindex><meta property=og:title content=Portfolio><meta property=og:type content=website><meta content=https://vectorbt.pro/documentation/portfolio/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_321460c7/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Documentation on portfolio simulation"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=../../assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=../../assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=../../assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../assets/logo/favicon-16x16.png><link rel=manifest href=../../assets/logo/site.webmanifest><link rel=mask-icon href=../../assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=../../assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_321460c7/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#portfolio class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> <i>New</i>: Star-import, signal unraveling, Python 3.12 support, and <a href=../../features/index.html><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.2c0 13.1 5.4 25.7 14.9 34.7l84.7 80.8c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9z"/></svg></span> </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=../../index.html title="VectorBT PRO" class="md-header__button md-logo" aria-label="VectorBT PRO" data-md-component=logo> <img src=../../assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT PRO <span class=md-version> v2024.2.22 </span> <a href=https://vectorbt.pro/ > <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M224 64c-44.2 0-80 35.8-80 80v48h240c35.3 0 64 28.7 64 64v192c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64h16v-48C80 64.5 144.5 0 224 0c57.5 0 107 33.7 130.1 82.3 7.6 16 .8 35.1-15.2 42.6s-35.1.8-42.6-15.2C283.4 82.6 255.9 64 224 64zm32 320c17.7 0 32-14.3 32-32s-14.3-32-32-32h-64c-17.7 0-32 14.3-32 32s14.3 32 32 32h64z"/></svg></span> </a> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Portfolio </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../index.html class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=../../features/overview/index.html class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../../tutorials/basic-rsi/index.html class=md-tabs__link> Tutorials </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../fundamentals/index.html class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=../../api/index.html class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=../../cookbook/overview/index.html class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=../../terms/terms-of-use/index.html class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../index.html title="VectorBT PRO" class="md-nav__button md-logo" aria-label="VectorBT PRO" data-md-component=logo> <img src=../../assets/logo/logo.svg alt=logo class=logo> </a> VectorBT PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Getting started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index.html class=md-nav__link> <span class=md-ellipsis> Getting started </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/installation/index.html class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_3> <label class=md-nav__link for=__nav_1_3 id=__nav_1_3_label tabindex> <span class=md-ellipsis> Release notes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> Release notes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/release-notes/index.html class=md-nav__link> <span class=md-ellipsis> Latest </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/release-notes/2023/index.html class=md-nav__link> <span class=md-ellipsis> 2023 </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/release-notes/2022/index.html class=md-nav__link> <span class=md-ellipsis> 2022 </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/release-notes/2021/index.html class=md-nav__link> <span class=md-ellipsis> 2021 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../features/overview/index.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../features/data/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4Z"/></svg> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=../../features/indicators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3 14 .5.07L8.07 9.5a1.95 1.95 0 0 1 .52-1.91c.78-.79 2.04-.79 2.82 0 .53.52.7 1.26.52 1.91l2.57 2.57.5-.07c.18 0 .35 0 .5.07l3.57-3.57C19 8.35 19 8.18 19 8a2 2 0 0 1 2-2 2 2 0 0 1 2 2 2 2 0 0 1-2 2c-.18 0-.35 0-.5-.07l-3.57 3.57c.07.15.07.32.07.5a2 2 0 0 1-2 2 2 2 0 0 1-2-2l.07-.5-2.57-2.57c-.32.07-.68.07-1 0L4.93 15.5 5 16a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2Z"/></svg> <span class=md-ellipsis> Indicators </span> </a> </li> <li class=md-nav__item> <a href=../../features/portfolio/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56 6.49 3.74Z"/></svg> <span class=md-ellipsis> Portfolio </span> </a> </li> <li class=md-nav__item> <a href=../../features/optimization/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16h-.58l-.81-.81A7.07 7.07 0 0 0 18 11c0-3.87-3.13-7-7-7-1.5 0-3 .5-4.21 1.4-3.09 2.32-3.72 6.71-1.4 9.8 2.32 3.09 6.71 3.72 9.8 1.4l.81.81V18l5 5 2-2-5-5m-7 0c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5M3 6 1 8V1h7L6 3H3v3m18-5v7l-2-2V3h-3l-2-2h7M6 19l2 2H1v-7l2 2v3h3Z"/></svg> <span class=md-ellipsis> Optimization </span> </a> </li> <li class=md-nav__item> <a href=../../features/analysis/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.2 11.2c1.77 0 3.2 1.43 3.2 3.2 0 1.77-1.43 3.2-3.2 3.2-1.77 0-3.2-1.43-3.2-3.2 0-1.77 1.43-3.2 3.2-3.2m7.6 4.8a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m.4-12A4.8 4.8 0 0 1 20 8.8c0 2.65-2.15 4.8-4.8 4.8a4.8 4.8 0 0 1-4.8-4.8c0-2.65 2.15-4.8 4.8-4.8Z"/></svg> <span class=md-ellipsis> Analysis </span> </a> </li> <li class=md-nav__item> <a href=../../features/productivity/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9M12 7a5 5 0 0 0-5 5 5 5 0 0 0 5 5 5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg> <span class=md-ellipsis> Productivity </span> </a> </li> <li class=md-nav__item> <a href=../../features/performance/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16a3 3 0 0 1-3-3c0-1.12.61-2.1 1.5-2.61l9.71-5.62-5.53 9.58c-.5.98-1.51 1.65-2.68 1.65m0-13c1.81 0 3.5.5 4.97 1.32l-2.1 1.21C14 5.19 13 5 12 5a8 8 0 0 0-8 8c0 2.21.89 4.21 2.34 5.65h.01c.39.39.39 1.02 0 1.41-.39.39-1.03.39-1.42.01A9.969 9.969 0 0 1 2 13 10 10 0 0 1 12 3m10 10c0 2.76-1.12 5.26-2.93 7.07-.39.38-1.02.38-1.41-.01a.996.996 0 0 1 0-1.41A7.95 7.95 0 0 0 20 13c0-1-.19-2-.54-2.9L20.67 8C21.5 9.5 22 11.18 22 13Z"/></svg> <span class=md-ellipsis> Performance </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/basic-rsi/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3.5 18.5 6-6 4 4L22 6.92 20.59 5.5l-7.09 8-4-4L2 17l1.5 1.5Z"/></svg> <span class=md-ellipsis> Basic RSI strategy </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> SuperFast SuperTrend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/superfast-supertrend/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24L11 9.47M13 1 6 15h5v8l7-14h-5V1Z"/></svg> <span class=md-ellipsis> SuperFast SuperTrend </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/superfast-supertrend/streaming/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24L11 9.47M13 1 6 15h5v8l7-14h-5V1Z"/></svg> <span class=md-ellipsis> Streaming </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/superfast-supertrend/multithreading/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24L11 9.47M13 1 6 15h5v8l7-14h-5V1Z"/></svg> <span class=md-ellipsis> Multithreading </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/superfast-supertrend/pipelines/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24L11 9.47M13 1 6 15h5v8l7-14h-5V1Z"/></svg> <span class=md-ellipsis> Pipelines </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex> <span class=md-ellipsis> Signal development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Signal development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/signal-development/generation/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg> <span class=md-ellipsis> Generation </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/signal-development/pre-analysis/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg> <span class=md-ellipsis> Pre-analysis </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../tutorials/stop-signals/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 23h-2V1h2v22m-4-4H5V5h4V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h4v-2M19 7v2h2V7h-2m0-2h2a2 2 0 0 0-2-2v2m2 10h-2v2h2v-2m-2-4v2h2v-2h-2m-2-8h-2v2h2V3m2 18c1.11 0 2-.89 2-2h-2v2m-2-2h-2v2h2v-2Z"/></svg> <span class=md-ellipsis> Stop signals </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> MTF analysis </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> MTF analysis </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/mtf-analysis/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 2h2v18h18v2H2V2m5 8h10v3H7v-3m4 5h10v3H11v-3M6 4h16v4h-2V6H8v2H6V4Z"/></svg> <span class=md-ellipsis> MTF analysis </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/mtf-analysis/alignment/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 2h2v18h18v2H2V2m5 8h10v3H7v-3m4 5h10v3H11v-3M6 4h16v4h-2V6H8v2H6V4Z"/></svg> <span class=md-ellipsis> Alignment </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/mtf-analysis/aggregation/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 2h2v18h18v2H2V2m5 8h10v3H7v-3m4 5h10v3H11v-3M6 4h16v4h-2V6H8v2H6V4Z"/></svg> <span class=md-ellipsis> Aggregation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6 id=__nav_3_6_label tabindex> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Portfolio optimization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/portfolio-optimization/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4v4m-4-7h4v2h-4v-2m-6-8h4v3h-4V6m4 9h-4v-5h4v5M6 10h4v2H6v-2m4 6H6v-3h4v3Z"/></svg> <span class=md-ellipsis> Portfolio optimization </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/portfolio-optimization/integrations/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4v4m-4-7h4v2h-4v-2m-6-8h4v3h-4V6m4 9h-4v-5h4v5M6 10h4v2H6v-2m4 6H6v-3h4v3Z"/></svg> <span class=md-ellipsis> Integrations </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/portfolio-optimization/dynamic/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4v4m-4-7h4v2h-4v-2m-6-8h4v3h-4V6m4 9h-4v-5h4v5M6 10h4v2H6v-2m4 6H6v-3h4v3Z"/></svg> <span class=md-ellipsis> Dynamic </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../tutorials/pairs-trading/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16L22 6.92Z"/></svg> <span class=md-ellipsis> Pairs trading </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_8> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex> <span class=md-ellipsis> Patterns and projections </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=false> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> Patterns and projections </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/patterns-and-projections/patterns/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m23 7.5-6.47-.54L14 1l-2.53 5.96L5 7.5l4.9 4.27-1.46 6.33L14 14.74l5.56 3.36-1.47-6.33L23 7.5m-6.86 4.73.4 1.71-1.51-.91-1.03-.62-1.03.62-1.51.91.39-1.71.28-1.18-.91-.79L9.88 9.1l1.76-.15 1.2-.1.47-1.11.69-1.62.69 1.62.47 1.11 1.2.1 1.75.15-1.33 1.16-.92.79.28 1.18M1.16 12c-.299-.5-.171-1.11.29-1.41l2.73-1.8 1.57 1.36-3.2 2.11c-.17.11-.36.17-.55.17-.32 0-.64-.16-.84-.43m.29 8.16 5.86-3.85L7 17.76l-.34 1.37-4.11 2.71c-.17.11-.36.16-.55.16-.32 0-.64-.16-.84-.45a1.013 1.013 0 0 1 .29-1.39m5.87-8.66.92.81-.27 1.19-5.42 3.55c-.17.11-.36.16-.55.16-.32 0-.64-.15-.84-.45a1 1 0 0 1 .29-1.38l5.87-3.88Z"/></svg> <span class=md-ellipsis> Patterns </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/patterns-and-projections/projections/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m23 7.5-6.47-.54L14 1l-2.53 5.96L5 7.5l4.9 4.27-1.46 6.33L14 14.74l5.56 3.36-1.47-6.33L23 7.5m-6.86 4.73.4 1.71-1.51-.91-1.03-.62-1.03.62-1.51.91.39-1.71.28-1.18-.91-.79L9.88 9.1l1.76-.15 1.2-.1.47-1.11.69-1.62.69 1.62.47 1.11 1.2.1 1.75.15-1.33 1.16-.92.79.28 1.18M1.16 12c-.299-.5-.171-1.11.29-1.41l2.73-1.8 1.57 1.36-3.2 2.11c-.17.11-.36.17-.55.17-.32 0-.64-.16-.84-.43m.29 8.16 5.86-3.85L7 17.76l-.34 1.37-4.11 2.71c-.17.11-.36.16-.55.16-.32 0-.64-.16-.84-.45a1.013 1.013 0 0 1 .29-1.39m5.87-8.66.92.81-.27 1.19-5.42 3.55c-.17.11-.36.16-.55.16-.32 0-.64-.15-.84-.45a1 1 0 0 1 .29-1.38l5.87-3.88Z"/></svg> <span class=md-ellipsis> Projections </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_9> <label class=md-nav__link for=__nav_3_9 id=__nav_3_9_label tabindex> <span class=md-ellipsis> Cross-validation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_9_label aria-expanded=false> <label class=md-nav__title for=__nav_3_9> <span class="md-nav__icon md-icon"></span> Cross-validation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/cross-validation/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M.41 13.41 6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7Z"/></svg> <span class=md-ellipsis> Cross-validation </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/cross-validation/splitter/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M.41 13.41 6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7Z"/></svg> <span class=md-ellipsis> Splitter </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/cross-validation/applications/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M.41 13.41 6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7Z"/></svg> <span class=md-ellipsis> Applications </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../tutorials/more-tutorials/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1-1.4 1.4 4.8 4.8 0 0 1 0-7l3.5-3.6a5.1 5.1 0 0 1 7.1 0 5.1 5.1 0 0 1 0 7.1l-1.5 1.5a6.4 6.4 0 0 0-.4-2.4l.5-.5a3.2 3.2 0 0 0 0-4.3 3.2 3.2 0 0 0-4.3 0l-3.5 3.6a2.9 2.9 0 0 0 0 4.2M23 18v2h-3v3h-2v-3h-3v-2h3v-3h2v3m-3.8-4.3a4.8 4.8 0 0 0-1.4-4.5 1 1 0 0 0-1.4 1.4 2.9 2.9 0 0 1 0 4.2l-3.5 3.6a3.2 3.2 0 0 1-4.3 0 3.2 3.2 0 0 1 0-4.3l.5-.4a7.3 7.3 0 0 1-.4-2.5l-1.5 1.5a5.1 5.1 0 0 0 0 7.1 5.1 5.1 0 0 0 7.1 0l1.8-1.8a6 6 0 0 1 3.1-4.3Z"/></svg> <span class=md-ellipsis> More tutorials </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/to-be-continued/index.html class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../fundamentals/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 7a2 2 0 0 0-2 2v8h2v-4h2v4h2V9a2 2 0 0 0-2-2H3m0 2h2v2H3m12-.5V9a2 2 0 0 0-2-2H9v10h4a2 2 0 0 0 2-2v-1.5a1.54 1.54 0 0 0-1.5-1.5 1.54 1.54 0 0 0 1.5-1.5M13 15h-2v-2h2v2m0-4h-2V9h2m6-2a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-1h-2v1h-2V9h2v1h2V9a2 2 0 0 0-2-2Z"/></svg> <span class=md-ellipsis> Fundamentals </span> </a> </li> <li class=md-nav__item> <a href=../building-blocks/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9M12 4.15 6.04 7.5 12 10.85l5.96-3.35L12 4.15M5 15.91l6 3.38v-6.71L5 9.21v6.7m14 0v-6.7l-6 3.37v6.71l6-3.38Z"/></svg> <span class=md-ellipsis> Building blocks </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex> <span class=md-ellipsis> Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../data/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4Z"/></svg> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=../data/local/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 20H4a2 2 0 0 1-2-2V6c0-1.11.89-2 2-2h6l2 2h7a2 2 0 0 1 2 2H4v10l2.14-8h17.07l-2.28 8.5c-.23.87-1.01 1.5-1.93 1.5Z"/></svg> <span class=md-ellipsis> Local </span> </a> </li> <li class=md-nav__item> <a href=../data/remote/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2m-5.15 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56M14.34 14H9.66c-.1-.66-.16-1.32-.16-2 0-.68.06-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2M12 19.96c-.83-1.2-1.5-2.53-1.91-3.96h3.82c-.41 1.43-1.08 2.76-1.91 3.96M8 8H5.08A7.923 7.923 0 0 1 9.4 4.44C8.8 5.55 8.35 6.75 8 8m-2.92 8H8c.35 1.25.8 2.45 1.4 3.56A8.008 8.008 0 0 1 5.08 16m-.82-2C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2M12 4.03c.83 1.2 1.5 2.54 1.91 3.97h-3.82c.41-1.43 1.08-2.77 1.91-3.97M18.92 8h-2.95a15.65 15.65 0 0 0-1.38-3.56c1.84.63 3.37 1.9 4.33 3.56M12 2C6.47 2 2 6.5 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2Z"/></svg> <span class=md-ellipsis> Remote </span> </a> </li> <li class=md-nav__item> <a href=../data/synthetic/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 1-1.26 2.75L15 5l2.74 1.26L19 9l1.25-2.74L23 5l-2.75-1.25M9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5M19 15l-1.26 2.74L15 19l2.74 1.25L19 23l1.25-2.75L23 19l-2.75-1.26"/></svg> <span class=md-ellipsis> Synthetic </span> </a> </li> <li class=md-nav__item> <a href=../data/scheduling/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a7 7 0 0 1-7-7 7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7m7.03-12.61 1.42-1.42c-.45-.51-.9-.97-1.41-1.41L17.62 6c-1.55-1.26-3.5-2-5.62-2a9 9 0 0 0-9 9 9 9 0 0 0 9 9c5 0 9-4.03 9-9 0-2.12-.74-4.07-1.97-5.61M11 14h2V8h-2m4-7H9v2h6V1Z"/></svg> <span class=md-ellipsis> Scheduling </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex> <span class=md-ellipsis> Indicators </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Indicators </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../indicators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3 14 .5.07L8.07 9.5a1.95 1.95 0 0 1 .52-1.91c.78-.79 2.04-.79 2.82 0 .53.52.7 1.26.52 1.91l2.57 2.57.5-.07c.18 0 .35 0 .5.07l3.57-3.57C19 8.35 19 8.18 19 8a2 2 0 0 1 2-2 2 2 0 0 1 2 2 2 2 0 0 1-2 2c-.18 0-.35 0-.5-.07l-3.57 3.57c.07.15.07.32.07.5a2 2 0 0 1-2 2 2 2 0 0 1-2-2l.07-.5-2.57-2.57c-.32.07-.68.07-1 0L4.93 15.5 5 16a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2Z"/></svg> <span class=md-ellipsis> Indicators </span> </a> </li> <li class=md-nav__item> <a href=../indicators/development/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 3c-1.11 0-2 .89-2 2v4c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2m.2 1.5 1.06 1.05L5.27 9.5 2.74 6.95 3.81 5.9l1.47 1.49M4 13c-1.11 0-2 .89-2 2v4c0 1.11.89 2 2 2h4c1.11 0 2-.89 2-2v-4c0-1.11-.89-2-2-2m-4 2h4v4H4m8-14h10v2H12m0 12v-2h10v2m-10-8h10v2H12Z"/></svg> <span class=md-ellipsis> Development </span> </a> </li> <li class=md-nav__item> <a href=../indicators/analysis/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 8c-1.5 0-2.3 1.4-1.9 2.5l-3.6 3.6c-.3-.1-.7-.1-1 0l-2.6-2.6c.4-1.1-.4-2.5-1.9-2.5-1.4 0-2.3 1.4-1.9 2.5L3.5 16c-1.1-.3-2.5.5-2.5 2 0 1.1.9 2 2 2 1.4 0 2.3-1.4 1.9-2.5l4.5-4.6c.3.1.7.1 1 0l2.6 2.6c-.3 1 .5 2.5 2 2.5s2.3-1.4 1.9-2.5l3.6-3.6c1.1.3 2.5-.5 2.5-1.9 0-1.1-.9-2-2-2m-6 1 .9-2.1L18 6l-2.1-.9L15 3l-.9 2.1L12 6l2.1.9L15 9M3.5 11 4 9l2-.5L4 8l-.5-2L3 8l-2 .5L3 9l.5 2Z"/></svg> <span class=md-ellipsis> Analysis </span> </a> </li> <li class=md-nav__item> <a href=../indicators/parsers/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.6 16.6 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4m-5.2 0L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4Z"/></svg> <span class=md-ellipsis> Parsers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5 checked> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex> <span class=md-ellipsis> Portfolio </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=true> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Portfolio </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56 6.49 3.74Z"/></svg> <span class=md-ellipsis> Portfolio </span> <span class="md-nav__icon md-icon"></span> </label> <a href=index.html class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56 6.49 3.74Z"/></svg> <span class=md-ellipsis> Portfolio </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#simulation class=md-nav__link> <span class=md-ellipsis> Simulation </span> </a> </li> <li class=md-nav__item> <a href=#primitive-commands class=md-nav__link> <span class=md-ellipsis> Primitive commands </span> </a> <nav class=md-nav aria-label="Primitive commands"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#buying class=md-nav__link> <span class=md-ellipsis> Buying </span> </a> </li> <li class=md-nav__item> <a href=#selling class=md-nav__link> <span class=md-ellipsis> Selling </span> </a> </li> <li class=md-nav__item> <a href=#shorting class=md-nav__link> <span class=md-ellipsis> Shorting </span> </a> </li> <li class=md-nav__item> <a href=#leverage class=md-nav__link> <span class=md-ellipsis> Leverage </span> </a> </li> <li class=md-nav__item> <a href=#symmetry class=md-nav__link> <span class=md-ellipsis> Symmetry </span> </a> </li> <li class=md-nav__item> <a href=#reversing class=md-nav__link> <span class=md-ellipsis> Reversing </span> </a> </li> <li class=md-nav__item> <a href=#closing class=md-nav__link> <span class=md-ellipsis> Closing </span> </a> </li> <li class=md-nav__item> <a href=#pipeline1 class=md-nav__link> <span class=md-ellipsis> Pipeline/1 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#order-execution class=md-nav__link> <span class=md-ellipsis> Order execution </span> </a> <nav class=md-nav aria-label="Order execution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#order class=md-nav__link> <span class=md-ellipsis> Order </span> </a> </li> <li class=md-nav__item> <a href=#validation class=md-nav__link> <span class=md-ellipsis> Validation </span> </a> </li> <li class=md-nav__item> <a href=#price-resolution class=md-nav__link> <span class=md-ellipsis> Price resolution </span> </a> </li> <li class=md-nav__item> <a href=#size-type-conversion class=md-nav__link> <span class=md-ellipsis> Size type conversion </span> </a> </li> <li class=md-nav__item> <a href=#direction class=md-nav__link> <span class=md-ellipsis> Direction </span> </a> </li> <li class=md-nav__item> <a href=#valuation class=md-nav__link> <span class=md-ellipsis> Valuation </span> </a> </li> <li class=md-nav__item> <a href=#pipeline2 class=md-nav__link> <span class=md-ellipsis> Pipeline/2 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#order-processing class=md-nav__link> <span class=md-ellipsis> Order processing </span> </a> <nav class=md-nav aria-label="Order processing"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#order-records class=md-nav__link> <span class=md-ellipsis> Order records </span> </a> </li> <li class=md-nav__item> <a href=#log-records class=md-nav__link> <span class=md-ellipsis> Log records </span> </a> </li> <li class=md-nav__item> <a href=#pipeline3 class=md-nav__link> <span class=md-ellipsis> Pipeline/3 </span> </a> </li> <li class=md-nav__item> <a href=#wrapping class=md-nav__link> <span class=md-ellipsis> Wrapping </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#flexible-indexing class=md-nav__link> <span class=md-ellipsis> Flexible indexing </span> </a> <nav class=md-nav aria-label="Flexible indexing"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rotational-indexing class=md-nav__link> <span class=md-ellipsis> Rotational indexing </span> </a> </li> <li class=md-nav__item> <a href=#pipeline4 class=md-nav__link> <span class=md-ellipsis> Pipeline/4 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#grouping class=md-nav__link> <span class=md-ellipsis> Grouping </span> </a> <nav class=md-nav aria-label=Grouping> <ul class=md-nav__list> <li class=md-nav__item> <a href=#group-lengths class=md-nav__link> <span class=md-ellipsis> Group lengths </span> </a> </li> <li class=md-nav__item> <a href=#group-map class=md-nav__link> <span class=md-ellipsis> Group map </span> </a> </li> <li class=md-nav__item> <a href=#call-sequence class=md-nav__link> <span class=md-ellipsis> Call sequence </span> </a> </li> <li class=md-nav__item> <a href=#pipeline5 class=md-nav__link> <span class=md-ellipsis> Pipeline/5 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#contexts class=md-nav__link> <span class=md-ellipsis> Contexts </span> </a> <nav class=md-nav aria-label=Contexts> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pipeline6 class=md-nav__link> <span class=md-ellipsis> Pipeline/6 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance class=md-nav__link> <span class=md-ellipsis> Performance </span> </a> <nav class=md-nav aria-label=Performance> <ul class=md-nav__list> <li class=md-nav__item> <a href=#benchmarking class=md-nav__link> <span class=md-ellipsis> Benchmarking </span> </a> </li> <li class=md-nav__item> <a href=#auto-parallelization class=md-nav__link> <span class=md-ellipsis> Auto-parallelization </span> </a> </li> <li class=md-nav__item> <a href=#caching class=md-nav__link> <span class=md-ellipsis> Caching </span> </a> </li> <li class=md-nav__item> <a href=#aot-compilation class=md-nav__link> <span class=md-ellipsis> AOT compilation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=from-orders/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 2v20h20V2H2m18 10h-4v4h4v4h-4v-4h-4v4H8v-4H4v-4h4V8H4V4h4v4h4V4h4v4h4v4m-4-4v4h-4V8h4m-4 4v4H8v-4h4Z"/></svg> <span class=md-ellipsis> From orders </span> </a> </li> <li class=md-nav__item> <a href=from-signals/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg> <span class=md-ellipsis> From signals </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../to-be-continued/index.html class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> API </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/index.html class=md-nav__link> <span class=md-ellipsis> API </span> </a> </li> <li class=md-nav__item> <a href=../../api/_settings/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h6.68a7 7 0 0 1-.68-3 7 7 0 0 1 7-7 7 7 0 0 1 1 .08V8l-6-6H6m7 1.5L18.5 9H13V3.5M18 14a.26.26 0 0 0-.26.21l-.19 1.32c-.3.13-.59.29-.85.47l-1.24-.5c-.11 0-.24 0-.31.13l-1 1.73c-.06.11-.04.24.06.32l1.06.82a4.193 4.193 0 0 0 0 1l-1.06.82a.26.26 0 0 0-.06.32l1 1.73c.06.13.19.13.31.13l1.24-.5c.26.18.54.35.85.47l.19 1.32c.02.12.12.21.26.21h2c.11 0 .22-.09.24-.21l.19-1.32c.3-.13.57-.29.84-.47l1.23.5c.13 0 .26 0 .33-.13l1-1.73a.26.26 0 0 0-.06-.32l-1.07-.82c.02-.17.04-.33.04-.5 0-.17-.01-.33-.04-.5l1.06-.82a.26.26 0 0 0 .06-.32l-1-1.73c-.06-.13-.19-.13-.32-.13l-1.23.5c-.27-.18-.54-.35-.85-.47l-.19-1.32A.236.236 0 0 0 20 14h-2m1 3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5c-.84 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5Z"/></svg> <span class=md-ellipsis> _settings </span> </a> </li> <li class=md-nav__item> <a href=../../api/_opt_deps/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h6.68a7 7 0 0 1-.68-3 7 7 0 0 1 7-7 7 7 0 0 1 1 .08V8l-6-6H6m7 1.5L18.5 9H13V3.5M18 14a.26.26 0 0 0-.26.21l-.19 1.32c-.3.13-.59.29-.85.47l-1.24-.5c-.11 0-.24 0-.31.13l-1 1.73c-.06.11-.04.24.06.32l1.06.82a4.193 4.193 0 0 0 0 1l-1.06.82a.26.26 0 0 0-.06.32l1 1.73c.06.13.19.13.31.13l1.24-.5c.26.18.54.35.85.47l.19 1.32c.02.12.12.21.26.21h2c.11 0 .22-.09.24-.21l.19-1.32c.3-.13.57-.29.84-.47l1.23.5c.13 0 .26 0 .33-.13l1-1.73a.26.26 0 0 0-.06-.32l-1.07-.82c.02-.17.04-.33.04-.5 0-.17-.01-.33-.04-.5l1.06-.82a.26.26 0 0 0 .06-.32l-1-1.73c-.06-.13-.19-.13-.32-.13l-1.23.5c-.27-.18-.54-.35-.85-.47l-.19-1.32A.236.236 0 0 0 20 14h-2m1 3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5c-.84 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5Z"/></svg> <span class=md-ellipsis> _opt_deps </span> </a> </li> <li class=md-nav__item> <a href=../../api/accessors/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 5H8l4-4 4 4h-3v4.43c-.75.46-1.42 1.03-2 1.69V5m11 6-4-4v3a6.747 6.747 0 0 0-7 6.17A3.006 3.006 0 0 0 9.17 20 3.006 3.006 0 0 0 13 21.83 3.01 3.01 0 0 0 14.83 18c-.3-.86-.98-1.53-1.83-1.83.47-4 4.47-4.2 4.95-4.2v3L22 11m-11.37.59A7.632 7.632 0 0 0 6 10V7l-4 4 4 4v-3c1.34.03 2.63.5 3.64 1.4.25-.64.58-1.25.99-1.81Z"/></svg> <span class=md-ellipsis> accessors </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5 id=__nav_5_5_label tabindex> <span class=md-ellipsis> base </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> base </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/base/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3M4 5h2v2H4m14 0h2v2h-2M8 17h2v2H8Z"/></svg> <span class=md-ellipsis> base </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/accessors/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 5H8l4-4 4 4h-3v4.43c-.75.46-1.42 1.03-2 1.69V5m11 6-4-4v3a6.747 6.747 0 0 0-7 6.17A3.006 3.006 0 0 0 9.17 20 3.006 3.006 0 0 0 13 21.83 3.01 3.01 0 0 0 14.83 18c-.3-.86-.98-1.53-1.83-1.83.47-4 4.47-4.2 4.95-4.2v3L22 11m-11.37.59A7.632 7.632 0 0 0 6 10V7l-4 4 4 4v-3c1.34.03 2.63.5 3.64 1.4.25-.64.58-1.25.99-1.81Z"/></svg> <span class=md-ellipsis> accessors </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/chunking/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16v-3h-3v9h-2V2h2v9h3V8l4 4-4 4M2 12l4 4v-3h3v9h2V2H9v9H6V8l-4 4Z"/></svg> <span class=md-ellipsis> chunking </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/combining/index.html class=md-nav__link> <span class=md-ellipsis> combining </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/decorators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3H2m2 2h2v2H4V5m14 2h2v2h-2V7m0 8v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2M8 17h2v2H8v-2Z"/></svg> <span class=md-ellipsis> decorators </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/flex_indexing/index.html class=md-nav__link> <span class=md-ellipsis> flex_indexing </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/indexes/index.html class=md-nav__link> <span class=md-ellipsis> indexes <span class=dobjtype>module</span><a class=githublink href=https://github.com/drew2323/vbtpro/blob/main/vectorbtpro/base/indexes.py target=_blank title="Jump to source"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg></a> </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/indexing/index.html class=md-nav__link> <span class=md-ellipsis> indexing </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/merging/index.html class=md-nav__link> <span class=md-ellipsis> merging </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/preparing/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 4V3a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V6h1v4H9v11a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-9h8V4h-3Z"/></svg> <span class=md-ellipsis> preparing </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/reshaping/index.html class=md-nav__link> <span class=md-ellipsis> reshaping </span> </a> </li> <li class=md-nav__item> <a href=../../api/base/wrapping/index.html class=md-nav__link> <span class=md-ellipsis> wrapping </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/base/grouping/index.html class=md-nav__link> <span class=md-ellipsis> grouping </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/base/resampling/index.html class=md-nav__link> <span class=md-ellipsis> resampling </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_6> <label class=md-nav__link for=__nav_5_6 id=__nav_5_6_label tabindex> <span class=md-ellipsis> data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/data/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4Z"/></svg> <span class=md-ellipsis> data </span> </a> </li> <li class=md-nav__item> <a href=../../api/data/base/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3M4 5h2v2H4m14 0h2v2h-2M8 17h2v2H8Z"/></svg> <span class=md-ellipsis> base </span> </a> </li> <li class=md-nav__item> <a href=../../api/data/decorators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3H2m2 2h2v2H4V5m14 2h2v2h-2V7m0 8v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2M8 17h2v2H8v-2Z"/></svg> <span class=md-ellipsis> decorators </span> </a> </li> <li class=md-nav__item> <a href=../../api/data/nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m6 20 4.16-12.09L9.34 6H8V4h2c.42 0 .78.26.93.63L16.66 18H18v2h-2c-.43 0-.79-.27-.93-.64l-3.74-8.71L8.12 20H6Z"/></svg> <span class=md-ellipsis> nb </span> </a> </li> <li class=md-nav__item> <a href=../../api/data/saver/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a7 7 0 0 1-7-7 7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7m7.03-12.61 1.42-1.42c-.45-.51-.9-.97-1.41-1.41L17.62 6c-1.55-1.26-3.5-2-5.62-2a9 9 0 0 0-9 9 9 9 0 0 0 9 9c5 0 9-4.03 9-9 0-2.12-.74-4.07-1.97-5.61M11 14h2V8h-2m4-7H9v2h6V1Z"/></svg> <span class=md-ellipsis> saver </span> </a> </li> <li class=md-nav__item> <a href=../../api/data/updater/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a7 7 0 0 1-7-7 7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7m7.03-12.61 1.42-1.42c-.45-.51-.9-.97-1.41-1.41L17.62 6c-1.55-1.26-3.5-2-5.62-2a9 9 0 0 0-9 9 9 9 0 0 0 9 9c5 0 9-4.03 9-9 0-2.12-.74-4.07-1.97-5.61M11 14h2V8h-2m4-7H9v2h6V1Z"/></svg> <span class=md-ellipsis> updater </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/data/custom/index.html class=md-nav__link> <span class=md-ellipsis> custom </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_7> <label class=md-nav__link for=__nav_5_7 id=__nav_5_7_label tabindex> <span class=md-ellipsis> generic </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_7_label aria-expanded=false> <label class=md-nav__title for=__nav_5_7> <span class="md-nav__icon md-icon"></span> generic </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/generic/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 2h4v2H4v16h2v2H2V2m18 2h-2V2h4v20h-4v-2h2V4M9 5h1v5h1v1H8v-1h1V6l-1 .5v-1L9 5m6 8h1v5h1v1h-3v-1h1v-4l-1 .5v-1l1-.5m-6 0c1.1 0 2 1.34 2 3s-.9 3-2 3-2-1.34-2-3 .9-3 2-3m0 1c-.55 0-1 .9-1 2s.45 2 1 2 1-.9 1-2-.45-2-1-2m6-9c1.1 0 2 1.34 2 3s-.9 3-2 3-2-1.34-2-3 .9-3 2-3m0 1c-.55 0-1 .9-1 2s.45 2 1 2 1-.9 1-2-.45-2-1-2Z"/></svg> <span class=md-ellipsis> generic </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/accessors/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 5H8l4-4 4 4h-3v4.43c-.75.46-1.42 1.03-2 1.69V5m11 6-4-4v3a6.747 6.747 0 0 0-7 6.17A3.006 3.006 0 0 0 9.17 20 3.006 3.006 0 0 0 13 21.83 3.01 3.01 0 0 0 14.83 18c-.3-.86-.98-1.53-1.83-1.83.47-4 4.47-4.2 4.95-4.2v3L22 11m-11.37.59A7.632 7.632 0 0 0 6 10V7l-4 4 4 4v-3c1.34.03 2.63.5 3.64 1.4.25-.64.58-1.25.99-1.81Z"/></svg> <span class=md-ellipsis> accessors </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/analyzable/index.html class=md-nav__link> <span class=md-ellipsis> analyzable </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/decorators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3H2m2 2h2v2H4V5m14 2h2v2h-2V7m0 8v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2M8 17h2v2H8v-2Z"/></svg> <span class=md-ellipsis> decorators </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/drawdowns/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 8v4h8v-4H8m0 6v4h8v-4H8M8 4v4h8V4H8Z"/></svg> <span class=md-ellipsis> drawdowns </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/enums/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 3h2v2H5v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5h2v2H5c-1.07-.27-2-.9-2-2v-4a2 2 0 0 0-2-2H0v-2h1a2 2 0 0 0 2-2V5a2 2 0 0 1 2-2m14 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3h2m-7 12a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m8 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1Z"/></svg> <span class=md-ellipsis> enums </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/plots_builder/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13.04 19.61a2.682 2.682 0 0 0-2.54-1.81c-1.5 0-2.7 1.2-2.7 2.7V22H4a2 2 0 0 1-2-2v-3.8h1.5c1.5 0 2.7-1.2 2.7-2.7S5 10.8 3.5 10.8H2V7c0-1.1.9-2 2-2h4V3.5a2.5 2.5 0 0 1 5 0V5h4a2 2 0 0 1 2 2v4h1.5a2.5 2.5 0 0 1 2.5 2.5c0 .32-.06.62-.17.89A5.991 5.991 0 0 0 19 13c-3.31 0-6 2.69-6 6 0 .2 0 .41.04.61M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg> <span class=md-ellipsis> plots_builder </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/plotting/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.2 11.2c1.77 0 3.2 1.43 3.2 3.2 0 1.77-1.43 3.2-3.2 3.2-1.77 0-3.2-1.43-3.2-3.2 0-1.77 1.43-3.2 3.2-3.2m7.6 4.8a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m.4-12A4.8 4.8 0 0 1 20 8.8c0 2.65-2.15 4.8-4.8 4.8a4.8 4.8 0 0 1-4.8-4.8c0-2.65 2.15-4.8 4.8-4.8Z"/></svg> <span class=md-ellipsis> plotting </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/price_records/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 8v4h8v-4H8m0 6v4h8v-4H8M8 4v4h8V4H8Z"/></svg> <span class=md-ellipsis> price_records </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/ranges/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 8v4h8v-4H8m0 6v4h8v-4H8M8 4v4h8V4H8Z"/></svg> <span class=md-ellipsis> ranges </span> </a> </li> <li class=md-nav__item> <a href=../../api/generic/stats_builder/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13.04 19.61a2.682 2.682 0 0 0-2.54-1.81c-1.5 0-2.7 1.2-2.7 2.7V22H4a2 2 0 0 1-2-2v-3.8h1.5c1.5 0 2.7-1.2 2.7-2.7S5 10.8 3.5 10.8H2V7c0-1.1.9-2 2-2h4V3.5a2.5 2.5 0 0 1 5 0V5h4a2 2 0 0 1 2 2v4h1.5a2.5 2.5 0 0 1 2.5 2.5c0 .32-.06.62-.17.89A5.991 5.991 0 0 0 19 13c-3.31 0-6 2.69-6 6 0 .2 0 .41.04.61M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg> <span class=md-ellipsis> stats_builder </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/generic/nb/index.html class=md-nav__link> <span class=md-ellipsis> nb </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/generic/splitting/index.html class=md-nav__link> <span class=md-ellipsis> splitting </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8> <label class=md-nav__link for=__nav_5_8 id=__nav_5_8_label tabindex> <span class=md-ellipsis> indicators </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> indicators </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/indicators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3 14 .5.07L8.07 9.5a1.95 1.95 0 0 1 .52-1.91c.78-.79 2.04-.79 2.82 0 .53.52.7 1.26.52 1.91l2.57 2.57.5-.07c.18 0 .35 0 .5.07l3.57-3.57C19 8.35 19 8.18 19 8a2 2 0 0 1 2-2 2 2 0 0 1 2 2 2 2 0 0 1-2 2c-.18 0-.35 0-.5-.07l-3.57 3.57c.07.15.07.32.07.5a2 2 0 0 1-2 2 2 2 0 0 1-2-2l.07-.5-2.57-2.57c-.32.07-.68.07-1 0L4.93 15.5 5 16a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2Z"/></svg> <span class=md-ellipsis> indicators </span> </a> </li> <li class=md-nav__item> <a href=../../api/indicators/configs/index.html class=md-nav__link> <span class=md-ellipsis> configs </span> </a> </li> <li class=md-nav__item> <a href=../../api/indicators/enums/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 3h2v2H5v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5h2v2H5c-1.07-.27-2-.9-2-2v-4a2 2 0 0 0-2-2H0v-2h1a2 2 0 0 0 2-2V5a2 2 0 0 1 2-2m14 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3h2m-7 12a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m8 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1Z"/></svg> <span class=md-ellipsis> enums </span> </a> </li> <li class=md-nav__item> <a href=../../api/indicators/expr/index.html class=md-nav__link> <span class=md-ellipsis> expr </span> </a> </li> <li class=md-nav__item> <a href=../../api/indicators/factory/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 18v2h4v-2H4m0-4v2h10v-2H4m6 4v2h4v-2h-4m6-4v2h4v-2h-4m0 4v2h4v-2h-4M2 22V8l5 4V8l5 4V8l5 4 1-10h3l1 10v10H2Z"/></svg> <span class=md-ellipsis> factory </span> </a> </li> <li class=md-nav__item> <a href=../../api/indicators/nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m6 20 4.16-12.09L9.34 6H8V4h2c.42 0 .78.26.93.63L16.66 18H18v2h-2c-.43 0-.79-.27-.93-.64l-3.74-8.71L8.12 20H6Z"/></svg> <span class=md-ellipsis> nb </span> </a> </li> <li class=md-nav__item> <a href=../../api/indicators/talib_/index.html class=md-nav__link> <span class=md-ellipsis> talib_ </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/indicators/custom/index.html class=md-nav__link> <span class=md-ellipsis> custom </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_9> <label class=md-nav__link for=__nav_5_9 id=__nav_5_9_label tabindex> <span class=md-ellipsis> labels </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_9_label aria-expanded=false> <label class=md-nav__title for=__nav_5_9> <span class="md-nav__icon md-icon"></span> labels </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/labels/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 18h9l-2 2H4c-.5 0-1.03-.21-1.41-.59C2.21 19.03 2 18.5 2 18V8h2v10M17.63 4.84C17.27 4.33 16.67 4 16 4H8c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h8c.67 0 1.27-.34 1.63-.85L22 10l-4.37-5.16M16 14H8V6h8l3.55 4Z"/></svg> <span class=md-ellipsis> labels </span> </a> </li> <li class=md-nav__item> <a href=../../api/labels/enums/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 3h2v2H5v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5h2v2H5c-1.07-.27-2-.9-2-2v-4a2 2 0 0 0-2-2H0v-2h1a2 2 0 0 0 2-2V5a2 2 0 0 1 2-2m14 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3h2m-7 12a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m8 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1Z"/></svg> <span class=md-ellipsis> enums </span> </a> </li> <li class=md-nav__item> <a href=../../api/labels/nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m6 20 4.16-12.09L9.34 6H8V4h2c.42 0 .78.26.93.63L16.66 18H18v2h-2c-.43 0-.79-.27-.93-.64l-3.74-8.71L8.12 20H6Z"/></svg> <span class=md-ellipsis> nb </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/labels/generators/index.html class=md-nav__link> <span class=md-ellipsis> generators </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_10> <label class=md-nav__link for=__nav_5_10 id=__nav_5_10_label tabindex> <span class=md-ellipsis> messaging </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_10_label aria-expanded=false> <label class=md-nav__title for=__nav_5_10> <span class="md-nav__icon md-icon"></span> messaging </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/messaging/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6l-4 4V4a2 2 0 0 1 2-2h16M4 4v13.17L5.17 16H20V4H4m2 3h12v2H6V7m0 4h9v2H6v-2Z"/></svg> <span class=md-ellipsis> messaging </span> </a> </li> <li class=md-nav__item> <a href=../../api/messaging/telegram/index.html class=md-nav__link> <span class=md-ellipsis> telegram </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_11> <label class=md-nav__link for=__nav_5_11 id=__nav_5_11_label tabindex> <span class=md-ellipsis> ohlcv </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_11_label aria-expanded=false> <label class=md-nav__title for=__nav_5_11> <span class="md-nav__icon md-icon"></span> ohlcv </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/ohlcv/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2v3h2v14H8v3H6v-3H4V5h2V2h2m8 0v5h-2v10h2v5h2v-5h2V7h-2V2h-2Z"/></svg> <span class=md-ellipsis> ohlcv </span> </a> </li> <li class=md-nav__item> <a href=../../api/ohlcv/accessors/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 5H8l4-4 4 4h-3v4.43c-.75.46-1.42 1.03-2 1.69V5m11 6-4-4v3a6.747 6.747 0 0 0-7 6.17A3.006 3.006 0 0 0 9.17 20 3.006 3.006 0 0 0 13 21.83 3.01 3.01 0 0 0 14.83 18c-.3-.86-.98-1.53-1.83-1.83.47-4 4.47-4.2 4.95-4.2v3L22 11m-11.37.59A7.632 7.632 0 0 0 6 10V7l-4 4 4 4v-3c1.34.03 2.63.5 3.64 1.4.25-.64.58-1.25.99-1.81Z"/></svg> <span class=md-ellipsis> accessors </span> </a> </li> <li class=md-nav__item> <a href=../../api/ohlcv/nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m6 20 4.16-12.09L9.34 6H8V4h2c.42 0 .78.26.93.63L16.66 18H18v2h-2c-.43 0-.79-.27-.93-.64l-3.74-8.71L8.12 20H6Z"/></svg> <span class=md-ellipsis> nb </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_12> <label class=md-nav__link for=__nav_5_12 id=__nav_5_12_label tabindex> <span class=md-ellipsis> portfolio </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_12_label aria-expanded=false> <label class=md-nav__title for=__nav_5_12> <span class="md-nav__icon md-icon"></span> portfolio </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/portfolio/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56 6.49 3.74Z"/></svg> <span class=md-ellipsis> portfolio </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/base/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3M4 5h2v2H4m14 0h2v2h-2M8 17h2v2H8Z"/></svg> <span class=md-ellipsis> base </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/call_seq/index.html class=md-nav__link> <span class=md-ellipsis> call_seq </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/chunking/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16v-3h-3v9h-2V2h2v9h3V8l4 4-4 4M2 12l4 4v-3h3v9h2V2H9v9H6V8l-4 4Z"/></svg> <span class=md-ellipsis> chunking </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/decorators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3H2m2 2h2v2H4V5m14 2h2v2h-2V7m0 8v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2M8 17h2v2H8v-2Z"/></svg> <span class=md-ellipsis> decorators </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/enums/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 3h2v2H5v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5h2v2H5c-1.07-.27-2-.9-2-2v-4a2 2 0 0 0-2-2H0v-2h1a2 2 0 0 0 2-2V5a2 2 0 0 1 2-2m14 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3h2m-7 12a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m8 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1Z"/></svg> <span class=md-ellipsis> enums </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/logs/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 8v4h8v-4H8m0 6v4h8v-4H8M8 4v4h8V4H8Z"/></svg> <span class=md-ellipsis> logs </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/orders/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 8v4h8v-4H8m0 6v4h8v-4H8M8 4v4h8V4H8Z"/></svg> <span class=md-ellipsis> orders </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/preparing/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 4V3a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V6h1v4H9v11a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-9h8V4h-3Z"/></svg> <span class=md-ellipsis> preparing </span> </a> </li> <li class=md-nav__item> <a href=../../api/portfolio/trades/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 8v4h8v-4H8m0 6v4h8v-4H8M8 4v4h8V4H8Z"/></svg> <span class=md-ellipsis> trades </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/portfolio/nb/index.html class=md-nav__link> <span class=md-ellipsis> nb </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/portfolio/pfopt/index.html class=md-nav__link> <span class=md-ellipsis> pfopt </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_13> <label class=md-nav__link for=__nav_5_13 id=__nav_5_13_label tabindex> <span class=md-ellipsis> px </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_13_label aria-expanded=false> <label class=md-nav__title for=__nav_5_13> <span class="md-nav__icon md-icon"></span> px </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/px/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.2 11.2c1.77 0 3.2 1.43 3.2 3.2 0 1.77-1.43 3.2-3.2 3.2-1.77 0-3.2-1.43-3.2-3.2 0-1.77 1.43-3.2 3.2-3.2m7.6 4.8a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m.4-12A4.8 4.8 0 0 1 20 8.8c0 2.65-2.15 4.8-4.8 4.8a4.8 4.8 0 0 1-4.8-4.8c0-2.65 2.15-4.8 4.8-4.8Z"/></svg> <span class=md-ellipsis> px </span> </a> </li> <li class=md-nav__item> <a href=../../api/px/accessors/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 5H8l4-4 4 4h-3v4.43c-.75.46-1.42 1.03-2 1.69V5m11 6-4-4v3a6.747 6.747 0 0 0-7 6.17A3.006 3.006 0 0 0 9.17 20 3.006 3.006 0 0 0 13 21.83 3.01 3.01 0 0 0 14.83 18c-.3-.86-.98-1.53-1.83-1.83.47-4 4.47-4.2 4.95-4.2v3L22 11m-11.37.59A7.632 7.632 0 0 0 6 10V7l-4 4 4 4v-3c1.34.03 2.63.5 3.64 1.4.25-.64.58-1.25.99-1.81Z"/></svg> <span class=md-ellipsis> accessors </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_14> <label class=md-nav__link for=__nav_5_14 id=__nav_5_14_label tabindex> <span class=md-ellipsis> records </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_14_label aria-expanded=false> <label class=md-nav__title for=__nav_5_14> <span class="md-nav__icon md-icon"></span> records </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/records/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 2h8a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 8v4h8v-4H8m0 6v4h8v-4H8M8 4v4h8V4H8Z"/></svg> <span class=md-ellipsis> records </span> </a> </li> <li class=md-nav__item> <a href=../../api/records/base/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3M4 5h2v2H4m14 0h2v2h-2M8 17h2v2H8Z"/></svg> <span class=md-ellipsis> base </span> </a> </li> <li class=md-nav__item> <a href=../../api/records/chunking/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16v-3h-3v9h-2V2h2v9h3V8l4 4-4 4M2 12l4 4v-3h3v9h2V2H9v9H6V8l-4 4Z"/></svg> <span class=md-ellipsis> chunking </span> </a> </li> <li class=md-nav__item> <a href=../../api/records/col_mapper/index.html class=md-nav__link> <span class=md-ellipsis> col_mapper </span> </a> </li> <li class=md-nav__item> <a href=../../api/records/decorators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3H2m2 2h2v2H4V5m14 2h2v2h-2V7m0 8v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2M8 17h2v2H8v-2Z"/></svg> <span class=md-ellipsis> decorators </span> </a> </li> <li class=md-nav__item> <a href=../../api/records/mapped_array/index.html class=md-nav__link> <span class=md-ellipsis> mapped_array </span> </a> </li> <li class=md-nav__item> <a href=../../api/records/nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m6 20 4.16-12.09L9.34 6H8V4h2c.42 0 .78.26.93.63L16.66 18H18v2h-2c-.43 0-.79-.27-.93-.64l-3.74-8.71L8.12 20H6Z"/></svg> <span class=md-ellipsis> nb </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_15> <label class=md-nav__link for=__nav_5_15 id=__nav_5_15_label tabindex> <span class=md-ellipsis> registries </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_15_label aria-expanded=false> <label class=md-nav__title for=__nav_5_15> <span class="md-nav__icon md-icon"></span> registries </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/registries/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17 21-2.75-3 1.16-1.16L17 18.43l3.59-3.59 1.16 1.41M12.8 21H5a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h14a2 2 0 0 1 2 2v7.8c-.88-.51-1.91-.8-3-.8l-1 .08V11H7v2h7.69A5.983 5.983 0 0 0 12 18c0 1.09.29 2.12.8 3m-.8-6H7v2h5m5-10H7v2h10"/></svg> <span class=md-ellipsis> registries </span> </a> </li> <li class=md-nav__item> <a href=../../api/registries/ca_registry/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 8-4 4h3a6 6 0 0 1-6 6c-1 0-1.97-.25-2.8-.7l-1.46 1.46A7.93 7.93 0 0 0 12 20a8 8 0 0 0 8-8h3M6 12a6 6 0 0 1 6-6c1 0 1.97.25 2.8.7l1.46-1.46A7.93 7.93 0 0 0 12 4a8 8 0 0 0-8 8H1l4 4 4-4"/></svg> <span class=md-ellipsis> ca_registry </span> </a> </li> <li class=md-nav__item> <a href=../../api/registries/ch_registry/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16v-3h-3v9h-2V2h2v9h3V8l4 4-4 4M2 12l4 4v-3h3v9h2V2H9v9H6V8l-4 4Z"/></svg> <span class=md-ellipsis> ch_registry </span> </a> </li> <li class=md-nav__item> <a href=../../api/registries/jit_registry/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16a3 3 0 0 1-3-3c0-1.12.61-2.1 1.5-2.61l9.71-5.62-5.53 9.58c-.5.98-1.51 1.65-2.68 1.65m0-13c1.81 0 3.5.5 4.97 1.32l-2.1 1.21C14 5.19 13 5 12 5a8 8 0 0 0-8 8c0 2.21.89 4.21 2.34 5.65h.01c.39.39.39 1.02 0 1.41-.39.39-1.03.39-1.42.01A9.969 9.969 0 0 1 2 13 10 10 0 0 1 12 3m10 10c0 2.76-1.12 5.26-2.93 7.07-.39.38-1.02.38-1.41-.01a.996.996 0 0 1 0-1.41A7.95 7.95 0 0 0 20 13c0-1-.19-2-.54-2.9L20.67 8C21.5 9.5 22 11.18 22 13Z"/></svg> <span class=md-ellipsis> jit_registry </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_16> <label class=md-nav__link for=__nav_5_16 id=__nav_5_16_label tabindex> <span class=md-ellipsis> returns </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_16_label aria-expanded=false> <label class=md-nav__title for=__nav_5_16> <span class="md-nav__icon md-icon"></span> returns </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/returns/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m16 11.78 4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L5.46 19H22v2H2V3h2v14.54L9.5 8l6.5 3.78Z"/></svg> <span class=md-ellipsis> returns </span> </a> </li> <li class=md-nav__item> <a href=../../api/returns/accessors/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 5H8l4-4 4 4h-3v4.43c-.75.46-1.42 1.03-2 1.69V5m11 6-4-4v3a6.747 6.747 0 0 0-7 6.17A3.006 3.006 0 0 0 9.17 20 3.006 3.006 0 0 0 13 21.83 3.01 3.01 0 0 0 14.83 18c-.3-.86-.98-1.53-1.83-1.83.47-4 4.47-4.2 4.95-4.2v3L22 11m-11.37.59A7.632 7.632 0 0 0 6 10V7l-4 4 4 4v-3c1.34.03 2.63.5 3.64 1.4.25-.64.58-1.25.99-1.81Z"/></svg> <span class=md-ellipsis> accessors </span> </a> </li> <li class=md-nav__item> <a href=../../api/returns/enums/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 3h2v2H5v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5h2v2H5c-1.07-.27-2-.9-2-2v-4a2 2 0 0 0-2-2H0v-2h1a2 2 0 0 0 2-2V5a2 2 0 0 1 2-2m14 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3h2m-7 12a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m8 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1Z"/></svg> <span class=md-ellipsis> enums </span> </a> </li> <li class=md-nav__item> <a href=../../api/returns/nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m6 20 4.16-12.09L9.34 6H8V4h2c.42 0 .78.26.93.63L16.66 18H18v2h-2c-.43 0-.79-.27-.93-.64l-3.74-8.71L8.12 20H6Z"/></svg> <span class=md-ellipsis> nb </span> </a> </li> <li class=md-nav__item> <a href=../../api/returns/qs_adapter/index.html class=md-nav__link> <span class=md-ellipsis> qs_adapter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_17> <label class=md-nav__link for=__nav_5_17 id=__nav_5_17_label tabindex> <span class=md-ellipsis> signals </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_17_label aria-expanded=false> <label class=md-nav__title for=__nav_5_17> <span class="md-nav__icon md-icon"></span> signals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/signals/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg> <span class=md-ellipsis> signals </span> </a> </li> <li class=md-nav__item> <a href=../../api/signals/accessors/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 5H8l4-4 4 4h-3v4.43c-.75.46-1.42 1.03-2 1.69V5m11 6-4-4v3a6.747 6.747 0 0 0-7 6.17A3.006 3.006 0 0 0 9.17 20 3.006 3.006 0 0 0 13 21.83 3.01 3.01 0 0 0 14.83 18c-.3-.86-.98-1.53-1.83-1.83.47-4 4.47-4.2 4.95-4.2v3L22 11m-11.37.59A7.632 7.632 0 0 0 6 10V7l-4 4 4 4v-3c1.34.03 2.63.5 3.64 1.4.25-.64.58-1.25.99-1.81Z"/></svg> <span class=md-ellipsis> accessors </span> </a> </li> <li class=md-nav__item> <a href=../../api/signals/enums/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 3h2v2H5v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5h2v2H5c-1.07-.27-2-.9-2-2v-4a2 2 0 0 0-2-2H0v-2h1a2 2 0 0 0 2-2V5a2 2 0 0 1 2-2m14 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3h2m-7 12a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m8 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1Z"/></svg> <span class=md-ellipsis> enums </span> </a> </li> <li class=md-nav__item> <a href=../../api/signals/factory/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 18v2h4v-2H4m0-4v2h10v-2H4m6 4v2h4v-2h-4m6-4v2h4v-2h-4m0 4v2h4v-2h-4M2 22V8l5 4V8l5 4V8l5 4 1-10h3l1 10v10H2Z"/></svg> <span class=md-ellipsis> factory </span> </a> </li> <li class=md-nav__item> <a href=../../api/signals/nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m6 20 4.16-12.09L9.34 6H8V4h2c.42 0 .78.26.93.63L16.66 18H18v2h-2c-.43 0-.79-.27-.93-.64l-3.74-8.71L8.12 20H6Z"/></svg> <span class=md-ellipsis> nb </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api/signals/generators/index.html class=md-nav__link> <span class=md-ellipsis> generators </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_18> <label class=md-nav__link for=__nav_5_18 id=__nav_5_18_label tabindex> <span class=md-ellipsis> utils </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_18_label aria-expanded=false> <label class=md-nav__title for=__nav_5_18> <span class="md-nav__icon md-icon"></span> utils </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/utils/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m21.71 20.29-1.42 1.42a1 1 0 0 1-1.41 0L7 9.85A3.81 3.81 0 0 1 6 10a4 4 0 0 1-3.78-5.3l2.54 2.54.53-.53 1.42-1.42.53-.53L4.7 2.22A4 4 0 0 1 10 6a3.81 3.81 0 0 1-.15 1l11.86 11.88a1 1 0 0 1 0 1.41M2.29 18.88a1 1 0 0 0 0 1.41l1.42 1.42a1 1 0 0 0 1.41 0l5.47-5.46-2.83-2.83M20 2l-4 2v2l-2.17 2.17 2 2L18 8h2l2-4Z"/></svg> <span class=md-ellipsis> utils </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/annotations/index.html class=md-nav__link> <span class=md-ellipsis> annotations </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/array_/index.html class=md-nav__link> <span class=md-ellipsis> array_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/attr_/index.html class=md-nav__link> <span class=md-ellipsis> attr_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/caching/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 8-4 4h3a6 6 0 0 1-6 6c-1 0-1.97-.25-2.8-.7l-1.46 1.46A7.93 7.93 0 0 0 12 20a8 8 0 0 0 8-8h3M6 12a6 6 0 0 1 6-6c1 0 1.97.25 2.8.7l1.46-1.46A7.93 7.93 0 0 0 12 4a8 8 0 0 0-8 8H1l4 4 4-4"/></svg> <span class=md-ellipsis> caching </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/chaining/index.html class=md-nav__link> <span class=md-ellipsis> chaining </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/checks/index.html class=md-nav__link> <span class=md-ellipsis> checks </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/chunking/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16v-3h-3v9h-2V2h2v9h3V8l4 4-4 4M2 12l4 4v-3h3v9h2V2H9v9H6V8l-4 4Z"/></svg> <span class=md-ellipsis> chunking </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/colors/index.html class=md-nav__link> <span class=md-ellipsis> colors </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/config/index.html class=md-nav__link> <span class=md-ellipsis> config </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/cutting/index.html class=md-nav__link> <span class=md-ellipsis> cutting </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/datetime_/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg> <span class=md-ellipsis> datetime_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/datetime_nb/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg> <span class=md-ellipsis> datetime_nb </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/decorators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3H2m2 2h2v2H4V5m14 2h2v2h-2V7m0 8v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2M8 17h2v2H8v-2Z"/></svg> <span class=md-ellipsis> decorators </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/enum_/index.html class=md-nav__link> <span class=md-ellipsis> enum_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/eval_/index.html class=md-nav__link> <span class=md-ellipsis> eval_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/execution/index.html class=md-nav__link> <span class=md-ellipsis> execution </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/figure/index.html class=md-nav__link> <span class=md-ellipsis> figure </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/formatting/index.html class=md-nav__link> <span class=md-ellipsis> formatting </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/hashing/index.html class=md-nav__link> <span class=md-ellipsis> hashing </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/image_/index.html class=md-nav__link> <span class=md-ellipsis> image_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/jitting/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16a3 3 0 0 1-3-3c0-1.12.61-2.1 1.5-2.61l9.71-5.62-5.53 9.58c-.5.98-1.51 1.65-2.68 1.65m0-13c1.81 0 3.5.5 4.97 1.32l-2.1 1.21C14 5.19 13 5 12 5a8 8 0 0 0-8 8c0 2.21.89 4.21 2.34 5.65h.01c.39.39.39 1.02 0 1.41-.39.39-1.03.39-1.42.01A9.969 9.969 0 0 1 2 13 10 10 0 0 1 12 3m10 10c0 2.76-1.12 5.26-2.93 7.07-.39.38-1.02.38-1.41-.01a.996.996 0 0 1 0-1.41A7.95 7.95 0 0 0 20 13c0-1-.19-2-.54-2.9L20.67 8C21.5 9.5 22 11.18 22 13Z"/></svg> <span class=md-ellipsis> jitting </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/magic_decorators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 3v6h2.95l2 6H6v6h6v-4.59L17.41 11H22V5h-6v4.57L10.59 15H9.06l-2-6H8V3H2m2 2h2v2H4V5m14 2h2v2h-2V7m0 8v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2M8 17h2v2H8v-2Z"/></svg> <span class=md-ellipsis> magic_decorators </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/mapping/index.html class=md-nav__link> <span class=md-ellipsis> mapping </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/math_/index.html class=md-nav__link> <span class=md-ellipsis> math_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/merging/index.html class=md-nav__link> <span class=md-ellipsis> merging </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/module_/index.html class=md-nav__link> <span class=md-ellipsis> module_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/path_/index.html class=md-nav__link> <span class=md-ellipsis> path_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/params/index.html class=md-nav__link> <span class=md-ellipsis> params </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/parsing/index.html class=md-nav__link> <span class=md-ellipsis> parsing </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/pbar/index.html class=md-nav__link> <span class=md-ellipsis> pbar </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/pickling/index.html class=md-nav__link> <span class=md-ellipsis> pickling </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/profiling/index.html class=md-nav__link> <span class=md-ellipsis> profiling </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/random_/index.html class=md-nav__link> <span class=md-ellipsis> random_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/requests_/index.html class=md-nav__link> <span class=md-ellipsis> requests_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/schedule_/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a7 7 0 0 1-7-7 7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7m7.03-12.61 1.42-1.42c-.45-.51-.9-.97-1.41-1.41L17.62 6c-1.55-1.26-3.5-2-5.62-2a9 9 0 0 0-9 9 9 9 0 0 0 9 9c5 0 9-4.03 9-9 0-2.12-.74-4.07-1.97-5.61M11 14h2V8h-2m4-7H9v2h6V1Z"/></svg> <span class=md-ellipsis> schedule_ </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/search/index.html class=md-nav__link> <span class=md-ellipsis> search </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/selection/index.html class=md-nav__link> <span class=md-ellipsis> selection </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/tagging/index.html class=md-nav__link> <span class=md-ellipsis> tagging </span> </a> </li> <li class=md-nav__item> <a href=../../api/utils/template/index.html class=md-nav__link> <span class=md-ellipsis> template </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Cookbook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cookbook/overview/index.html class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/discovery/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 3h6v4H3V3m12 7h6v4h-6v-4m0 7h6v4h-6v-4m-2-4H7v5h6v2H5V9h2v2h6v2Z"/></svg> <span class=md-ellipsis> Discovery </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/configuration/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/></svg> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/persistence/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 12h2v5h16v-5h2v5c0 1.11-.89 2-2 2H4a2 2 0 0 1-2-2v-5m10 3 5.55-5.46-1.42-1.41L13 11.25V2h-2v9.25L7.88 8.13 6.46 9.55 12 15Z"/></svg> <span class=md-ellipsis> Persistence </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/caching/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 8-4 4h3a6 6 0 0 1-6 6c-1 0-1.97-.25-2.8-.7l-1.46 1.46A7.93 7.93 0 0 0 12 20a8 8 0 0 0 8-8h3M6 12a6 6 0 0 1 6-6c1 0 1.97.25 2.8.7l1.46-1.46A7.93 7.93 0 0 0 12 4a8 8 0 0 0-8 8H1l4 4 4-4"/></svg> <span class=md-ellipsis> Caching </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/plotting/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.2 11.2c1.77 0 3.2 1.43 3.2 3.2 0 1.77-1.43 3.2-3.2 3.2-1.77 0-3.2-1.43-3.2-3.2 0-1.77 1.43-3.2 3.2-3.2m7.6 4.8a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m.4-12A4.8 4.8 0 0 1 20 8.8c0 2.65-2.15 4.8-4.8 4.8a4.8 4.8 0 0 1-4.8-4.8c0-2.65 2.15-4.8 4.8-4.8Z"/></svg> <span class=md-ellipsis> Plotting </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/compilation/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16a3 3 0 0 1-3-3c0-1.12.61-2.1 1.5-2.61l9.71-5.62-5.53 9.58c-.5.98-1.51 1.65-2.68 1.65m0-13c1.81 0 3.5.5 4.97 1.32l-2.1 1.21C14 5.19 13 5 12 5a8 8 0 0 0-8 8c0 2.21.89 4.21 2.34 5.65h.01c.39.39.39 1.02 0 1.41-.39.39-1.03.39-1.42.01A9.969 9.969 0 0 1 2 13 10 10 0 0 1 12 3m10 10c0 2.76-1.12 5.26-2.93 7.07-.39.38-1.02.38-1.41-.01a.996.996 0 0 1 0-1.41A7.95 7.95 0 0 0 20 13c0-1-.19-2-.54-2.9L20.67 8C21.5 9.5 22 11.18 22 13Z"/></svg> <span class=md-ellipsis> Compilation </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/data/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4Z"/></svg> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/arrays/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7 2h14a2 2 0 0 1 2 2v12c0 1.11-.89 2-2 2H7a2 2 0 0 1-2-2V4c0-1.1.9-2 2-2m0 4v4h6V6H7m8 0v4h6V6h-6m-8 6v4h6v-4H7m8 0v4h6v-4h-6M3 20V6H1v14c0 1.11.89 2 2 2h16v-2H3Z"/></svg> <span class=md-ellipsis> Arrays </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/indexing/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 20.5c0 .8-.7 1.5-1.5 1.5H13c-.4 0-.7-.1-1-.4l-4-4.2.7-.8c.2-.2.5-.3.8-.3h.2L12 18V9c0-.6.4-1 1-1s1 .4 1 1v4.5l1.2.1 3.9 2.2c.5.2.9.8.9 1.3v3.4M20 2H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h4v-2H4V4h16v8h-2v2h2c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2Z"/></svg> <span class=md-ellipsis> Indexing </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/indicators/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3 14 .5.07L8.07 9.5a1.95 1.95 0 0 1 .52-1.91c.78-.79 2.04-.79 2.82 0 .53.52.7 1.26.52 1.91l2.57 2.57.5-.07c.18 0 .35 0 .5.07l3.57-3.57C19 8.35 19 8.18 19 8a2 2 0 0 1 2-2 2 2 0 0 1 2 2 2 2 0 0 1-2 2c-.18 0-.35 0-.5-.07l-3.57 3.57c.07.15.07.32.07.5a2 2 0 0 1-2 2 2 2 0 0 1-2-2l.07-.5-2.57-2.57c-.32.07-.68.07-1 0L4.93 15.5 5 16a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2Z"/></svg> <span class=md-ellipsis> Indicators </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/signals/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10Z"/></svg> <span class=md-ellipsis> Signals </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/portfolio/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56 6.49 3.74Z"/></svg> <span class=md-ellipsis> Portfolio </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/optimization/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16h-.58l-.81-.81A7.07 7.07 0 0 0 18 11c0-3.87-3.13-7-7-7-1.5 0-3 .5-4.21 1.4-3.09 2.32-3.72 6.71-1.4 9.8 2.32 3.09 6.71 3.72 9.8 1.4l.81.81V18l5 5 2-2-5-5m-7 0c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5M3 6 1 8V1h7L6 3H3v3m18-5v7l-2-2V3h-3l-2-2h7M6 19l2 2H1v-7l2 2v3h3Z"/></svg> <span class=md-ellipsis> Optimization </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/cross-validation/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M.41 13.41 6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7Z"/></svg> <span class=md-ellipsis> Cross-validation </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/benchmarking/index.html class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 5a7 7 0 0 1 7 7h1v3h-1v4H9a7 7 0 0 1-7-7 7 7 0 0 1 7-7m0 3a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m8 9h5v4h-2v-2h-3v-2Z"/></svg> <span class=md-ellipsis> Benchmarking </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Terms </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../terms/terms-of-use/index.html class=md-nav__link> <span class=md-ellipsis> Terms of Use </span> </a> </li> <li class=md-nav__item> <a href=../../terms/software-license/index.html class=md-nav__link> <span class=md-ellipsis> Software License </span> </a> </li> <li class=md-nav__item> <a href=../../terms/remarks/index.html class=md-nav__link> <span class=md-ellipsis> Remarks </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../fundamentals/index.html class=md-path__link> <span class=md-ellipsis> Documentation </span> </a> </li> <li class=md-path__item> <a href=index.html class=md-path__link> <span class=md-ellipsis> Portfolio </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=portfolio><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56 6.49 3.74Z"/></svg></span> Portfolio<a class=headerlink href=#portfolio title="Permanent link">&para;</a></h1> <p>Portfolio refers to any combination of financial assets held by a trader. In the world of vectorbt, "portfolio" is a multidimensional structure capable of simulating and tracking multiple independent but also dependent portfolio instances. The main function of a portfolio is to apply a trading logic on a set of inputs to simulate a realistic trading environment, also referred to as "simulation". The outputs of such a simulation are orders and other information that can be used by the user in assessing the portfolio's performance, also referred to as "reconstruction" or "post-analysis". Both phases are isolated in nature, which enables various interesting use cases for quantitative analysis and data science.</p> <p>The main class concerned with simulating and analyzing portfolios (i.e., with the actual backtesting) is <a href=../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio>Portfolio</a>, which is a regular Python class subclassing <a href=../../api/generic/analyzable/index.html#vectorbtpro.generic.analyzable.Analyzable>Analyzable</a> and having a range of Numba-compiled functions at its disposal. It's built similarly to other analyzable classes in the way that it has diverse class methods for instantiation from a range of inputs (such as <a href=../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> taking signals), it's a state-full class capable of wrapping and indexing any Pandas-like objects contained inside it, and it can compute metrics and display (sub-)plots for quick introspection of the stored data.</p> <h2 id=simulation>Simulation<a class=headerlink href=#simulation title="Permanent link">&para;</a></h2> <p>So, what's a simulation? It's just a sophisticated loop! <img alt=🍩 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f369.svg title=:doughnut:> </p> <p>A typical simulation in vectorbt takes some inputs (such as signals), gradually iterates over their rows (time steps in the real world) using a for-loop, and at each row, runs the trading logic by issuing and executing orders, and updating the current state of the trading environment such as the cash balance and position size. If we think about it, it's the exact same way we would approach algorithmic trading in reality: at each minute/hour/day (= row), decide what to do (= trading logic), and place an order if you decided to change your position in the market.</p> <p>Now, let's talk about execution. The core of the vectorbt's backtesting engine is fully Numba-compiled for best performance. The functionality of the engine is distributed across many functions in an entire sub-package - <a href=../../api/portfolio/nb/index.html >portfolio.nb</a>, ranging from core order execution commands to calculation of P&amp;L in trade records. Remember that those functions aren't meant to be used directly (unless specifically desired) but are used by Python functions higher in the stack that know how to properly pre-process their input data and post-process the output data.</p> <p>In the following parts, we'll discuss order execution and processing, and gradually implement a collection of simple pipelines to better illustrate various simulation concepts.</p> <h2 id=primitive-commands>Primitive commands<a class=headerlink href=#primitive-commands title="Permanent link">&para;</a></h2> <p>Remember that vectorbt is an exceptionally raw backtester: it's primary commands are "buy" <img alt=🟢 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f7e2.svg title=:green_circle:> and "sell" <img alt=🔴 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f534.svg title=:red_circle:> This means that any strategy that can be translated into a set of those commands is also supported out of the box. This also means that more complex orders such as limit and SL orders must be implemented manually. In contrast to other backtesting frameworks where processing is monolothic and functionality is written in an <a href=https://en.wikipedia.org/wiki/Object-oriented_programming>object-oriented manner</a>, Numba forces vectorbt to implement most of the functionality in a procedural manner.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Even though Numba supports OOP by compiling Python classes with <code>@jitclass</code>, they are treated as functions, must be statically typed, and have performance drawbacks that don't allow us to jump on the wagon just yet.</p> </div> <p>Functions related to order execution are primarily located in <a href=../../api/portfolio/nb/core/index.html >portfolio.nb.core</a>. The functions implementing our primary two commands are <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.buy_nb>buy_nb</a> and <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.sell_nb>sell_nb</a>. Among the requested size and price of an order, the primary input of each of these functions is the current account state of type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.AccountState>AccountState</a>, which contains the current cash balance, position size, and other information about the current environment. Whenever we buy or sell something, the function creates and returns a new state of the same type. Furthermore, it returns an order result of type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OrderResult>OrderResult</a>, which contains the filled size, price adjusted with slippage, transaction fee, order side, status information on whether the order succeeded or failed, and valuable information about why it failed.</p> <h3 id=buying>Buying<a class=headerlink href=#buying title="Permanent link">&para;</a></h3> <p>The buy operation consists of two distinct operations: "long-buy" implemented by <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.long_buy_nb>long_buy_nb</a> and "short-buy" implemented by <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.short_buy_nb>short_buy_nb</a>. The first one opens or increases a long position, while the second one decreases a short position. By chaining these two operations, we can reverse a short position, which is done automatically by <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.buy_nb>buy_nb</a>: it checks the position we're in (if any), and calls the responsible function.</p> <p>Let's say we have $100 available and want to buy 1 share at the price of $15:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>vectorbtpro</span> <span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>100.0</span>  <span class=c1># (3)!</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=go>OrderResult(</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=go>    size=1.0,</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=go>    price=15.0,</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=go>    fees=0.0,</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=go>    side=0,</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=go>    status=0,</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=go>    status_info=-1</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=go>)</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=go>AccountState(</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=go>    cash=85.0,</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=go>    position=1.0,</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=go>    debt=0.0,</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=go>    free_cash=85.0</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=go>)</span>
</span></code></pre></div> <ol> <li>Debt is non-zero only when leveraging or shorting</li> <li>Locked cash is non-zero only when leveraging or shorting</li> <li>Free cash deviates from the regular cash balance only when leveraging or shorting</li> </ol> <p>The returned state indicates that we spent $15 and increased our position by 1 share. The order result contains details about the executed order: we bought 1 share for $15, with no transaction fees. Since order side and status are of named tuple type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OrderSide>OrderSide</a> and <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OrderStatus>OrderStatus</a> respectively, we can query the meaning behind those numbers as follows:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderSide</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>side</span><span class=p>]</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=go>&#39;Buy&#39;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderStatus</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status</span><span class=p>]</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=go>&#39;Filled&#39;</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If any value is <code>-1</code> and cannot be found in the named tuple, the information is unavailable.</p> </div> <p>Now, based on the new state, let's execute a transaction that uses up the remaining cash:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=go>OrderResult(</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=go>    size=5.666666666666667,</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=go>    price=15.0,</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=go>    side=0,</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=go>    status=0,</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=go>)</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=go>AccountState(</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=go>    cash=0.0,</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=go>    position=6.666666666666667,</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=go>    debt=0.0,</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=go>)</span>
</span></code></pre></div> <ol> <li>Use the previous account state as input</li> <li>Infinity means using up the entire balance</li> </ol> <p>Since vectorbt was originally tailored to cryptocurrency and fractional shares, the default behavior is buying as much as possible (here <code>5.67</code>), even if the amount is below of that requested. But what happens if we wanted to have the entire share instead? Let's specify the size granularity of 1, indicating that only integer amounts should be allowed:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=p>,</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=gp>... </span>    <span class=n>size_granularity</span><span class=o>=</span><span class=mi>1</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=go>OrderResult(</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=go>    size=6.0,</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=go>    price=15.0,</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=go>    fees=0.0,</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=go>    side=0,</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=go>    status=0,</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=go>    status_info=-1</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=go>)</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=go>AccountState(</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=go>    cash=10.0,</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=go>    position=6.0,</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=go>    debt=0.0,</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=go>    free_cash=10.0</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=go>)</span>
</span></code></pre></div> <p>This has bought exactly 6 shares. Given the new account state, let's run the same transaction again:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=gp>... </span>    <span class=n>new_account_state</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=gp>... </span>    <span class=n>size_granularity</span><span class=o>=</span><span class=mi>1</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>OrderResult(</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=go>    size=np.nan,</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=go>    price=np.nan,</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=go>    fees=np.nan,</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=go>    side=-1,</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=go>    status=1,</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=go>    status_info=5</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=go>)</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=go>AccountState(</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=go>    cash=10.0,</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=go>    position=6.0,</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=go>    debt=0.0,</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=go>    free_cash=10.0</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=go>)</span>
</span></code></pre></div> <ol> <li>Use the account state from the previous operation</li> </ol> <p>The account state remains unchanged, while so many NaNs in the order result hint at a failed order. Let's query the meaning behind the status and status information numbers using <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OrderStatus>OrderStatus</a> and <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.OrderStatusInfo>OrderStatusInfo</a> named tuple respectively:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderStatus</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status</span><span class=p>]</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=go>&#39;Ignored&#39;</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderStatusInfo</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status_info</span><span class=p>]</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=go>&#39;SizeZero&#39;</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>status_info_desc</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status_info</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=go>&#39;Size is zero&#39;</span>
</span></code></pre></div> <ol> <li>There is a list with more elaborative descriptions of different statuses</li> </ol> <p>Here, the status "Size is zero" means that by considering our cash balance and after applying the size granularity, the (potentially) filled order size is zero, thus the order should be ignored. Ignored orders have no effect on the trading environment and are simply, well, <em>ignored</em>. But sometimes, when the user has specific requirements and vectorbt cannot execute them, the status will become "Rejected", indicating that the request could not be fulfilled and an error can be thrown if wanted.</p> <p>For example, let's try to buy more than possible:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>1000.0</span><span class=p>,</span> 
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=gp>... </span>    <span class=n>allow_partial</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=go>OrderResult(</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=go>    size=np.nan,</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=go>    price=np.nan,</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=go>    fees=np.nan,</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=go>    side=-1,</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=go>    status=2,</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=go>    status_info=12</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=go>)</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=go>AccountState(</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=go>    cash=100.0,</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=go>    position=0.0,</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=go>    debt=0.0,</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=go>    free_cash=100.0</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=go>)</span>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderStatus</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status</span><span class=p>]</span>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=go>&#39;Rejected&#39;</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>status_info_desc</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status_info</span><span class=p>]</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=go>&#39;Final size is less than requested&#39;</span>
</span></code></pre></div> <p>There are many other parameters to control the execution. Let's use 50% of cash, and apply 1% in fees and slippage:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=gp>... </span>    <span class=n>fees</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=gp>... </span>    <span class=n>slippage</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=gp>... </span>    <span class=n>percent</span><span class=o>=</span><span class=mf>0.5</span>  <span class=c1># (3)!</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=go>OrderResult(</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=go>    size=3.2676534980230696,</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=go>    price=15.15,</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=go>    fees=0.4950495049504937,</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=go>    side=0,</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=go>    status=0,</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=go>    status_info=-1</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=go>)</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=go>AccountState(</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=go>    cash=50.0,</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=go>    position=3.2676534980230696,</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=go>    debt=0.0,</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=go>    free_cash=50.0</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=go>)</span>
</span></code></pre></div> <ol> <li>0.01 = 1%. Paid always in cash. To specify fixed fees, use <code>fixed_fees</code> instead.</li> <li>0.01 = 1%. Applied on the price. By artificially increasing the price, you always put yourself at a disadvantage, but this might be wanted to make backtesting more realistic.</li> <li>0.01 = 1%. Applied on the resources used to open or increase a position. </li> </ol> <p>The final fees and the price adjusted with the slippage are reflected in the order result.</p> <p>Whenever we place an order, we can specify any price. Thus, it may sometimes happen that the provided price is (by mistake of the user) higher than the highest price of that bar or lower than the lowest price of that bar. Also, if the user wanted the price to be closing, and he specified a slippage, this would also be quite unrealistic. To avoid such mistakes, the function performs an OHLC check. For this, we need to specify the <code>price_area</code> of type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PriceArea>PriceArea</a>: with the price boundaries, and what should be done if a boundary violation happens via <code>price_area_vio_mode</code> of type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.PriceAreaVioMode>PriceAreaVioMode</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price_area</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PriceArea</span><span class=p>(</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mi>12</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=gp>... </span>    <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span><span class=p>,</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=gp>... </span>    <span class=n>price_area_vio_mode</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PriceAreaVioMode</span><span class=o>.</span><span class=n>Error</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=go>ValueError: Adjusted order price is above the highest price</span>
</span></code></pre></div> <h3 id=selling>Selling<a class=headerlink href=#selling title="Permanent link">&para;</a></h3> <p>The sell operation consists of two distinct operations: "long-sell" implemented by <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.long_sell_nb>long_sell_nb</a> and "short-sell" implemented by <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.short_sell_nb>short_sell_nb</a>. The first one decreases a long position, while the second one opens or increases a short position. By chaining these two operations, we can reverse a long position, which is done automatically by <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.sell_nb>sell_nb</a>: it checks the position we're in (if any), and calls the responsible function.</p> <p>The function for selling takes the same arguments but uses them in the opposite direction. Let's remove 2 shares from a position of 10 shares:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>0.0</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>2.0</span><span class=p>,</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=go>OrderResult(</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=go>    size=2.0,</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=go>    price=15.0,</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=go>    fees=0.0,</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=go>    side=1,</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=go>    status=0,</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=go>    status_info=-1</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=go>)</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=go>AccountState(</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=go>    cash=30.0,</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a><span class=go>    position=8.0,</span>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a><span class=go>    debt=0.0,</span>
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a><span class=go>    free_cash=30.0</span>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a><span class=go>)</span>
</span></code></pre></div> <p>The size in the order result remains positive but the side has changed from 0 to 1:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderSide</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>side</span><span class=p>]</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=go>&#39;Sell&#39;</span>
</span></code></pre></div> <h3 id=shorting>Shorting<a class=headerlink href=#shorting title="Permanent link">&para;</a></h3> <p>Shorting is a regular sell operation with <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.sell_nb>sell_nb</a>, but with one exception: it now involves the debt as well as the locked cash balance. Whenever we short, we are borrowing shares and selling them to buyers willing to pay the market price. This operation increases the cash balance and turns the position size negative. It also registers the received cash amount as a debt, and subtracts it from the free cash balance. Whenever we buy some shares back, the debt decreases proportionally to the value of the shares bought back, while the free cash might increase depending upon whether the price was higher or lower than the average short-selling price. Whenever we cover the short position entirely, the debt becomes zero and the free cash balance returns to the same level as the regular cash balance.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>You shouldn't treat debt as an absolute amount of cash you owe since you owe shares, not cash; it's used for calculating the average leverage and entry price of the short position, which is then used to calculate the change in the free cash balance with each trade.</p> </div> <p>To borrow any shares, we need a positive free cash balance to be used as a collateral. The exact amount of free cash needed for a shorting operation depends on margin; by default, we need the same amount of funds available in our margin account as the value of to-be-borrowed shares. For example, if we short a stock and the new position had a value of $100, we would be required to have the $100 that came from the short sale plus an additional $100 in cash, for a total of $200, which depending on the definition is either a 100% (before sale) or 200% (after sale) initial margin requirement. Maintenance margin and liquidation checks are the responsibility of the user (for now). </p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=go>OrderResult(</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=go>    size=6.666666666666667,</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=go>    price=15.0,</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=go>    fees=0.0,</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=go>    side=1,</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=go>    status=0,</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=go>    status_info=-1</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=go>)</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=go>AccountState(</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=go>    cash=200.0,</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a><span class=go>    position=-6.666666666666667,</span>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=go>    debt=100.0,</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=go>    locked_cash=100.0,</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-11-29><a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=go>)</span>
</span></code></pre></div> <ol> <li>Short-sell as much as possible</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Infinity is a special value in vectorbt and usually means "go as far as you can".</p> </div> <p>Here's what happened. First, we've converted all the available free cash ($100) into the locked one such that it becomes the collateral of our shorting operation. Because the default leverage is 1, we've borrowed the same value in shares ($100), which has been added to the regular cash balance as well registered as a debt. This value corresponds to (minus = borrowed) 6.67 shares. But here's the problem: since we've doubled the regular cash balance, it may be used by other assets. To avoid that, all operations are done strictly on the free cash balance! But it's zero right now, so how do we buy back the borrowed shares? Remember that the debt and locked cash represent the total amount of cash that we used in the first place; by adding both to the free cash, we get our cash limit for the current buy operation, which nicely matches the regular cash when dealing with only one asset.</p> <p>To change the margin, we can use the argument <code>leverage</code>. For example, setting it to 2 will allow us to borrow twice as many shares as can be covered by the current free cash:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=mi>2</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=go>OrderResult(</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=go>    size=13.333333333333334,</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=go>    price=15.0,</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=go>    fees=0.0,</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=go>    side=1,</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=go>    status=0,</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=go>    status_info=-1</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=go>)</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a><span class=go>AccountState(</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=go>    cash=300.0,</span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=go>    position=-13.333333333333334,</span>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a><span class=go>    debt=200.0,</span>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a><span class=go>    locked_cash=100.0,</span>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30 href=#__codelineno-12-30></a><span class=go>)</span>
</span></code></pre></div> <p>The debt-to-locked-cash ratio is now 2, which corresponds to the leverage that we specified.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>We can specify a different leverage for each short-sell order, even in the same position.</p> </div> <p>Let's try to run the same operation again, but now on the new account state:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=mi>2</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=go>OrderResult(</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=go>    size=np.nan,</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=go>    price=np.nan,</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=go>    fees=np.nan,</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=go>    side=-1,</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=go>    status=2,</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=go>    status_info=6</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=go>)</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=go>AccountState(</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=go>    cash=300.0,</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=go>    position=-13.333333333333334,</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=go>    debt=200.0,</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=go>    locked_cash=100.0,</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=go>)</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderStatus</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status</span><span class=p>]</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=go>&#39;Rejected&#39;</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>status_info_desc</span><span class=p>[</span><span class=n>order_result</span><span class=o>.</span><span class=n>status_info</span><span class=p>]</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=go>&#39;Not enough cash&#39;</span>
</span></code></pre></div> <p>We see that vectorbt prevents the free cash balance to become negative.</p> <p>To order any quantity possible, we can use the unlimited leverage:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> 
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span> 
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=go>OrderResult(</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=go>    size=1000.0,</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=go>    price=15.0,</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=go>    fees=0.0,</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=go>    side=1,</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=go>    status=0,</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=go>    status_info=-1</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=go>)</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=go>AccountState(</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=go>    cash=15100.0,</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=go>    position=-1000.0,</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=go>    debt=15000.0,</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=go>    locked_cash=100.0,</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=go>)</span>
</span></code></pre></div> <p>What's the effective leverage of this operation?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_account_state</span><span class=o>.</span><span class=n>debt</span> <span class=o>/</span> <span class=n>new_account_state</span><span class=o>.</span><span class=n>locked_cash</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=go>150.0</span>
</span></code></pre></div> <p>If we had to calculate the current portfolio value, it would still default to the initial cash since no transaction costs were involved and no additional trades were made:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_account_state</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>new_account_state</span><span class=o>.</span><span class=n>position</span> <span class=o>*</span> <span class=n>order_result</span><span class=o>.</span><span class=n>price</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=go>100.0</span>
</span></code></pre></div> <p>As we see, the positive cash balance and the negative position size keep the total value in balance. Now, let's illustrate buying back some shares using <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.buy_nb>buy_nb</a>. First, we'll borrow 10 shares with 2x leverage and sell them for the price of $10 per share:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span> 
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=mi>2</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=go>OrderResult(</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=go>    size=10.0,</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=go>    price=15.0,</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=go>    fees=0.0,</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=go>    side=1,</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=go>    status=0,</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=go>    status_info=-1</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=go>)</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=go>AccountState(</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=go>    cash=250.0,</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=go>    position=-10.0,</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=go>    debt=150.0,</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=go>    locked_cash=75.0,</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=go>    free_cash=25.0</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=go>)</span>
</span></code></pre></div> <p>Let's buy back 5 shares for the price of $30 per share (my condolences):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span> 
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>30.0</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=go>OrderResult(</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=go>    size=5.0,</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=go>    price=30.0,</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=go>    side=0,</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=go>    status=0,</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=go>)</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=go>AccountState(</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=go>    cash=100.0,</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=go>    position=-5.0,</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=go>    debt=75.0,</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=go>    locked_cash=37.5,</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=go>    free_cash=-12.5</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a><span class=go>)</span>
</span></code></pre></div> <p>We executed the order for $150, which have been deducted from the regular cash balance. The position has been reduced by half, to 5 borrowed shares. Along with the position, the debt and locked cash have also been reduced by half. Given the absolute amount of released debt ($75), we can then compute the P&amp;L, which is the total spent cash subtracted from the total released debt, or -$75. But this operation has also released some locked cash - $37.5, such that the amount of cash added back to our free cash balance is -$37.5, which makes it negative. A negative free cash means that we won't be able to buy any other assets apart from reducing any short positions and thus potentially releasing additional funds (i.e., profits as well as losses are shared among all assets within the same group with cash sharing). Even though we've got a negative free cash, we can still buy back more shares because the sum of <code>debt</code>, <code>locked_cash</code>, and <code>free_cash</code> is greater than zero.</p> <p>Not only the debt and locked cash can be used to compute the effective leverage, but we can also derive the average entry price of the entire position:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_account_state2</span><span class=o>.</span><span class=n>debt</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>new_account_state2</span><span class=o>.</span><span class=n>position</span><span class=p>)</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=go>15.0</span>
</span></code></pre></div> <p>Let's say instead of jumping, the price has dipped to $10 per share (my congratulations!):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span> 
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>10.0</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=go>OrderResult(</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=go>    size=5.0,</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=go>    price=10.0,</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=go>    side=0,</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=go>    status=0,</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=go>)</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=go>AccountState(</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=go>    cash=200.0,</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=go>    position=-5.0,</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=go>    debt=75.0,</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a><span class=go>    locked_cash=37.5,</span>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=go>    free_cash=87.5</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a><span class=go>)</span>
</span></code></pre></div> <p>We see that the debt and locked cash have decreased to the same level as previously (because we've bought back the same relative amount of shares), but the free cash balance is now $200, netting $25 in profit! Again, the calculation is simple: we just take the total amount of spent cash ($5 * 10 = $50) and subtract it from the total released debt (0.5 * $150 = $75) to get the P&amp;L. By adding the P&amp;L, the released locked cash (0.5 * $75 = $37.5), and the current free cash ($25) together, we get the new free cash of $87.5 immediately available for all other assets to use.</p> <p>Let's compute the equity to validate the profit:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st0</span> <span class=o>=</span> <span class=n>account_state</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st1</span> <span class=o>=</span> <span class=n>new_account_state2</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>avg_entry_price</span> <span class=o>=</span> <span class=n>st1</span><span class=o>.</span><span class=n>debt</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>st1</span><span class=o>.</span><span class=n>position</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_equity</span> <span class=o>=</span> <span class=n>st1</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>st1</span><span class=o>.</span><span class=n>position</span> <span class=o>*</span> <span class=n>avg_entry_price</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_equity</span> <span class=o>-</span> <span class=n>st0</span><span class=o>.</span><span class=n>cash</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=go>25.0</span>
</span></code></pre></div> <ol> <li>The remaining shares are still valued at $15</li> </ol> <p>Let's close out the open short position using the same price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state3</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state2</span><span class=p>,</span> 
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span> 
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>10.0</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=go>OrderResult(</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=go>    size=5.0,</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=go>    price=10.0,</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=go>    side=0,</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=go>    status=0,</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=go>)</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state3</span><span class=p>)</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=go>AccountState(</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=go>    cash=150.0,</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=go>    position=0.0,</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=go>    debt=0.0,</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a><span class=go>    free_cash=150.0</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=go>)</span>
</span></code></pre></div> <p>The free cash balance equals to the regular cash balance, and we are debt-free! Additionally, the last two operations have brought us $50 in profit, or (15 - 10) * 10 = $50.</p> <p>Finally, let's try to close out the position using an astronomically high price!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state3</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state2</span><span class=p>,</span> 
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span> 
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=go>OrderResult(</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=go>    size=2.0,</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=go>    price=100.0,</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=go>    side=0,</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=go>    status=0,</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=go>)</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state3</span><span class=p>)</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=go>AccountState(</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=go>    cash=0.0,</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=go>    position=-3.0,</span>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=go>    debt=45.0,</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class=go>    locked_cash=22.5,</span>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=go>    free_cash=-67.5</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a><span class=go>)</span>
</span></code></pre></div> <p>We could buy back only 2 shares out of the remaining 5. If we try the same operation again, we would get the "Not enough cash" message because <code>debt + locked_cash + free_cash</code> is below or equal to zero. We also witness the regular cash balance going to zero, which means that we've exhausted all of our capital; but we shouldn't rely on it to make trading decisions! If any other asset buys shares with leverage, regular cash may go negative, which doesn't necessarily mean that we have no cash left - only free cash (with debt and locked cash when covering shorts) provide us with the right information.</p> <h3 id=leverage>Leverage<a class=headerlink href=#leverage title="Permanent link">&para;</a></h3> <p>Even though vectorbt allows setting an arbitrary (even an infinite) cash and ordering as many shares as required by the user, this constellation is associated with some drawbacks: an infinite cash leads to an infinite portfolio value, which makes certain operations on that value impossible, such as the conversion from a target percentage into a target amount of shares; but also, the more cash we have, the smaller are potential contributions of the positions to the portfolio value, thus lowering the magnitude of the portfolio returns. What we need though is to multiply those contributions without inflating the cash balance, which can be effectively done using leverage.</p> <p>Leverage involves borrowing additional funds to buy shares. In main contrast to shorting, leverage is applied to long positions and borrows cash instead of shares. The underlying mechanism is quite similar though. First, we multiply the available free cash by <code>leverage</code>. Then, we derive the order value and the fraction of it to be borrowed. Finally, we move the borrowed cash to <code>debt</code> while declaring a part of the free cash as the collateral of the operation and moving it to <code>locked_cash</code>. But since the locked cash must be spent to buy a part of the shares, it changes the way the effective leverage can be calculated from <code>debt / locked_cash</code> to <code>debt / locked_cash + 1</code>.</p> <p>Let's say we have $100 in our margin account and want to buy $200 worth of shares. As we learned previously, we can specify an infinite leverage and vectorbt will derive the effective leverage internally for us:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> 
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=go>OrderResult(</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=go>    size=20,</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=go>    price=10.0,</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=go>    fees=0.0,</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=go>    side=0,</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=go>    status=0,</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=go>    status_info=-1</span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=go>)</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a><span class=go>AccountState(</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a><span class=go>    cash=-100.0,</span>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a><span class=go>    position=20.0,</span>
</span><span id=__span-24-27><a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a><span class=go>    debt=100.0,</span>
</span><span id=__span-24-28><a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a><span class=go>    locked_cash=100.0,</span>
</span><span id=__span-24-29><a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-24-30><a id=__codelineno-24-30 name=__codelineno-24-30 href=#__codelineno-24-30></a><span class=go>)</span>
</span></code></pre></div> <p>We can see that $100 were deducted from our free cash balance and additional $100 were borrowed, thus bringing the effective leverage to 2:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_account_state</span><span class=o>.</span><span class=n>debt</span> <span class=o>/</span> <span class=n>new_account_state</span><span class=o>.</span><span class=n>locked_cash</span> <span class=o>+</span> <span class=mi>1</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=go>2.0</span>
</span></code></pre></div> <p>Buying 10 shares instead would use no leverage since the transaction can be entirely covered by the free cash, even if the leverage is infinity:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> 
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=go>OrderResult(</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=go>    size=10,</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=go>    price=10.0,</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=go>    fees=0.0,</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=go>    side=0,</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=go>    status=0,</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=go>    status_info=-1</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=go>)</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=go>AccountState(</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=go>    cash=0.0,</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=go>    position=10.0,</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=go>    debt=0.0,</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=go>)</span>
</span></code></pre></div> <p>Is there a way to use only a subset of our own free cash while borrowing the rest? Yes! The command <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.buy_nb>buy_nb</a> takes the argument <code>leverage_mode</code> of the type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.LeverageMode>LeverageMode</a>, which supports two modes: "lazy" and "eager" leveraging. The first mode is the default one and enables leverage only if the quantity to be bought cannot be fulfilled using own resources. The second mode enables leverage for any quantity and requires the leverage to be set explicitly, that is, an infinite leverage would raise an error. </p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Shorting supports "lazy" leveraging only.</p> </div> <p>Let's buy 10 shares with a 3x leverage:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> 
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=gp>... </span>    <span class=n>leverage_mode</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>LeverageMode</span><span class=o>.</span><span class=n>Eager</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=go>OrderResult(</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>    size=10,</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=go>    price=10.0,</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=go>    fees=0.0,</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>    side=0,</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=go>    status=0,</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=go>    status_info=-1</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=go>)</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=go>AccountState(</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=go>    cash=0.0,</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=go>    position=10.0,</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=go>    debt=66.66666666666667,</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=go>    locked_cash=33.333333333333336,</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=go>    free_cash=66.66666666666666</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=go>)</span>
</span></code></pre></div> <p>We've used only $33.3 from our free cash balance as the collateral to borrow additional $66.6, making a total of $100 that were spent to buy the desired quantity.</p> <p>Now, how do we repay the debt? When selling, the debt and locked cash balances decrease proportionally to the number of shares sold, which is exactly the same procedure as during (partially-) closing a short position. The main difference is in the calculation of the P&amp;L: we take the total of the released debt and locked cash and subtract them from the cash retrieved from the operation.</p> <p>First, we'll use a 2x leverage to buy 10 shares for the price of $20 per share:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> 
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>20.0</span><span class=p>,</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=mi>2</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=go>OrderResult(</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=go>    size=10,</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=go>    price=20.0,</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=go>    fees=0.0,</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=go>    side=0,</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=go>    status=0,</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=go>    status_info=-1</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=go>)</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=go>AccountState(</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=go>    cash=-100.0,</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a><span class=go>    position=10.0,</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a><span class=go>    debt=100.0,</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a><span class=go>    locked_cash=100.0,</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a><span class=go>)</span>
</span></code></pre></div> <p>Let's sell 5 shares for the price of $5 per share (my condolences):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span> 
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>5.0</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=go>OrderResult(</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=go>    size=5.0,</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=go>    price=5.0,</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=go>    side=1,</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=go>    status=0,</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=go>)</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=go>AccountState(</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=go>    cash=-75.0,</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=go>    position=5.0,</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=go>    debt=50.0,</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=go>    locked_cash=50.0,</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=go>    free_cash=-25.0</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=go>)</span>
</span></code></pre></div> <p>We've retrieved $25 from this operation, which have been added to the regular cash balance. The debt and locked cash have been cut in half because the half of the leveraged position has been closed out. The P&amp;L of this operation is the gained cash ($25) minus the released debt ($50) and locked cash ($50), which makes it a loss of $75. By adding this number to the released locked cash, we arrive at the new free cash of -$25 - a change that is propagated to all other assets using the same cash balance and thus preventing them to open or increase their positions.</p> <p>Another way of calculating the P&amp;L using the equity:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st0</span> <span class=o>=</span> <span class=n>account_state</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st1</span> <span class=o>=</span> <span class=n>new_account_state2</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>avg_entry_price</span> <span class=o>=</span> <span class=p>(</span><span class=n>st1</span><span class=o>.</span><span class=n>debt</span> <span class=o>+</span> <span class=n>st1</span><span class=o>.</span><span class=n>locked_cash</span><span class=p>)</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>st1</span><span class=o>.</span><span class=n>position</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_equity</span> <span class=o>=</span> <span class=n>st1</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>st1</span><span class=o>.</span><span class=n>position</span> <span class=o>*</span> <span class=n>avg_entry_price</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_equity</span> <span class=o>-</span> <span class=n>st0</span><span class=o>.</span><span class=n>cash</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=go>-75.0</span>
</span></code></pre></div> <ol> <li>The remaining shares are still valued at $20</li> </ol> <p>Now, let's say instead of dipping, the price has jumped to $40 per share (my congratulations!):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span> 
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>40.0</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=go>OrderResult(</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=go>    size=5.0,</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=go>    price=40.0,</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=go>    side=1,</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=go>    status=0,</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=go>)</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=go>AccountState(</span>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=go>    cash=100.0,</span>
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=go>    position=5.0,</span>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=go>    debt=50.0,</span>
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=go>    locked_cash=50.0,</span>
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=go>    free_cash=150.0</span>
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=go>)</span>
</span></code></pre></div> <p>We've retrieved $200 from this operation, which have been added to the regular cash balance. The debt and locked cash have been cut in half because the half of the leveraged position has been closed out. The P&amp;L of this operation is the gained cash ($200) minus the released debt ($50) and locked cash ($50), which makes it a profit of $100. By adding this number to the released locked cash, we arrive at the new free cash of $150, which can be now used by all other assets sharing the same balance.</p> <p>Let's close out the remaining position using the same price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span> 
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>40.0</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=go>OrderResult(</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=go>    size=5.0,</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=go>    price=40.0,</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=go>    fees=0.0,</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=go>    side=1,</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=go>    status=0,</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=go>    status_info=-1</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a><span class=go>)</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=go>AccountState(</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=go>    cash=300.0,</span>
</span><span id=__span-32-18><a id=__codelineno-32-18 name=__codelineno-32-18 href=#__codelineno-32-18></a><span class=go>    position=0.0,</span>
</span><span id=__span-32-19><a id=__codelineno-32-19 name=__codelineno-32-19 href=#__codelineno-32-19></a><span class=go>    debt=0.0,</span>
</span><span id=__span-32-20><a id=__codelineno-32-20 name=__codelineno-32-20 href=#__codelineno-32-20></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-32-21><a id=__codelineno-32-21 name=__codelineno-32-21 href=#__codelineno-32-21></a><span class=go>    free_cash=300.0</span>
</span><span id=__span-32-22><a id=__codelineno-32-22 name=__codelineno-32-22 href=#__codelineno-32-22></a><span class=go>)</span>
</span></code></pre></div> <p>We've made a profit of $200, which is just the same as we had used our own cash:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>200.0</span><span class=p>,</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>200.0</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>_</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> 
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>20.0</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>_</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span> 
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>40.0</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_account_state2</span><span class=o>.</span><span class=n>free_cash</span> <span class=o>-</span> <span class=n>account_state</span><span class=o>.</span><span class=n>free_cash</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=go>200.0</span>
</span></code></pre></div> <h3 id=symmetry>Symmetry<a class=headerlink href=#symmetry title="Permanent link">&para;</a></h3> <p>Long and short positions behave symmetrically. For example, let's open two opposite positions using an infinite size and 10x leverage and close them out with a price difference of $5 per share that favors the current position:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>_</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span><span class=p>,</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=mi>10</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>_</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span><span class=p>,</span>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=go>AccountState(</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=go>    cash=600.0,</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a><span class=go>    position=0.0,</span>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a><span class=go>    debt=0.0,</span>
</span><span id=__span-34-27><a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-34-28><a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=go>    free_cash=600.0</span>
</span><span id=__span-34-29><a id=__codelineno-34-29 name=__codelineno-34-29 href=#__codelineno-34-29></a><span class=go>)</span>
</span><span id=__span-34-30><a id=__codelineno-34-30 name=__codelineno-34-30 href=#__codelineno-34-30></a>
</span><span id=__span-34-31><a id=__codelineno-34-31 name=__codelineno-34-31 href=#__codelineno-34-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>_</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-34-32><a id=__codelineno-34-32 name=__codelineno-34-32 href=#__codelineno-34-32></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-34-33><a id=__codelineno-34-33 name=__codelineno-34-33 href=#__codelineno-34-33></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>ShortOnly</span><span class=p>,</span>
</span><span id=__span-34-34><a id=__codelineno-34-34 name=__codelineno-34-34 href=#__codelineno-34-34></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-34-35><a id=__codelineno-34-35 name=__codelineno-34-35 href=#__codelineno-34-35></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-34-36><a id=__codelineno-34-36 name=__codelineno-34-36 href=#__codelineno-34-36></a><span class=gp>... </span>    <span class=n>leverage</span><span class=o>=</span><span class=mi>10</span>
</span><span id=__span-34-37><a id=__codelineno-34-37 name=__codelineno-34-37 href=#__codelineno-34-37></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-34-38><a id=__codelineno-34-38 name=__codelineno-34-38 href=#__codelineno-34-38></a><span class=gp>&gt;&gt;&gt; </span><span class=n>_</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-34-39><a id=__codelineno-34-39 name=__codelineno-34-39 href=#__codelineno-34-39></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-34-40><a id=__codelineno-34-40 name=__codelineno-34-40 href=#__codelineno-34-40></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>ShortOnly</span><span class=p>,</span>
</span><span id=__span-34-41><a id=__codelineno-34-41 name=__codelineno-34-41 href=#__codelineno-34-41></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-34-42><a id=__codelineno-34-42 name=__codelineno-34-42 href=#__codelineno-34-42></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>5.0</span>
</span><span id=__span-34-43><a id=__codelineno-34-43 name=__codelineno-34-43 href=#__codelineno-34-43></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-34-44><a id=__codelineno-34-44 name=__codelineno-34-44 href=#__codelineno-34-44></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-34-45><a id=__codelineno-34-45 name=__codelineno-34-45 href=#__codelineno-34-45></a><span class=go>AccountState(</span>
</span><span id=__span-34-46><a id=__codelineno-34-46 name=__codelineno-34-46 href=#__codelineno-34-46></a><span class=go>    cash=600.0,</span>
</span><span id=__span-34-47><a id=__codelineno-34-47 name=__codelineno-34-47 href=#__codelineno-34-47></a><span class=go>    position=0.0,</span>
</span><span id=__span-34-48><a id=__codelineno-34-48 name=__codelineno-34-48 href=#__codelineno-34-48></a><span class=go>    debt=0.0,</span>
</span><span id=__span-34-49><a id=__codelineno-34-49 name=__codelineno-34-49 href=#__codelineno-34-49></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-34-50><a id=__codelineno-34-50 name=__codelineno-34-50 href=#__codelineno-34-50></a><span class=go>    free_cash=600.0</span>
</span><span id=__span-34-51><a id=__codelineno-34-51 name=__codelineno-34-51 href=#__codelineno-34-51></a><span class=go>)</span>
</span></code></pre></div> <h3 id=reversing>Reversing<a class=headerlink href=#reversing title="Permanent link">&para;</a></h3> <p>Positions in vectorbt can be reversed with a single order. To reverse a position, the direction argument should stay at its default - <code>Direction.Both</code>. Let's start with a position of 10 shares, reverse it to the maximum extent in the short direction, and then reverse it to the maximum extent again but in the opposite (long) direction:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>0.0</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=go>OrderResult(</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=go>    size=20.0,</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=go>    price=15.0,</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=go>    fees=0.0,</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=go>    side=1,</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a><span class=go>    status=0,</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a><span class=go>    status_info=-1</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a><span class=go>)</span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a><span class=go>AccountState(</span>
</span><span id=__span-35-24><a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a><span class=go>    cash=300.0,</span>
</span><span id=__span-35-25><a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a><span class=go>    position=-10.0,</span>
</span><span id=__span-35-26><a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a><span class=go>    debt=150.0,</span>
</span><span id=__span-35-27><a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a><span class=go>    locked_cash=150.0,</span>
</span><span id=__span-35-28><a id=__codelineno-35-28 name=__codelineno-35-28 href=#__codelineno-35-28></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-35-29><a id=__codelineno-35-29 name=__codelineno-35-29 href=#__codelineno-35-29></a><span class=go>)</span>
</span><span id=__span-35-30><a id=__codelineno-35-30 name=__codelineno-35-30 href=#__codelineno-35-30></a>
</span><span id=__span-35-31><a id=__codelineno-35-31 name=__codelineno-35-31 href=#__codelineno-35-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>
</span><span id=__span-35-32><a id=__codelineno-35-32 name=__codelineno-35-32 href=#__codelineno-35-32></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>new_account_state</span><span class=p>,</span> 
</span><span id=__span-35-33><a id=__codelineno-35-33 name=__codelineno-35-33 href=#__codelineno-35-33></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-35-34><a id=__codelineno-35-34 name=__codelineno-35-34 href=#__codelineno-35-34></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-35-35><a id=__codelineno-35-35 name=__codelineno-35-35 href=#__codelineno-35-35></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-35-36><a id=__codelineno-35-36 name=__codelineno-35-36 href=#__codelineno-35-36></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-35-37><a id=__codelineno-35-37 name=__codelineno-35-37 href=#__codelineno-35-37></a><span class=go>OrderResult(</span>
</span><span id=__span-35-38><a id=__codelineno-35-38 name=__codelineno-35-38 href=#__codelineno-35-38></a><span class=go>    size=20.0,</span>
</span><span id=__span-35-39><a id=__codelineno-35-39 name=__codelineno-35-39 href=#__codelineno-35-39></a><span class=go>    price=15.0,</span>
</span><span id=__span-35-40><a id=__codelineno-35-40 name=__codelineno-35-40 href=#__codelineno-35-40></a><span class=go>    fees=0.0,</span>
</span><span id=__span-35-41><a id=__codelineno-35-41 name=__codelineno-35-41 href=#__codelineno-35-41></a><span class=go>    side=0,</span>
</span><span id=__span-35-42><a id=__codelineno-35-42 name=__codelineno-35-42 href=#__codelineno-35-42></a><span class=go>    status=0,</span>
</span><span id=__span-35-43><a id=__codelineno-35-43 name=__codelineno-35-43 href=#__codelineno-35-43></a><span class=go>    status_info=-1</span>
</span><span id=__span-35-44><a id=__codelineno-35-44 name=__codelineno-35-44 href=#__codelineno-35-44></a><span class=go>)</span>
</span><span id=__span-35-45><a id=__codelineno-35-45 name=__codelineno-35-45 href=#__codelineno-35-45></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state2</span><span class=p>)</span>
</span><span id=__span-35-46><a id=__codelineno-35-46 name=__codelineno-35-46 href=#__codelineno-35-46></a><span class=go>AccountState(</span>
</span><span id=__span-35-47><a id=__codelineno-35-47 name=__codelineno-35-47 href=#__codelineno-35-47></a><span class=go>    cash=0.0,</span>
</span><span id=__span-35-48><a id=__codelineno-35-48 name=__codelineno-35-48 href=#__codelineno-35-48></a><span class=go>    position=10.0,</span>
</span><span id=__span-35-49><a id=__codelineno-35-49 name=__codelineno-35-49 href=#__codelineno-35-49></a><span class=go>    debt=0.0,</span>
</span><span id=__span-35-50><a id=__codelineno-35-50 name=__codelineno-35-50 href=#__codelineno-35-50></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-35-51><a id=__codelineno-35-51 name=__codelineno-35-51 href=#__codelineno-35-51></a><span class=go>    free_cash=0.0</span>
</span><span id=__span-35-52><a id=__codelineno-35-52 name=__codelineno-35-52 href=#__codelineno-35-52></a><span class=go>)</span>
</span></code></pre></div> <p>Both operations are symmetric in nature and cancel each other out by a repetitive call, thus ultimately we've arrived at our initial state of the account.</p> <h3 id=closing>Closing<a class=headerlink href=#closing title="Permanent link">&para;</a></h3> <p>To close out a position and to avoid its reversal, we can either specify the exact size, or the size of infinity and the current direction via the <code>direction</code> argument of the type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.Direction>Direction</a>. For example, if we're in a long position and specified the long-only direction, the position won't be reversed:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>0.0</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span> 
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=go>OrderResult(</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=go>    size=10.0,</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=go>    price=15.0,</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=go>    fees=0.0,</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=go>    side=1,</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=go>    status=0,</span>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a><span class=go>    status_info=-1</span>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=go>)</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a><span class=go>AccountState(</span>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=go>    cash=150.0,</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a><span class=go>    position=0.0,</span>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a><span class=go>    debt=0.0,</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-36-29><a id=__codelineno-36-29 name=__codelineno-36-29 href=#__codelineno-36-29></a><span class=go>    free_cash=150.0</span>
</span><span id=__span-36-30><a id=__codelineno-36-30 name=__codelineno-36-30 href=#__codelineno-36-30></a><span class=go>)</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Using the <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.buy_nb>buy_nb</a> and <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.sell_nb>sell_nb</a> commands guarantees to execute the order in the long and short direction respectively.</p> </div> <p>We can also use the commands that are guaranteed to execute within the current position and not open an opposite one: <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.long_sell_nb>long_sell_nb</a> for long positions and <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.short_buy_nb>short_buy_nb</a> for short positions. They don't require the argument <code>direction</code> at all, just the size of infinity:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>0.0</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>long_sell_nb</span><span class=p>(</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=gp>... </span>    <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span> 
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> 
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=go>OrderResult(</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=go>    size=10.0,</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=go>    price=15.0,</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a><span class=go>    fees=0.0,</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18 href=#__codelineno-37-18></a><span class=go>    side=1,</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19 href=#__codelineno-37-19></a><span class=go>    status=0,</span>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20 href=#__codelineno-37-20></a><span class=go>    status_info=-1</span>
</span><span id=__span-37-21><a id=__codelineno-37-21 name=__codelineno-37-21 href=#__codelineno-37-21></a><span class=go>)</span>
</span><span id=__span-37-22><a id=__codelineno-37-22 name=__codelineno-37-22 href=#__codelineno-37-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_account_state</span><span class=p>)</span>
</span><span id=__span-37-23><a id=__codelineno-37-23 name=__codelineno-37-23 href=#__codelineno-37-23></a><span class=go>AccountState(</span>
</span><span id=__span-37-24><a id=__codelineno-37-24 name=__codelineno-37-24 href=#__codelineno-37-24></a><span class=go>    cash=150.0,</span>
</span><span id=__span-37-25><a id=__codelineno-37-25 name=__codelineno-37-25 href=#__codelineno-37-25></a><span class=go>    position=0.0,</span>
</span><span id=__span-37-26><a id=__codelineno-37-26 name=__codelineno-37-26 href=#__codelineno-37-26></a><span class=go>    debt=0.0,</span>
</span><span id=__span-37-27><a id=__codelineno-37-27 name=__codelineno-37-27 href=#__codelineno-37-27></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-37-28><a id=__codelineno-37-28 name=__codelineno-37-28 href=#__codelineno-37-28></a><span class=go>    free_cash=150.0</span>
</span><span id=__span-37-29><a id=__codelineno-37-29 name=__codelineno-37-29 href=#__codelineno-37-29></a><span class=go>)</span>
</span></code></pre></div> <h3 id=pipeline1>Pipeline/1<a class=headerlink href=#pipeline1 title="Permanent link">&para;</a></h3> <p>Even by using just these two essential commands, we can already build our own backtesting pipeline of arbitrary complexity and flexibility. As said before, a simulation is just a loop that iterates over timestamps. Let's create a simplified pipeline that puts $1 into Bitcoin each time it discovers a <a href=https://www.investopedia.com/terms/g/goldencross.asp>Golden Cross</a> entry signal, and sells $1 otherwise. What we want is one number: the final value of the portfolio.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>pipeline_1_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=gp>... </span>    <span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>AccountState</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=gp>... </span>        <span class=n>cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>),</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=gp>... </span>        <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=gp>... </span>        <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=gp>... </span>        <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=gp>... </span>        <span class=n>free_cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>)</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>entries</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=gp>... </span>            <span class=n>_</span><span class=p>,</span> <span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>buy_nb</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=gp>... </span>                <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=gp>... </span>                <span class=n>size</span><span class=o>=</span><span class=mi>1</span> <span class=o>/</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=gp>... </span>                <span class=n>price</span><span class=o>=</span><span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>exits</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=gp>... </span>            <span class=n>_</span><span class=p>,</span> <span class=n>account_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sell_nb</span><span class=p>(</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=gp>... </span>                <span class=n>account_state</span><span class=o>=</span><span class=n>account_state</span><span class=p>,</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=gp>... </span>                <span class=n>size</span><span class=o>=</span><span class=mi>1</span> <span class=o>/</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=gp>... </span>                <span class=n>price</span><span class=o>=</span><span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>account_state</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>account_state</span><span class=o>.</span><span class=n>position</span> <span class=o>*</span> <span class=n>close</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># (3)!</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>YFData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span><span class=s2>&quot;BTC-USD&quot;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&quot;2022-01-01&quot;</span><span class=p>)</span>
</span><span id=__span-38-26><a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sma_50</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>talib</span><span class=p>(</span><span class=s2>&quot;SMA&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> <span class=mi>50</span><span class=p>)</span>
</span><span id=__span-38-27><a id=__codelineno-38-27 name=__codelineno-38-27 href=#__codelineno-38-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sma_200</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>talib</span><span class=p>(</span><span class=s2>&quot;SMA&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> <span class=mi>200</span><span class=p>)</span>
</span><span id=__span-38-28><a id=__codelineno-38-28 name=__codelineno-38-28 href=#__codelineno-38-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>sma_50</span><span class=o>.</span><span class=n>real_crossed_above</span><span class=p>(</span><span class=n>sma_200</span><span class=p>)</span>
</span><span id=__span-38-29><a id=__codelineno-38-29 name=__codelineno-38-29 href=#__codelineno-38-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>sma_50</span><span class=o>.</span><span class=n>real_crossed_below</span><span class=p>(</span><span class=n>sma_200</span><span class=p>)</span>
</span><span id=__span-38-30><a id=__codelineno-38-30 name=__codelineno-38-30 href=#__codelineno-38-30></a>
</span><span id=__span-38-31><a id=__codelineno-38-31 name=__codelineno-38-31 href=#__codelineno-38-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline_1_nb</span><span class=p>(</span>
</span><span id=__span-38-32><a id=__codelineno-38-32 name=__codelineno-38-32 href=#__codelineno-38-32></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-38-33><a id=__codelineno-38-33 name=__codelineno-38-33 href=#__codelineno-38-33></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-38-34><a id=__codelineno-38-34 name=__codelineno-38-34 href=#__codelineno-38-34></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-38-35><a id=__codelineno-38-35 name=__codelineno-38-35 href=#__codelineno-38-35></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-38-36><a id=__codelineno-38-36 name=__codelineno-38-36 href=#__codelineno-38-36></a><span class=go>210.71073253390762</span>
</span></code></pre></div> <ol> <li>Initial account state</li> <li>Execute the order and return a new account state</li> <li>Calculate the final portfolio value</li> </ol> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>Adding a suffix <code>_nb</code> to indicate a Numba-compiled function is not necessary but still a good convention in vectorbt.</p> </div> <p>We can validate the pipeline using one of the preset simulation methods:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_orders</span><span class=p>(</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> 
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>entries</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span> <span class=o>-</span> <span class=n>exits</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>),</span> 
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>final_value</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=go>210.71073253390762</span>
</span></code></pre></div> <h2 id=order-execution>Order execution<a class=headerlink href=#order-execution title="Permanent link">&para;</a></h2> <p>Using the primitive commands is fun as long as we exactly know the direction of the order and are sure that the provided arguments make sense. But very often, we have to deal with more complex requirements such as target percentages, which change the order direction depending on the current value. In addition, the commands do not validate their arguments; for example, there won't be any error thrown in a case when the user accidentally passes a negative order price. But also, we need a better representation of an order - it's a bad practice of passing all the parameters such as slippage as keyword arguments. </p> <p>All the checks and other pre-processing procedures are happening in the function <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.execute_order_nb>execute_order_nb</a>. The first input to this function is an order execution state of type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.ExecState>ExecState</a>, which contains the same information as an account state we saw above, but with additional information on the current valuation. The second input is a named tuple of type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.Order>Order</a> representing an order. The third argument is the price area, which we are also already familiar with.</p> <h3 id=order>Order<a class=headerlink href=#order title="Permanent link">&para;</a></h3> <p>An order in vectorbt is represented by a <a href=https://realpython.com/python-namedtuple/ >named tuple</a>. Named tuples are alternatives to data classes in both the Python and Numba world; they are very efficient and lightweight data structures that can be easily constructed and processed. Let's create an instance of an order:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Order</span><span class=p>()</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=go>Order(</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=go>    size=np.inf,</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=go>    price=np.inf,</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=go>    size_type=0,</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=go>    direction=2,</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=go>    fees=0.0,</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=go>    fixed_fees=0.0,</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=go>    slippage=0.0,</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=go>    min_size=np.nan,</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=go>    max_size=np.nan,</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=go>    size_granularity=np.nan,</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=go>    leverage=1.0,</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=go>    leverage_mode=0,</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=go>    reject_prob=0.0,</span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=go>    price_area_vio_mode=0,</span>
</span><span id=__span-40-18><a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a><span class=go>    allow_partial=True,</span>
</span><span id=__span-40-19><a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a><span class=go>    raise_reject=False,</span>
</span><span id=__span-40-20><a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a><span class=go>    log=False</span>
</span><span id=__span-40-21><a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a><span class=go>)</span>
</span></code></pre></div> <p>The tuple allows for attribute access through the dot notation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order</span><span class=o>.</span><span class=n>direction</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=go>2</span>
</span></code></pre></div> <p>Other than this, it behaves just like any other tuple in Python:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=go>2</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>tuple</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=go>(inf,</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=go> inf,</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=go> 0,</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=go> 2,</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=go> 0.0,</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=go> 0.0,</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=go> 0.0,</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=go> nan,</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=go> nan,</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=go> nan,</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=go> 1.0,</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=go> 0,</span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=go> 0.0,</span>
</span><span id=__span-42-18><a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a><span class=go> 0,</span>
</span><span id=__span-42-19><a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a><span class=go> True,</span>
</span><span id=__span-42-20><a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a><span class=go> False,</span>
</span><span id=__span-42-21><a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a><span class=go> False)</span>
</span></code></pre></div> <ol> <li>Convert to a regular tuple</li> </ol> <p>One issue that we still have to address when working with Numba are default arguments: although we can construct a new tuple solely with default arguments in Numba as we did above, if we want to override some values, they must be located strictly on the left in that tuple's definition. Otherwise, we must explicitly provide all the default arguments located before them:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>create_order_nb</span><span class=p>():</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Order</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>create_order_nb</span><span class=p>()</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=go>Order(size=inf, price=inf, ...)</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=gp>... </span><span class=k>def</span> <span class=nf>create_order_nb</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>price</span><span class=p>):</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Order</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>size</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=n>price</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>create_order_nb</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>15</span><span class=p>)</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=go>Order(size=1, price=15, ...)</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=gp>... </span><span class=k>def</span> <span class=nf>create_order_nb</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>price</span><span class=p>,</span> <span class=n>direction</span><span class=p>):</span>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Order</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>size</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=n>price</span><span class=p>,</span> <span class=n>direction</span><span class=o>=</span><span class=n>direction</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>create_order_nb</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=go>Failed in nopython mode pipeline (step: nopython frontend)</span>
</span></code></pre></div> <ol> <li>Using the default values only</li> <li>Overriding the default values of arguments on the left side</li> <li>Overriding the default values of arguments on different positions</li> </ol> <p>Another issue are data types. In the example above where we provided integer size and price, Numba had no issues processing them. But as soon as we create such as order in a loop and one of the arguments is a float instead of an integer provided previously, Numba will throw an error because it cannot unify data types anymore. Thus, we should cast all arguments to their target data types before constructing an order.</p> <p>Both issues are solved by using the function <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.order_nb>order_nb</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>create_order_nb</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>price</span><span class=p>,</span> <span class=n>direction</span><span class=p>):</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>size</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=n>price</span><span class=p>,</span> <span class=n>direction</span><span class=o>=</span><span class=n>direction</span><span class=p>)</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>create_order_nb</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=go>Order(size=1.0, price=15.0, ..., direction=2, ...)</span>
</span></code></pre></div> <p>Notice how the size and price arguments were automatically cast to floats.</p> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>Use <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.order_nb>order_nb</a> instead of <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.Order>Order</a> whenever possible.</p> </div> <p>To create an order that closes out the current position, we can conveniently use <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.close_position_nb>close_position_nb</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>close_position_nb</span><span class=p>(</span><span class=mi>15</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=go>Order(size=0.0, price=15.0, size_type=6, ...)</span>
</span></code></pre></div> <ol> <li>Uses size of zero and size type of <code>TargetAmount</code></li> </ol> <h3 id=validation>Validation<a class=headerlink href=#validation title="Permanent link">&para;</a></h3> <p>Having constructed the order, <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.execute_order_nb>execute_order_nb</a> will check the arguments of that order for correct data types and values. For example, let's try passing a negative price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=gp>... </span>    <span class=n>val_price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=gp>... </span>    <span class=n>value</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>price</span><span class=o>=-</span><span class=mi>15</span><span class=p>)</span>
</span><span id=__span-46-13><a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-14><a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a><span class=go>ValueError: order.price must be finite and 0 or greater</span>
</span></code></pre></div> <h3 id=price-resolution>Price resolution<a class=headerlink href=#price-resolution title="Permanent link">&para;</a></h3> <p>After validating the inputs, <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.execute_order_nb>execute_order_nb</a> uses them to decide which command to run: buy or sell. But first, it has to do some preprocessing.</p> <p>Even though vectorbt isn't associated with any particular data schema and can run on tick data just as well as on bar data, it still gives us an option to provide the current candle (<code>price_area</code>) for validation and resolution reasons. In such a case, it will consider the passed order price as a price point located within four price bounds: the opening, high, low, and closing price. Since order execution must happen strictly within those bounds, setting order price to <code>-np.inf</code> and <code>np.inf</code> will replace it by the opening and closing price respectively. Hence, next time, when you see any default price being <code>np.inf</code>, just know that it means the close price <img alt=✍ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/270d.svg title=:writing_hand:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price_area</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PriceArea</span><span class=p>(</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mi>12</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>),</span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=gp>... </span>    <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=o>.</span><span class=n>price</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=go>10.0</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>),</span>
</span><span id=__span-47-18><a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a><span class=gp>... </span>    <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span>
</span><span id=__span-47-19><a id=__codelineno-47-19 name=__codelineno-47-19 href=#__codelineno-47-19></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-47-20><a id=__codelineno-47-20 name=__codelineno-47-20 href=#__codelineno-47-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=o>.</span><span class=n>price</span>
</span><span id=__span-47-21><a id=__codelineno-47-21 name=__codelineno-47-21 href=#__codelineno-47-21></a><span class=go>12.0</span>
</span><span id=__span-47-22><a id=__codelineno-47-22 name=__codelineno-47-22 href=#__codelineno-47-22></a>
</span><span id=__span-47-23><a id=__codelineno-47-23 name=__codelineno-47-23 href=#__codelineno-47-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-47-24><a id=__codelineno-47-24 name=__codelineno-47-24 href=#__codelineno-47-24></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-47-25><a id=__codelineno-47-25 name=__codelineno-47-25 href=#__codelineno-47-25></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>)</span>
</span><span id=__span-47-26><a id=__codelineno-47-26 name=__codelineno-47-26 href=#__codelineno-47-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-47-27><a id=__codelineno-47-27 name=__codelineno-47-27 href=#__codelineno-47-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=o>.</span><span class=n>price</span>
</span><span id=__span-47-28><a id=__codelineno-47-28 name=__codelineno-47-28 href=#__codelineno-47-28></a><span class=go>nan</span>
</span></code></pre></div> <ol> <li>Price gets replaced by the open price. Order executed.</li> <li>Price gets replaced by the close price (default). Order executed.</li> <li>Price gets replaced by <code>np.nan</code> since the price area is not defined. Order ignored.</li> </ol> <h3 id=size-type-conversion>Size type conversion<a class=headerlink href=#size-type-conversion title="Permanent link">&para;</a></h3> <p>Our primitive commands accept only a size in the number of shares, thus we have to convert any size type defined in <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.SizeType>SizeType</a> to <code>Amount</code>. Different size types require different information for conversion; for example, <code>TargetAmount</code> requires to know the current position size, while <code>Value</code> also requires to know the current valuation price.</p> <p>Let's execute an order such that the new position has 3 shares:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> 
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetAmount</span>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=gp>... </span>    <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=go>OrderResult(</span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a><span class=go>    size=3.0,</span>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a><span class=go>    price=12.0,</span>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=go>    fees=0.0,</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=go>    side=0,</span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a><span class=go>    status=0,</span>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a><span class=go>    status_info=-1</span>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=go>)</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_exec_state</span><span class=p>)</span>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=go>ExecState(</span>
</span><span id=__span-48-20><a id=__codelineno-48-20 name=__codelineno-48-20 href=#__codelineno-48-20></a><span class=go>    cash=64.0,</span>
</span><span id=__span-48-21><a id=__codelineno-48-21 name=__codelineno-48-21 href=#__codelineno-48-21></a><span class=go>    position=3.0,</span>
</span><span id=__span-48-22><a id=__codelineno-48-22 name=__codelineno-48-22 href=#__codelineno-48-22></a><span class=go>    debt=0.0,</span>
</span><span id=__span-48-23><a id=__codelineno-48-23 name=__codelineno-48-23 href=#__codelineno-48-23></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-48-24><a id=__codelineno-48-24 name=__codelineno-48-24 href=#__codelineno-48-24></a><span class=go>    free_cash=64.0,</span>
</span><span id=__span-48-25><a id=__codelineno-48-25 name=__codelineno-48-25 href=#__codelineno-48-25></a><span class=go>    val_price=15.0,</span>
</span><span id=__span-48-26><a id=__codelineno-48-26 name=__codelineno-48-26 href=#__codelineno-48-26></a><span class=go>    value=100.0</span>
</span><span id=__span-48-27><a id=__codelineno-48-27 name=__codelineno-48-27 href=#__codelineno-48-27></a><span class=go>)</span>
</span></code></pre></div> <p>Since we're not in the market, vectorbt used <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.buy_nb>buy_nb</a> to buy 3 shares. If we were in the market with 10 shares, it would have used <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.sell_nb>sell_nb</a> to sell 7 shares.</p> <h3 id=direction>Direction<a class=headerlink href=#direction title="Permanent link">&para;</a></h3> <p>Function <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.order_nb>order_nb</a> takes the argument <code>direction</code> for two reasons: resolve the direction of the order based on the sign of the argument <code>size</code>, and decide on whether to reverse the position or just to close out it. When the direction is <code>LongOnly</code> or <code>Both</code>, a positive size means buying and a negative size means selling. When the direction is <code>ShortOnly</code> though, the exact opposite happens: a positive size means selling and a negative size means buying. This is because a positive size is associated with increasing a position, which means buying to increase a long position and selling to increase a short position. For example, if the direction was <code>ShortOnly</code> and the size was a negative infinity, any short position would be closed out and any long position would be enlarged.</p> <h3 id=valuation>Valuation<a class=headerlink href=#valuation title="Permanent link">&para;</a></h3> <p>Speaking about the valuation price, it's the latest available price at the time of decision-making, or the price used to calculate the portfolio value. In many simulation methods, valuation price defaults to the order price, but sometimes it makes more sense to use the open or previous close price for the conversion step. The separation of the valuation and order price enables us to introduce a time gap between order placement and its execution. This is important because, in reality, not always an order can be executed right away.</p> <p>Let's order 100% of the portfolio value:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span> 
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=gp>... </span>    <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=go>OrderResult(</span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=go>    size=6.666666666666667,</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=go>    price=12.0,</span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=go>    fees=0.0,</span>
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a><span class=go>    side=0,</span>
</span><span id=__span-49-15><a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a><span class=go>    status=0,</span>
</span><span id=__span-49-16><a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a><span class=go>    status_info=-1</span>
</span><span id=__span-49-17><a id=__codelineno-49-17 name=__codelineno-49-17 href=#__codelineno-49-17></a><span class=go>)</span>
</span><span id=__span-49-18><a id=__codelineno-49-18 name=__codelineno-49-18 href=#__codelineno-49-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_exec_state</span><span class=p>)</span>
</span><span id=__span-49-19><a id=__codelineno-49-19 name=__codelineno-49-19 href=#__codelineno-49-19></a><span class=go>ExecState(</span>
</span><span id=__span-49-20><a id=__codelineno-49-20 name=__codelineno-49-20 href=#__codelineno-49-20></a><span class=go>    cash=20.0,</span>
</span><span id=__span-49-21><a id=__codelineno-49-21 name=__codelineno-49-21 href=#__codelineno-49-21></a><span class=go>    position=6.666666666666667,</span>
</span><span id=__span-49-22><a id=__codelineno-49-22 name=__codelineno-49-22 href=#__codelineno-49-22></a><span class=go>    debt=0.0,</span>
</span><span id=__span-49-23><a id=__codelineno-49-23 name=__codelineno-49-23 href=#__codelineno-49-23></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-49-24><a id=__codelineno-49-24 name=__codelineno-49-24 href=#__codelineno-49-24></a><span class=go>    free_cash=20.0,</span>
</span><span id=__span-49-25><a id=__codelineno-49-25 name=__codelineno-49-25 href=#__codelineno-49-25></a><span class=go>    val_price=15.0,</span>
</span><span id=__span-49-26><a id=__codelineno-49-26 name=__codelineno-49-26 href=#__codelineno-49-26></a><span class=go>    value=100.0</span>
</span><span id=__span-49-27><a id=__codelineno-49-27 name=__codelineno-49-27 href=#__codelineno-49-27></a><span class=go>)</span>
</span></code></pre></div> <p>Why haven't we spent the entire cash? Because to convert the target percentage into the target amount of shares, vectorbt used the provided order execution state with <code>val_price</code> of $15 and <code>value</code> of $100, which produced <code>100 / 15 = 6.67</code>. The closer the valuation price is to the order price, the closer the calculation result would be to the target requirement.</p> <p>By default, if we want to place multiple orders within the same bar (for example, in pairs trading), vectorbt wouldn't adjust the portfolio value after each order. This is because it assumes that we made our trading decisions way before order execution and adjusting the value would affect those decisions. But also, an order has only a marginal immediate effect on the value, for example, because of a commission. To force vectorbt to update the valuation price and value itself, we can enable <code>update_value</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span> 
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span><span class=p>,</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=gp>... </span>        <span class=n>fixed_fees</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=gp>... </span>        <span class=n>slippage</span><span class=o>=</span><span class=mf>0.01</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=gp>... </span>    <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span><span class=p>,</span>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=gp>... </span>    <span class=n>update_value</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>order_result</span><span class=p>)</span>
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a><span class=go>OrderResult(</span>
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a><span class=go>    size=6.666666666666667,</span>
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a><span class=go>    price=12.120000000000001,</span>
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a><span class=go>    fees=10.0,</span>
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a><span class=go>    side=0,</span>
</span><span id=__span-50-18><a id=__codelineno-50-18 name=__codelineno-50-18 href=#__codelineno-50-18></a><span class=go>    status=0,</span>
</span><span id=__span-50-19><a id=__codelineno-50-19 name=__codelineno-50-19 href=#__codelineno-50-19></a><span class=go>    status_info=-1</span>
</span><span id=__span-50-20><a id=__codelineno-50-20 name=__codelineno-50-20 href=#__codelineno-50-20></a><span class=go>)</span>
</span><span id=__span-50-21><a id=__codelineno-50-21 name=__codelineno-50-21 href=#__codelineno-50-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>new_exec_state</span><span class=p>)</span>
</span><span id=__span-50-22><a id=__codelineno-50-22 name=__codelineno-50-22 href=#__codelineno-50-22></a><span class=go>ExecState(</span>
</span><span id=__span-50-23><a id=__codelineno-50-23 name=__codelineno-50-23 href=#__codelineno-50-23></a><span class=go>    cash=9.199999999999989,</span>
</span><span id=__span-50-24><a id=__codelineno-50-24 name=__codelineno-50-24 href=#__codelineno-50-24></a><span class=go>    position=6.666666666666667,</span>
</span><span id=__span-50-25><a id=__codelineno-50-25 name=__codelineno-50-25 href=#__codelineno-50-25></a><span class=go>    debt=0.0,</span>
</span><span id=__span-50-26><a id=__codelineno-50-26 name=__codelineno-50-26 href=#__codelineno-50-26></a><span class=go>    locked_cash=0.0,</span>
</span><span id=__span-50-27><a id=__codelineno-50-27 name=__codelineno-50-27 href=#__codelineno-50-27></a><span class=go>    free_cash=9.199999999999989,</span>
</span><span id=__span-50-28><a id=__codelineno-50-28 name=__codelineno-50-28 href=#__codelineno-50-28></a><span class=go>    val_price=12.120000000000001,</span>
</span><span id=__span-50-29><a id=__codelineno-50-29 name=__codelineno-50-29 href=#__codelineno-50-29></a><span class=go>    value=90.0</span>
</span><span id=__span-50-30><a id=__codelineno-50-30 name=__codelineno-50-30 href=#__codelineno-50-30></a><span class=go>)</span>
</span></code></pre></div> <p>Notice how the new valuation price has been set to the close price adjusted with the slippage while the value has decreased by the fixed commission. Any new order placed after this one would use the updated value and thus probably produce a different outcome.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Use this feature only if you can control the order in which orders appear within a bar and when you have intra-bar data.</p> </div> <h3 id=pipeline2>Pipeline/2<a class=headerlink href=#pipeline2 title="Permanent link">&para;</a></h3> <p>Let's create another simplified pipeline that orders given a target percentage array. In particular, we'll keep 50% of the portfolio value in shares, and rebalance monthly. We'll calculate the portfolio value based on the open price at the beginning of each bar, and order at the end of each bar (to keep things realistic). Also, we'll fill asset value and portfolio value arrays to later plot the allocation at each bar.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>pipeline_2_nb</span><span class=p>(</span><span class=nb>open</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>target_pct</span><span class=p>,</span> <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=gp>... </span>    <span class=n>asset_value_out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=gp>... </span>    <span class=n>value_out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=gp>... </span>    <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=gp>... </span>        <span class=n>cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>),</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=gp>... </span>        <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=gp>... </span>        <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=gp>... </span>        <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=gp>... </span>        <span class=n>free_cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>),</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=gp>... </span>        <span class=n>val_price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=gp>... </span>        <span class=n>value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=gp>...</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=gp>... </span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>target_pct</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>  <span class=c1># (3)!</span>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=gp>... </span>            <span class=n>val_price</span> <span class=o>=</span> <span class=nb>open</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a><span class=gp>... </span>            <span class=n>value</span> <span class=o>=</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>val_price</span> <span class=o>*</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>position</span>  <span class=c1># (4)!</span>
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a><span class=gp>...</span>
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a><span class=gp>... </span>            <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a><span class=gp>... </span>                <span class=n>cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span><span class=p>,</span>
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a><span class=gp>... </span>                <span class=n>position</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span><span class=p>,</span>
</span><span id=__span-51-23><a id=__codelineno-51-23 name=__codelineno-51-23 href=#__codelineno-51-23></a><span class=gp>... </span>                <span class=n>debt</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>debt</span><span class=p>,</span>
</span><span id=__span-51-24><a id=__codelineno-51-24 name=__codelineno-51-24 href=#__codelineno-51-24></a><span class=gp>... </span>                <span class=n>locked_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>locked_cash</span><span class=p>,</span>
</span><span id=__span-51-25><a id=__codelineno-51-25 name=__codelineno-51-25 href=#__codelineno-51-25></a><span class=gp>... </span>                <span class=n>free_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>free_cash</span><span class=p>,</span>
</span><span id=__span-51-26><a id=__codelineno-51-26 name=__codelineno-51-26 href=#__codelineno-51-26></a><span class=gp>... </span>                <span class=n>val_price</span><span class=o>=</span><span class=n>val_price</span><span class=p>,</span>
</span><span id=__span-51-27><a id=__codelineno-51-27 name=__codelineno-51-27 href=#__codelineno-51-27></a><span class=gp>... </span>                <span class=n>value</span><span class=o>=</span><span class=n>value</span>
</span><span id=__span-51-28><a id=__codelineno-51-28 name=__codelineno-51-28 href=#__codelineno-51-28></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-51-29><a id=__codelineno-51-29 name=__codelineno-51-29 href=#__codelineno-51-29></a><span class=gp>... </span>            <span class=n>order</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-51-30><a id=__codelineno-51-30 name=__codelineno-51-30 href=#__codelineno-51-30></a><span class=gp>... </span>                <span class=n>size</span><span class=o>=</span><span class=n>target_pct</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span><span id=__span-51-31><a id=__codelineno-51-31 name=__codelineno-51-31 href=#__codelineno-51-31></a><span class=gp>... </span>                <span class=n>price</span><span class=o>=</span><span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span><span id=__span-51-32><a id=__codelineno-51-32 name=__codelineno-51-32 href=#__codelineno-51-32></a><span class=gp>... </span>                <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span>
</span><span id=__span-51-33><a id=__codelineno-51-33 name=__codelineno-51-33 href=#__codelineno-51-33></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-51-34><a id=__codelineno-51-34 name=__codelineno-51-34 href=#__codelineno-51-34></a><span class=gp>... </span>            <span class=n>_</span><span class=p>,</span> <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>  <span class=c1># (7)!</span>
</span><span id=__span-51-35><a id=__codelineno-51-35 name=__codelineno-51-35 href=#__codelineno-51-35></a><span class=gp>... </span>                <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-51-36><a id=__codelineno-51-36 name=__codelineno-51-36 href=#__codelineno-51-36></a><span class=gp>... </span>                <span class=n>order</span><span class=o>=</span><span class=n>order</span>
</span><span id=__span-51-37><a id=__codelineno-51-37 name=__codelineno-51-37 href=#__codelineno-51-37></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-51-38><a id=__codelineno-51-38 name=__codelineno-51-38 href=#__codelineno-51-38></a><span class=gp>...</span>
</span><span id=__span-51-39><a id=__codelineno-51-39 name=__codelineno-51-39 href=#__codelineno-51-39></a><span class=gp>... </span>        <span class=n>asset_value_out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>position</span> <span class=o>*</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>  <span class=c1># (8)!</span>
</span><span id=__span-51-40><a id=__codelineno-51-40 name=__codelineno-51-40 href=#__codelineno-51-40></a><span class=gp>... </span>        <span class=n>value_out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>position</span> <span class=o>*</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-51-41><a id=__codelineno-51-41 name=__codelineno-51-41 href=#__codelineno-51-41></a><span class=gp>... </span>        
</span><span id=__span-51-42><a id=__codelineno-51-42 name=__codelineno-51-42 href=#__codelineno-51-42></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>asset_value_out</span><span class=p>,</span> <span class=n>value_out</span>
</span></code></pre></div> <ol> <li>Create two empty arrays with a floating data type. Remember that creating an array with <code>np.empty</code> will produce an array with uninitialized (garbage) values that you should override.</li> <li>Our initial order execution state</li> <li>There is no need to run order execution when target percentage is <code>np.nan</code> (= do not rebalance)</li> <li>Calculate the portfolio value at the beginning of the bar (= valuation)</li> <li>Create a new existing order execution state after the valuation</li> <li>Create a new order tuple using the close price as order price</li> <li>Execute the order and return the order result and the new execution state</li> <li>Fill the arrays (you should fill each single element!)</li> </ol> <p>Let's run the pipeline on our Bitcoin data:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>symbol_wrapper</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get_symbol_wrapper</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_pct</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_pct</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;MS&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>asset_value</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>pipeline_2_nb</span><span class=p>(</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=gp>... </span>    <span class=n>target_pct</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>asset_value</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>asset_value</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>value</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span> <span class=o>=</span> <span class=p>(</span><span class=n>asset_value</span> <span class=o>/</span> <span class=n>value</span><span class=p>)</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>scatterplot</span><span class=p>(</span><span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=gp>... </span>    <span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=gp>... </span>        <span class=n>color</span><span class=o>=</span><span class=n>allocations</span><span class=p>,</span> 
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=gp>... </span>        <span class=n>colorscale</span><span class=o>=</span><span class=s2>&quot;Temps&quot;</span><span class=p>,</span> 
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=gp>... </span>        <span class=n>cmin</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span>
</span><span id=__span-52-19><a id=__codelineno-52-19 name=__codelineno-52-19 href=#__codelineno-52-19></a><span class=gp>... </span>        <span class=n>cmid</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span><span id=__span-52-20><a id=__codelineno-52-20 name=__codelineno-52-20 href=#__codelineno-52-20></a><span class=gp>... </span>        <span class=n>cmax</span><span class=o>=</span><span class=mf>0.7</span>
</span><span id=__span-52-21><a id=__codelineno-52-21 name=__codelineno-52-21 href=#__codelineno-52-21></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-52-22><a id=__codelineno-52-22 name=__codelineno-52-22 href=#__codelineno-52-22></a><span class=gp>... </span><span class=p>))</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>We cannot use <code>data.wrapper</code> because it contains OHLC as columns. What we need is a wrapper that has symbols as columns, to fill the array with target percentages.</li> <li>Fill the array with NaNs and set all data points at the beginning of each month to <code>0.5</code>.</li> <li>Use the same wrapper to convert the NumPy array into Pandas Series</li> <li>Divide the asset value by the portfolio value to derive the allocation</li> </ol> <p><img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_2_allocation1.light.svg#only-light> <img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_2_allocation1.dark.svg#only-dark></p> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>Each point represents a revaluation at the end of each bar.</p> </div> <p>We see that allocations are being regularly pulled back to the target level of 50%.</p> <p>Let's validate the pipeline using <a href=../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_orders</span><span class=p>(</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span> 
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>target_pct</span><span class=p>,</span> 
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;targetpercent&quot;</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>scatterplot</span><span class=p>(</span><span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=gp>... </span>    <span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=gp>... </span>        <span class=n>color</span><span class=o>=</span><span class=n>allocations</span><span class=p>,</span> 
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=gp>... </span>        <span class=n>colorscale</span><span class=o>=</span><span class=s2>&quot;Temps&quot;</span><span class=p>,</span> 
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=gp>... </span>        <span class=n>cmin</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=gp>... </span>        <span class=n>cmid</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=gp>... </span>        <span class=n>cmax</span><span class=o>=</span><span class=mf>0.7</span>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=gp>... </span><span class=p>))</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_2_allocation2.light.svg#only-light> <img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_2_allocation2.dark.svg#only-dark></p> <p>One of the biggest advantages of using vectorbt is that you can run your minimalistic trading environment in any Python function, even inside objective functions of machine learning models! There is no need to trigger the entire backtesting pipeline as a script or any other complex process like most backtesting frameworks force us to do <img alt=😵‍💫 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f635-200d-1f4ab.svg title=:face_with_spiral_eyes:></p> <h2 id=order-processing>Order processing<a class=headerlink href=#order-processing title="Permanent link">&para;</a></h2> <p>Order execution takes an order instruction and translates it into a buy or sell operation. The responsibility of the user is to do something with the returned order execution state and result; mostly, we want to post-process and append each successful order to some list for later analysis - that's where order and log records come into play. Furthermore, we may want to raise an error if an order has been rejected and a certain flag in the requirements is present. All of this is ensured by <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.process_order_nb>process_order_nb</a>.</p> <h3 id=order-records>Order records<a class=headerlink href=#order-records title="Permanent link">&para;</a></h3> <p>Order records is a <a href=https://numpy.org/doc/stable/user/basics.rec.html>structured</a> NumPy array of the data type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.order_dt>order_dt</a> containing information on each successful order. Each order in this array is assumed to be completed, that is, you should view an order as a trade in the vectorbt's world. Since we're dealing with Numba, we cannot and should not use lists and other inefficient data structures for storing such complex information. Given that orders have fields with variable data types, the best data structure is a record array, which is a regular NumPy array with a complex data type and that behaves similarly to a Pandas DataFrame.</p> <p>Since any NumPy array is a non-appendable structure, we should initialize an empty array of a sufficient size, and gradually fill it with new information. For this, we need a counter - a simple integer - that points to an index of the next record to be written.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Actually, you can append to a NumPy array, but it will create a new array. Don't try this at home <img alt=😄 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f604.svg title=:smile:></p> </div> <p>Let's create an array with two order records and a counter:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>order_dt</span><span class=p>)</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></code></pre></div> <p>We shouldn't access this array just yet because it contains memory garbage, thus it requires the user to manually set all the values in the array, and should be used with caution.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=go>array([(4585679916398730403, ..., 4583100142070297783),</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=go>       (4582795628349012822, ..., 4576866499094039639)],</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=go>      dtype={&#39;names&#39;:[&#39;id&#39;,&#39;col&#39;,&#39;idx&#39;,&#39;size&#39;,&#39;price&#39;,&#39;fees&#39;,&#39;side&#39;], ...})</span>
</span></code></pre></div> <p>Let's execute an order using <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.execute_order_nb>execute_order_nb</a> at the 678th bar, and fill the first record in the array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=gp>... </span>    <span class=n>cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=gp>... </span>    <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=gp>... </span>    <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=gp>... </span>    <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=gp>... </span>    <span class=n>free_cash</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=gp>... </span>    <span class=n>val_price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=gp>... </span>    <span class=n>value</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>)</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>order_result</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderStatus</span><span class=o>.</span><span class=n>Filled</span><span class=p>:</span>  <span class=c1># (1)!</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_count</span>  <span class=c1># (2)!</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-56-17><a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;idx&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=mi>678</span>  <span class=c1># (3)!</span>
</span><span id=__span-56-18><a id=__codelineno-56-18 name=__codelineno-56-18 href=#__codelineno-56-18></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;size&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>size</span>
</span><span id=__span-56-19><a id=__codelineno-56-19 name=__codelineno-56-19 href=#__codelineno-56-19></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;price&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>price</span>
</span><span id=__span-56-20><a id=__codelineno-56-20 name=__codelineno-56-20 href=#__codelineno-56-20></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;fees&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>fees</span>
</span><span id=__span-56-21><a id=__codelineno-56-21 name=__codelineno-56-21 href=#__codelineno-56-21></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;side&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>side</span>
</span><span id=__span-56-22><a id=__codelineno-56-22 name=__codelineno-56-22 href=#__codelineno-56-22></a><span class=gp>... </span>    <span class=n>order_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-56-23><a id=__codelineno-56-23 name=__codelineno-56-23 href=#__codelineno-56-23></a>
</span><span id=__span-56-24><a id=__codelineno-56-24 name=__codelineno-56-24 href=#__codelineno-56-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-56-25><a id=__codelineno-56-25 name=__codelineno-56-25 href=#__codelineno-56-25></a><span class=go>(0, 0, 678, 6.66666667, 15., 0., 0)</span>
</span><span id=__span-56-26><a id=__codelineno-56-26 name=__codelineno-56-26 href=#__codelineno-56-26></a>
</span><span id=__span-56-27><a id=__codelineno-56-27 name=__codelineno-56-27 href=#__codelineno-56-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_count</span>
</span><span id=__span-56-28><a id=__codelineno-56-28 name=__codelineno-56-28 href=#__codelineno-56-28></a><span class=go>1</span>
</span></code></pre></div> <ol> <li>Check that the order has been filled</li> <li>Order ids start with 0 and follow the counter</li> <li>Index of the current bar</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>When writing to an element of a record field, first select the field, and then the index.</p> </div> <p>At the next bar, we'll reverse the position and fill the second record:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result</span><span class=p>,</span> <span class=n>new_exec_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>new_exec_state</span><span class=p>,</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=mf>16.0</span><span class=p>)</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>order_result</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OrderStatus</span><span class=o>.</span><span class=n>Filled</span><span class=p>:</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_count</span>  <span class=c1># (1)!</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;idx&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=mi>679</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;size&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>size</span>
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;price&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>price</span>
</span><span id=__span-57-11><a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;fees&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>fees</span>
</span><span id=__span-57-12><a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;side&quot;</span><span class=p>][</span><span class=n>order_count</span><span class=p>]</span> <span class=o>=</span> <span class=n>order_result</span><span class=o>.</span><span class=n>side</span>
</span><span id=__span-57-13><a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a><span class=gp>... </span>    <span class=n>order_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-57-14><a id=__codelineno-57-14 name=__codelineno-57-14 href=#__codelineno-57-14></a>
</span><span id=__span-57-15><a id=__codelineno-57-15 name=__codelineno-57-15 href=#__codelineno-57-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-57-16><a id=__codelineno-57-16 name=__codelineno-57-16 href=#__codelineno-57-16></a><span class=go>(1, 0, 679, 13.33333333, 16., 0., 1)</span>
</span><span id=__span-57-17><a id=__codelineno-57-17 name=__codelineno-57-17 href=#__codelineno-57-17></a>
</span><span id=__span-57-18><a id=__codelineno-57-18 name=__codelineno-57-18 href=#__codelineno-57-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_count</span>
</span><span id=__span-57-19><a id=__codelineno-57-19 name=__codelineno-57-19 href=#__codelineno-57-19></a><span class=go>2</span>
</span></code></pre></div> <ol> <li>Don't forget to increment the order id</li> </ol> <p>Here are the order records that we've populated:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=go>array([(0, 0, 678,  6.66666667, 15., 0., 0),</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=go>       (1, 0, 679, 13.33333333, 16., 0., 1)],</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=go>      dtype={&#39;names&#39;:[&#39;id&#39;,&#39;col&#39;,&#39;idx&#39;,&#39;size&#39;,&#39;price&#39;,&#39;fees&#39;,&#39;side&#39;], ...})</span>
</span></code></pre></div> <p>But instead of setting each of these records manually, we can use <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.process_order_nb>process_order_nb</a> to do it for us! We just need to do one little adjustment: both the order records and the counter must be provided per column since vectorbt primarily works on multi-columnar data. This means that the order records array must become a two-dimensional array and the counter constant must become a one-dimensional array (both with only one column in our example):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>((</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>order_dt</span><span class=p>)</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result1</span><span class=p>,</span> <span class=n>new_exec_state1</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=gp>... </span>    <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>678</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>),</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=gp>... </span>    <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a><span class=gp>... </span>    <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result2</span><span class=p>,</span> <span class=n>new_exec_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a><span class=gp>... </span>    <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>679</span><span class=p>,</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>new_exec_state</span><span class=p>,</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=mf>16.0</span><span class=p>),</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a><span class=gp>... </span>    <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-59-16><a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a><span class=gp>... </span>    <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span>
</span><span id=__span-59-17><a id=__codelineno-59-17 name=__codelineno-59-17 href=#__codelineno-59-17></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-59-18><a id=__codelineno-59-18 name=__codelineno-59-18 href=#__codelineno-59-18></a>
</span><span id=__span-59-19><a id=__codelineno-59-19 name=__codelineno-59-19 href=#__codelineno-59-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span>
</span><span id=__span-59-20><a id=__codelineno-59-20 name=__codelineno-59-20 href=#__codelineno-59-20></a><span class=go>array([(0, 0, 678,  6.66666667, 15., 0., 0),</span>
</span><span id=__span-59-21><a id=__codelineno-59-21 name=__codelineno-59-21 href=#__codelineno-59-21></a><span class=go>       (1, 0, 679, 13.33333333, 16., 0., 1)],</span>
</span><span id=__span-59-22><a id=__codelineno-59-22 name=__codelineno-59-22 href=#__codelineno-59-22></a><span class=go>      dtype={&#39;names&#39;:[&#39;id&#39;,&#39;col&#39;,&#39;idx&#39;,&#39;size&#39;,&#39;price&#39;,&#39;fees&#39;,&#39;side&#39;], ...})</span>
</span><span id=__span-59-23><a id=__codelineno-59-23 name=__codelineno-59-23 href=#__codelineno-59-23></a>
</span><span id=__span-59-24><a id=__codelineno-59-24 name=__codelineno-59-24 href=#__codelineno-59-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_counts</span>
</span><span id=__span-59-25><a id=__codelineno-59-25 name=__codelineno-59-25 href=#__codelineno-59-25></a><span class=go>array([2])</span>
</span></code></pre></div> <ol> <li>Current group, column, and index (row)</li> </ol> <p>Such filled order records will become the backbone of the post-analysis phase.</p> <h3 id=log-records>Log records<a class=headerlink href=#log-records title="Permanent link">&para;</a></h3> <p>Log records have the data type <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.log_dt>log_dt</a> and are similar to order records, but with a few key differences: they are saved irrespective of whether the order has been filled, and they also contain information on the current execution state, the order request, and the new execution state. This way, we can completely and post-factum track down issues related to order processing.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>((</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>order_dt</span><span class=p>)</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>log_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>((</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>log_dt</span><span class=p>)</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>log_counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result1</span><span class=p>,</span> <span class=n>new_exec_state1</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a><span class=gp>... </span>    <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>678</span><span class=p>,</span>
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=mf>15.0</span><span class=p>,</span> <span class=n>log</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a><span class=gp>... </span>    <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a><span class=gp>... </span>    <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span><span class=p>,</span>
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a><span class=gp>... </span>    <span class=n>log_records</span><span class=o>=</span><span class=n>log_records</span><span class=p>,</span>
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a><span class=gp>... </span>    <span class=n>log_counts</span><span class=o>=</span><span class=n>log_counts</span>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_result2</span><span class=p>,</span> <span class=n>new_exec_state2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a><span class=gp>... </span>    <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>679</span><span class=p>,</span>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a><span class=gp>... </span>    <span class=n>exec_state</span><span class=o>=</span><span class=n>new_exec_state</span><span class=p>,</span>
</span><span id=__span-60-18><a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a><span class=gp>... </span>    <span class=n>order</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span><span class=n>size</span><span class=o>=-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=n>price</span><span class=o>=</span><span class=mf>16.0</span><span class=p>,</span> <span class=n>log</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span><span id=__span-60-19><a id=__codelineno-60-19 name=__codelineno-60-19 href=#__codelineno-60-19></a><span class=gp>... </span>    <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-60-20><a id=__codelineno-60-20 name=__codelineno-60-20 href=#__codelineno-60-20></a><span class=gp>... </span>    <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span><span class=p>,</span>
</span><span id=__span-60-21><a id=__codelineno-60-21 name=__codelineno-60-21 href=#__codelineno-60-21></a><span class=gp>... </span>    <span class=n>log_records</span><span class=o>=</span><span class=n>log_records</span><span class=p>,</span>
</span><span id=__span-60-22><a id=__codelineno-60-22 name=__codelineno-60-22 href=#__codelineno-60-22></a><span class=gp>... </span>    <span class=n>log_counts</span><span class=o>=</span><span class=n>log_counts</span>
</span><span id=__span-60-23><a id=__codelineno-60-23 name=__codelineno-60-23 href=#__codelineno-60-23></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-60-24><a id=__codelineno-60-24 name=__codelineno-60-24 href=#__codelineno-60-24></a>
</span><span id=__span-60-25><a id=__codelineno-60-25 name=__codelineno-60-25 href=#__codelineno-60-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>log_records</span>
</span><span id=__span-60-26><a id=__codelineno-60-26 name=__codelineno-60-26 href=#__codelineno-60-26></a><span class=go>array([[(0, 0, 0, 678, ..., 0., 15., 100., 0)],</span>
</span><span id=__span-60-27><a id=__codelineno-60-27 name=__codelineno-60-27 href=#__codelineno-60-27></a><span class=go>       [(1, 0, 0, 679, ..., 0., 15., 100., 1)]],</span>
</span><span id=__span-60-28><a id=__codelineno-60-28 name=__codelineno-60-28 href=#__codelineno-60-28></a><span class=go>      dtype={&#39;names&#39;:[&#39;id&#39;,&#39;group&#39;,...,&#39;res_status_info&#39;,&#39;order_id&#39;], ...})</span>
</span></code></pre></div> <ol> <li>Logging of each order must be explicitly enabled</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Logging costs performance and memory. Use only when really needed.</p> </div> <h3 id=pipeline3>Pipeline/3<a class=headerlink href=#pipeline3 title="Permanent link">&para;</a></h3> <p>Let's extend the <a href=#pipeline2>last pipeline</a> to independently process an arbitrary number of columns, and gradually fill order records. This way, we can backtest multiple parameter combinations by taking advantage of multidimensionality!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>pipeline_3_nb</span><span class=p>(</span><span class=nb>open</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>target_pct</span><span class=p>,</span> <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=gp>... </span>    <span class=n>order_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>order_dt</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=gp>... </span>    <span class=n>order_counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a><span class=gp>...</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>  <span class=c1># (2)!</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=gp>... </span>        <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=gp>... </span>            <span class=n>cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>),</span>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=gp>... </span>            <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=gp>... </span>            <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=gp>... </span>            <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-61-12><a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a><span class=gp>... </span>            <span class=n>free_cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>),</span>
</span><span id=__span-61-13><a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a><span class=gp>... </span>            <span class=n>val_price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-61-14><a id=__codelineno-61-14 name=__codelineno-61-14 href=#__codelineno-61-14></a><span class=gp>... </span>            <span class=n>value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-61-15><a id=__codelineno-61-15 name=__codelineno-61-15 href=#__codelineno-61-15></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-61-16><a id=__codelineno-61-16 name=__codelineno-61-16 href=#__codelineno-61-16></a><span class=gp>...</span>
</span><span id=__span-61-17><a id=__codelineno-61-17 name=__codelineno-61-17 href=#__codelineno-61-17></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-61-18><a id=__codelineno-61-18 name=__codelineno-61-18 href=#__codelineno-61-18></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>target_pct</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]):</span>  <span class=c1># (3)!</span>
</span><span id=__span-61-19><a id=__codelineno-61-19 name=__codelineno-61-19 href=#__codelineno-61-19></a><span class=gp>... </span>                <span class=n>val_price</span> <span class=o>=</span> <span class=nb>open</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-61-20><a id=__codelineno-61-20 name=__codelineno-61-20 href=#__codelineno-61-20></a><span class=gp>... </span>                <span class=n>value</span> <span class=o>=</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>val_price</span> <span class=o>*</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>position</span>
</span><span id=__span-61-21><a id=__codelineno-61-21 name=__codelineno-61-21 href=#__codelineno-61-21></a><span class=gp>...</span>
</span><span id=__span-61-22><a id=__codelineno-61-22 name=__codelineno-61-22 href=#__codelineno-61-22></a><span class=gp>... </span>                <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-61-23><a id=__codelineno-61-23 name=__codelineno-61-23 href=#__codelineno-61-23></a><span class=gp>... </span>                    <span class=n>cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span><span class=p>,</span>
</span><span id=__span-61-24><a id=__codelineno-61-24 name=__codelineno-61-24 href=#__codelineno-61-24></a><span class=gp>... </span>                    <span class=n>position</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span><span class=p>,</span>
</span><span id=__span-61-25><a id=__codelineno-61-25 name=__codelineno-61-25 href=#__codelineno-61-25></a><span class=gp>... </span>                    <span class=n>debt</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>debt</span><span class=p>,</span>
</span><span id=__span-61-26><a id=__codelineno-61-26 name=__codelineno-61-26 href=#__codelineno-61-26></a><span class=gp>... </span>                    <span class=n>locked_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>locked_cash</span><span class=p>,</span>
</span><span id=__span-61-27><a id=__codelineno-61-27 name=__codelineno-61-27 href=#__codelineno-61-27></a><span class=gp>... </span>                    <span class=n>free_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>free_cash</span><span class=p>,</span>
</span><span id=__span-61-28><a id=__codelineno-61-28 name=__codelineno-61-28 href=#__codelineno-61-28></a><span class=gp>... </span>                    <span class=n>val_price</span><span class=o>=</span><span class=n>val_price</span><span class=p>,</span>
</span><span id=__span-61-29><a id=__codelineno-61-29 name=__codelineno-61-29 href=#__codelineno-61-29></a><span class=gp>... </span>                    <span class=n>value</span><span class=o>=</span><span class=n>value</span>
</span><span id=__span-61-30><a id=__codelineno-61-30 name=__codelineno-61-30 href=#__codelineno-61-30></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-61-31><a id=__codelineno-61-31 name=__codelineno-61-31 href=#__codelineno-61-31></a><span class=gp>... </span>                <span class=n>order</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-61-32><a id=__codelineno-61-32 name=__codelineno-61-32 href=#__codelineno-61-32></a><span class=gp>... </span>                    <span class=n>size</span><span class=o>=</span><span class=n>target_pct</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-61-33><a id=__codelineno-61-33 name=__codelineno-61-33 href=#__codelineno-61-33></a><span class=gp>... </span>                    <span class=n>price</span><span class=o>=</span><span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-61-34><a id=__codelineno-61-34 name=__codelineno-61-34 href=#__codelineno-61-34></a><span class=gp>... </span>                    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span>
</span><span id=__span-61-35><a id=__codelineno-61-35 name=__codelineno-61-35 href=#__codelineno-61-35></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-61-36><a id=__codelineno-61-36 name=__codelineno-61-36 href=#__codelineno-61-36></a><span class=gp>... </span>                <span class=n>_</span><span class=p>,</span> <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-61-37><a id=__codelineno-61-37 name=__codelineno-61-37 href=#__codelineno-61-37></a><span class=gp>... </span>                    <span class=n>col</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-61-38><a id=__codelineno-61-38 name=__codelineno-61-38 href=#__codelineno-61-38></a><span class=gp>... </span>                    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-61-39><a id=__codelineno-61-39 name=__codelineno-61-39 href=#__codelineno-61-39></a><span class=gp>... </span>                    <span class=n>order</span><span class=o>=</span><span class=n>order</span><span class=p>,</span>
</span><span id=__span-61-40><a id=__codelineno-61-40 name=__codelineno-61-40 href=#__codelineno-61-40></a><span class=gp>... </span>                    <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-61-41><a id=__codelineno-61-41 name=__codelineno-61-41 href=#__codelineno-61-41></a><span class=gp>... </span>                    <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span>
</span><span id=__span-61-42><a id=__codelineno-61-42 name=__codelineno-61-42 href=#__codelineno-61-42></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-61-43><a id=__codelineno-61-43 name=__codelineno-61-43 href=#__codelineno-61-43></a><span class=gp>... </span>        
</span><span id=__span-61-44><a id=__codelineno-61-44 name=__codelineno-61-44 href=#__codelineno-61-44></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>repartition_nb</span><span class=p>(</span><span class=n>order_records</span><span class=p>,</span> <span class=n>order_counts</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span></code></pre></div> <ol> <li>Since we don't know the number of orders in advance, let's prepare for the worst-case scenario: one record at each bar. Remember that order records must be aligned column-wise.</li> <li>Iterate over columns in <code>close</code> and run our logic on each one</li> <li>Since every array passed to the pipeline now must be two-dimensional, don't forget to specify the column when accessing an array element. Also, in indexing, first comes the row and then the column <img alt=☝ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/261d.svg title=:point_up:></li> <li>Use <a href=../../api/generic/nb/base/index.html#vectorbtpro.generic.nb.base.repartition_nb>repartition_nb</a> to flatten the final order records array (= concatenate records of all columns into a one-dimensional array)</li> <li>Since all columns represent independent backtests, groups become columns</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>We are flattening (repartitioning) order records because most records are left unfilled, thus unnecessarily taking memory. By flattening, we're effectively compressing them without losing any information because each record already tracks the column it's supposed to be in.</p> </div> <p>Our pipeline now expects all arrays to be two-dimensional. Let's test three value combinations of the parameter <code>every</code>, which controls the re-allocation periodicity. For this, we need to expand all arrays to have the same number of columns as the parameter combinations.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>every</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=s2>&quot;MS&quot;</span><span class=p>,</span> <span class=s2>&quot;Q&quot;</span><span class=p>,</span> <span class=s2>&quot;Y&quot;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;every&quot;</span><span class=p>)</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>open</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>every</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>every</span><span class=p>)</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=go>every                                MS             Q             Y</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=go>Date                                                               </span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=go>2014-09-17 00:00:00+00:00    457.334015    457.334015    457.334015</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=go>2014-09-18 00:00:00+00:00    424.440002    424.440002    424.440002</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=go>2014-09-19 00:00:00+00:00    394.795990    394.795990    394.795990</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=go>...                                 ...           ...           ...</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=go>2021-12-29 00:00:00+00:00  46444.710938  46444.710938  46444.710938</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=go>2021-12-30 00:00:00+00:00  47178.125000  47178.125000  47178.125000</span>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=go>2021-12-31 00:00:00+00:00  46306.445312  46306.445312  46306.445312</span>
</span><span id=__span-62-15><a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a>
</span><span id=__span-62-16><a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=go>[2663 rows x 3 columns]</span>
</span><span id=__span-62-17><a id=__codelineno-62-17 name=__codelineno-62-17 href=#__codelineno-62-17></a>
</span><span id=__span-62-18><a id=__codelineno-62-18 name=__codelineno-62-18 href=#__codelineno-62-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_pct</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>every</span><span class=p>)</span>
</span><span id=__span-62-19><a id=__codelineno-62-19 name=__codelineno-62-19 href=#__codelineno-62-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_pct</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;MS&quot;</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;MS&quot;</span><span class=p>],</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-62-20><a id=__codelineno-62-20 name=__codelineno-62-20 href=#__codelineno-62-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_pct</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;Q&quot;</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;Q&quot;</span><span class=p>],</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-62-21><a id=__codelineno-62-21 name=__codelineno-62-21 href=#__codelineno-62-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_pct</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;Y&quot;</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;Y&quot;</span><span class=p>],</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-62-22><a id=__codelineno-62-22 name=__codelineno-62-22 href=#__codelineno-62-22></a>
</span><span id=__span-62-23><a id=__codelineno-62-23 name=__codelineno-62-23 href=#__codelineno-62-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>pipeline_3_nb</span><span class=p>(</span>
</span><span id=__span-62-24><a id=__codelineno-62-24 name=__codelineno-62-24 href=#__codelineno-62-24></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-62-25><a id=__codelineno-62-25 name=__codelineno-62-25 href=#__codelineno-62-25></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-62-26><a id=__codelineno-62-26 name=__codelineno-62-26 href=#__codelineno-62-26></a><span class=gp>... </span>    <span class=n>target_pct</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-62-27><a id=__codelineno-62-27 name=__codelineno-62-27 href=#__codelineno-62-27></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-62-28><a id=__codelineno-62-28 name=__codelineno-62-28 href=#__codelineno-62-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span>
</span><span id=__span-62-29><a id=__codelineno-62-29 name=__codelineno-62-29 href=#__codelineno-62-29></a><span class=go>array([( 0, 0,   14, 1.29056570e-01,   383.61499023, 0., 0),  &lt;&lt; first column</span>
</span><span id=__span-62-30><a id=__codelineno-62-30 name=__codelineno-62-30 href=#__codelineno-62-30></a><span class=go>       ( 1, 0,   45, 1.00206092e-02,   325.74899292, 0., 0),</span>
</span><span id=__span-62-31><a id=__codelineno-62-31 name=__codelineno-62-31 href=#__codelineno-62-31></a><span class=go>       ( 2, 0,   75, 7.10912824e-03,   379.24499512, 0., 1),</span>
</span><span id=__span-62-32><a id=__codelineno-62-32 name=__codelineno-62-32 href=#__codelineno-62-32></a><span class=go>       ...</span>
</span><span id=__span-62-33><a id=__codelineno-62-33 name=__codelineno-62-33 href=#__codelineno-62-33></a><span class=go>       (84, 0, 2571, 7.79003416e-04, 48116.94140625, 0., 0),</span>
</span><span id=__span-62-34><a id=__codelineno-62-34 name=__codelineno-62-34 href=#__codelineno-62-34></a><span class=go>       (85, 0, 2602, 3.00678739e-03, 61004.40625   , 0., 1),</span>
</span><span id=__span-62-35><a id=__codelineno-62-35 name=__codelineno-62-35 href=#__codelineno-62-35></a><span class=go>       (86, 0, 2632, 6.84410394e-04, 57229.828125  , 0., 0),</span>
</span><span id=__span-62-36><a id=__codelineno-62-36 name=__codelineno-62-36 href=#__codelineno-62-36></a><span class=go>       ( 0, 1,   13, 1.32947604e-01,   386.94400024, 0., 0),  &lt;&lt; second column</span>
</span><span id=__span-62-37><a id=__codelineno-62-37 name=__codelineno-62-37 href=#__codelineno-62-37></a><span class=go>       ( 1, 1,  105, 1.16132613e-02,   320.19299316, 0., 0),</span>
</span><span id=__span-62-38><a id=__codelineno-62-38 name=__codelineno-62-38 href=#__codelineno-62-38></a><span class=go>       ( 2, 1,  195, 1.83187063e-02,   244.22399902, 0., 0),</span>
</span><span id=__span-62-39><a id=__codelineno-62-39 name=__codelineno-62-39 href=#__codelineno-62-39></a><span class=go>       ...</span>
</span><span id=__span-62-40><a id=__codelineno-62-40 name=__codelineno-62-40 href=#__codelineno-62-40></a><span class=go>       (27, 1, 2478, 7.74416872e-03, 35040.8359375 , 0., 0),</span>
</span><span id=__span-62-41><a id=__codelineno-62-41 name=__codelineno-62-41 href=#__codelineno-62-41></a><span class=go>       (28, 1, 2570, 2.08567037e-03, 43790.89453125, 0., 1),</span>
</span><span id=__span-62-42><a id=__codelineno-62-42 name=__codelineno-62-42 href=#__codelineno-62-42></a><span class=go>       (29, 1, 2662, 1.72637091e-03, 46306.4453125 , 0., 1),</span>
</span><span id=__span-62-43><a id=__codelineno-62-43 name=__codelineno-62-43 href=#__codelineno-62-43></a><span class=go>       ( 0, 2,  105, 1.60816173e-01,   320.19299316, 0., 0),  &lt;&lt; third column</span>
</span><span id=__span-62-44><a id=__codelineno-62-44 name=__codelineno-62-44 href=#__codelineno-62-44></a><span class=go>       ( 1, 2,  470, 2.34573523e-02,   430.56698608, 0., 1),</span>
</span><span id=__span-62-45><a id=__codelineno-62-45 name=__codelineno-62-45 href=#__codelineno-62-45></a><span class=go>       ( 2, 2,  836, 3.81744650e-02,   963.74298096, 0., 1),</span>
</span><span id=__span-62-46><a id=__codelineno-62-46 name=__codelineno-62-46 href=#__codelineno-62-46></a><span class=go>       ...</span>
</span><span id=__span-62-47><a id=__codelineno-62-47 name=__codelineno-62-47 href=#__codelineno-62-47></a><span class=go>       ( 5, 2, 1931, 2.83026812e-02,  7193.59912109, 0., 1),</span>
</span><span id=__span-62-48><a id=__codelineno-62-48 name=__codelineno-62-48 href=#__codelineno-62-48></a><span class=go>       ( 6, 2, 2297, 3.54188390e-02, 29001.72070312, 0., 1),</span>
</span><span id=__span-62-49><a id=__codelineno-62-49 name=__codelineno-62-49 href=#__codelineno-62-49></a><span class=go>       ( 7, 2, 2662, 1.14541249e-02, 46306.4453125 , 0., 1)],</span>
</span><span id=__span-62-50><a id=__codelineno-62-50 name=__codelineno-62-50 href=#__codelineno-62-50></a><span class=go>      dtype={&#39;names&#39;:[&#39;id&#39;,&#39;col&#39;,&#39;idx&#39;,&#39;size&#39;,&#39;price&#39;,&#39;fees&#39;,&#39;side&#39;], ...})</span>
</span></code></pre></div> <ol> <li>Use <a href=../../api/base/accessors/index.html#vectorbtpro.base.accessors.BaseAccessor.tile>BaseAccessor.tile</a> to populate columns and append a new column level for our parameter combinations</li> <li>Change the corresponding column only</li> </ol> <h3 id=wrapping>Wrapping<a class=headerlink href=#wrapping title="Permanent link">&para;</a></h3> <p>This output is exactly what <a href=../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> requires as input: order records with a couple of other arguments can be used to reconstruct the simulation state, including the regular cash balance and the position size at each time step. The reconstructed state can be used to model the equity curve, then returns, and then the accompanying metrics such as the old but gold Sharpe ratio. So, what how do we construct a portfolio? Instead of using any class method, we'll pass the data directly to the class. For this, only three arguments are required: a wrapper, a close series, and order records. Ideally, we should also supply arguments that were used during the simulation, such as the initial cash:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>phelp</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=p>)</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=go>Portfolio.__init__(</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a><span class=go>    self,</span>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=go>    wrapper,</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=go>    order_records,</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=go>    *,</span>
</span><span id=__span-63-7><a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a><span class=go>    close,</span>
</span><span id=__span-63-8><a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=go>    open=None,</span>
</span><span id=__span-63-9><a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a><span class=go>    high=None,</span>
</span><span id=__span-63-10><a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a><span class=go>    low=None,</span>
</span><span id=__span-63-11><a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=go>    log_records=None,</span>
</span><span id=__span-63-12><a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=go>    cash_sharing=False,</span>
</span><span id=__span-63-13><a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a><span class=go>    init_cash=&#39;auto&#39;,</span>
</span><span id=__span-63-14><a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a><span class=go>    ...</span>
</span><span id=__span-63-15><a id=__codelineno-63-15 name=__codelineno-63-15 href=#__codelineno-63-15></a><span class=go>)</span>
</span></code></pre></div> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>Notice <code>*</code>? It means any argument after <code>order_records</code> must be provided as a keyword argument.</p> </div> <p>Let's do the wrapping part:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=p>(</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>wrapper</span><span class=p>,</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=gp>... </span>    <span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=nb>open</span><span class=p>,</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span>  <span class=c1># (1)!</span>
</span><span id=__span-64-7><a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Make sure to use the same initial cash as during the simulation</li> </ol> <p>We can now use the portfolio the same way as if we simulated it with any preset method:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=go>every</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=go>MS    1.267804</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=go>Q     1.309943</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=go>Y     1.393820</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span></code></pre></div> <h2 id=flexible-indexing>Flexible indexing<a class=headerlink href=#flexible-indexing title="Permanent link">&para;</a></h2> <p>The issue of bringing all arrays to the same shape as we did above is that it unnecessarily consumes memory: even though the only array that has different data in each column is <code>target_pct</code>, we have almost tripled memory consumption by having to expand other arrays like <code>close</code>. Imagine how expensive would it be having to align dozens of such array-like arguments <img alt=😮‍💨 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f62e-200d-1f4a8.svg title=:face_exhaling:></p> <p>Flexible indexing allows us to overcome this alignment step and to access each element of an array solely based on its shape. For example, there is no need to tile <code>close</code> three times if each row stays the same for each column - we can simply return the same row element irrespective of the column being queried. The same goes for a one-dimensional array with elements per column - return the same column element for each row. The only requirement is that the array must have one dimension if it should broadcast against rows <strong>or</strong> columns, and two dimensions if it should broadcast against rows <strong>and</strong> columns. Any scalars should be transformed into one of the above formats, otherwise we'll be greeted with an ugly Numba error. </p> <p>For the actual indexing, we can use the following Numba-compiled functions:</p> <ul> <li>One-dimensional array (generic): <a href=../../api/base/flex_indexing/index.html#vectorbtpro.base.flex_indexing.flex_select_1d_nb>flex_select_1d_nb</a></li> <li>One-dimensional array (per row): <a href=../../api/base/flex_indexing/index.html#vectorbtpro.base.flex_indexing.flex_select_1d_pr_nb>flex_select_1d_pr_nb</a></li> <li>One-dimensional array (per column): <a href=../../api/base/flex_indexing/index.html#vectorbtpro.base.flex_indexing.flex_select_1d_pc_nb>flex_select_1d_pc_nb</a></li> <li>Two-dimensional array: <a href=../../api/base/flex_indexing/index.html#vectorbtpro.base.flex_indexing.flex_select_nb>flex_select_nb</a></li> </ul> <p>Let's demonstrate their use in different scenarios:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>per_row_arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>per_col_arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>])</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>per_elem_arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=gp>... </span>    <span class=p>[</span><span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>],</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=gp>... </span>    <span class=p>[</span><span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>],</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a><span class=gp>... </span>    <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>11</span><span class=p>]</span>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a>
</span><span id=__span-66-9><a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_pr_nb</span><span class=p>(</span><span class=n>per_row_arr</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-66-10><a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a><span class=go>3</span>
</span><span id=__span-66-11><a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a>
</span><span id=__span-66-12><a id=__codelineno-66-12 name=__codelineno-66-12 href=#__codelineno-66-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_pc_nb</span><span class=p>(</span><span class=n>per_col_arr</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-66-13><a id=__codelineno-66-13 name=__codelineno-66-13 href=#__codelineno-66-13></a><span class=go>5</span>
</span><span id=__span-66-14><a id=__codelineno-66-14 name=__codelineno-66-14 href=#__codelineno-66-14></a>
</span><span id=__span-66-15><a id=__codelineno-66-15 name=__codelineno-66-15 href=#__codelineno-66-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>per_elem_arr</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-66-16><a id=__codelineno-66-16 name=__codelineno-66-16 href=#__codelineno-66-16></a><span class=go>11</span>
</span></code></pre></div> <ol> <li>Get the value under the third row</li> <li>Get the value under the second column</li> <li>Get the value under the third row and second column</li> </ol> <p>One-dimensional indexing functions are suited only for arguments that are one-dimensional by design, such as initial capital, which makes only sense to be provided per column, not per element. But what if the user should also be able to pass <code>per_row_arr</code> or <code>per_col_arr</code> as fully-broadcast arrays? In this case, the user needs to expand both arrays to two dimensions according to the <a href=https://numpy.org/doc/stable/user/basics.broadcasting.html>NumPy's broadcasting rules</a> and use exclusively <a href=../../api/base/flex_indexing/index.html#vectorbtpro.base.flex_indexing.flex_select_nb>flex_select_nb</a>. The reason for this is that Numba isn't flexible enough to permit doing operations on both one-dimensional and two-dimensional arrays, so we must decide on the indexing function beforehand.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>per_row_arr_2d</span> <span class=o>=</span> <span class=n>per_row_arr</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>per_row_arr_2d</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=go>array([[1],</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=go>       [2],</span>
</span><span id=__span-67-5><a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a><span class=go>       [3]])</span>
</span><span id=__span-67-6><a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a>
</span><span id=__span-67-7><a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>per_row_arr_2d</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-67-8><a id=__codelineno-67-8 name=__codelineno-67-8 href=#__codelineno-67-8></a><span class=go>3</span>
</span><span id=__span-67-9><a id=__codelineno-67-9 name=__codelineno-67-9 href=#__codelineno-67-9></a>
</span><span id=__span-67-10><a id=__codelineno-67-10 name=__codelineno-67-10 href=#__codelineno-67-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>per_col_arr_2d</span> <span class=o>=</span> <span class=n>per_col_arr</span><span class=p>[</span><span class=kc>None</span><span class=p>]</span>  <span class=c1># (2)!</span>
</span><span id=__span-67-11><a id=__codelineno-67-11 name=__codelineno-67-11 href=#__codelineno-67-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>per_col_arr_2d</span>
</span><span id=__span-67-12><a id=__codelineno-67-12 name=__codelineno-67-12 href=#__codelineno-67-12></a><span class=go>array([[4, 5]])</span>
</span><span id=__span-67-13><a id=__codelineno-67-13 name=__codelineno-67-13 href=#__codelineno-67-13></a>
</span><span id=__span-67-14><a id=__codelineno-67-14 name=__codelineno-67-14 href=#__codelineno-67-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>per_col_arr_2d</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-67-15><a id=__codelineno-67-15 name=__codelineno-67-15 href=#__codelineno-67-15></a><span class=go>5</span>
</span></code></pre></div> <ol> <li>Create the second axis of length one: from <code>(3,)</code> to <code>(3, 1)</code></li> <li>Create the first axis of length one: from <code>(3,)</code> to <code>(1, 3)</code></li> </ol> <p>This yields the same results as if we had aligned the arrays prior to indexing (= memory expensive):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span> <span class=o>=</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_array_to</span><span class=p>(</span><span class=n>per_row_arr</span><span class=p>,</span> <span class=n>target_shape</span><span class=p>[</span><span class=mi>0</span><span class=p>])[</span><span class=mi>2</span><span class=p>]</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=go>3</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_array_to</span><span class=p>(</span><span class=n>per_col_arr</span><span class=p>,</span> <span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a><span class=go>5</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_array_to</span><span class=p>(</span><span class=n>per_row_arr_2d</span><span class=p>,</span> <span class=n>target_shape</span><span class=p>)[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a><span class=go>3</span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_array_to</span><span class=p>(</span><span class=n>per_col_arr_2d</span><span class=p>,</span> <span class=n>target_shape</span><span class=p>)[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a><span class=go>5</span>
</span></code></pre></div> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>If you're not sure whether a flexible array will be indexed correctly, try broadcasting it with NumPy!</p> </div> <h3 id=rotational-indexing>Rotational indexing<a class=headerlink href=#rotational-indexing title="Permanent link">&para;</a></h3> <p>But what happens if the index is out of bounds? Let's say we iterate over 6 columns but an array has data only for 3. In such a case, vectorbt can rotate the index and return the first element in the array for the fourth column, the second element for the fifth column, and so on:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_pr_nb</span><span class=p>(</span><span class=n>per_row_arr</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=n>rotate_rows</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a><span class=go>2</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_pc_nb</span><span class=p>(</span><span class=n>per_col_arr</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a><span class=go>4</span>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>per_elem_arr</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=n>rotate_rows</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=go>8</span>
</span></code></pre></div> <ol> <li>Resolves to index 100 % 3 == 1 and element 2</li> <li>Resolves to index 100 % 2 == 0 and element 4</li> </ol> <p>If you think that this is crazy, and you would rather have an error shown: rotational indexing is very useful when it comes to testing multiple assets and parameter combinations. Without it (default), we would need to tile the asset DataFrame by the number of parameter combinations, but with it, we could have just passed the data without tiling and thus wasting memory. But also, in many places, vectorbt ensures that all arrays can broadcast against each other nicely anyway.</p> <h3 id=pipeline4>Pipeline/4<a class=headerlink href=#pipeline4 title="Permanent link">&para;</a></h3> <p>Let's adapt the previous pipeline for flexible indexing. Since usually we don't know which one of the passed arrays has the full shape, and sometimes there is no array with the full shape at all, we need to introduce another argument - <code>target_shape</code> - to provide the full shape for our loops to iterate over. We'll also experiment with rotational indexing, which isn't supported by any of the preset simulation methods.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>pipeline_4_nb</span><span class=p>(</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span> 
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=gp>... </span>    <span class=nb>open</span><span class=p>,</span> 
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=gp>... </span>    <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=gp>... </span>    <span class=n>target_pct</span><span class=p>,</span> 
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a><span class=gp>... </span>    <span class=n>rotate_cols</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a><span class=gp>... </span>    <span class=n>init_cash_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>init_cash</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a><span class=gp>... </span>    <span class=n>open_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=nb>open</span><span class=p>))</span>  <span class=c1># (2)!</span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=gp>... </span>    <span class=n>close_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>close</span><span class=p>))</span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a><span class=gp>... </span>    <span class=n>target_pct_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>target_pct</span><span class=p>))</span>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a><span class=gp>... </span>    <span class=n>order_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>target_shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>order_dt</span><span class=p>)</span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a><span class=gp>... </span>    <span class=n>order_counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a><span class=gp>...</span>
</span><span id=__span-70-17><a id=__codelineno-70-17 name=__codelineno-70-17 href=#__codelineno-70-17></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span><span id=__span-70-18><a id=__codelineno-70-18 name=__codelineno-70-18 href=#__codelineno-70-18></a><span class=gp>... </span>        <span class=n>init_cash_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_pc_nb</span><span class=p>(</span>
</span><span id=__span-70-19><a id=__codelineno-70-19 name=__codelineno-70-19 href=#__codelineno-70-19></a><span class=gp>... </span>            <span class=n>init_cash_</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-70-20><a id=__codelineno-70-20 name=__codelineno-70-20 href=#__codelineno-70-20></a><span class=gp>...</span>
</span><span id=__span-70-21><a id=__codelineno-70-21 name=__codelineno-70-21 href=#__codelineno-70-21></a><span class=gp>... </span>        <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-70-22><a id=__codelineno-70-22 name=__codelineno-70-22 href=#__codelineno-70-22></a><span class=gp>... </span>            <span class=n>cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash_elem</span><span class=p>),</span>
</span><span id=__span-70-23><a id=__codelineno-70-23 name=__codelineno-70-23 href=#__codelineno-70-23></a><span class=gp>... </span>            <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-70-24><a id=__codelineno-70-24 name=__codelineno-70-24 href=#__codelineno-70-24></a><span class=gp>... </span>            <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-70-25><a id=__codelineno-70-25 name=__codelineno-70-25 href=#__codelineno-70-25></a><span class=gp>... </span>            <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-70-26><a id=__codelineno-70-26 name=__codelineno-70-26 href=#__codelineno-70-26></a><span class=gp>... </span>            <span class=n>free_cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash_elem</span><span class=p>),</span>
</span><span id=__span-70-27><a id=__codelineno-70-27 name=__codelineno-70-27 href=#__codelineno-70-27></a><span class=gp>... </span>            <span class=n>val_price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-70-28><a id=__codelineno-70-28 name=__codelineno-70-28 href=#__codelineno-70-28></a><span class=gp>... </span>            <span class=n>value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-70-29><a id=__codelineno-70-29 name=__codelineno-70-29 href=#__codelineno-70-29></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-70-30><a id=__codelineno-70-30 name=__codelineno-70-30 href=#__codelineno-70-30></a><span class=gp>...</span>
</span><span id=__span-70-31><a id=__codelineno-70-31 name=__codelineno-70-31 href=#__codelineno-70-31></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-70-32><a id=__codelineno-70-32 name=__codelineno-70-32 href=#__codelineno-70-32></a><span class=gp>... </span>            <span class=n>open_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-70-33><a id=__codelineno-70-33 name=__codelineno-70-33 href=#__codelineno-70-33></a><span class=gp>... </span>                <span class=n>open_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-70-34><a id=__codelineno-70-34 name=__codelineno-70-34 href=#__codelineno-70-34></a><span class=gp>... </span>            <span class=n>close_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-70-35><a id=__codelineno-70-35 name=__codelineno-70-35 href=#__codelineno-70-35></a><span class=gp>... </span>                <span class=n>close_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-70-36><a id=__codelineno-70-36 name=__codelineno-70-36 href=#__codelineno-70-36></a><span class=gp>... </span>            <span class=n>target_pct_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-70-37><a id=__codelineno-70-37 name=__codelineno-70-37 href=#__codelineno-70-37></a><span class=gp>... </span>                <span class=n>target_pct_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-70-38><a id=__codelineno-70-38 name=__codelineno-70-38 href=#__codelineno-70-38></a><span class=gp>...</span>
</span><span id=__span-70-39><a id=__codelineno-70-39 name=__codelineno-70-39 href=#__codelineno-70-39></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>target_pct_elem</span><span class=p>):</span>
</span><span id=__span-70-40><a id=__codelineno-70-40 name=__codelineno-70-40 href=#__codelineno-70-40></a><span class=gp>... </span>                <span class=n>value</span> <span class=o>=</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>open_elem</span> <span class=o>*</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>position</span>
</span><span id=__span-70-41><a id=__codelineno-70-41 name=__codelineno-70-41 href=#__codelineno-70-41></a><span class=gp>...</span>
</span><span id=__span-70-42><a id=__codelineno-70-42 name=__codelineno-70-42 href=#__codelineno-70-42></a><span class=gp>... </span>                <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-70-43><a id=__codelineno-70-43 name=__codelineno-70-43 href=#__codelineno-70-43></a><span class=gp>... </span>                    <span class=n>cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span><span class=p>,</span>
</span><span id=__span-70-44><a id=__codelineno-70-44 name=__codelineno-70-44 href=#__codelineno-70-44></a><span class=gp>... </span>                    <span class=n>position</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span><span class=p>,</span>
</span><span id=__span-70-45><a id=__codelineno-70-45 name=__codelineno-70-45 href=#__codelineno-70-45></a><span class=gp>... </span>                    <span class=n>debt</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>debt</span><span class=p>,</span>
</span><span id=__span-70-46><a id=__codelineno-70-46 name=__codelineno-70-46 href=#__codelineno-70-46></a><span class=gp>... </span>                    <span class=n>locked_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>locked_cash</span><span class=p>,</span>
</span><span id=__span-70-47><a id=__codelineno-70-47 name=__codelineno-70-47 href=#__codelineno-70-47></a><span class=gp>... </span>                    <span class=n>free_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>free_cash</span><span class=p>,</span>
</span><span id=__span-70-48><a id=__codelineno-70-48 name=__codelineno-70-48 href=#__codelineno-70-48></a><span class=gp>... </span>                    <span class=n>val_price</span><span class=o>=</span><span class=n>open_elem</span><span class=p>,</span>
</span><span id=__span-70-49><a id=__codelineno-70-49 name=__codelineno-70-49 href=#__codelineno-70-49></a><span class=gp>... </span>                    <span class=n>value</span><span class=o>=</span><span class=n>value</span>
</span><span id=__span-70-50><a id=__codelineno-70-50 name=__codelineno-70-50 href=#__codelineno-70-50></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-70-51><a id=__codelineno-70-51 name=__codelineno-70-51 href=#__codelineno-70-51></a><span class=gp>... </span>                <span class=n>order</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-70-52><a id=__codelineno-70-52 name=__codelineno-70-52 href=#__codelineno-70-52></a><span class=gp>... </span>                    <span class=n>size</span><span class=o>=</span><span class=n>target_pct_elem</span><span class=p>,</span>
</span><span id=__span-70-53><a id=__codelineno-70-53 name=__codelineno-70-53 href=#__codelineno-70-53></a><span class=gp>... </span>                    <span class=n>price</span><span class=o>=</span><span class=n>close_elem</span><span class=p>,</span>
</span><span id=__span-70-54><a id=__codelineno-70-54 name=__codelineno-70-54 href=#__codelineno-70-54></a><span class=gp>... </span>                    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span>
</span><span id=__span-70-55><a id=__codelineno-70-55 name=__codelineno-70-55 href=#__codelineno-70-55></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-70-56><a id=__codelineno-70-56 name=__codelineno-70-56 href=#__codelineno-70-56></a><span class=gp>... </span>                <span class=n>_</span><span class=p>,</span> <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-70-57><a id=__codelineno-70-57 name=__codelineno-70-57 href=#__codelineno-70-57></a><span class=gp>... </span>                    <span class=n>col</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span>
</span><span id=__span-70-58><a id=__codelineno-70-58 name=__codelineno-70-58 href=#__codelineno-70-58></a><span class=gp>... </span>                    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-70-59><a id=__codelineno-70-59 name=__codelineno-70-59 href=#__codelineno-70-59></a><span class=gp>... </span>                    <span class=n>order</span><span class=o>=</span><span class=n>order</span><span class=p>,</span>
</span><span id=__span-70-60><a id=__codelineno-70-60 name=__codelineno-70-60 href=#__codelineno-70-60></a><span class=gp>... </span>                    <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-70-61><a id=__codelineno-70-61 name=__codelineno-70-61 href=#__codelineno-70-61></a><span class=gp>... </span>                    <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span>
</span><span id=__span-70-62><a id=__codelineno-70-62 name=__codelineno-70-62 href=#__codelineno-70-62></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-70-63><a id=__codelineno-70-63 name=__codelineno-70-63 href=#__codelineno-70-63></a><span class=gp>... </span>        
</span><span id=__span-70-64><a id=__codelineno-70-64 name=__codelineno-70-64 href=#__codelineno-70-64></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>repartition_nb</span><span class=p>(</span><span class=n>order_records</span><span class=p>,</span> <span class=n>order_counts</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>This line allows us to pass a one-dimensional flexible array also as a scalar. Note how we write the result to a new variable (with a trailing underscore) and then use it in indexing.</li> <li>Same for two-dimensional flexible arrays</li> <li>Select the current element of the initial cash array. Remember that indexing functions with the suffix <code>1d</code> are expecting one-dimensional arrays.</li> <li>Since all three arrays are not guaranteed to have the full shape anymore, we must switch to flexible indexing instead of doing <code>open[i, col]</code>. Remember that indexing functions without the suffix <code>1d</code> are expecting two-dimensional arrays.</li> </ol> <p>Thanks to flexible indexing, we can now use all arrays without tiling:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_shapes</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=gp>... </span>    <span class=n>target_pct</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=go>(2663, 3)</span>
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a>
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>pipeline_4_nb</span><span class=p>(</span>
</span><span id=__span-71-10><a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-71-11><a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-71-12><a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-71-13><a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a><span class=gp>... </span>    <span class=n>target_pct</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-71-14><a id=__codelineno-71-14 name=__codelineno-71-14 href=#__codelineno-71-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-71-15><a id=__codelineno-71-15 name=__codelineno-71-15 href=#__codelineno-71-15></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>len</span><span class=p>(</span><span class=n>order_records</span><span class=p>)</span>
</span><span id=__span-71-16><a id=__codelineno-71-16 name=__codelineno-71-16 href=#__codelineno-71-16></a><span class=go>125</span>
</span></code></pre></div> <ol> <li>We need to build the target shape to iterate over. This also works as a broadcasting check.</li> </ol> <p>This also allows us to provide target percentages as a constant to re-allocate at each bar! Since constants don't have any implications on the targe shape, we only need to broadcast the price shapes:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_shapes</span><span class=p>(</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=go>(2663,)</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_shape</span><span class=p>(</span><span class=n>target_shape</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a><span class=go>(2663, 1)</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>pipeline_4_nb</span><span class=p>(</span>
</span><span id=__span-72-13><a id=__codelineno-72-13 name=__codelineno-72-13 href=#__codelineno-72-13></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-72-14><a id=__codelineno-72-14 name=__codelineno-72-14 href=#__codelineno-72-14></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-72-15><a id=__codelineno-72-15 name=__codelineno-72-15 href=#__codelineno-72-15></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-72-16><a id=__codelineno-72-16 name=__codelineno-72-16 href=#__codelineno-72-16></a><span class=gp>... </span>    <span class=mf>0.5</span>
</span><span id=__span-72-17><a id=__codelineno-72-17 name=__codelineno-72-17 href=#__codelineno-72-17></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-72-18><a id=__codelineno-72-18 name=__codelineno-72-18 href=#__codelineno-72-18></a><span class=go>len(order_records)</span>
</span><span id=__span-72-19><a id=__codelineno-72-19 name=__codelineno-72-19 href=#__codelineno-72-19></a><span class=go>2663</span>
</span></code></pre></div> <ol> <li>Target shape must always be two-dimensional</li> </ol> <p>This operation has generated the same number of orders as we have elements in the data:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>np</span><span class=o>.</span><span class=n>product</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape_2d</span><span class=p>)</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=go>2663</span>
</span></code></pre></div> <p>To demonstrate rotational indexing, let's pull multiple symbols and perform the simulation without having to tile or change them in any way:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>YFData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=gp>... </span>    <span class=p>[</span><span class=s2>&quot;BTC-USD&quot;</span><span class=p>,</span> <span class=s2>&quot;ETH-USD&quot;</span><span class=p>],</span> 
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=s2>&quot;2022-01-01&quot;</span><span class=p>,</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=gp>... </span>    <span class=n>missing_index</span><span class=o>=</span><span class=s2>&quot;drop&quot;</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p> <div class="progress progress-100plus candystripe"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Symbol 2/2</p> </div> </div> </p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_symbol_wrapper</span> <span class=o>=</span> <span class=n>mult_data</span><span class=o>.</span><span class=n>get_symbol_wrapper</span><span class=p>()</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_target_pct</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a><span class=gp>... </span>    <span class=n>mult_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=n>every</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>every</span><span class=p>))</span>
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a><span class=gp>... </span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>every</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_shapes</span><span class=p>(</span>
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>tile_shape</span><span class=p>(</span><span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>every</span><span class=p>)),</span>  <span class=c1># (2)!</span>
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>tile_shape</span><span class=p>(</span><span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>every</span><span class=p>)),</span> 
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a><span class=gp>... </span>    <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span>
</span><span id=__span-75-11><a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-75-12><a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span>
</span><span id=__span-75-13><a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a><span class=go>(1514, 6)</span>
</span><span id=__span-75-14><a id=__codelineno-75-14 name=__codelineno-75-14 href=#__codelineno-75-14></a>
</span><span id=__span-75-15><a id=__codelineno-75-15 name=__codelineno-75-15 href=#__codelineno-75-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>pipeline_4_nb</span><span class=p>(</span>
</span><span id=__span-75-16><a id=__codelineno-75-16 name=__codelineno-75-16 href=#__codelineno-75-16></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-75-17><a id=__codelineno-75-17 name=__codelineno-75-17 href=#__codelineno-75-17></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-75-18><a id=__codelineno-75-18 name=__codelineno-75-18 href=#__codelineno-75-18></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-75-19><a id=__codelineno-75-19 name=__codelineno-75-19 href=#__codelineno-75-19></a><span class=gp>... </span>    <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-75-20><a id=__codelineno-75-20 name=__codelineno-75-20 href=#__codelineno-75-20></a><span class=gp>... </span>    <span class=n>rotate_cols</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-75-21><a id=__codelineno-75-21 name=__codelineno-75-21 href=#__codelineno-75-21></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-75-22><a id=__codelineno-75-22 name=__codelineno-75-22 href=#__codelineno-75-22></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>len</span><span class=p>(</span><span class=n>order_records</span><span class=p>)</span>
</span><span id=__span-75-23><a id=__codelineno-75-23 name=__codelineno-75-23 href=#__codelineno-75-23></a><span class=go>142</span>
</span></code></pre></div> <ol> <li>That's another way of constructing the target percentage array</li> <li>Since broadcasting doesn't support rotations, we can use <a href=../../api/base/reshaping/index.html#vectorbtpro.base.reshaping.tile_shape>tile_shape</a> to tile the shape of <code>open</code> and <code>close</code> manually (don't tile the actual array!)</li> <li>There is no need to tile any array thanks to rotational indexing</li> </ol> <p>Without rotation, we would have got an <em>"IndexError: index out of bounds"</em> error as the number of columns in the target shape is bigger than that in the price arrays.</p> <h2 id=grouping>Grouping<a class=headerlink href=#grouping title="Permanent link">&para;</a></h2> <p>Using groups, we can put multiple columns to the same backtesting basket <img alt=🧺 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f9fa.svg title=:basket:></p> <p>Generally, a group consists of a number of columns that are part of a single portfolio entity and should be backtested as a single whole. Very often, we use groups to share capital among multiple columns, but we can also use groups to bind columns on some logical level. During a simulation, it's our responsibility to make use of grouping. For example, even though <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.process_order_nb>process_order_nb</a> requires a group index, it uses it just for filling log records and nothing else. But after the simulation, vectorbt has many tools at its disposal to enable us in aggregating and analyzing various information per group, such as portfolio value.</p> <p>Groups can be constructed and provided in two ways: as group lengths and as a group map. The former is easier to handle, marginally faster, and requires the columns to be split into monolithic groups, while the latter allows the columns of a group to be distributed arbitrarily, and is generally a more flexible option. Group lengths is the format primarily used by simulation methods (since asset columns, in contrast to parameter columns, are usually located next to each other), while group maps are predominantly used by generic functions specialized in pre- and post-analysis. Both formats can be easily generated by a <a href=../../api/base/grouping/base/index.html#vectorbtpro.base.grouping.base.Grouper>Grouper</a> instance.</p> <h3 id=group-lengths>Group lengths<a class=headerlink href=#group-lengths title="Permanent link">&para;</a></h3> <p>Let's create a custom column index with 5 assets, and put them into 2 groups. Since group lengths work on monolithic groups only, assets in each group must be next to each other:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>columns</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=s2>&quot;BTC-USD&quot;</span><span class=p>,</span> <span class=s2>&quot;ETH-USD&quot;</span><span class=p>,</span> <span class=s2>&quot;BNB-USD&quot;</span><span class=p>,</span> <span class=s2>&quot;SOL-USD&quot;</span><span class=p>,</span> <span class=s2>&quot;XRP-USD&quot;</span><span class=p>])</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mono_grouper</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Grouper</span><span class=p>(</span><span class=n>columns</span><span class=p>,</span> <span class=n>group_by</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mono_grouper</span><span class=o>.</span><span class=n>get_group_lens</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a><span class=go>array([3, 2])</span>
</span></code></pre></div> <ol> <li>Using <a href=../../api/base/grouping/base/index.html#vectorbtpro.base.grouping.base.Grouper.get_group_lens>Grouper.get_group_lens</a></li> </ol> <p>The first element in the returned array is the number of columns with the label <code>0</code>, and the second element is the number of columns with the label <code>1</code>.</p> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p><a href=../../api/base/grouping/base/index.html#vectorbtpro.base.grouping.base.Grouper>Grouper</a> doesn't care if we pass a list of integers or a sequence of strings - it will convert everything into a Pandas Index and treat it as group labels. They <strong>don't</strong> have to be alphanumerically sorted.</p> </div> <p>If we create discrete groups, the generation will fail:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dist_grouper</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Grouper</span><span class=p>(</span><span class=n>columns</span><span class=p>,</span> <span class=n>group_by</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dist_grouper</span><span class=o>.</span><span class=n>get_group_lens</span><span class=p>()</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=go>ValueError: group_by must form monolithic groups</span>
</span></code></pre></div> <p>Now, how do we define logic per group? Here's a template:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_lens</span> <span class=o>=</span> <span class=n>mono_grouper</span><span class=o>.</span><span class=n>get_group_lens</span><span class=p>()</span>
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a>
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_end_idxs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>group_lens</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-78-4><a id=__codelineno-78-4 name=__codelineno-78-4 href=#__codelineno-78-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_start_idxs</span> <span class=o>=</span> <span class=n>group_end_idxs</span> <span class=o>-</span> <span class=n>group_lens</span>  <span class=c1># (2)!</span>
</span><span id=__span-78-5><a id=__codelineno-78-5 name=__codelineno-78-5 href=#__codelineno-78-5></a>
</span><span id=__span-78-6><a id=__codelineno-78-6 name=__codelineno-78-6 href=#__codelineno-78-6></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>group_lens</span><span class=p>)):</span>  <span class=c1># (3)!</span>
</span><span id=__span-78-7><a id=__codelineno-78-7 name=__codelineno-78-7 href=#__codelineno-78-7></a><span class=gp>... </span>    <span class=n>from_col</span> <span class=o>=</span> <span class=n>group_start_idxs</span><span class=p>[</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-78-8><a id=__codelineno-78-8 name=__codelineno-78-8 href=#__codelineno-78-8></a><span class=gp>... </span>    <span class=n>to_col</span> <span class=o>=</span> <span class=n>group_end_idxs</span><span class=p>[</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-78-9><a id=__codelineno-78-9 name=__codelineno-78-9 href=#__codelineno-78-9></a><span class=gp>... </span>    <span class=c1># (4)!</span>
</span><span id=__span-78-10><a id=__codelineno-78-10 name=__codelineno-78-10 href=#__codelineno-78-10></a><span class=gp>...</span>
</span><span id=__span-78-11><a id=__codelineno-78-11 name=__codelineno-78-11 href=#__codelineno-78-11></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>from_col</span><span class=p>,</span> <span class=n>to_col</span><span class=p>):</span>  <span class=c1># (5)!</span>
</span><span id=__span-78-12><a id=__codelineno-78-12 name=__codelineno-78-12 href=#__codelineno-78-12></a><span class=gp>... </span>        <span class=k>pass</span>  <span class=c1># (6)!</span>
</span></code></pre></div> <ol> <li>Get the end column index of each group (excluding)</li> <li>Get the start column index of each group (including)</li> <li>Iterate over all groups</li> <li>Define here your logic per group</li> <li>Iterate over all columns in the group</li> <li>Define here your logic per column in the group</li> </ol> <h3 id=group-map>Group map<a class=headerlink href=#group-map title="Permanent link">&para;</a></h3> <p>Group map is a tuple of two arrays:</p> <ol> <li>One-dimensional array with column indices sorted by group</li> <li>One-dimensional array with the length of each group in the first array</li> </ol> <p>Thus, a group map makes distributed groups inherently monolithic, such that we can work with any possible group distribution:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mono_grouper</span><span class=o>.</span><span class=n>get_group_map</span><span class=p>()</span>
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a><span class=go>(array([0, 1, 2, 3, 4]), array([3, 2]))</span>
</span><span id=__span-79-3><a id=__codelineno-79-3 name=__codelineno-79-3 href=#__codelineno-79-3></a>
</span><span id=__span-79-4><a id=__codelineno-79-4 name=__codelineno-79-4 href=#__codelineno-79-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dist_grouper</span><span class=o>.</span><span class=n>get_group_map</span><span class=p>()</span>
</span><span id=__span-79-5><a id=__codelineno-79-5 name=__codelineno-79-5 href=#__codelineno-79-5></a><span class=go>(array([0, 2, 1, 3, 4]), array([2, 3]))</span>
</span></code></pre></div> <p>In the second example, the first two (<code>2</code>) column indices in the first array belong to the first group, while the remaining three (<code>3</code>) column indices belong to the second group.</p> <p>Here's a template for working with a group map:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_map</span> <span class=o>=</span> <span class=n>dist_grouper</span><span class=o>.</span><span class=n>get_group_map</span><span class=p>()</span>
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a>
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_idxs</span><span class=p>,</span> <span class=n>group_lens</span> <span class=o>=</span> <span class=n>group_map</span>
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_start_idxs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>group_lens</span><span class=p>)</span> <span class=o>-</span> <span class=n>group_lens</span>  <span class=c1># (1)!</span>
</span><span id=__span-80-5><a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a>
</span><span id=__span-80-6><a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>group_lens</span><span class=p>)):</span>
</span><span id=__span-80-7><a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a><span class=gp>... </span>    <span class=n>group_len</span> <span class=o>=</span> <span class=n>group_lens</span><span class=p>[</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-80-8><a id=__codelineno-80-8 name=__codelineno-80-8 href=#__codelineno-80-8></a><span class=gp>... </span>    <span class=n>start_idx</span> <span class=o>=</span> <span class=n>group_start_idxs</span><span class=p>[</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-80-9><a id=__codelineno-80-9 name=__codelineno-80-9 href=#__codelineno-80-9></a><span class=gp>... </span>    <span class=n>col_idxs</span> <span class=o>=</span> <span class=n>group_idxs</span><span class=p>[</span><span class=n>start_idx</span> <span class=p>:</span> <span class=n>start_idx</span> <span class=o>+</span> <span class=n>group_len</span><span class=p>]</span>  <span class=c1># (2)!</span>
</span><span id=__span-80-10><a id=__codelineno-80-10 name=__codelineno-80-10 href=#__codelineno-80-10></a><span class=gp>... </span>    <span class=c1># (3)!</span>
</span><span id=__span-80-11><a id=__codelineno-80-11 name=__codelineno-80-11 href=#__codelineno-80-11></a><span class=gp>... </span>
</span><span id=__span-80-12><a id=__codelineno-80-12 name=__codelineno-80-12 href=#__codelineno-80-12></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>col_idxs</span><span class=p>)):</span>  <span class=c1># (4)!</span>
</span><span id=__span-80-13><a id=__codelineno-80-13 name=__codelineno-80-13 href=#__codelineno-80-13></a><span class=gp>... </span>        <span class=n>col</span> <span class=o>=</span> <span class=n>col_idxs</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span><span id=__span-80-14><a id=__codelineno-80-14 name=__codelineno-80-14 href=#__codelineno-80-14></a><span class=gp>... </span>        <span class=c1># (5)!</span>
</span></code></pre></div> <ol> <li>Get the start index of each group in the first array</li> <li>Get the column indices of the group in the first array</li> <li>Define here your logic per group</li> <li>Iterate over all column indices in the group</li> <li>Define here your logic per column in the group</li> </ol> <h3 id=call-sequence>Call sequence<a class=headerlink href=#call-sequence title="Permanent link">&para;</a></h3> <p>When sharing capital between two or more assets, we sometimes want to process one column before the others. This makes most sense, for example, in cases where we need to exit positions before opening new ones to release funds for them. If we look at the templates for both grouping formats above, we can precisely identify where the column processing order should be changed: in the for-loop that iterates over columns. But how do we programmatically change this order? Here comes a call sequence into play.</p> <p>Call sequence is an array of column indices in the order of their processing. For example, if the third column should be processed first, the first column second, and the second column third, the call sequence would be <code>[2, 0, 1]</code>. That is, we are always moving from left to right in the call sequence and pick the current column index. Such a design has one immense benefit: we can use another array, such as with potential order values, to (arg-)sort the call sequence.</p> <p>The sorting is done by the function <a href=../../api/utils/array_/index.html#vectorbtpro.utils.array_.insert_argsort_nb>insert_argsort_nb</a>, which takes an array with values to sort by and an array of indices, and sorts the indices in-place using <a href=https://en.wikipedia.org/wiki/Insertion_sort>insertion sort</a> in the order the values appear in the first array. This sorting algorithm is best suited for smaller arrays and does not require any additional memory space - perfect for groups with assets!</p> <p>Let's say we have three assets: one not in position, one in a short position, and one in a long position. We want to close all positions in the order such that assets that should be sold are processed first. Otherwise, we wouldn't have cash from exiting the long position to close out the short position. For this, we will first use <a href=../../api/portfolio/nb/core/index.html#vectorbtpro.portfolio.nb.core.approx_order_value_nb>approx_order_value_nb</a> to approximate the order value of each operation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>position</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.0</span><span class=p>,</span> <span class=o>-</span><span class=mf>10.0</span><span class=p>,</span> <span class=mf>10.0</span><span class=p>])</span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>val_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>10.0</span><span class=p>,</span> <span class=mf>25.0</span><span class=p>,</span> <span class=mf>15.0</span><span class=p>])</span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>debt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>100.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>])</span>
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>locked_cash</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>100.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>])</span>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a>
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>position</span><span class=p>)):</span>
</span><span id=__span-81-8><a id=__codelineno-81-8 name=__codelineno-81-8 href=#__codelineno-81-8></a><span class=gp>... </span>    <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-81-9><a id=__codelineno-81-9 name=__codelineno-81-9 href=#__codelineno-81-9></a><span class=gp>... </span>        <span class=n>cash</span><span class=o>=</span><span class=mf>200.0</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-81-10><a id=__codelineno-81-10 name=__codelineno-81-10 href=#__codelineno-81-10></a><span class=gp>... </span>        <span class=n>position</span><span class=o>=</span><span class=n>position</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>  <span class=c1># (2)!</span>
</span><span id=__span-81-11><a id=__codelineno-81-11 name=__codelineno-81-11 href=#__codelineno-81-11></a><span class=gp>... </span>        <span class=n>debt</span><span class=o>=</span><span class=n>debt</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-81-12><a id=__codelineno-81-12 name=__codelineno-81-12 href=#__codelineno-81-12></a><span class=gp>... </span>        <span class=n>locked_cash</span><span class=o>=</span><span class=n>locked_cash</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-81-13><a id=__codelineno-81-13 name=__codelineno-81-13 href=#__codelineno-81-13></a><span class=gp>... </span>        <span class=n>free_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-81-14><a id=__codelineno-81-14 name=__codelineno-81-14 href=#__codelineno-81-14></a><span class=gp>... </span>        <span class=n>val_price</span><span class=o>=</span><span class=n>val_price</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-81-15><a id=__codelineno-81-15 name=__codelineno-81-15 href=#__codelineno-81-15></a><span class=gp>... </span>        <span class=n>value</span><span class=o>=</span><span class=mf>100.0</span>
</span><span id=__span-81-16><a id=__codelineno-81-16 name=__codelineno-81-16 href=#__codelineno-81-16></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-81-17><a id=__codelineno-81-17 name=__codelineno-81-17 href=#__codelineno-81-17></a><span class=gp>... </span>    <span class=n>order_value</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>approx_order_value_nb</span><span class=p>(</span>
</span><span id=__span-81-18><a id=__codelineno-81-18 name=__codelineno-81-18 href=#__codelineno-81-18></a><span class=gp>... </span>        <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-81-19><a id=__codelineno-81-19 name=__codelineno-81-19 href=#__codelineno-81-19></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mf>0.</span><span class=p>,</span>
</span><span id=__span-81-20><a id=__codelineno-81-20 name=__codelineno-81-20 href=#__codelineno-81-20></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetAmount</span><span class=p>,</span>
</span><span id=__span-81-21><a id=__codelineno-81-21 name=__codelineno-81-21 href=#__codelineno-81-21></a><span class=gp>... </span>        <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>Both</span>
</span><span id=__span-81-22><a id=__codelineno-81-22 name=__codelineno-81-22 href=#__codelineno-81-22></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-81-23><a id=__codelineno-81-23 name=__codelineno-81-23 href=#__codelineno-81-23></a>
</span><span id=__span-81-24><a id=__codelineno-81-24 name=__codelineno-81-24 href=#__codelineno-81-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_value</span>  <span class=c1># (3)!</span>
</span><span id=__span-81-25><a id=__codelineno-81-25 name=__codelineno-81-25 href=#__codelineno-81-25></a><span class=go>array([0., 50., -150.])</span>
</span></code></pre></div> <ol> <li>Cash-related information is defined per group using a constant</li> <li>Position-related information is defined per column using an array</li> <li>Positive number means outbound cash flow, negative number means inbound cash flow</li> </ol> <p>We see that the second column would require approx. $50 in cash and the third column would bring approx. $150 in cash to close out the position. Let's create a call sequence and sort it by the order value:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>vectorbtpro.utils.array_</span> <span class=kn>import</span> <span class=n>insert_argsort_nb</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>call_seq</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>])</span>  <span class=c1># (1)!</span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>insert_argsort_nb</span><span class=p>(</span><span class=n>order_value</span><span class=p>,</span> <span class=n>call_seq</span><span class=p>)</span>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>call_seq</span>
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a><span class=go>array([2, 0, 1])</span>
</span></code></pre></div> <ol> <li>We should always start with a simple range</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Both the order value and the call sequence are sorted in-place!</p> </div> <p>We can then modify the for-loop to iterate over the call sequence instead:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>call_seq</span><span class=p>)):</span>  <span class=c1># (1)!</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a><span class=gp>... </span>    <span class=n>c</span> <span class=o>=</span> <span class=n>call_seq</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span><span id=__span-83-3><a id=__codelineno-83-3 name=__codelineno-83-3 href=#__codelineno-83-3></a><span class=gp>... </span>    <span class=n>col</span> <span class=o>=</span> <span class=n>from_col</span> <span class=o>+</span> <span class=n>c</span>
</span><span id=__span-83-4><a id=__codelineno-83-4 name=__codelineno-83-4 href=#__codelineno-83-4></a>
</span><span id=__span-83-5><a id=__codelineno-83-5 name=__codelineno-83-5 href=#__codelineno-83-5></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>call_seq</span><span class=p>)):</span>  <span class=c1># (2)!</span>
</span><span id=__span-83-6><a id=__codelineno-83-6 name=__codelineno-83-6 href=#__codelineno-83-6></a><span class=gp>... </span>    <span class=n>c</span> <span class=o>=</span> <span class=n>call_seq</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span><span id=__span-83-7><a id=__codelineno-83-7 name=__codelineno-83-7 href=#__codelineno-83-7></a><span class=gp>... </span>    <span class=n>col</span> <span class=o>=</span> <span class=n>col_idxs</span><span class=p>[</span><span class=n>c</span><span class=p>]</span>
</span></code></pre></div> <ol> <li>When working with group lengths</li> <li>When working with a group map</li> </ol> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>A good practice is to keep a consistent naming of variables. Here, we're using <code>k</code> to denote an index in the call sequence, <code>c</code> to denote a column index within a group, and <code>col</code> to denote a global column index.</p> </div> <h3 id=pipeline5>Pipeline/5<a class=headerlink href=#pipeline5 title="Permanent link">&para;</a></h3> <p>Let's upgrade our previous pipeline to rebalance groups of assets. To better illustrate how important is sorting by order value when rebalancing multi-asset portfolios, we'll introduce another argument <code>auto_call_seq</code> to switch between sorting and not sorting. We will use group lengths as the grouping format of choice because of its simplicity. Also note that now we have to keep a lot of position-related information in arrays rather than constants since they exist in relation to columns rather than groups. In addition, as we already know how to fill order records, let's track the allocation at each bar instead.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2 href=#__codelineno-84-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>pipeline_5_nb</span><span class=p>(</span>
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3 href=#__codelineno-84-3></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-84-4><a id=__codelineno-84-4 name=__codelineno-84-4 href=#__codelineno-84-4></a><span class=gp>... </span>    <span class=n>group_lens</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-84-5><a id=__codelineno-84-5 name=__codelineno-84-5 href=#__codelineno-84-5></a><span class=gp>... </span>    <span class=nb>open</span><span class=p>,</span>
</span><span id=__span-84-6><a id=__codelineno-84-6 name=__codelineno-84-6 href=#__codelineno-84-6></a><span class=gp>... </span>    <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-84-7><a id=__codelineno-84-7 name=__codelineno-84-7 href=#__codelineno-84-7></a><span class=gp>... </span>    <span class=n>target_pct</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-84-8><a id=__codelineno-84-8 name=__codelineno-84-8 href=#__codelineno-84-8></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-84-9><a id=__codelineno-84-9 name=__codelineno-84-9 href=#__codelineno-84-9></a><span class=gp>... </span>    <span class=n>auto_call_seq</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-84-10><a id=__codelineno-84-10 name=__codelineno-84-10 href=#__codelineno-84-10></a><span class=gp>... </span>    <span class=n>rotate_cols</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-84-11><a id=__codelineno-84-11 name=__codelineno-84-11 href=#__codelineno-84-11></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-84-12><a id=__codelineno-84-12 name=__codelineno-84-12 href=#__codelineno-84-12></a><span class=gp>... </span>    <span class=n>init_cash_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>init_cash</span><span class=p>))</span>
</span><span id=__span-84-13><a id=__codelineno-84-13 name=__codelineno-84-13 href=#__codelineno-84-13></a><span class=gp>... </span>    <span class=n>open_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=nb>open</span><span class=p>))</span>
</span><span id=__span-84-14><a id=__codelineno-84-14 name=__codelineno-84-14 href=#__codelineno-84-14></a><span class=gp>... </span>    <span class=n>close_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>close</span><span class=p>))</span>
</span><span id=__span-84-15><a id=__codelineno-84-15 name=__codelineno-84-15 href=#__codelineno-84-15></a><span class=gp>... </span>    <span class=n>target_pct_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>target_pct</span><span class=p>))</span>
</span><span id=__span-84-16><a id=__codelineno-84-16 name=__codelineno-84-16 href=#__codelineno-84-16></a><span class=gp>... </span>    <span class=n>alloc</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>target_shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-84-17><a id=__codelineno-84-17 name=__codelineno-84-17 href=#__codelineno-84-17></a><span class=gp>...</span>
</span><span id=__span-84-18><a id=__codelineno-84-18 name=__codelineno-84-18 href=#__codelineno-84-18></a><span class=gp>... </span>    <span class=n>group_end_idxs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>group_lens</span><span class=p>)</span>
</span><span id=__span-84-19><a id=__codelineno-84-19 name=__codelineno-84-19 href=#__codelineno-84-19></a><span class=gp>... </span>    <span class=n>group_start_idxs</span> <span class=o>=</span> <span class=n>group_end_idxs</span> <span class=o>-</span> <span class=n>group_lens</span>
</span><span id=__span-84-20><a id=__codelineno-84-20 name=__codelineno-84-20 href=#__codelineno-84-20></a><span class=gp>...</span>
</span><span id=__span-84-21><a id=__codelineno-84-21 name=__codelineno-84-21 href=#__codelineno-84-21></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>group_lens</span><span class=p>)):</span>  <span class=c1># (5)!</span>
</span><span id=__span-84-22><a id=__codelineno-84-22 name=__codelineno-84-22 href=#__codelineno-84-22></a><span class=gp>... </span>        <span class=n>group_len</span> <span class=o>=</span> <span class=n>group_lens</span><span class=p>[</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-84-23><a id=__codelineno-84-23 name=__codelineno-84-23 href=#__codelineno-84-23></a><span class=gp>... </span>        <span class=n>from_col</span> <span class=o>=</span> <span class=n>group_start_idxs</span><span class=p>[</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-84-24><a id=__codelineno-84-24 name=__codelineno-84-24 href=#__codelineno-84-24></a><span class=gp>... </span>        <span class=n>to_col</span> <span class=o>=</span> <span class=n>group_end_idxs</span><span class=p>[</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-84-25><a id=__codelineno-84-25 name=__codelineno-84-25 href=#__codelineno-84-25></a><span class=gp>...</span>
</span><span id=__span-84-26><a id=__codelineno-84-26 name=__codelineno-84-26 href=#__codelineno-84-26></a><span class=gp>... </span>        <span class=c1># (6)!</span>
</span><span id=__span-84-27><a id=__codelineno-84-27 name=__codelineno-84-27 href=#__codelineno-84-27></a><span class=gp>... </span>        <span class=n>init_cash_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_pc_nb</span><span class=p>(</span>
</span><span id=__span-84-28><a id=__codelineno-84-28 name=__codelineno-84-28 href=#__codelineno-84-28></a><span class=gp>... </span>            <span class=n>init_cash_</span><span class=p>,</span> <span class=n>group</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-29><a id=__codelineno-84-29 name=__codelineno-84-29 href=#__codelineno-84-29></a><span class=gp>... </span>    
</span><span id=__span-84-30><a id=__codelineno-84-30 name=__codelineno-84-30 href=#__codelineno-84-30></a><span class=gp>... </span>        <span class=n>last_position</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>group_len</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-84-31><a id=__codelineno-84-31 name=__codelineno-84-31 href=#__codelineno-84-31></a><span class=gp>... </span>        <span class=n>last_debt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>group_len</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-84-32><a id=__codelineno-84-32 name=__codelineno-84-32 href=#__codelineno-84-32></a><span class=gp>... </span>        <span class=n>last_locked_cash</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>group_len</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-84-33><a id=__codelineno-84-33 name=__codelineno-84-33 href=#__codelineno-84-33></a><span class=gp>... </span>        <span class=n>cash_now</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>init_cash_elem</span><span class=p>)</span>
</span><span id=__span-84-34><a id=__codelineno-84-34 name=__codelineno-84-34 href=#__codelineno-84-34></a><span class=gp>... </span>        <span class=n>free_cash_now</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>init_cash_elem</span><span class=p>)</span>
</span><span id=__span-84-35><a id=__codelineno-84-35 name=__codelineno-84-35 href=#__codelineno-84-35></a><span class=gp>...</span>
</span><span id=__span-84-36><a id=__codelineno-84-36 name=__codelineno-84-36 href=#__codelineno-84-36></a><span class=gp>... </span>        <span class=n>order_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>group_len</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (8)!</span>
</span><span id=__span-84-37><a id=__codelineno-84-37 name=__codelineno-84-37 href=#__codelineno-84-37></a><span class=gp>... </span>        <span class=n>call_seq</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>group_len</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-84-38><a id=__codelineno-84-38 name=__codelineno-84-38 href=#__codelineno-84-38></a><span class=gp>... </span>
</span><span id=__span-84-39><a id=__codelineno-84-39 name=__codelineno-84-39 href=#__codelineno-84-39></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>  <span class=c1># (9)!</span>
</span><span id=__span-84-40><a id=__codelineno-84-40 name=__codelineno-84-40 href=#__codelineno-84-40></a><span class=gp>... </span>            <span class=c1># (10)!</span>
</span><span id=__span-84-41><a id=__codelineno-84-41 name=__codelineno-84-41 href=#__codelineno-84-41></a><span class=gp>... </span>            <span class=n>value_now</span> <span class=o>=</span> <span class=n>cash_now</span>
</span><span id=__span-84-42><a id=__codelineno-84-42 name=__codelineno-84-42 href=#__codelineno-84-42></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>group_len</span><span class=p>):</span>
</span><span id=__span-84-43><a id=__codelineno-84-43 name=__codelineno-84-43 href=#__codelineno-84-43></a><span class=gp>... </span>                <span class=n>col</span> <span class=o>=</span> <span class=n>from_col</span> <span class=o>+</span> <span class=n>c</span>
</span><span id=__span-84-44><a id=__codelineno-84-44 name=__codelineno-84-44 href=#__codelineno-84-44></a><span class=gp>... </span>                <span class=n>open_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-45><a id=__codelineno-84-45 name=__codelineno-84-45 href=#__codelineno-84-45></a><span class=gp>... </span>                    <span class=n>open_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-46><a id=__codelineno-84-46 name=__codelineno-84-46 href=#__codelineno-84-46></a><span class=gp>... </span>                <span class=n>value_now</span> <span class=o>+=</span> <span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>*</span> <span class=n>open_elem</span>  <span class=c1># (11)!</span>
</span><span id=__span-84-47><a id=__codelineno-84-47 name=__codelineno-84-47 href=#__codelineno-84-47></a><span class=gp>... </span>        
</span><span id=__span-84-48><a id=__codelineno-84-48 name=__codelineno-84-48 href=#__codelineno-84-48></a><span class=gp>... </span>            <span class=c1># (12)!</span>
</span><span id=__span-84-49><a id=__codelineno-84-49 name=__codelineno-84-49 href=#__codelineno-84-49></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>group_len</span><span class=p>):</span>
</span><span id=__span-84-50><a id=__codelineno-84-50 name=__codelineno-84-50 href=#__codelineno-84-50></a><span class=gp>... </span>                <span class=n>col</span> <span class=o>=</span> <span class=n>from_col</span> <span class=o>+</span> <span class=n>c</span>
</span><span id=__span-84-51><a id=__codelineno-84-51 name=__codelineno-84-51 href=#__codelineno-84-51></a><span class=gp>... </span>                <span class=n>open_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-52><a id=__codelineno-84-52 name=__codelineno-84-52 href=#__codelineno-84-52></a><span class=gp>... </span>                    <span class=n>open_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-53><a id=__codelineno-84-53 name=__codelineno-84-53 href=#__codelineno-84-53></a><span class=gp>... </span>                <span class=n>target_pct_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-54><a id=__codelineno-84-54 name=__codelineno-84-54 href=#__codelineno-84-54></a><span class=gp>... </span>                    <span class=n>target_pct_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-55><a id=__codelineno-84-55 name=__codelineno-84-55 href=#__codelineno-84-55></a><span class=gp>... </span>                <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-84-56><a id=__codelineno-84-56 name=__codelineno-84-56 href=#__codelineno-84-56></a><span class=gp>... </span>                    <span class=n>cash</span><span class=o>=</span><span class=n>cash_now</span><span class=p>,</span>
</span><span id=__span-84-57><a id=__codelineno-84-57 name=__codelineno-84-57 href=#__codelineno-84-57></a><span class=gp>... </span>                    <span class=n>position</span><span class=o>=</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=p>],</span>
</span><span id=__span-84-58><a id=__codelineno-84-58 name=__codelineno-84-58 href=#__codelineno-84-58></a><span class=gp>... </span>                    <span class=n>locked_cash</span><span class=o>=</span><span class=n>last_locked_cash</span><span class=p>[</span><span class=n>c</span><span class=p>],</span>
</span><span id=__span-84-59><a id=__codelineno-84-59 name=__codelineno-84-59 href=#__codelineno-84-59></a><span class=gp>... </span>                    <span class=n>debt</span><span class=o>=</span><span class=n>last_debt</span><span class=p>[</span><span class=n>c</span><span class=p>],</span>
</span><span id=__span-84-60><a id=__codelineno-84-60 name=__codelineno-84-60 href=#__codelineno-84-60></a><span class=gp>... </span>                    <span class=n>free_cash</span><span class=o>=</span><span class=n>free_cash_now</span><span class=p>,</span>
</span><span id=__span-84-61><a id=__codelineno-84-61 name=__codelineno-84-61 href=#__codelineno-84-61></a><span class=gp>... </span>                    <span class=n>val_price</span><span class=o>=</span><span class=n>open_elem</span><span class=p>,</span>
</span><span id=__span-84-62><a id=__codelineno-84-62 name=__codelineno-84-62 href=#__codelineno-84-62></a><span class=gp>... </span>                    <span class=n>value</span><span class=o>=</span><span class=n>value_now</span><span class=p>,</span>
</span><span id=__span-84-63><a id=__codelineno-84-63 name=__codelineno-84-63 href=#__codelineno-84-63></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-84-64><a id=__codelineno-84-64 name=__codelineno-84-64 href=#__codelineno-84-64></a><span class=gp>... </span>                <span class=n>order_value</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>approx_order_value_nb</span><span class=p>(</span>  <span class=c1># (13)!</span>
</span><span id=__span-84-65><a id=__codelineno-84-65 name=__codelineno-84-65 href=#__codelineno-84-65></a><span class=gp>... </span>                    <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-84-66><a id=__codelineno-84-66 name=__codelineno-84-66 href=#__codelineno-84-66></a><span class=gp>... </span>                    <span class=n>size</span><span class=o>=</span><span class=n>target_pct_elem</span><span class=p>,</span>
</span><span id=__span-84-67><a id=__codelineno-84-67 name=__codelineno-84-67 href=#__codelineno-84-67></a><span class=gp>... </span>                    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span><span class=p>,</span>
</span><span id=__span-84-68><a id=__codelineno-84-68 name=__codelineno-84-68 href=#__codelineno-84-68></a><span class=gp>... </span>                    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>Both</span>
</span><span id=__span-84-69><a id=__codelineno-84-69 name=__codelineno-84-69 href=#__codelineno-84-69></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-84-70><a id=__codelineno-84-70 name=__codelineno-84-70 href=#__codelineno-84-70></a><span class=gp>... </span>                <span class=n>call_seq</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span>  <span class=c1># (14)!</span>
</span><span id=__span-84-71><a id=__codelineno-84-71 name=__codelineno-84-71 href=#__codelineno-84-71></a><span class=gp>... </span>
</span><span id=__span-84-72><a id=__codelineno-84-72 name=__codelineno-84-72 href=#__codelineno-84-72></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>auto_call_seq</span><span class=p>:</span>
</span><span id=__span-84-73><a id=__codelineno-84-73 name=__codelineno-84-73 href=#__codelineno-84-73></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>insert_argsort_nb</span><span class=p>(</span><span class=n>order_value</span><span class=p>,</span> <span class=n>call_seq</span><span class=p>)</span>  <span class=c1># (15)!</span>
</span><span id=__span-84-74><a id=__codelineno-84-74 name=__codelineno-84-74 href=#__codelineno-84-74></a><span class=gp>... </span>
</span><span id=__span-84-75><a id=__codelineno-84-75 name=__codelineno-84-75 href=#__codelineno-84-75></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>call_seq</span><span class=p>)):</span>  <span class=c1># (16)!</span>
</span><span id=__span-84-76><a id=__codelineno-84-76 name=__codelineno-84-76 href=#__codelineno-84-76></a><span class=gp>... </span>                <span class=n>c</span> <span class=o>=</span> <span class=n>call_seq</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>  <span class=c1># (17)!</span>
</span><span id=__span-84-77><a id=__codelineno-84-77 name=__codelineno-84-77 href=#__codelineno-84-77></a><span class=gp>... </span>                <span class=n>col</span> <span class=o>=</span> <span class=n>from_col</span> <span class=o>+</span> <span class=n>c</span>  <span class=c1># (18)!</span>
</span><span id=__span-84-78><a id=__codelineno-84-78 name=__codelineno-84-78 href=#__codelineno-84-78></a><span class=gp>...</span>
</span><span id=__span-84-79><a id=__codelineno-84-79 name=__codelineno-84-79 href=#__codelineno-84-79></a><span class=gp>... </span>                <span class=n>open_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-80><a id=__codelineno-84-80 name=__codelineno-84-80 href=#__codelineno-84-80></a><span class=gp>... </span>                    <span class=n>open_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-81><a id=__codelineno-84-81 name=__codelineno-84-81 href=#__codelineno-84-81></a><span class=gp>... </span>                <span class=n>close_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-82><a id=__codelineno-84-82 name=__codelineno-84-82 href=#__codelineno-84-82></a><span class=gp>... </span>                    <span class=n>close_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-83><a id=__codelineno-84-83 name=__codelineno-84-83 href=#__codelineno-84-83></a><span class=gp>... </span>                <span class=n>target_pct_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-84><a id=__codelineno-84-84 name=__codelineno-84-84 href=#__codelineno-84-84></a><span class=gp>... </span>                    <span class=n>target_pct_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-85><a id=__codelineno-84-85 name=__codelineno-84-85 href=#__codelineno-84-85></a><span class=gp>...</span>
</span><span id=__span-84-86><a id=__codelineno-84-86 name=__codelineno-84-86 href=#__codelineno-84-86></a><span class=gp>... </span>                <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>target_pct_elem</span><span class=p>):</span>  <span class=c1># (19)!</span>
</span><span id=__span-84-87><a id=__codelineno-84-87 name=__codelineno-84-87 href=#__codelineno-84-87></a><span class=gp>... </span>                    <span class=n>order</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-84-88><a id=__codelineno-84-88 name=__codelineno-84-88 href=#__codelineno-84-88></a><span class=gp>... </span>                        <span class=n>size</span><span class=o>=</span><span class=n>target_pct_elem</span><span class=p>,</span>
</span><span id=__span-84-89><a id=__codelineno-84-89 name=__codelineno-84-89 href=#__codelineno-84-89></a><span class=gp>... </span>                        <span class=n>price</span><span class=o>=</span><span class=n>close_elem</span><span class=p>,</span>
</span><span id=__span-84-90><a id=__codelineno-84-90 name=__codelineno-84-90 href=#__codelineno-84-90></a><span class=gp>... </span>                        <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span><span class=p>,</span>
</span><span id=__span-84-91><a id=__codelineno-84-91 name=__codelineno-84-91 href=#__codelineno-84-91></a><span class=gp>... </span>                        <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>Both</span>
</span><span id=__span-84-92><a id=__codelineno-84-92 name=__codelineno-84-92 href=#__codelineno-84-92></a><span class=gp>... </span>                    <span class=p>)</span>
</span><span id=__span-84-93><a id=__codelineno-84-93 name=__codelineno-84-93 href=#__codelineno-84-93></a><span class=gp>... </span>                    <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-84-94><a id=__codelineno-84-94 name=__codelineno-84-94 href=#__codelineno-84-94></a><span class=gp>... </span>                        <span class=n>cash</span><span class=o>=</span><span class=n>cash_now</span><span class=p>,</span>
</span><span id=__span-84-95><a id=__codelineno-84-95 name=__codelineno-84-95 href=#__codelineno-84-95></a><span class=gp>... </span>                        <span class=n>position</span><span class=o>=</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=p>],</span>
</span><span id=__span-84-96><a id=__codelineno-84-96 name=__codelineno-84-96 href=#__codelineno-84-96></a><span class=gp>... </span>                        <span class=n>debt</span><span class=o>=</span><span class=n>last_debt</span><span class=p>[</span><span class=n>c</span><span class=p>],</span>
</span><span id=__span-84-97><a id=__codelineno-84-97 name=__codelineno-84-97 href=#__codelineno-84-97></a><span class=gp>... </span>                        <span class=n>locked_cash</span><span class=o>=</span><span class=n>last_locked_cash</span><span class=p>[</span><span class=n>c</span><span class=p>],</span>
</span><span id=__span-84-98><a id=__codelineno-84-98 name=__codelineno-84-98 href=#__codelineno-84-98></a><span class=gp>... </span>                        <span class=n>free_cash</span><span class=o>=</span><span class=n>free_cash_now</span><span class=p>,</span>
</span><span id=__span-84-99><a id=__codelineno-84-99 name=__codelineno-84-99 href=#__codelineno-84-99></a><span class=gp>... </span>                        <span class=n>val_price</span><span class=o>=</span><span class=n>open_elem</span><span class=p>,</span>
</span><span id=__span-84-100><a id=__codelineno-84-100 name=__codelineno-84-100 href=#__codelineno-84-100></a><span class=gp>... </span>                        <span class=n>value</span><span class=o>=</span><span class=n>value_now</span><span class=p>,</span>
</span><span id=__span-84-101><a id=__codelineno-84-101 name=__codelineno-84-101 href=#__codelineno-84-101></a><span class=gp>... </span>                    <span class=p>)</span>
</span><span id=__span-84-102><a id=__codelineno-84-102 name=__codelineno-84-102 href=#__codelineno-84-102></a><span class=gp>... </span>                    <span class=n>_</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-84-103><a id=__codelineno-84-103 name=__codelineno-84-103 href=#__codelineno-84-103></a><span class=gp>... </span>                        <span class=n>group</span><span class=o>=</span><span class=n>group</span><span class=p>,</span>
</span><span id=__span-84-104><a id=__codelineno-84-104 name=__codelineno-84-104 href=#__codelineno-84-104></a><span class=gp>... </span>                        <span class=n>col</span><span class=o>=</span><span class=n>col</span><span class=p>,</span>
</span><span id=__span-84-105><a id=__codelineno-84-105 name=__codelineno-84-105 href=#__codelineno-84-105></a><span class=gp>... </span>                        <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-84-106><a id=__codelineno-84-106 name=__codelineno-84-106 href=#__codelineno-84-106></a><span class=gp>... </span>                        <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-84-107><a id=__codelineno-84-107 name=__codelineno-84-107 href=#__codelineno-84-107></a><span class=gp>... </span>                        <span class=n>order</span><span class=o>=</span><span class=n>order</span>
</span><span id=__span-84-108><a id=__codelineno-84-108 name=__codelineno-84-108 href=#__codelineno-84-108></a><span class=gp>... </span>                    <span class=p>)</span>
</span><span id=__span-84-109><a id=__codelineno-84-109 name=__codelineno-84-109 href=#__codelineno-84-109></a><span class=gp>... </span>                    <span class=n>cash_now</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>cash</span>
</span><span id=__span-84-110><a id=__codelineno-84-110 name=__codelineno-84-110 href=#__codelineno-84-110></a><span class=gp>... </span>                    <span class=n>free_cash_now</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>free_cash</span>
</span><span id=__span-84-111><a id=__codelineno-84-111 name=__codelineno-84-111 href=#__codelineno-84-111></a><span class=gp>... </span>                    <span class=n>value_now</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-84-112><a id=__codelineno-84-112 name=__codelineno-84-112 href=#__codelineno-84-112></a><span class=gp>... </span>                    <span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>position</span>
</span><span id=__span-84-113><a id=__codelineno-84-113 name=__codelineno-84-113 href=#__codelineno-84-113></a><span class=gp>... </span>                    <span class=n>last_debt</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>debt</span>
</span><span id=__span-84-114><a id=__codelineno-84-114 name=__codelineno-84-114 href=#__codelineno-84-114></a><span class=gp>... </span>                    <span class=n>last_locked_cash</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>locked_cash</span>
</span><span id=__span-84-115><a id=__codelineno-84-115 name=__codelineno-84-115 href=#__codelineno-84-115></a><span class=gp>...</span>
</span><span id=__span-84-116><a id=__codelineno-84-116 name=__codelineno-84-116 href=#__codelineno-84-116></a><span class=gp>... </span>            <span class=c1># (20)!</span>
</span><span id=__span-84-117><a id=__codelineno-84-117 name=__codelineno-84-117 href=#__codelineno-84-117></a><span class=gp>... </span>            <span class=n>value_now</span> <span class=o>=</span> <span class=n>cash_now</span>
</span><span id=__span-84-118><a id=__codelineno-84-118 name=__codelineno-84-118 href=#__codelineno-84-118></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>group_len</span><span class=p>):</span>
</span><span id=__span-84-119><a id=__codelineno-84-119 name=__codelineno-84-119 href=#__codelineno-84-119></a><span class=gp>... </span>                <span class=n>col</span> <span class=o>=</span> <span class=n>from_col</span> <span class=o>+</span> <span class=n>c</span>
</span><span id=__span-84-120><a id=__codelineno-84-120 name=__codelineno-84-120 href=#__codelineno-84-120></a><span class=gp>... </span>                <span class=n>close_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-121><a id=__codelineno-84-121 name=__codelineno-84-121 href=#__codelineno-84-121></a><span class=gp>... </span>                    <span class=n>close_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-122><a id=__codelineno-84-122 name=__codelineno-84-122 href=#__codelineno-84-122></a><span class=gp>... </span>                <span class=n>value_now</span> <span class=o>+=</span> <span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>*</span> <span class=n>close_elem</span>
</span><span id=__span-84-123><a id=__codelineno-84-123 name=__codelineno-84-123 href=#__codelineno-84-123></a><span class=gp>...</span>
</span><span id=__span-84-124><a id=__codelineno-84-124 name=__codelineno-84-124 href=#__codelineno-84-124></a><span class=gp>... </span>            <span class=c1># (21)!</span>
</span><span id=__span-84-125><a id=__codelineno-84-125 name=__codelineno-84-125 href=#__codelineno-84-125></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>group_len</span><span class=p>):</span>
</span><span id=__span-84-126><a id=__codelineno-84-126 name=__codelineno-84-126 href=#__codelineno-84-126></a><span class=gp>... </span>                <span class=n>col</span> <span class=o>=</span> <span class=n>from_col</span> <span class=o>+</span> <span class=n>c</span>
</span><span id=__span-84-127><a id=__codelineno-84-127 name=__codelineno-84-127 href=#__codelineno-84-127></a><span class=gp>... </span>                <span class=n>close_elem</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span>
</span><span id=__span-84-128><a id=__codelineno-84-128 name=__codelineno-84-128 href=#__codelineno-84-128></a><span class=gp>... </span>                    <span class=n>close_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>rotate_cols</span><span class=o>=</span><span class=n>rotate_cols</span><span class=p>)</span>
</span><span id=__span-84-129><a id=__codelineno-84-129 name=__codelineno-84-129 href=#__codelineno-84-129></a><span class=gp>... </span>                <span class=n>alloc</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>*</span> <span class=n>close_elem</span> <span class=o>/</span> <span class=n>value_now</span>
</span><span id=__span-84-130><a id=__codelineno-84-130 name=__codelineno-84-130 href=#__codelineno-84-130></a><span class=gp>... </span>
</span><span id=__span-84-131><a id=__codelineno-84-131 name=__codelineno-84-131 href=#__codelineno-84-131></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>alloc</span>
</span></code></pre></div> <ol> <li>Second number in the target shape tracks assets (x parameter combinations) - it doesn't track groups!</li> <li>The group lengths array must have the same number of elements as we have groups, while the sum of this array must yield the number of columns in <code>target_shape</code></li> <li>Target allocations must be provided per asset, thus the array should broadcast against <code>target_shape</code></li> <li>Allocations must be filled per asset, thus the same shape as <code>target_shape</code></li> <li>Iterate over groups</li> <li>Here comes the creation of various arrays that should exist only per group, such as the cash balance, position size per asset, and other state information. Remember that different groups represent independent, isolated tests, and shouldn't be connected by any means!</li> <li>We can't create a single instance of <a href=../../api/portfolio/enums/index.html#vectorbtpro.portfolio.enums.ExecState>ExecState</a> like we did before because an order execution state contains information per asset, thus we need to keep track of its fields using separate variables (constants for data per group, arrays for data per asset)</li> <li>We could have also created those two arrays at each bar, but frequent array creation slows down the simulation. A better practice is to create an array only once and re-fill it as many times as we want.</li> <li>Iterate over time steps (bars) as we did in previous pipelines</li> <li>Calculate the value of each group (= portfolio value) by iterating over the assets of the group and adding their position value to the current cash balance</li> <li>Last position array exists only for this group, thus we're using <code>c</code>, not <code>col</code>!</li> <li>Prepare the order value and call sequence arrays</li> <li>Approximate the value of a potential order. We're at the beginning of the bar, thus we use the open price.</li> <li>Write the current column index within this group. This will connect order values to column indices.</li> <li>Sort both arrays in-place such that column indices associated with a lower order value appear first in the call sequence</li> <li>Next we want to execute orders, hence iterate over the newly sorted call sequence</li> <li>Get the associated column index within the group</li> <li>Get the associated global column index</li> <li>Perform the same logic as in the previous pipeline</li> <li>Calculate the group value once again, but now using the updated position and the close price. Note that we are running this outside of the <code>np.nan</code> check since we want to track the allocation at each single bar.</li> <li>Calculate the current allocation of each asset, and write it to the output array</li> </ol> <p>Wow, this went complex really fast! <img alt=😵 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f635.svg title=:dizzy_face:></p> <p>But it's not that complex as it may appear. We took a bunch of columns and split them into groups. Then, for each group, we defined a mini-pipeline that applies our logic on the columns within this group only, acting as a single portfolio unit. At the beginning of each bar, we calculate the portfolio value, and build a call sequence that re-arranges columns by their order value. We then iterate over this sequence and execute an order in each column. Finally, at the end of each bar, we again re-calculate the portfolio value and write the real allocation of each asset to the output array. The best in this pipeline is that it closely mimics how preset simulation methods work in vectorbt, and it's one of the most flexible pieces of code you can actually write!</p> <p>Let's allocate 70% to BTC and 30% to ETH, and rebalance on a monthly basis:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_target_pct</span> <span class=o>=</span> <span class=n>mult_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span>
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_target_pct</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>([[</span><span class=mf>0.7</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>]],</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;MS&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouper</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Grouper</span><span class=p>(</span><span class=n>mult_symbol_wrapper</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_lens</span> <span class=o>=</span> <span class=n>grouper</span><span class=o>.</span><span class=n>get_group_lens</span><span class=p>()</span>
</span><span id=__span-85-5><a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a>
</span><span id=__span-85-6><a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_shapes</span><span class=p>(</span>
</span><span id=__span-85-7><a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-85-8><a id=__codelineno-85-8 name=__codelineno-85-8 href=#__codelineno-85-8></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-85-9><a id=__codelineno-85-9 name=__codelineno-85-9 href=#__codelineno-85-9></a><span class=gp>... </span>    <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span>
</span><span id=__span-85-10><a id=__codelineno-85-10 name=__codelineno-85-10 href=#__codelineno-85-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-85-11><a id=__codelineno-85-11 name=__codelineno-85-11 href=#__codelineno-85-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span>
</span><span id=__span-85-12><a id=__codelineno-85-12 name=__codelineno-85-12 href=#__codelineno-85-12></a><span class=go>(1514, 2)</span>
</span><span id=__span-85-13><a id=__codelineno-85-13 name=__codelineno-85-13 href=#__codelineno-85-13></a>
</span><span id=__span-85-14><a id=__codelineno-85-14 name=__codelineno-85-14 href=#__codelineno-85-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span> <span class=o>=</span> <span class=n>pipeline_5_nb</span><span class=p>(</span>
</span><span id=__span-85-15><a id=__codelineno-85-15 name=__codelineno-85-15 href=#__codelineno-85-15></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-85-16><a id=__codelineno-85-16 name=__codelineno-85-16 href=#__codelineno-85-16></a><span class=gp>... </span>    <span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-85-17><a id=__codelineno-85-17 name=__codelineno-85-17 href=#__codelineno-85-17></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-85-18><a id=__codelineno-85-18 name=__codelineno-85-18 href=#__codelineno-85-18></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-85-19><a id=__codelineno-85-19 name=__codelineno-85-19 href=#__codelineno-85-19></a><span class=gp>... </span>    <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-85-20><a id=__codelineno-85-20 name=__codelineno-85-20 href=#__codelineno-85-20></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-85-21><a id=__codelineno-85-21 name=__codelineno-85-21 href=#__codelineno-85-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span> <span class=o>=</span> <span class=n>mult_symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>alloc</span><span class=p>)</span>
</span><span id=__span-85-22><a id=__codelineno-85-22 name=__codelineno-85-22 href=#__codelineno-85-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-85-23><a id=__codelineno-85-23 name=__codelineno-85-23 href=#__codelineno-85-23></a><span class=gp>... </span>   <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>stackgroup</span><span class=o>=</span><span class=s2>&quot;one&quot;</span><span class=p>),</span>
</span><span id=__span-85-24><a id=__codelineno-85-24 name=__codelineno-85-24 href=#__codelineno-85-24></a><span class=gp>... </span>   <span class=n>use_gl</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-85-25><a id=__codelineno-85-25 name=__codelineno-85-25 href=#__codelineno-85-25></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_5_auto_call_seq.light.svg#only-light> <img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_5_auto_call_seq.dark.svg#only-dark></p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>As you might have noticed, some allocations do not quite sum to 100%. This is because we used the open price for group valuation and decision-making, while the actual orders were executed using the close price. By the way, it's a bad sign when everything aligns perfectly - this could mean that your simulation is too ideal for the real world.</p> </div> <p>And here's the same procedure but without sorting the call sequence array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span> <span class=o>=</span> <span class=n>pipeline_5_nb</span><span class=p>(</span>
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a><span class=gp>... </span>    <span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-86-5><a id=__codelineno-86-5 name=__codelineno-86-5 href=#__codelineno-86-5></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-86-6><a id=__codelineno-86-6 name=__codelineno-86-6 href=#__codelineno-86-6></a><span class=gp>... </span>    <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-86-7><a id=__codelineno-86-7 name=__codelineno-86-7 href=#__codelineno-86-7></a><span class=gp>... </span>    <span class=n>auto_call_seq</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-86-8><a id=__codelineno-86-8 name=__codelineno-86-8 href=#__codelineno-86-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-86-9><a id=__codelineno-86-9 name=__codelineno-86-9 href=#__codelineno-86-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span> <span class=o>=</span> <span class=n>mult_symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>alloc</span><span class=p>)</span>
</span><span id=__span-86-10><a id=__codelineno-86-10 name=__codelineno-86-10 href=#__codelineno-86-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-86-11><a id=__codelineno-86-11 name=__codelineno-86-11 href=#__codelineno-86-11></a><span class=gp>... </span>   <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>stackgroup</span><span class=o>=</span><span class=s2>&quot;one&quot;</span><span class=p>),</span>
</span><span id=__span-86-12><a id=__codelineno-86-12 name=__codelineno-86-12 href=#__codelineno-86-12></a><span class=gp>... </span>   <span class=n>use_gl</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-86-13><a id=__codelineno-86-13 name=__codelineno-86-13 href=#__codelineno-86-13></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_5_wo_auto_call_seq.light.svg#only-light> <img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/pipeline_5_wo_auto_call_seq.dark.svg#only-dark></p> <p>As we see, some rebalancing steps couldn't be completed at all because long operations were executed before short operations, leaving them without the required funds.</p> <p>The biggest advantage of this pipeline is in its flexibility: we can turn off grouping via <code>group_by=False</code> to run the entire logic per column (each group will contain only one column). We can also test multiple weight combinations via multiple groups, without having to tile the pricing data thanks to rotational indexing. This, for example, cannot be done even with <a href=../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a> <img alt=😉 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f609.svg title=:wink:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>groups</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;group&quot;</span><span class=p>)</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_alloc</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=mf>0.7</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;target_alloc&quot;</span><span class=p>)</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>final_columns</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>stack_indexes</span><span class=p>((</span>  <span class=c1># (1)!</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a><span class=gp>... </span>    <span class=n>groups</span><span class=p>,</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6 href=#__codelineno-87-6></a><span class=gp>... </span>    <span class=n>target_alloc</span><span class=p>,</span> 
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7 href=#__codelineno-87-7></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>tile_index</span><span class=p>(</span><span class=n>mult_symbol_wrapper</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8 href=#__codelineno-87-8></a><span class=gp>... </span><span class=p>))</span>
</span><span id=__span-87-9><a id=__codelineno-87-9 name=__codelineno-87-9 href=#__codelineno-87-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>final_wrapper</span> <span class=o>=</span> <span class=n>mult_symbol_wrapper</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-87-10><a id=__codelineno-87-10 name=__codelineno-87-10 href=#__codelineno-87-10></a><span class=gp>... </span>    <span class=n>columns</span><span class=o>=</span><span class=n>final_columns</span><span class=p>,</span>
</span><span id=__span-87-11><a id=__codelineno-87-11 name=__codelineno-87-11 href=#__codelineno-87-11></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=s2>&quot;group&quot;</span>
</span><span id=__span-87-12><a id=__codelineno-87-12 name=__codelineno-87-12 href=#__codelineno-87-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-87-13><a id=__codelineno-87-13 name=__codelineno-87-13 href=#__codelineno-87-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_target_pct</span> <span class=o>=</span> <span class=n>final_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-87-14><a id=__codelineno-87-14 name=__codelineno-87-14 href=#__codelineno-87-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_target_pct</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>target_alloc</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=kc>None</span><span class=p>],</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;MS&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-87-15><a id=__codelineno-87-15 name=__codelineno-87-15 href=#__codelineno-87-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>group_lens</span> <span class=o>=</span> <span class=n>final_wrapper</span><span class=o>.</span><span class=n>grouper</span><span class=o>.</span><span class=n>get_group_lens</span><span class=p>()</span>
</span><span id=__span-87-16><a id=__codelineno-87-16 name=__codelineno-87-16 href=#__codelineno-87-16></a>
</span><span id=__span-87-17><a id=__codelineno-87-17 name=__codelineno-87-17 href=#__codelineno-87-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_groups</span> <span class=o>=</span> <span class=n>final_wrapper</span><span class=o>.</span><span class=n>grouper</span><span class=o>.</span><span class=n>get_group_count</span><span class=p>()</span>
</span><span id=__span-87-18><a id=__codelineno-87-18 name=__codelineno-87-18 href=#__codelineno-87-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_shapes</span><span class=p>(</span>
</span><span id=__span-87-19><a id=__codelineno-87-19 name=__codelineno-87-19 href=#__codelineno-87-19></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>tile_shape</span><span class=p>(</span><span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>n_groups</span><span class=p>),</span>  <span class=c1># (4)!</span>
</span><span id=__span-87-20><a id=__codelineno-87-20 name=__codelineno-87-20 href=#__codelineno-87-20></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>tile_shape</span><span class=p>(</span><span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>n_groups</span><span class=p>),</span> 
</span><span id=__span-87-21><a id=__codelineno-87-21 name=__codelineno-87-21 href=#__codelineno-87-21></a><span class=gp>... </span>    <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>shape</span>
</span><span id=__span-87-22><a id=__codelineno-87-22 name=__codelineno-87-22 href=#__codelineno-87-22></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-87-23><a id=__codelineno-87-23 name=__codelineno-87-23 href=#__codelineno-87-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>target_shape</span>
</span><span id=__span-87-24><a id=__codelineno-87-24 name=__codelineno-87-24 href=#__codelineno-87-24></a><span class=go>(1514, 4)</span>
</span><span id=__span-87-25><a id=__codelineno-87-25 name=__codelineno-87-25 href=#__codelineno-87-25></a>
</span><span id=__span-87-26><a id=__codelineno-87-26 name=__codelineno-87-26 href=#__codelineno-87-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span> <span class=o>=</span> <span class=n>pipeline_5_nb</span><span class=p>(</span>
</span><span id=__span-87-27><a id=__codelineno-87-27 name=__codelineno-87-27 href=#__codelineno-87-27></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-87-28><a id=__codelineno-87-28 name=__codelineno-87-28 href=#__codelineno-87-28></a><span class=gp>... </span>    <span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-87-29><a id=__codelineno-87-29 name=__codelineno-87-29 href=#__codelineno-87-29></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-87-30><a id=__codelineno-87-30 name=__codelineno-87-30 href=#__codelineno-87-30></a><span class=gp>... </span>    <span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-87-31><a id=__codelineno-87-31 name=__codelineno-87-31 href=#__codelineno-87-31></a><span class=gp>... </span>    <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-87-32><a id=__codelineno-87-32 name=__codelineno-87-32 href=#__codelineno-87-32></a><span class=gp>... </span>    <span class=n>rotate_cols</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-87-33><a id=__codelineno-87-33 name=__codelineno-87-33 href=#__codelineno-87-33></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-87-34><a id=__codelineno-87-34 name=__codelineno-87-34 href=#__codelineno-87-34></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span> <span class=o>=</span> <span class=n>mult_target_pct</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>alloc</span><span class=p>)</span>
</span><span id=__span-87-35><a id=__codelineno-87-35 name=__codelineno-87-35 href=#__codelineno-87-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc</span>
</span><span id=__span-87-36><a id=__codelineno-87-36 name=__codelineno-87-36 href=#__codelineno-87-36></a><span class=go>group                                       0                   1          </span>
</span><span id=__span-87-37><a id=__codelineno-87-37 name=__codelineno-87-37 href=#__codelineno-87-37></a><span class=go>target_alloc                    0.7       0.3       0.5       0.5</span>
</span><span id=__span-87-38><a id=__codelineno-87-38 name=__codelineno-87-38 href=#__codelineno-87-38></a><span class=go>symbol                      BTC-USD   ETH-USD   BTC-USD   ETH-USD</span>
</span><span id=__span-87-39><a id=__codelineno-87-39 name=__codelineno-87-39 href=#__codelineno-87-39></a><span class=go>Date                                                             </span>
</span><span id=__span-87-40><a id=__codelineno-87-40 name=__codelineno-87-40 href=#__codelineno-87-40></a><span class=go>2017-11-09 00:00:00+00:00  0.000000  0.000000  0.000000  0.000000</span>
</span><span id=__span-87-41><a id=__codelineno-87-41 name=__codelineno-87-41 href=#__codelineno-87-41></a><span class=go>2017-11-10 00:00:00+00:00  0.000000  0.000000  0.000000  0.000000</span>
</span><span id=__span-87-42><a id=__codelineno-87-42 name=__codelineno-87-42 href=#__codelineno-87-42></a><span class=go>2017-11-11 00:00:00+00:00  0.000000  0.000000  0.000000  0.000000</span>
</span><span id=__span-87-43><a id=__codelineno-87-43 name=__codelineno-87-43 href=#__codelineno-87-43></a><span class=go>2017-11-12 00:00:00+00:00  0.000000  0.000000  0.000000  0.000000</span>
</span><span id=__span-87-44><a id=__codelineno-87-44 name=__codelineno-87-44 href=#__codelineno-87-44></a><span class=go>2017-11-13 00:00:00+00:00  0.000000  0.000000  0.000000  0.000000</span>
</span><span id=__span-87-45><a id=__codelineno-87-45 name=__codelineno-87-45 href=#__codelineno-87-45></a><span class=go>...                             ...       ...       ...       ...</span>
</span><span id=__span-87-46><a id=__codelineno-87-46 name=__codelineno-87-46 href=#__codelineno-87-46></a><span class=go>2021-12-27 00:00:00+00:00  0.703817  0.296183  0.504464  0.495536</span>
</span><span id=__span-87-47><a id=__codelineno-87-47 name=__codelineno-87-47 href=#__codelineno-87-47></a><span class=go>2021-12-28 00:00:00+00:00  0.703452  0.296548  0.504026  0.495974</span>
</span><span id=__span-87-48><a id=__codelineno-87-48 name=__codelineno-87-48 href=#__codelineno-87-48></a><span class=go>2021-12-29 00:00:00+00:00  0.708035  0.291965  0.509543  0.490457</span>
</span><span id=__span-87-49><a id=__codelineno-87-49 name=__codelineno-87-49 href=#__codelineno-87-49></a><span class=go>2021-12-30 00:00:00+00:00  0.706467  0.293533  0.507650  0.492350</span>
</span><span id=__span-87-50><a id=__codelineno-87-50 name=__codelineno-87-50 href=#__codelineno-87-50></a><span class=go>2021-12-31 00:00:00+00:00  0.704346  0.295654  0.505099  0.494901</span>
</span><span id=__span-87-51><a id=__codelineno-87-51 name=__codelineno-87-51 href=#__codelineno-87-51></a>
</span><span id=__span-87-52><a id=__codelineno-87-52 name=__codelineno-87-52 href=#__codelineno-87-52></a><span class=go>[1514 rows x 4 columns]</span>
</span></code></pre></div> <ol> <li>Build a new column hierarchy with three levels: groups, weights, and assets. Each level must have the same length.</li> <li>Create a new (grouped) wrapper with the new column hierarchy</li> <li>Create the target percentage array of the same shape as the new wrapper and fill with NaN</li> <li>We're using rotational indexing - tile the shapes of <code>open</code> and <code>close</code> by the number of groups for the shapes to broadcast nicely and build the target shape</li> </ol> <h2 id=contexts>Contexts<a class=headerlink href=#contexts title="Permanent link">&para;</a></h2> <p>Sometimes, there is a need to create a simulation method that takes a user-defined function and calls it to make some trading decision. Such a UDF would require access to the simulation's state (such as the current position size and direction) and other information, which could quickly involve dozens of variables. Remember that we cannot do full-scale OOP in Numba, thus we have to pass data using primitive containers such as tuples. But usage of variable positional arguments or a regular tuple would be quite cumbersome for the user because accessing each field can only be done using an integer index or tuple unpacking. To ease this burden, we usually pass such information in form of a named tuple, often referred to as a (simulation) "context".</p> <h3 id=pipeline6>Pipeline/6<a class=headerlink href=#pipeline6 title="Permanent link">&para;</a></h3> <p>Let's create a very basic pipeline that iterates over rows and columns, and, at each element, calls a UDF to get an order and execute it!</p> <p>First, we need to answer the following question: "What information would a UDF need?" Mostly, we just include everything we have:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SimContext</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;SimContext&quot;</span><span class=p>,</span> <span class=p>[</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a><span class=gp>... </span>    <span class=s2>&quot;open&quot;</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a><span class=gp>... </span>    <span class=s2>&quot;high&quot;</span><span class=p>,</span>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a><span class=gp>... </span>    <span class=s2>&quot;low&quot;</span><span class=p>,</span>
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a><span class=gp>... </span>    <span class=s2>&quot;close&quot;</span><span class=p>,</span>
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a><span class=gp>... </span>    <span class=s2>&quot;init_cash&quot;</span><span class=p>,</span>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a><span class=gp>... </span>    <span class=s2>&quot;col&quot;</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a><span class=gp>... </span>    <span class=s2>&quot;i&quot;</span><span class=p>,</span>
</span><span id=__span-88-9><a id=__codelineno-88-9 name=__codelineno-88-9 href=#__codelineno-88-9></a><span class=gp>... </span>    <span class=s2>&quot;price_area&quot;</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-88-10><a id=__codelineno-88-10 name=__codelineno-88-10 href=#__codelineno-88-10></a><span class=gp>... </span>    <span class=s2>&quot;exec_state&quot;</span>
</span><span id=__span-88-11><a id=__codelineno-88-11 name=__codelineno-88-11 href=#__codelineno-88-11></a><span class=gp>... </span><span class=p>])</span>
</span></code></pre></div> <ol> <li>Arguments passed to the simulator</li> <li>Loop variables</li> <li>State information, either unpacked (marginally faster) or in form of named tuples (more convenient)</li> </ol> <p>And here's our pipeline that takes and calls an order function:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>pipeline_6_nb</span><span class=p>(</span>
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a><span class=gp>... </span>    <span class=nb>open</span><span class=p>,</span> <span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a><span class=gp>... </span>    <span class=n>order_func_nb</span><span class=p>,</span> <span class=n>order_args</span><span class=o>=</span><span class=p>(),</span> 
</span><span id=__span-89-5><a id=__codelineno-89-5 name=__codelineno-89-5 href=#__codelineno-89-5></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span>
</span><span id=__span-89-6><a id=__codelineno-89-6 name=__codelineno-89-6 href=#__codelineno-89-6></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-89-7><a id=__codelineno-89-7 name=__codelineno-89-7 href=#__codelineno-89-7></a><span class=gp>... </span>    <span class=n>order_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>order_dt</span><span class=p>)</span>
</span><span id=__span-89-8><a id=__codelineno-89-8 name=__codelineno-89-8 href=#__codelineno-89-8></a><span class=gp>... </span>    <span class=n>order_counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-89-9><a id=__codelineno-89-9 name=__codelineno-89-9 href=#__codelineno-89-9></a><span class=gp>...</span>
</span><span id=__span-89-10><a id=__codelineno-89-10 name=__codelineno-89-10 href=#__codelineno-89-10></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span><span id=__span-89-11><a id=__codelineno-89-11 name=__codelineno-89-11 href=#__codelineno-89-11></a><span class=gp>... </span>        <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-89-12><a id=__codelineno-89-12 name=__codelineno-89-12 href=#__codelineno-89-12></a><span class=gp>... </span>            <span class=n>cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>),</span>
</span><span id=__span-89-13><a id=__codelineno-89-13 name=__codelineno-89-13 href=#__codelineno-89-13></a><span class=gp>... </span>            <span class=n>position</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-89-14><a id=__codelineno-89-14 name=__codelineno-89-14 href=#__codelineno-89-14></a><span class=gp>... </span>            <span class=n>debt</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-89-15><a id=__codelineno-89-15 name=__codelineno-89-15 href=#__codelineno-89-15></a><span class=gp>... </span>            <span class=n>locked_cash</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span><span id=__span-89-16><a id=__codelineno-89-16 name=__codelineno-89-16 href=#__codelineno-89-16></a><span class=gp>... </span>            <span class=n>free_cash</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>),</span>
</span><span id=__span-89-17><a id=__codelineno-89-17 name=__codelineno-89-17 href=#__codelineno-89-17></a><span class=gp>... </span>            <span class=n>val_price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-89-18><a id=__codelineno-89-18 name=__codelineno-89-18 href=#__codelineno-89-18></a><span class=gp>... </span>            <span class=n>value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-89-19><a id=__codelineno-89-19 name=__codelineno-89-19 href=#__codelineno-89-19></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-89-20><a id=__codelineno-89-20 name=__codelineno-89-20 href=#__codelineno-89-20></a><span class=gp>...</span>
</span><span id=__span-89-21><a id=__codelineno-89-21 name=__codelineno-89-21 href=#__codelineno-89-21></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-89-22><a id=__codelineno-89-22 name=__codelineno-89-22 href=#__codelineno-89-22></a><span class=gp>... </span>            <span class=n>val_price</span> <span class=o>=</span> <span class=nb>open</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-89-23><a id=__codelineno-89-23 name=__codelineno-89-23 href=#__codelineno-89-23></a><span class=gp>... </span>            <span class=n>value</span> <span class=o>=</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span> <span class=o>+</span> <span class=n>val_price</span> <span class=o>*</span> <span class=n>exec_state</span><span class=o>.</span><span class=n>position</span>
</span><span id=__span-89-24><a id=__codelineno-89-24 name=__codelineno-89-24 href=#__codelineno-89-24></a><span class=gp>...</span>
</span><span id=__span-89-25><a id=__codelineno-89-25 name=__codelineno-89-25 href=#__codelineno-89-25></a><span class=gp>... </span>            <span class=n>price_area</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PriceArea</span><span class=p>(</span>
</span><span id=__span-89-26><a id=__codelineno-89-26 name=__codelineno-89-26 href=#__codelineno-89-26></a><span class=gp>... </span>                <span class=nb>open</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-89-27><a id=__codelineno-89-27 name=__codelineno-89-27 href=#__codelineno-89-27></a><span class=gp>... </span>                <span class=n>high</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-89-28><a id=__codelineno-89-28 name=__codelineno-89-28 href=#__codelineno-89-28></a><span class=gp>... </span>                <span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-89-29><a id=__codelineno-89-29 name=__codelineno-89-29 href=#__codelineno-89-29></a><span class=gp>... </span>                <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-89-30><a id=__codelineno-89-30 name=__codelineno-89-30 href=#__codelineno-89-30></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-89-31><a id=__codelineno-89-31 name=__codelineno-89-31 href=#__codelineno-89-31></a><span class=gp>... </span>            <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-89-32><a id=__codelineno-89-32 name=__codelineno-89-32 href=#__codelineno-89-32></a><span class=gp>... </span>                <span class=n>cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>cash</span><span class=p>,</span>
</span><span id=__span-89-33><a id=__codelineno-89-33 name=__codelineno-89-33 href=#__codelineno-89-33></a><span class=gp>... </span>                <span class=n>position</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span><span class=p>,</span>
</span><span id=__span-89-34><a id=__codelineno-89-34 name=__codelineno-89-34 href=#__codelineno-89-34></a><span class=gp>... </span>                <span class=n>debt</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>debt</span><span class=p>,</span>
</span><span id=__span-89-35><a id=__codelineno-89-35 name=__codelineno-89-35 href=#__codelineno-89-35></a><span class=gp>... </span>                <span class=n>locked_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>locked_cash</span><span class=p>,</span>
</span><span id=__span-89-36><a id=__codelineno-89-36 name=__codelineno-89-36 href=#__codelineno-89-36></a><span class=gp>... </span>                <span class=n>free_cash</span><span class=o>=</span><span class=n>exec_state</span><span class=o>.</span><span class=n>free_cash</span><span class=p>,</span>
</span><span id=__span-89-37><a id=__codelineno-89-37 name=__codelineno-89-37 href=#__codelineno-89-37></a><span class=gp>... </span>                <span class=n>val_price</span><span class=o>=</span><span class=n>val_price</span><span class=p>,</span>
</span><span id=__span-89-38><a id=__codelineno-89-38 name=__codelineno-89-38 href=#__codelineno-89-38></a><span class=gp>... </span>                <span class=n>value</span><span class=o>=</span><span class=n>value</span>
</span><span id=__span-89-39><a id=__codelineno-89-39 name=__codelineno-89-39 href=#__codelineno-89-39></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-89-40><a id=__codelineno-89-40 name=__codelineno-89-40 href=#__codelineno-89-40></a><span class=gp>... </span>            <span class=n>sim_ctx</span> <span class=o>=</span> <span class=n>SimContext</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-89-41><a id=__codelineno-89-41 name=__codelineno-89-41 href=#__codelineno-89-41></a><span class=gp>... </span>                <span class=nb>open</span><span class=o>=</span><span class=nb>open</span><span class=p>,</span>
</span><span id=__span-89-42><a id=__codelineno-89-42 name=__codelineno-89-42 href=#__codelineno-89-42></a><span class=gp>... </span>                <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-89-43><a id=__codelineno-89-43 name=__codelineno-89-43 href=#__codelineno-89-43></a><span class=gp>... </span>                <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-89-44><a id=__codelineno-89-44 name=__codelineno-89-44 href=#__codelineno-89-44></a><span class=gp>... </span>                <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-89-45><a id=__codelineno-89-45 name=__codelineno-89-45 href=#__codelineno-89-45></a><span class=gp>... </span>                <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span><span class=p>,</span>
</span><span id=__span-89-46><a id=__codelineno-89-46 name=__codelineno-89-46 href=#__codelineno-89-46></a><span class=gp>... </span>                <span class=n>col</span><span class=o>=</span><span class=n>col</span><span class=p>,</span>
</span><span id=__span-89-47><a id=__codelineno-89-47 name=__codelineno-89-47 href=#__codelineno-89-47></a><span class=gp>... </span>                <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-89-48><a id=__codelineno-89-48 name=__codelineno-89-48 href=#__codelineno-89-48></a><span class=gp>... </span>                <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span><span class=p>,</span>
</span><span id=__span-89-49><a id=__codelineno-89-49 name=__codelineno-89-49 href=#__codelineno-89-49></a><span class=gp>... </span>                <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span>
</span><span id=__span-89-50><a id=__codelineno-89-50 name=__codelineno-89-50 href=#__codelineno-89-50></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-89-51><a id=__codelineno-89-51 name=__codelineno-89-51 href=#__codelineno-89-51></a><span class=gp>... </span>            <span class=n>order</span> <span class=o>=</span> <span class=n>order_func_nb</span><span class=p>(</span><span class=n>sim_ctx</span><span class=p>,</span> <span class=o>*</span><span class=n>order_args</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-89-52><a id=__codelineno-89-52 name=__codelineno-89-52 href=#__codelineno-89-52></a><span class=gp>... </span>            <span class=n>_</span><span class=p>,</span> <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-89-53><a id=__codelineno-89-53 name=__codelineno-89-53 href=#__codelineno-89-53></a><span class=gp>... </span>                <span class=n>col</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span>
</span><span id=__span-89-54><a id=__codelineno-89-54 name=__codelineno-89-54 href=#__codelineno-89-54></a><span class=gp>... </span>                <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-89-55><a id=__codelineno-89-55 name=__codelineno-89-55 href=#__codelineno-89-55></a><span class=gp>... </span>                <span class=n>order</span><span class=o>=</span><span class=n>order</span><span class=p>,</span>
</span><span id=__span-89-56><a id=__codelineno-89-56 name=__codelineno-89-56 href=#__codelineno-89-56></a><span class=gp>... </span>                <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span><span class=p>,</span>
</span><span id=__span-89-57><a id=__codelineno-89-57 name=__codelineno-89-57 href=#__codelineno-89-57></a><span class=gp>... </span>                <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-89-58><a id=__codelineno-89-58 name=__codelineno-89-58 href=#__codelineno-89-58></a><span class=gp>... </span>                <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span>
</span><span id=__span-89-59><a id=__codelineno-89-59 name=__codelineno-89-59 href=#__codelineno-89-59></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-89-60><a id=__codelineno-89-60 name=__codelineno-89-60 href=#__codelineno-89-60></a><span class=gp>... </span>        
</span><span id=__span-89-61><a id=__codelineno-89-61 name=__codelineno-89-61 href=#__codelineno-89-61></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>repartition_nb</span><span class=p>(</span><span class=n>order_records</span><span class=p>,</span> <span class=n>order_counts</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Initialize the simulation context (= creates a named tuple)</li> <li>Call the UDF by first passing the context and then any user-defined arguments</li> </ol> <p>Let's write our own order function that generates orders based on signals:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>  <span class=c1># (1)!</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>signal_order_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>):</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>entries</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>()</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>exits</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-90-6><a id=__codelineno-90-6 name=__codelineno-90-6 href=#__codelineno-90-6></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>close_position_nb</span><span class=p>()</span>
</span><span id=__span-90-7><a id=__codelineno-90-7 name=__codelineno-90-7 href=#__codelineno-90-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nothing_nb</span><span class=p>()</span>
</span><span id=__span-90-8><a id=__codelineno-90-8 name=__codelineno-90-8 href=#__codelineno-90-8></a>
</span><span id=__span-90-9><a id=__codelineno-90-9 name=__codelineno-90-9 href=#__codelineno-90-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>broadcasted_args</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>broadcast</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-90-10><a id=__codelineno-90-10 name=__codelineno-90-10 href=#__codelineno-90-10></a><span class=gp>... </span>    <span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-90-11><a id=__codelineno-90-11 name=__codelineno-90-11 href=#__codelineno-90-11></a><span class=gp>... </span>        <span class=nb>open</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-90-12><a id=__codelineno-90-12 name=__codelineno-90-12 href=#__codelineno-90-12></a><span class=gp>... </span>        <span class=n>high</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-90-13><a id=__codelineno-90-13 name=__codelineno-90-13 href=#__codelineno-90-13></a><span class=gp>... </span>        <span class=n>low</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-90-14><a id=__codelineno-90-14 name=__codelineno-90-14 href=#__codelineno-90-14></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-90-15><a id=__codelineno-90-15 name=__codelineno-90-15 href=#__codelineno-90-15></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-90-16><a id=__codelineno-90-16 name=__codelineno-90-16 href=#__codelineno-90-16></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-90-17><a id=__codelineno-90-17 name=__codelineno-90-17 href=#__codelineno-90-17></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-90-18><a id=__codelineno-90-18 name=__codelineno-90-18 href=#__codelineno-90-18></a><span class=gp>... </span>    <span class=n>min_ndim</span><span class=o>=</span><span class=mi>2</span>
</span><span id=__span-90-19><a id=__codelineno-90-19 name=__codelineno-90-19 href=#__codelineno-90-19></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-90-20><a id=__codelineno-90-20 name=__codelineno-90-20 href=#__codelineno-90-20></a>
</span><span id=__span-90-21><a id=__codelineno-90-21 name=__codelineno-90-21 href=#__codelineno-90-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline_6_nb</span><span class=p>(</span>
</span><span id=__span-90-22><a id=__codelineno-90-22 name=__codelineno-90-22 href=#__codelineno-90-22></a><span class=gp>... </span>    <span class=n>broadcasted_args</span><span class=p>[</span><span class=s2>&quot;open&quot;</span><span class=p>],</span>
</span><span id=__span-90-23><a id=__codelineno-90-23 name=__codelineno-90-23 href=#__codelineno-90-23></a><span class=gp>... </span>    <span class=n>broadcasted_args</span><span class=p>[</span><span class=s2>&quot;high&quot;</span><span class=p>],</span> 
</span><span id=__span-90-24><a id=__codelineno-90-24 name=__codelineno-90-24 href=#__codelineno-90-24></a><span class=gp>... </span>    <span class=n>broadcasted_args</span><span class=p>[</span><span class=s2>&quot;low&quot;</span><span class=p>],</span> 
</span><span id=__span-90-25><a id=__codelineno-90-25 name=__codelineno-90-25 href=#__codelineno-90-25></a><span class=gp>... </span>    <span class=n>broadcasted_args</span><span class=p>[</span><span class=s2>&quot;close&quot;</span><span class=p>],</span> 
</span><span id=__span-90-26><a id=__codelineno-90-26 name=__codelineno-90-26 href=#__codelineno-90-26></a><span class=gp>... </span>    <span class=n>signal_order_func_nb</span><span class=p>,</span>
</span><span id=__span-90-27><a id=__codelineno-90-27 name=__codelineno-90-27 href=#__codelineno-90-27></a><span class=gp>... </span>    <span class=n>order_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-90-28><a id=__codelineno-90-28 name=__codelineno-90-28 href=#__codelineno-90-28></a><span class=gp>... </span>        <span class=n>broadcasted_args</span><span class=p>[</span><span class=s2>&quot;entries&quot;</span><span class=p>],</span>
</span><span id=__span-90-29><a id=__codelineno-90-29 name=__codelineno-90-29 href=#__codelineno-90-29></a><span class=gp>... </span>        <span class=n>broadcasted_args</span><span class=p>[</span><span class=s2>&quot;exits&quot;</span><span class=p>]</span>
</span><span id=__span-90-30><a id=__codelineno-90-30 name=__codelineno-90-30 href=#__codelineno-90-30></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-90-31><a id=__codelineno-90-31 name=__codelineno-90-31 href=#__codelineno-90-31></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-90-32><a id=__codelineno-90-32 name=__codelineno-90-32 href=#__codelineno-90-32></a><span class=go>array([( 0, 0,  300, 0.34786966,   287.46398926, 0., 0),</span>
</span><span id=__span-90-33><a id=__codelineno-90-33 name=__codelineno-90-33 href=#__codelineno-90-33></a><span class=go>       ( 1, 0,  362, 0.34786966,   230.64399719, 0., 1),</span>
</span><span id=__span-90-34><a id=__codelineno-90-34 name=__codelineno-90-34 href=#__codelineno-90-34></a><span class=go>       ( 2, 0,  406, 0.26339233,   304.61801147, 0., 0),</span>
</span><span id=__span-90-35><a id=__codelineno-90-35 name=__codelineno-90-35 href=#__codelineno-90-35></a><span class=go>       ( 3, 0, 1290, 0.26339233,  6890.52001953, 0., 1),</span>
</span><span id=__span-90-36><a id=__codelineno-90-36 name=__codelineno-90-36 href=#__codelineno-90-36></a><span class=go>       ( 4, 0, 1680, 0.33210511,  5464.86669922, 0., 0),</span>
</span><span id=__span-90-37><a id=__codelineno-90-37 name=__codelineno-90-37 href=#__codelineno-90-37></a><span class=go>       ( 5, 0, 1865, 0.33210511,  9244.97265625, 0., 1),</span>
</span><span id=__span-90-38><a id=__codelineno-90-38 name=__codelineno-90-38 href=#__codelineno-90-38></a><span class=go>       ( 6, 0, 1981, 0.31871477,  9633.38671875, 0., 0),</span>
</span><span id=__span-90-39><a id=__codelineno-90-39 name=__codelineno-90-39 href=#__codelineno-90-39></a><span class=go>       ( 7, 0, 2016, 0.31871477,  6681.06298828, 0., 1),</span>
</span><span id=__span-90-40><a id=__codelineno-90-40 name=__codelineno-90-40 href=#__codelineno-90-40></a><span class=go>       ( 8, 0, 2073, 0.2344648 ,  9081.76171875, 0., 0),</span>
</span><span id=__span-90-41><a id=__codelineno-90-41 name=__codelineno-90-41 href=#__codelineno-90-41></a><span class=go>       ( 9, 0, 2467, 0.2344648 , 35615.87109375, 0., 1),</span>
</span><span id=__span-90-42><a id=__codelineno-90-42 name=__codelineno-90-42 href=#__codelineno-90-42></a><span class=go>       (10, 0, 2555, 0.17333543, 48176.34765625, 0., 0)],</span>
</span><span id=__span-90-43><a id=__codelineno-90-43 name=__codelineno-90-43 href=#__codelineno-90-43></a><span class=go>      dtype={&#39;names&#39;:[&#39;id&#39;,&#39;col&#39;,&#39;idx&#39;,&#39;size&#39;,&#39;price&#39;,&#39;fees&#39;,&#39;side&#39;], ...})</span>
</span></code></pre></div> <ol> <li>Don't forget to decorate your order function with <code>@njit</code> as well!</li> <li>We can access any information similarly to accessing attributes of any Python object</li> <li>Neither prices nor signals utilize flexible indexing, thus we need to broadcast them to the full shape</li> <li>These two arrays were generated for the <a href=#pipeline1>first pipeline</a></li> </ol> <p>We just created our own shallow <a href=../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_order_func>Portfolio.from_order_func</a> functionality, neat! <img alt=💥 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f4a5.svg title=:boom:></p> <p>Your homework is to extend this pipeline with flexible indexing <img alt=😉 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f609.svg title=:wink:></p> <h2 id=performance>Performance<a class=headerlink href=#performance title="Permanent link">&para;</a></h2> <p>In terms of performance, Numba code is often a roller coaster <img alt=🎢 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f3a2.svg title=:roller_coaster:></p> <p>Numba is a just-in-time (JIT) compiler that analyzes and optimizes code, and finally uses the <a href=https://github.com/numba/llvmlite>LLVM compiler library</a> to generate a machine code version of a Python function to be compiled. But sometimes, even if the function looks efficient on paper, Numba may generate a suboptimal machine code because of some variables or their types not interacting optimally. In such a case, the code may still run very fast compared to a similar implementation with Python or even to another JIT compiler, but there is a lot of space for improvement that may be hard to discover, even for experienced users. There are even cases where switching the lines in which variables are defined suddenly and unexpectedly has a negative/positive effect on performance.</p> <p>Apart from <a href=https://numba.pydata.org/numba-doc/latest/user/performance-tips.html>official tips</a>, there are some of the best practices you should always keep in mind when designing and optimizing Numba-compiled functions:</p> <ol> <li>Numba is perfectly happy with loops, and often even more happy than with vectorized operations. That's why 90% of vectorbt's functionality is enabled by loops.</li> <li>Numba hates repeated creation of new arrays and allocating (even small) chunks of memory in loops. A much better idea is to create a bunch of bigger arrays prior to the iteration, and use them as a buffer for storing temporary information. Be aware that operations with NumPy that yield a new array, such as <code>np.cumsum</code>, create a new array!</li> <li>Reading and writing one array element at a time is more efficient than in chunks</li> <li>Basic math operations such as <code>-</code>, <code>+</code>, <code>*</code>, and <code>/</code> should be preferred to NumPy operations</li> <li>When using a function as an argument to another function, arguments to this function should be accepted in a packed format (<code>args</code>) instead of an unpacked format (<code>*args</code>). This rule is often violated by vectorbt itself, but such cases are usually benchmarked to ensure that performance stays the same.</li> <li>Packing named tuples inside other named tuples (as we did above) is not encouraged, but sometimes there is no negative effect at all</li> <li>NumPy arrays are almost always a better deal than lists and dictionaries!</li> <li>Even if <code>fastmath=True</code> option has a positive impact on performance, be aware that it's associated with various <a href=https://llvm.org/docs/LangRef.html#fast-math-flags>compromises</a> when doing numeric operations</li> <li>Do not iterate over elements of an array, iterate over a range with the same length instead and use the loop variable to select the respective element</li> <li>When overwriting a variable, make sure that it has the same type</li> </ol> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>As a rule of thumb: the simpler is the code, the easier it becomes for Numba to analyze and optimize it.</p> </div> <h3 id=benchmarking>Benchmarking<a class=headerlink href=#benchmarking title="Permanent link">&para;</a></h3> <p>To benchmark a simulator, we can use the <a href=https://docs.python.org/3/library/timeit.html>timeit</a> module. If possible, create some sample data of a sufficient size, and prepare for the worst-case scenario where orders are issued and executed at each single time step to benchmark the full load. Also, make sure to run tests all the way during the simulator's development to track the evolution of its execution time and stability.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Generation of sample data and preparation of other inputs must be done prior to benchmarking.</p> </div> <p>Let's generate 1-minute random OHLC data for one year using <a href=../../api/data/custom/random_ohlc/index.html#vectorbtpro.data.custom.random_ohlc.RandomOHLCData>RandomOHLCData</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>RandomOHLCData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span> 
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=s2>&quot;2021-01-01&quot;</span><span class=p>,</span>
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a><span class=gp>... </span>    <span class=n>timeframe</span><span class=o>=</span><span class=s2>&quot;1min&quot;</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a><span class=gp>... </span>    <span class=n>std</span><span class=o>=</span><span class=mf>0.0001</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6 href=#__codelineno-91-6></a><span class=gp>... </span>    <span class=n>symmetric</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (3)!</span>
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7 href=#__codelineno-91-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8 href=#__codelineno-91-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_data</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=s2>&quot;1d&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>  <span class=c1># (4)!</span>
</span></code></pre></div> <ol> <li>Set tick frequency to 1 minute</li> <li>Set tick volatility to 0.01%</li> <li>Use symmetric returns (50% negative return == 100% positive return)</li> <li>Plot to ensure that the generated data is realistic. Here we're resampling to daily frequency for faster plotting.</li> </ol> <p><img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/simulation_random_ohlc_data.light.svg#only-light> <img alt class=iimg loading=lazy src=../../assets/images/documentation/pf/simulation_random_ohlc_data.dark.svg#only-dark></p> <p>Then, we need to prepare all the data, which includes filling signals such that there is at least one order at each bar (our worst-case scenario for performance and memory):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_open</span> <span class=o>=</span> <span class=n>test_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>]</span>  <span class=c1># (2)!</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2 href=#__codelineno-92-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_high</span> <span class=o>=</span> <span class=n>test_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>]</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3 href=#__codelineno-92-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_low</span> <span class=o>=</span> <span class=n>test_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>]</span>
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4 href=#__codelineno-92-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_close</span> <span class=o>=</span> <span class=n>test_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>]</span>
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5 href=#__codelineno-92-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_entries</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>test_data</span><span class=o>.</span><span class=n>get_symbol_wrapper</span><span class=p>()</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=kc>False</span><span class=p>)[:,</span> <span class=kc>None</span><span class=p>]</span>
</span><span id=__span-92-6><a id=__codelineno-92-6 name=__codelineno-92-6 href=#__codelineno-92-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_exits</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>test_data</span><span class=o>.</span><span class=n>get_symbol_wrapper</span><span class=p>()</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=kc>False</span><span class=p>)[:,</span> <span class=kc>None</span><span class=p>]</span>
</span><span id=__span-92-7><a id=__codelineno-92-7 name=__codelineno-92-7 href=#__codelineno-92-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_entries</span><span class=p>[</span><span class=mi>0</span><span class=p>::</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (3)!</span>
</span><span id=__span-92-8><a id=__codelineno-92-8 name=__codelineno-92-8 href=#__codelineno-92-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_exits</span><span class=p>[</span><span class=mi>1</span><span class=p>::</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (4)!</span>
</span><span id=__span-92-9><a id=__codelineno-92-9 name=__codelineno-92-9 href=#__codelineno-92-9></a><span class=gp>&gt;&gt;&gt; </span><span class=k>del</span> <span class=n>test_data</span>  <span class=c1># (5)!</span>
</span><span id=__span-92-10><a id=__codelineno-92-10 name=__codelineno-92-10 href=#__codelineno-92-10></a>
</span><span id=__span-92-11><a id=__codelineno-92-11 name=__codelineno-92-11 href=#__codelineno-92-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>test_entries</span><span class=o>.</span><span class=n>shape</span>
</span><span id=__span-92-12><a id=__codelineno-92-12 name=__codelineno-92-12 href=#__codelineno-92-12></a><span class=go>(527041, 1)</span>
</span></code></pre></div> <ol> <li>Generate random OHLC data with symmetric returns</li> <li>Get a column, extract the NumPy array, and expand the array to two dimensions (omit the last step if your data is already two-dimensional!)</li> <li>Place an entry at each second bar starting from the first bar</li> <li>Place an exit at each second bar starting from the second bar</li> <li>Delete the data object to release memory</li> </ol> <p>Each of the arrays is 527,041 data points long. </p> <p>So, how is our simulator performing on this data?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>  <span class=c1># (1)!</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline_6_nb</span><span class=p>(</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3 href=#__codelineno-93-3></a><span class=gp>... </span>    <span class=n>test_open</span><span class=p>,</span> 
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4 href=#__codelineno-93-4></a><span class=gp>... </span>    <span class=n>test_high</span><span class=p>,</span> 
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5 href=#__codelineno-93-5></a><span class=gp>... </span>    <span class=n>test_low</span><span class=p>,</span> 
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6 href=#__codelineno-93-6></a><span class=gp>... </span>    <span class=n>test_close</span><span class=p>,</span> 
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7 href=#__codelineno-93-7></a><span class=gp>... </span>    <span class=n>signal_order_func_nb</span><span class=p>,</span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8 href=#__codelineno-93-8></a><span class=gp>... </span>    <span class=n>order_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-93-9><a id=__codelineno-93-9 name=__codelineno-93-9 href=#__codelineno-93-9></a><span class=gp>... </span>        <span class=n>test_entries</span><span class=p>,</span> 
</span><span id=__span-93-10><a id=__codelineno-93-10 name=__codelineno-93-10 href=#__codelineno-93-10></a><span class=gp>... </span>        <span class=n>test_exits</span>
</span><span id=__span-93-11><a id=__codelineno-93-11 name=__codelineno-93-11 href=#__codelineno-93-11></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-93-12><a id=__codelineno-93-12 name=__codelineno-93-12 href=#__codelineno-93-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-93-13><a id=__codelineno-93-13 name=__codelineno-93-13 href=#__codelineno-93-13></a><span class=go>79.4 ms ± 290 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</span></code></pre></div> <ol> <li>This magic command works only in a Jupyter environment and only if you place this command at the beginning of the cell. If you're running the code as a script, use the <code>timeit</code> module.</li> </ol> <p>80 milliseconds to generate half a million orders on Apple M1, not bad! <img alt=🔥 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f525.svg title=:fire:></p> <p>To better illustrate how only a minor change can impact performance, we will create a new order function that also creates a zero-sized empty array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a><span class=gp>... </span><span class=k>def</span> <span class=nf>subopt_signal_order_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>):</span>
</span><span id=__span-94-3><a id=__codelineno-94-3 name=__codelineno-94-3 href=#__codelineno-94-3></a><span class=gp>... </span>    <span class=n>_</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-94-4><a id=__codelineno-94-4 name=__codelineno-94-4 href=#__codelineno-94-4></a><span class=gp>...</span>
</span><span id=__span-94-5><a id=__codelineno-94-5 name=__codelineno-94-5 href=#__codelineno-94-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>entries</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-94-6><a id=__codelineno-94-6 name=__codelineno-94-6 href=#__codelineno-94-6></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>()</span>
</span><span id=__span-94-7><a id=__codelineno-94-7 name=__codelineno-94-7 href=#__codelineno-94-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>exits</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>exec_state</span><span class=o>.</span><span class=n>position</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-94-8><a id=__codelineno-94-8 name=__codelineno-94-8 href=#__codelineno-94-8></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>close_position_nb</span><span class=p>()</span>
</span><span id=__span-94-9><a id=__codelineno-94-9 name=__codelineno-94-9 href=#__codelineno-94-9></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nothing_nb</span><span class=p>()</span>
</span><span id=__span-94-10><a id=__codelineno-94-10 name=__codelineno-94-10 href=#__codelineno-94-10></a>
</span><span id=__span-94-11><a id=__codelineno-94-11 name=__codelineno-94-11 href=#__codelineno-94-11></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-94-12><a id=__codelineno-94-12 name=__codelineno-94-12 href=#__codelineno-94-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline_6_nb</span><span class=p>(</span>
</span><span id=__span-94-13><a id=__codelineno-94-13 name=__codelineno-94-13 href=#__codelineno-94-13></a><span class=gp>... </span>    <span class=n>test_open</span><span class=p>,</span> 
</span><span id=__span-94-14><a id=__codelineno-94-14 name=__codelineno-94-14 href=#__codelineno-94-14></a><span class=gp>... </span>    <span class=n>test_high</span><span class=p>,</span> 
</span><span id=__span-94-15><a id=__codelineno-94-15 name=__codelineno-94-15 href=#__codelineno-94-15></a><span class=gp>... </span>    <span class=n>test_low</span><span class=p>,</span> 
</span><span id=__span-94-16><a id=__codelineno-94-16 name=__codelineno-94-16 href=#__codelineno-94-16></a><span class=gp>... </span>    <span class=n>test_close</span><span class=p>,</span> 
</span><span id=__span-94-17><a id=__codelineno-94-17 name=__codelineno-94-17 href=#__codelineno-94-17></a><span class=gp>... </span>    <span class=n>subopt_signal_order_func_nb</span><span class=p>,</span>
</span><span id=__span-94-18><a id=__codelineno-94-18 name=__codelineno-94-18 href=#__codelineno-94-18></a><span class=gp>... </span>    <span class=n>order_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-94-19><a id=__codelineno-94-19 name=__codelineno-94-19 href=#__codelineno-94-19></a><span class=gp>... </span>        <span class=n>test_entries</span><span class=p>,</span> 
</span><span id=__span-94-20><a id=__codelineno-94-20 name=__codelineno-94-20 href=#__codelineno-94-20></a><span class=gp>... </span>        <span class=n>test_exits</span>
</span><span id=__span-94-21><a id=__codelineno-94-21 name=__codelineno-94-21 href=#__codelineno-94-21></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-94-22><a id=__codelineno-94-22 name=__codelineno-94-22 href=#__codelineno-94-22></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-94-23><a id=__codelineno-94-23 name=__codelineno-94-23 href=#__codelineno-94-23></a><span class=go>130 ms ± 675 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <ol> <li>Here</li> </ol> <p>As we see, creating an empty array at each bar has slowed down the execution by more than 50%. And this is a very important lesson to learn: create arrays outside of loops and only once!</p> <h3 id=auto-parallelization>Auto-parallelization<a class=headerlink href=#auto-parallelization title="Permanent link">&para;</a></h3> <p>Because of path dependencies (= the current state depends on the previous one), we cannot parallelize the loop that iterates over rows (= time). But here's the deal: since vectorbt allows us to define a multi-columnar backtesting logic, we can parallelize the loop that iterates over columns or groups of columns, given that those columns or groups of columns are independent of each other - all using Numba alone. By the way, this is one of the primary reasons why vectorbt loves two-dimensional data layouts so much.</p> <p>Automatic parallelization with Numba cannot be simpler: just replace <code>range</code> that you want to parallelize with <code>numba.prange</code>, and instruct Numba to parallelize the function by passing <code>parallel=True</code> to the <code>@njit</code> decorator. This will (try to) execute the code in the loop simultaneously by multiple parallel threads. You can read more about automatic parallelization with Numba <a href=https://numba.pydata.org/numba-doc/latest/user/parallel.html>here</a> and about the available threading layers <a href=https://numba.pydata.org/numba-doc/latest/user/threading-layer.html>here</a>. On MacBook Air (M1, 2020), turning on parallelization reduces the processing time by 2-3 times on average. Usually, a simple arithmetic-heavy code without creating any arrays can be better parallelized than a complex vectorization-heavy code.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>You can modify the same array from multiple threads, as done by countless functions in vectorbt. Just make sure that multiple threads (columns, in our case) aren't modifying the same elements and data in general!</p> </div> <p>Here's a small example of a function that computes the expanding maximum on two-dimensional data, without and with automatic parallelization:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>1000000</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-95-4><a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a><span class=gp>... </span><span class=k>def</span> <span class=nf>expanding_max_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
</span><span id=__span-95-5><a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty_like</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-95-6><a id=__codelineno-95-6 name=__codelineno-95-6 href=#__codelineno-95-6></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span><span id=__span-95-7><a id=__codelineno-95-7 name=__codelineno-95-7 href=#__codelineno-95-7></a><span class=gp>... </span>        <span class=n>maxv</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-95-8><a id=__codelineno-95-8 name=__codelineno-95-8 href=#__codelineno-95-8></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-95-9><a id=__codelineno-95-9 name=__codelineno-95-9 href=#__codelineno-95-9></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>maxv</span><span class=p>:</span>
</span><span id=__span-95-10><a id=__codelineno-95-10 name=__codelineno-95-10 href=#__codelineno-95-10></a><span class=gp>... </span>                <span class=n>maxv</span> <span class=o>=</span> <span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-95-11><a id=__codelineno-95-11 name=__codelineno-95-11 href=#__codelineno-95-11></a><span class=gp>... </span>            <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>maxv</span>
</span><span id=__span-95-12><a id=__codelineno-95-12 name=__codelineno-95-12 href=#__codelineno-95-12></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-95-13><a id=__codelineno-95-13 name=__codelineno-95-13 href=#__codelineno-95-13></a>
</span><span id=__span-95-14><a id=__codelineno-95-14 name=__codelineno-95-14 href=#__codelineno-95-14></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%</span><span class=n>timeit</span> <span class=n>expanding_max_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>)</span>
</span><span id=__span-95-15><a id=__codelineno-95-15 name=__codelineno-95-15 href=#__codelineno-95-15></a><span class=go>40.7 ms ± 558 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</span><span id=__span-95-16><a id=__codelineno-95-16 name=__codelineno-95-16 href=#__codelineno-95-16></a>
</span><span id=__span-95-17><a id=__codelineno-95-17 name=__codelineno-95-17 href=#__codelineno-95-17></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>parallel</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-95-18><a id=__codelineno-95-18 name=__codelineno-95-18 href=#__codelineno-95-18></a><span class=gp>... </span><span class=k>def</span> <span class=nf>parallel_expanding_max_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
</span><span id=__span-95-19><a id=__codelineno-95-19 name=__codelineno-95-19 href=#__codelineno-95-19></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty_like</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-95-20><a id=__codelineno-95-20 name=__codelineno-95-20 href=#__codelineno-95-20></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>prange</span><span class=p>(</span><span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>  <span class=c1># (2)!</span>
</span><span id=__span-95-21><a id=__codelineno-95-21 name=__codelineno-95-21 href=#__codelineno-95-21></a><span class=gp>... </span>        <span class=n>maxv</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-95-22><a id=__codelineno-95-22 name=__codelineno-95-22 href=#__codelineno-95-22></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-95-23><a id=__codelineno-95-23 name=__codelineno-95-23 href=#__codelineno-95-23></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>maxv</span><span class=p>:</span>
</span><span id=__span-95-24><a id=__codelineno-95-24 name=__codelineno-95-24 href=#__codelineno-95-24></a><span class=gp>... </span>                <span class=n>maxv</span> <span class=o>=</span> <span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-95-25><a id=__codelineno-95-25 name=__codelineno-95-25 href=#__codelineno-95-25></a><span class=gp>... </span>            <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>maxv</span>
</span><span id=__span-95-26><a id=__codelineno-95-26 name=__codelineno-95-26 href=#__codelineno-95-26></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-95-27><a id=__codelineno-95-27 name=__codelineno-95-27 href=#__codelineno-95-27></a>
</span><span id=__span-95-28><a id=__codelineno-95-28 name=__codelineno-95-28 href=#__codelineno-95-28></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%</span><span class=n>timeit</span> <span class=n>parallel_expanding_max_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>)</span>
</span><span id=__span-95-29><a id=__codelineno-95-29 name=__codelineno-95-29 href=#__codelineno-95-29></a><span class=go>26.6 ms ± 437 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</span></code></pre></div> <ol> <li>Here's the first change</li> <li>Here's the second change</li> </ol> <p>It's your turn: enable automatic parallelization of columns in the <a href=#pipeline6>sixth pipeline</a> and benchmark it! Just don't forget to reduce the number of rows and increase the number of columns.</p> <h3 id=caching>Caching<a class=headerlink href=#caching title="Permanent link">&para;</a></h3> <p>Even if we had optimized the simulation pipeline for the best-possible performance, the actual compilation step would take a huge chunk of that time savings away. However, the good news is that Numba doesn't have to re-compile the function the second time it's executed, given that we passed the same argument <strong>types</strong> (not data!). This means that we need to wait only once if we want to test the same function on many parameter combinations, at the same Python runtime. Sadly, if only one argument differs in type, or we've restarted the Python runtime, Numba has to compile again. </p> <p>But luckily, Numba gives us a mechanism to avoid re-compilation even if we've restarted the runtime, called <a href=https://numba.pydata.org/numba-doc/latest/developer/caching.html>caching</a>. To enable caching, just pass <code>cache=True</code> to the <code>@njit</code> decorator.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Avoid turning on caching for functions that take complex, user-defined data, such as (named) tuples and other functions. This may lead to some hidden bugs and kernel crashes if the data changes during the next runtime. Also make sure that your function doesn't use global variables. For example, the <a href=#pipeline5>fifth pipeline</a> is perfectly cacheable, while the <a href=#pipeline6>sixth pipeline</a> is not cacheable, or maybe could be if <code>order_func_nb</code> was cacheable as well.</p> </div> <p>Make sure to define any cached function inside a Python file rather than in a notebook cell since it must have a clear filepath such that it can be introspected by Numba. To invalidate the cache, go to the directory where the function resides and remove the <code>__pycache__</code> directory. You can do that by running <code>rm -rf __pycache__</code> from your terminal.</p> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>A good practice is to invalidate the cache every time you change the code of a cached function to avoid potential side effects. Also, disable caching for the entire time of developing a function and turn it only on once the function has been fully implemented.</p> </div> <h3 id=aot-compilation>AOT compilation<a class=headerlink href=#aot-compilation title="Permanent link">&para;</a></h3> <p>Using <a href=https://numba.pydata.org/numba-doc/dev/user/pycc.html>ahead-of-time compilation</a>, we can compile a function only once and get no compilation overhead at runtime. Although this feature of Numba isn't widely used in vectorbt because it would restrict us from passing input data flexibly, we can make use of it in cases where we know the argument types in advance. Let's pre-compile our <a href=#pipeline5>fifth pipeline</a>!</p> <p>For this, we have to specify the signature of a function explicitly. You can read more about it in the <a href=https://numba.pydata.org/numba-doc/dev/reference/types.html#numba-types>types</a> reference.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>numba.pycc</span> <span class=kn>import</span> <span class=n>CC</span>
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cc</span> <span class=o>=</span> <span class=n>CC</span><span class=p>(</span><span class=s1>&#39;pipeline_5&#39;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a>
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sig</span> <span class=o>=</span> <span class=s2>&quot;f8[:, :](&quot;</span> \ <span class=c1># (2)!</span>
</span><span id=__span-96-5><a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a><span class=gp>... </span>      <span class=s2>&quot;UniTuple(i8, 2), &quot;</span> \ <span class=c1># (3)!</span>
</span><span id=__span-96-6><a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a><span class=gp>... </span>      <span class=s2>&quot;i8[:], &quot;</span> \ <span class=c1># (4)!</span>
</span><span id=__span-96-7><a id=__codelineno-96-7 name=__codelineno-96-7 href=#__codelineno-96-7></a><span class=gp>... </span>      <span class=s2>&quot;f8[:, :], &quot;</span> \ <span class=c1># (5)!</span>
</span><span id=__span-96-8><a id=__codelineno-96-8 name=__codelineno-96-8 href=#__codelineno-96-8></a><span class=gp>... </span>      <span class=s2>&quot;f8[:, :], &quot;</span> \
</span><span id=__span-96-9><a id=__codelineno-96-9 name=__codelineno-96-9 href=#__codelineno-96-9></a><span class=gp>... </span>      <span class=s2>&quot;f8[:, :], &quot;</span> \
</span><span id=__span-96-10><a id=__codelineno-96-10 name=__codelineno-96-10 href=#__codelineno-96-10></a><span class=gp>... </span>      <span class=s2>&quot;f8[:], &quot;</span> \ <span class=c1># (6)!</span>
</span><span id=__span-96-11><a id=__codelineno-96-11 name=__codelineno-96-11 href=#__codelineno-96-11></a><span class=gp>... </span>      <span class=s2>&quot;b1, &quot;</span> \ <span class=c1># (7)!</span>
</span><span id=__span-96-12><a id=__codelineno-96-12 name=__codelineno-96-12 href=#__codelineno-96-12></a><span class=gp>... </span>      <span class=s2>&quot;b1&quot;</span> \
</span><span id=__span-96-13><a id=__codelineno-96-13 name=__codelineno-96-13 href=#__codelineno-96-13></a><span class=gp>... </span>      <span class=s2>&quot;)&quot;</span>
</span><span id=__span-96-14><a id=__codelineno-96-14 name=__codelineno-96-14 href=#__codelineno-96-14></a>
</span><span id=__span-96-15><a id=__codelineno-96-15 name=__codelineno-96-15 href=#__codelineno-96-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cc</span><span class=o>.</span><span class=n>export</span><span class=p>(</span><span class=s1>&#39;pipeline_5_nb&#39;</span><span class=p>,</span> <span class=n>sig</span><span class=p>)(</span><span class=n>pipeline_5_nb</span><span class=p>)</span>   <span class=c1># (8)!</span>
</span><span id=__span-96-16><a id=__codelineno-96-16 name=__codelineno-96-16 href=#__codelineno-96-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cc</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span> <span class=c1># (9)!</span>
</span></code></pre></div> <ol> <li>Initialize a new module</li> <li>Function should return a two-dimensional array of 64-bit floating-point data type (allocations)</li> <li>Tuple with two 64-bit integers (<code>target_shape</code>)</li> <li>One-dimensional array of 64-bit integer data type (<code>group_lens</code>)</li> <li>Two-dimensional array of 64-bit floating-point data type (<code>open</code>, <code>close</code>, and <code>target_pct</code>)</li> <li>One-dimensional array of 64-bit floating-point data type (<code>init_cash</code>)</li> <li>Boolean value (<code>auto_call_seq</code> and <code>rotate_cols</code>)</li> <li>Register the function with the provided signature. You can bind multiple signatures to the same function.</li> <li>Compile the module</li> </ol> <p>This has generated an extension module named <code>pipeline_5</code>. On macOS, the actual filename is <code>pipeline_5.cpython-37m-darwin.so</code>. We can then import the module like a regular Python module and run the function <code>pipeline_5_nb</code> of that module:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span> <span class=nn>pipeline_5</span>
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a>
</span><span id=__span-97-3><a id=__codelineno-97-3 name=__codelineno-97-3 href=#__codelineno-97-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mult_alloc</span> <span class=o>=</span> <span class=n>pipeline_5</span><span class=o>.</span><span class=n>pipeline_5_nb</span><span class=p>(</span>
</span><span id=__span-97-4><a id=__codelineno-97-4 name=__codelineno-97-4 href=#__codelineno-97-4></a><span class=gp>... </span>    <span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-97-5><a id=__codelineno-97-5 name=__codelineno-97-5 href=#__codelineno-97-5></a><span class=gp>... </span>    <span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-97-6><a id=__codelineno-97-6 name=__codelineno-97-6 href=#__codelineno-97-6></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>))</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s2>&quot;f8&quot;</span><span class=p>,</span> <span class=n>copy</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-97-7><a id=__codelineno-97-7 name=__codelineno-97-7 href=#__codelineno-97-7></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>mult_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>))</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s2>&quot;f8&quot;</span><span class=p>,</span> <span class=n>copy</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span><span id=__span-97-8><a id=__codelineno-97-8 name=__codelineno-97-8 href=#__codelineno-97-8></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>mult_target_pct</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s2>&quot;f8&quot;</span><span class=p>,</span> <span class=n>copy</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span><span id=__span-97-9><a id=__codelineno-97-9 name=__codelineno-97-9 href=#__codelineno-97-9></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s2>&quot;f8&quot;</span><span class=p>,</span> <span class=n>copy</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span><span id=__span-97-10><a id=__codelineno-97-10 name=__codelineno-97-10 href=#__codelineno-97-10></a><span class=gp>... </span>    <span class=n>auto_call_seq</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-97-11><a id=__codelineno-97-11 name=__codelineno-97-11 href=#__codelineno-97-11></a><span class=gp>... </span>    <span class=n>rotate_cols</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-97-12><a id=__codelineno-97-12 name=__codelineno-97-12 href=#__codelineno-97-12></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>This makes sure that the array has a proper dimensionality and data type</li> <li>Keyword arguments must be provided as positional ones. Also, default values must be provided explicitly.</li> </ol> <p>That was lightning fast! <img alt=⚡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/26a1.svg title=:zap:></p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>You should ensure that the provided arguments exactly match the registered signature, otherwise you may get errors that may be very difficult to debug. For example, while setting <code>init_cash</code> to <code>100</code> would yield an <em>"index is out of bounds"</em> error, casting the array to integer would make all allocations zero!</p> </div> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>We've covered in detail a lot of components of a typical simulator in vectorbt. Simulation is the primary step in backtesting of a trading strategy, and by mastering it you'll gain some hard-core skills that can be applied just in any place of the vectorbt's rich Numba ecosystem. </p> <p>One of the most important takeaways from this documentation piece is that implementing a custom simulator is as easy (or as difficult) as any other Numba-compiled function, and there is no point in using the preset simulation methods such as <a href=../../api/portfolio/base/index.html#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> if you can produce the same results, achieve a multifold performance gain, be able to use rotational indexing, caching, and AOT compilation, by designing your own pipeline from scratch. After all, it's just a bunch of loops that gradually move over the shape of a matrix, execute orders, update the state of the simulation, and write some output data. Everything else is up to your imagination <img alt=🧙 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f9d9.svg title=:mage:></p> <p><a class=md-button href=../../assets/jupytext/documentation/portfolio/index.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5h1.18m-4.28 11.79c-.4 0-.72.3-.72.89 0 .59.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68H4.86M9.14 5.71c.4 0 .72-.3.72-.89 0-.59-.32-.71-.72-.71-.39 0-.71.12-.71.71s.32.89.71.89Z"/></svg></span> Python code</a></p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../indicators/parsers/index.html class="md-footer__link md-footer__link--prev" aria-label="Previous: Parsers"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Parsers </div> </div> </a> <a href=from-orders/index.html class="md-footer__link md-footer__link--next" aria-label="Next: From orders"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> From orders </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2024 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.sections", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.8e8db93a.min.js></script> <script src=../../assets/javascripts/extra.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_321460c7/documentation/portfolio/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 05 Mar 2024 10:56:26 GMT -->
</html>